<script>
    // Tag ambiente
    document.getElementById('envTag').textContent =
      `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/public`;
    // Configuração local
    (function setupConfig() {
      const wantLocal = location.hostname === "localhost" || location.search.includes("useLocalApi=1");
      if (wantLocal) {
        window.APP_CONFIG = Object.assign(window.APP_CONFIG || {}, {
          API_BASE: "http://localhost:3000/api",
          ENV: "dev"
        });
        console.log("config.local.js aplicado: API_BASE = http://localhost:3000/api");
      } else {
        window.APP_CONFIG = Object.assign(window.APP_CONFIG || {}, {
          API_BASE: "https://conhecimento-com-luz-api.onrender.com",
          ENV: "prod"
        });
        console.log("config.prod.js aplicado: API_BASE = https://conhecimento-com-luz-api.onrender.com");
      }
    })();
    // Definições iniciais
    const EMO = {
      POS: {'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperança':3,'paz':2,'fé':3,'gratidão':2,'vitória':3,'superação':3,'luz':2,'deus':3,'coragem':2,'força':2,'confiança':2,'propósito':3},
      NEG: {'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustração':-2,'decepcao':-2,'decepção':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solidão':-2,'desespero':-3,'cansaco':-2,'cansaço':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'dúvida':-2}
    };
    // ** CORREÇÃO CIRÚRGICA: Otimizado para melhor controle do fluxo e carregamento dinâmico. **
    window.JORNADA_BLOCKS = window.JORNADA_BLOCKS || [
        { id: "b1", title: "Bloco 1 — Raízes", questions: ['Quem é você hoje?','O que a Luz te pede agora?','Qual é o próximo passo concreto?'], video_after: "/assets/videos/video-bloco1.mp4" },
        { id: "b2", title: "Bloco 2 — Caminho", questions: ['Qual verdade você precisa admitir para seguir?','O que precisa ser curado neste momento?'], video_after: "/assets/videos/video-bloco2.mp4" },
        { id: "b3", title: "Bloco 3 — Encontros", questions: ['Como o seu propósito se manifesta no mundo?'], video_after: "/assets/videos/video-bloco3.mp4" }
    ];
    window.JORNADA_FINAL_VIDEO = "/assets/videos/video-final.mp4"; // Definindo o vídeo final
    const PERGUNTAS = [
      'Quem é você hoje?',
      'O que a Luz te pede agora?',
      'Qual é o próximo passo concreto?',
      'Qual verdade você precisa admitir para seguir?',
      'O que precisa ser curado neste momento?'
    ];
    // JORNADA_TYPE (jornada-typing.js)
    (function ensureStyle() {
      if (document.getElementById('typing-style')) return;
      const st = document.createElement('style');
      st.id = 'typing-style';
      st.textContent = `
        .typing-caret { display: inline-block; width: 0.6ch; margin-left: 2px; animation: blink 1s step-end infinite; }
        @keyframes blink { 50% { opacity: 0; } }
      `;
      document.head.appendChild(st);
    })();
    const JORNADA_TYPE = {
      run: async function(root, opts = {}) {
        const scope = (typeof root === 'string') ? document.querySelector(root) : (root || document);
        const selector = opts.selector || '[data-typing]';
        const speed = Number(opts.speed ?? 18);
        const nodes = Array.from(scope.querySelectorAll(selector));
        for (const n of nodes) {
          const text = n.getAttribute('data-text') ?? n.textContent ?? '';
          n.textContent = '';
          const caret = document.createElement('span');
          caret.className = 'typing-caret';
          n.appendChild(caret);
          if (opts.delay) await new Promise(r => setTimeout(r, opts.delay));
          for (let i = 0; i < text.length; i++) {
            caret.before(document.createTextNode(text[i]));
            await new Promise(r => setTimeout(r, speed));
          }
          caret.remove();
        }
      },
      typeIt: function(el, text, speed = 24) {
        if (!el || !text) return;
        el.textContent = '';
        let i = 0;
        const tick = () => {
          if (i < text.length) {
            el.textContent += text.charAt(i++);
            requestAnimationFrame(tick);
          }
        };
        requestAnimationFrame(tick);
      }
    };
    window.JORNADA_TYPE = JORNADA_TYPE;
    // Utils
    const JORNADA_UTILS = {
      saveLocal: (key, value) => localStorage.setItem(key, JSON.stringify(value)),
      loadLocal: (key) => {
        try { return JSON.parse(localStorage.getItem(key) || "{}"); } catch (_) { return {}; }
      },
      clearLocal: (key) => localStorage.removeItem(key),
      el: (html) => {
        const d = document.createElement("div");
        d.innerHTML = (html || "").trim();
        return d.firstElementChild;
      },
      $: (sel, root = document) => root.querySelector(sel),
      $$: (sel, root = document) => Array.from(root.querySelectorAll(sel)),
      getApiBase: () => window.APP_CONFIG?.API_BASE || "https://conhecimento-com-luz-api.onrender.com",
      apiGet: async (path, opts = {}) => {
        const url = JORNADA_UTILS.getApiBase() + path;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        try {
          const res = await fetch(url, {
            method: "GET",
            headers: { Accept: "application/json" },
            signal: controller.signal,
            ...opts
          });
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`GET ${url} -> ${res.status}`);
          return res.headers.get("content-type")?.includes("application/json") ? res.json() : res.text();
        } catch (e) {
          console.error('Erro na API GET:', e);
          UI.toast('Erro ao conectar com o servidor. Tente novamente.');
          throw e;
        }
      },
      apiPost: async (path, body = {}, opts = {}) => {
        const url = JORNADA_UTILS.getApiBase() + path;
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json", Accept: "application/json, application/pdf" },
            body: JSON.stringify(body),
            signal: controller.signal,
            ...opts
          });
          clearTimeout(timeoutId);
          if (!res.ok) throw new Error(`POST ${url} -> ${res.status}`);
          const ct = res.headers.get("content-type") || "";
          if (ct.includes("application/json")) return res.json();
          if (ct.includes("application/pdf")) return res.blob();
          return res.text();
        } catch (e) {
          console.error('Erro na API POST:', e);
          UI.toast('Erro ao enviar dados. Tente novamente.');
          throw e;
        }
      }
    };
    window.JORNADA_UTILS = JORNADA_UTILS;
    // Core
    const JORNADA_CORE = {
      iniciarFluxo: function() { JORNADA_CORE.STATE.respostas = {}; },
      salvarRespostas: function(data) {
        if (data && typeof data === "object") {
          Object.assign(JORNADA_CORE.STATE.respostas, data);
        }
        JORNADA_UTILS.saveLocal("jornada_respostas", JORNADA_CORE.STATE.respostas);
      },
      baixarArquivos: async function(payload = {}) {
        try {
          return await JORNADA_UTILS.apiPost('/download', payload);
        } catch (e) {
          console.error('Erro ao baixar arquivos:', e);
          UI.toast('Erro ao gerar PDF. Tente novamente.');
          throw e;
        }
      },
      STATE: { respostas: {} }
    };
    window.JORNADA_CORE = JORNADA_CORE;
    window.JORNADA_UI = Object.assign(window.JORNADA_UI || {}, {
      setProgressoBlocos: function(blocoIdx0, totalBlocos) {
        const el = document.getElementById('badgeProgressoBlocos');
        if (!el || !totalBlocos) return;
        const pct = Math.round(((blocoIdx0 + 1) / totalBlocos) * 100);
        el.textContent = `${pct}% concluído`;
      },
      setProgressoPerguntas: function(percent) {
        const bar = document.getElementById('progressBar');
        if (bar) bar.style.width = `${Math.max(0, Math.min(100, percent | 0))}%`;
      }
    });
    // State
    const JSTATE = {
      load: () => JORNADA_UTILS.loadLocal('jornada_state'),
      save: (data) => JORNADA_UTILS.saveLocal('jornada_state', data),
      clearAll: () => JORNADA_UTILS.clearLocal('jornada_state'),
      get: (k, fallback) => {
        const state = JSTATE.load();
        return state.hasOwnProperty(k) ? state[k] : fallback;
      },
      set: (k, v) => {
        const st = JSTATE.load();
        st[k] = v;
        JSTATE.save(st);
      },
      clear: (k) => {
        const st = JSTATE.load();
        delete st[k];
        JSTATE.save(st);
      }
    };
    window.JSTATE = JSTATE;
    // Paper
    const JORNADA_PAPER = {
      set: function(mode /* 'v' | 'h' */) {
        const root = document.getElementById('jornada-canvas');
        root.classList.remove("pergaminho-v", "pergaminho-h");
        if (mode === "v") {
          root.classList.add("pergaminho-v");
        } else if (mode === "h") {
          root.classList.add("pergaminho-h");
        }
        const imageUrl = (mode === "v") ? "/assets/img/pergaminho-rasgado-vert.png" : "/assets/img/pergaminho-rasgado-horiz.png";
        root.style.backgroundImage = `url("${imageUrl}")`;
        root.style.backgroundRepeat = "no-repeat";
        root.style.backgroundPosition = "center";
        root.style.backgroundSize = "cover";
        root.style.minHeight = "82vh";
      },
      ensureCanvas: function() {
        let root = document.getElementById('jornada-canvas');
        if (!root) {
          root = document.createElement("section");
          root.id = 'jornada-canvas';
          root.className = "card pergaminho";
          document.body.appendChild(root);
        }
        let content = document.getElementById('jornada-conteudo');
        if (!content) {
          content = document.createElement("div");
          content.id = 'jornada-conteudo';
          content.className = "conteudo-pergaminho";
          root.innerHTML = "";
          root.appendChild(content);
        }
        return { root, content };
      }
    };
    window.JORNADA_PAPER = JORNADA_PAPER;
    // Questions
    const QUESTIONS = {
      BLOCS: window.JORNADA_BLOCKS,
      ACOLHIMENTO: { id: "acolhimento", title: "Acolhimento do Lumen", items: ["Deixe aqui uma palavra ao seu Eu do Futuro."] },
      totalBlocks: function() { return this.BLOCS.length; },
      totalQuestions: function() {
        return this.BLOCS.reduce((n, b) => n + b.questions.length, 0) + this.ACOLHIMENTO.items.length;
      },
      getBlock: function(i) { return this.BLOCS[i] || null; },
      getAcolhimento: function() { return this.ACOLHIMENTO; },
      blockKey: function(blockIdx, qIdx) { return `${this.BLOCS[blockIdx].id}#${qIdx}`; },
      acolhKey: function() { return `${this.ACOLHIMENTO.id}#0`; },
      getAnswerMap: function() { return JORNADA_UTILS.loadLocal("jornada_respostas_v1"); },
      getAnswer: function(key) { return this.getAnswerMap()[key] || ""; },
      setAnswer: function(key, val) {
        const all = this.getAnswerMap();
        all[key] = String(val || "");
        JORNADA_UTILS.saveLocal("jornada_respostas_v1", all);
      },
      countAnswered: function() {
        const all = this.getAnswerMap();
        let answered = 0;
        this.BLOCS.forEach((b, bi) => {
          b.questions.forEach((_, qi) => {
            if ((all[this.blockKey(bi, qi)] || "").trim().length > 0) answered++;
          });
        });
        if ((all[this.acolhKey()] || "").trim().length > 0) answered++;
        return answered;
      }
    };
    window.QUESTIONS = QUESTIONS;
    // UI
    const UI = {
      qs: (sel, root = document) => root.querySelector(sel),
      qsa: (sel, root = document) => Array.from(root.querySelectorAll(sel)),
      showSection: (idOrSelector) => {
        const views = UI.qsa('section.card');
        const target = idOrSelector?.startsWith('#') || idOrSelector?.startsWith('[')
          ? idOrSelector
          : `#${idOrSelector}`;
        views.forEach(sec => {
          if (sec.matches(target)) sec.classList.remove('hidden');
          else sec.classList.add('hidden');
        });
      },
      setProgress: (percent) => {
        const bar = UI.qs('#progressBar');
        if (bar) bar.style.width = `${Math.max(0, Math.min(100, percent))}%`;
      },
      setPergunta: (index, total, perguntas) => {
        const titulo = UI.qs('#perguntaTitulo');
        const etapaNum = UI.qs('#etapaNum');
        const etapaTot = UI.qs('#etapaTot');
        if (etapaTot) etapaTot.textContent = String(total || (perguntas?.length || 0));
        if (etapaNum) etapaNum.textContent = String((index ?? 0) + 1);
        if (titulo) {
          if (Array.isArray(perguntas)) {
            const item = perguntas[index] ?? '';
            const texto = typeof item === 'string' ? item : (item?.titulo || item?.texto || '');
            titulo.textContent = texto || 'Pergunta';
          } else {
            titulo.textContent = 'Pergunta';
          }
        }
      },
      toast: (msg) => {
        const t = document.createElement('div');
        t.className = 'toast';
        t.textContent = msg;
        document.body.appendChild(t);
        requestAnimationFrame(() => t.classList.add('show'));
        setTimeout(() => { t.classList.remove('show'); t.remove(); }, 3000);
      },
      fadeOutIn: (fn) => {
        const root = UI.qs('#app') || document.body;
        root.classList.add('fade-out');
        setTimeout(() => {
          try { fn && fn(); }
          finally { root.classList.remove('fade-out'); }
        }, 220);
      },
      mountGlobalHandlers: () => {
        document.addEventListener('click', (e) => {
          if (e.target.matches('[data-once]')) {
            if (e.target.dataset._locked) { e.preventDefault(); return; }
            e.target.dataset._locked = '1';
          }
        });
      }
    };
    window.UI = UI;
    // EMOÇÃO E DATILOGRAFIA
    function analyzeSentiment(text) {
      let score = 0;
      const tokens = (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').split(/\s+/);
      for (const t of tokens) {
        if (EMO.POS[t] != null) score += EMO.POS[t];
        if (EMO.NEG[t] != null) score += EMO.NEG[t];
      }
      return score;
    }
    // CHAMA
    const JORNADA_CHAMA = {
      analyzeSentiment: analyzeSentiment,
      updateChama: function(scoreNum, targetId = 'chama-perguntas') {
        const el = document.getElementById(targetId);
        if (!el) {
          return;
        }
        el.classList.add('chama-viva');
        const modo = (scoreNum <= -2) ? 'fraca' : (scoreNum >= 2) ? 'forte' : 'media';
        el.setAttribute('data-intensidade', modo);
        if (modo === 'forte') {
          el.classList.add('chama-pico');
          clearTimeout(el._pulse_t);
          el._pulse_t = setTimeout(() => el.classList.remove('chama-pico'), 700);
        } else {
          el.classList.remove('chama-pico');
        }
        const bola = document.getElementById('chama-bola');
        if (bola) {
          bola.classList.remove('fraca', 'media', 'forte');
          bola.classList.add(modo);
          bola.setAttribute('data-intensidade', modo);
        }
      },
      updateChamaFromText: function(text, targetId = 'chama-perguntas') {
        const score = analyzeSentiment(text);
        this.updateChama(score, targetId);
        return { score, intensidade: (score <= -2) ? 'fraca' : (score >= 2) ? 'forte' : 'media' };
      },
      setChamaIntensidade: function(target, modo) {
        const el = typeof target === 'string' ? document.getElementById(target) : target;
        if (!el) return;
        el.classList.add('chama-viva');
        el.setAttribute('data-intensidade', modo);
        if (!el.querySelector('.brasa')) {
          el.innerHTML = `
            <div class="brasa"></div>
            <div class="lingua"></div>
            <div class="lingua"></div>
            <div class="lingua"></div>
            <div class="brilho"></div>
          `;
        }
      },
      ensureHeroFlame: function(sectionId) {
        const introChama = document.getElementById('chama-intro');
        const finalChama = document.getElementById('chama-final');
        const perguntasChama = document.getElementById('chama-perguntas');
        if (introChama) introChama.style.visibility = (sectionId === 'sec-intro') ? 'visible' : 'hidden';
        if (finalChama) finalChama.style.visibility = (sectionId === 'sec-final') ? 'visible' : 'hidden';
        if (perguntasChama) perguntasChama.style.visibility = (sectionId === 'sec-wizard') ? 'visible' : 'hidden';
      },
      setChamaBola: function(intensidade, targetId = 'chama-bola') {
        const el = document.getElementById(targetId);
        if (el) {
          el.classList.remove('fraca', 'media', 'forte');
          el.classList.add(intensidade);
          el.setAttribute('data-intensidade', intensidade);
        }
      }
    };
    window.JORNADA_CHAMA = JORNADA_CHAMA;
    // micro-variação para cada chama
    document.querySelectorAll('#chama-intro, #chama-perguntas, #chama-final, #chama-bola')
      .forEach(f => {
        f.style.setProperty('--jitter', `${(Math.random() * 2 - 1).toFixed(2)}px`);
        f.querySelectorAll('.lingua').forEach((n, i) => {
          n.style.animationDelay = `${i * 0.07 + Math.random() * 0.08}s`;
        });
      });
    // PROGRESSO & STORAGE
    function updateProgress() {
      const perguntas = document.querySelectorAll('.j-pergunta');
      const respondidas = Array.from(perguntas).filter(p => p.querySelector('textarea').value.trim() !== '').length;
      const progresso = (respondidas / (perguntas.length || 1)) * 100;
      const fill = document.getElementById('jprog-fill');
      const badge = document.getElementById('jprog-pct');
      const jFill = document.querySelector('.j-progress__fill');
      const jMeta = document.getElementById('j-meta');
      if (fill) fill.style.width = `${progresso}%`;
      if (badge) badge.textContent = `${Math.round(progresso)}% concluído`;
      if (jFill) jFill.style.width = `${progresso}%`;
      if (jMeta) jMeta.textContent = `Respondidas: ${respondidas} de ${perguntas.length}`;
    }
    function saveAnswers() {
      const respostas = {};
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
        const name = input.name || `q${idx + 1}`;
        respostas[name] = input.value || '';
      });
      JSTATE.set('respostas', respostas);
      JORNADA_CORE.salvarRespostas(respostas);
    }
    function loadAnswers() {
      try {
        const respostas = JSTATE.get('respostas', {});
        document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
          const name = input.name || `q${idx + 1}`;
          input.value = respostas[name] || '';
        });
      } catch (e) { console.warn('Falha ao carregar respostas:', e); }
      updateProgress();
    }
    // NAVEGAÇÃO
    const JORNADA_NAV = {
      routes: {
        intro: "sec-intro",
        perguntas: "sec-wizard",
        final: "sec-final",
        home: "home",
      },
      renderFromHash: function() {
        const raw = (location.hash || "").replace(/^#/, "");
        if (!raw) return this.goIntro(false);
        const [route, param] = raw.split(":");
        switch (route) {
          case this.routes.intro: activateJornada(); return renderIntro();
          case this.routes.perguntas: activateJornada(); return renderPerguntas(Number(param || 0) || 0);
          case this.routes.final: activateJornada(); return renderFinal();
          case this.routes.home: deactivateJornada(); return this.goHome(true);
          default: return this.goIntro(false);
        }
      },
      goIntro: function(push = true) { if (push) location.hash = "#" + this.routes.intro; else { location.replace("#" + this.routes.intro); renderIntro(); } },
      goPerguntas: function(index = 0) { location.hash = `#${this.routes.perguntas}:${index}`; },
      goFinal: function() { location.hash = "#" + this.routes.final; },
      goHome: function(replaceOnly = false) {
        const url = "/jornadas.html";
        if (replaceOnly) location.replace(url); else window.location.href = url;
      },
      nextBlock: function(currIndex) {
        if (currIndex < window.JORNADA_BLOCKS.length - 1) return this.goPerguntas(currIndex + 1);
        return this.goFinal();
      },
      prevBlock: function(currIndex) {
        if (currIndex > 0) return this.goPerguntas(currIndex - 1);
        return this.goIntro();
      },
      onClick: function(e) {
        const a = e.target.closest("[data-nav]");
        if (!a) return;
        const nav = a.getAttribute("data-nav");
        if (!nav) return;
        e.preventDefault();
        switch (nav) {
          case "home": return this.goHome();
          case "intro": return this.goIntro();
          case "final": return this.goFinal();
          case "perguntas-next": return this.nextBlock(Number(a.dataset.idx || 0));
          case "perguntas-prev": return this.prevBlock(Number(a.dataset.idx || 0));
          case "perguntas": return this.goPerguntas(Number(a.dataset.idx || 0));
        }
      },
      init: function() {
        window.addEventListener("hashchange", () => this.renderFromHash(), { once: true });
        document.addEventListener("click", (e) => this.onClick(e));
        this.renderFromHash();
      }
    };
    window.JORNADA_NAV = JORNADA_NAV;
    function activateJornada() { document.body.classList.add('jornada-active'); }
    function deactivateJornada() { document.body.classList.remove('jornada-active'); }
    // ROTEAMENTO, RENDER E CONTROLE
    function updateCanvasBackground(sectionId) {
      JORNADA_PAPER.set(sectionId === 'sec-wizard' ? 'h' : 'v');
    }
    // ** CORREÇÃO CIRÚRGICA: Lógica de exibição de seção aprimorada e chamada da renderização de conteúdo. **
    function showSection(sectionId) {
        document.querySelectorAll('.j-section').forEach(s => s.classList.add('hidden'));
        const active = document.getElementById(sectionId);
        if (active) active.classList.remove('hidden');
        updateCanvasBackground(sectionId);
        if (window.JORNADA_CHAMA && typeof window.JORNADA_CHAMA.ensureHeroFlame === 'function') {
            window.JORNADA_CHAMA.ensureHeroFlame(sectionId);
        }
        // Chamada da função de renderização de conteúdo específica para cada seção
        if (sectionId === 'sec-auth') {
            JORNADA_TYPE.run('#sec-auth', { selector: '[data-typing]', speed: 50 });
        } else if (sectionId === 'sec-intro') {
            JORNADA_TYPE.run('#sec-intro', { selector: '[data-typing]', speed: 40 });
        } else if (sectionId === 'sec-wizard') {
            renderBlocoPerguntas(state.blocoIndex);
        } else if (sectionId === 'sec-final') {
            JORNADA_TYPE.run('#sec-final', { selector: '[data-typing]', speed: 40 });
        }
    }
    
    // ** CORREÇÃO CIRÚRGICA: Lógica de carregamento e exibição de blocos aprimorada. **
    function renderBlocoPerguntas(blocoIdx) {
        const container = document.getElementById('perguntas-container');
        if (!container) {
            console.error('Erro: #perguntas-container não encontrado no DOM!');
            return;
        }

        // Limpa o conteúdo anterior
        container.innerHTML = '';

        const blocoData = window.JORNADA_BLOCKS[blocoIdx];
        if (!blocoData) {
            console.error('Bloco de dados não encontrado para o índice:', blocoIdx);
            return;
        }

        const blocoEl = JORNADA_UTILS.el(`<section class="j-bloco" data-bloco="${blocoIdx}">
            <h2 class="bloco-titulo">${blocoData.title}</h2>
        </section>`);

        blocoData.questions.forEach((q, qIdx) => {
            const perguntaEl = JORNADA_UTILS.el(`<div class="j-pergunta" data-pergunta="${qIdx}">
                <h3 class="pergunta-enunciado" data-typing data-text="${q}" data-speed="40"></h3>
                <textarea name="q-${blocoIdx}-${qIdx}" placeholder="Sua resposta..." rows="4"></textarea>
            </div>`);
            blocoEl.appendChild(perguntaEl);
        });

        container.appendChild(blocoEl);
        
        // Garante que a primeira pergunta do bloco é exibida e focada
        const perguntas = Array.from(container.querySelectorAll('.j-pergunta'));
        perguntas.forEach(p => p.style.display = 'none');
        if (perguntas.length > 0) {
            const primeiraPergunta = perguntas[0];
            primeiraPergunta.style.display = 'block';
            const input = primeiraPergunta.querySelector('textarea');
            if (input) {
                input.value = JSTATE.get('respostas', {})[`q-${blocoIdx}-0`] || '';
                input.focus();
                input.oninput = debounce(() => {
                    state.respostas[`q-${blocoIdx}-0`] = input.value;
                    JSTATE.set('respostas', state.respostas);
                    JORNADA_CHAMA.updateChama(JORNADA_CHAMA.analyzeSentiment(input.value));
                    updateProgress();
                }, 300);
            }
            JORNADA_TYPE.run(primeiraPergunta, { selector: '.pergunta-enunciado', speed: 40 });
        }
    }
    
    // ** CORREÇÃO CIRÚRGICA: Lógica de navegação entre perguntas e blocos unificada e mais robusta. **
    const JC = (window.JC = window.JC || {});
    const state = {
        blocoIndex: parseInt(sessionStorage.getItem('jornada.block') || '0', 10) || 0,
        perguntaIndex: parseInt(sessionStorage.getItem('jornada.step') || '0', 10) || 0,
        respostas: JSTATE.get('respostas', {}),
    };
    const S = {
        root: () => document.getElementById('jornada-canvas'),
        blocos: () => Array.from(document.querySelectorAll('.j-bloco,[data-bloco]')),
        blocoAtivo: () => S.blocos()[state.blocoIndex],
        perguntasDo: (blocoEl) => Array.from(blocoEl.querySelectorAll('.j-pergunta,[data-pergunta]')),
        btnPrev: () => document.getElementById('btnVoltar'),
        btnNext: () => document.getElementById('btnProxima'),
        btnStart: () => document.getElementById('btnIniciar'),
        meta: () => document.getElementById('j-meta'),
        progressFill: () => document.querySelector('.j-progress__fill'),
        overlay: () => document.getElementById('videoOverlay'),
        video: () => document.getElementById('videoTransicao'),
        skip: () => document.getElementById('skipVideo'),
    };
    const U = {
        show(el, disp = 'block') { if (el) el.style.display = disp; },
        hide(el) { if (el) el.style.display = 'none'; },
        clamp(n, a, b) { return Math.max(a, Math.min(b, n)); },
        key(b, q) { return `b${b}-q${q}`; },
        getAnswerEl(qEl) { return qEl?.querySelector?.('textarea') || null; },
        getVal(el) { return (el && (el.value ?? '')).trim(); },
        setProgress(cur, total) {
            const pct = total ? Math.round((cur / total) * 100) : 0;
            const bar = S.progressFill();
            const meta = S.meta();
            if (bar) bar.style.width = pct + '%';
            if (meta) meta.innerHTML = `<b>${cur}</b> / ${total} (${pct}%)`;
        },
    };

    function saveCurrentAnswer() {
        const bloco = S.blocoAtivo();
        if (!bloco) return;
        const perguntas = S.perguntasDo(bloco);
        const qEl = perguntas[state.perguntaIndex];
        if (!qEl) return;
        const input = U.getAnswerEl(qEl);
        if (input) {
            const k = `q-${state.blocoIndex}-${state.perguntaIndex}`;
            state.respostas[k] = U.getVal(input);
            JSTATE.set('respostas', state.respostas);
        }
    }

    function render() {
        // Redireciona para o render correto com base no estado
        if (document.body.classList.contains('jornada-active')) {
            showSection('sec-wizard');
            showPergunta(state.perguntaIndex);
        } else {
            showSection('sec-auth');
        }
    }
    
    function showPergunta(perguntaIdx) {
        const bloco = document.querySelector(`.j-bloco[data-bloco="${state.blocoIndex}"]`);
        if (!bloco) {
            console.error('Bloco ativo não encontrado!');
            return;
        }
        const perguntas = Array.from(bloco.querySelectorAll('.j-pergunta'));
        perguntas.forEach(p => p.style.display = 'none'); // Esconde todas
        
        const atual = perguntas[perguntaIdx];
        if (atual) {
            atual.style.display = 'block';
            const input = U.getAnswerEl(atual);
            if (input) {
                input.value = state.respostas[`q-${state.blocoIndex}-${perguntaIdx}`] || '';
                input.focus();
                input.oninput = debounce(() => {
                    const k = `q-${state.blocoIndex}-${perguntaIdx}`;
                    state.respostas[k] = input.value;
                    JSTATE.set('respostas', state.respostas);
                    JORNADA_CHAMA.updateChama(JORNADA_CHAMA.analyzeSentiment(input.value));
                    updateProgress();
                }, 300);
            }
            JORNADA_TYPE.run(atual, { selector: '.pergunta-enunciado', speed: 40 });
        }
        
        const totalPerguntasDoBloco = window.JORNADA_BLOCKS[state.blocoIndex].questions.length;
        U.setProgress(perguntaIdx + 1, totalPerguntasDoBloco);
        const nextBtn = S.btnNext();
        if (nextBtn) {
            nextBtn.textContent = (perguntaIdx === totalPerguntasDoBloco - 1) ? 'Próximo Bloco' : 'Próxima';
        }
        const prevBtn = S.btnPrev();
        if (prevBtn) {
            prevBtn.disabled = (state.blocoIndex === 0 && perguntaIdx === 0);
        }
    }
    
    function goNext() {
        saveCurrentAnswer();
        const blocoData = window.JORNADA_BLOCKS[state.blocoIndex];
        if (state.perguntaIndex < blocoData.questions.length - 1) {
            state.perguntaIndex++;
            sessionStorage.setItem('jornada.step', String(state.perguntaIndex));
            showPergunta(state.perguntaIndex);
        } else {
            const nextBlocoIndex = state.blocoIndex + 1;
            if (nextBlocoIndex < window.JORNADA_BLOCKS.length) {
                const nextBlocoData = window.JORNADA_BLOCKS[nextBlocoIndex];
                if (blocoData.video_after) {
                    playTransition(blocoData.video_after, () => {
                        state.blocoIndex = nextBlocoIndex;
                        state.perguntaIndex = 0;
                        sessionStorage.setItem('jornada.block', String(state.blocoIndex));
                        sessionStorage.setItem('jornada.step', '0');
                        showSection('sec-wizard');
                        renderBlocoPerguntas(state.blocoIndex);
                    });
                } else {
                    state.blocoIndex = nextBlocoIndex;
                    state.perguntaIndex = 0;
                    sessionStorage.setItem('jornada.block', String(state.blocoIndex));
                    sessionStorage.setItem('jornada.step', '0');
                    showSection('sec-wizard');
                    renderBlocoPerguntas(state.blocoIndex);
                }
            } else {
                playTransition(window.JORNADA_FINAL_VIDEO, () => {
                    showSection('sec-final');
                });
            }
        }
    }
    
    function goPrev() {
        saveCurrentAnswer();
        if (state.perguntaIndex > 0) {
            state.perguntaIndex--;
            sessionStorage.setItem('jornada.step', String(state.perguntaIndex));
            showPergunta(state.perguntaIndex);
        } else if (state.blocoIndex > 0) {
            const prevBlocoIndex = state.blocoIndex - 1;
            const prevBlocoData = window.JORNADA_BLOCKS[prevBlocoIndex];
            state.blocoIndex = prevBlocoIndex;
            state.perguntaIndex = prevBlocoData.questions.length - 1;
            sessionStorage.setItem('jornada.block', String(state.blocoIndex));
            sessionStorage.setItem('jornada.step', String(state.perguntaIndex));
            showSection('sec-wizard');
            renderBlocoPerguntas(state.blocoIndex);
            setTimeout(() => showPergunta(state.perguntaIndex), 100);
        } else {
            showSection('sec-intro');
        }
    }

    function debounce(fn, ms) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), ms);
      };
    }
    function startJourney() {
      const senhaInput = document.getElementById('senha');
      if (!senhaInput) {
        UI.toast('Erro: Campo de senha não carregou.');
        return;
      }
      const senha = senhaInput.value.trim().toLowerCase();
      const senhasValidas = ['iniciar', 'olho magico', 'olho mágico'];
      if (senhasValidas.includes(senha)) {
        JSTATE.set('auth', 'ok');
        document.body.classList.add('jornada-active');
        showSection('sec-intro');
      } else {
        UI.toast('Senha incorreta. Tente novamente.');
        document.getElementById('authError').classList.remove('hidden');
      }
    }
    function playTransition(src, onEnd) {
      const overlay = document.getElementById('videoOverlay');
      const video = document.getElementById('videoTransicao');
      const skipBtn = document.getElementById('skipVideo');
      if (!overlay || !video || !src) {
        UI.toast('Vídeo não disponível. Continuando...');
        onEnd && onEnd();
        return;
      }
      video.src = src;
      overlay.classList.remove('hidden');
      const cleanup = () => {
        try { video.pause(); video.removeAttribute('src'); video.load(); } catch {}
        overlay.classList.add('hidden');
        onEnd && onEnd();
      };
      skipBtn.onclick = cleanup;
      video.onended = cleanup;
      video.onerror = () => { UI.toast('Erro ao carregar vídeo. Continuando...'); cleanup(); };
      video.muted = true;
      video.play().catch(() => {});
    }
    function finalize() {
      saveCurrentAnswer();
      const payload = { respostas: state.respostas, meta: { quando: new Date().toISOString() } };
      JORNADA_CORE.baixarArquivos(payload).then(blob => {
        if (blob) {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `Jornada-Essencial_${stamp()}.pdf`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
        }
        JSTATE.clearAll();
        sessionStorage.removeItem('jornada.step');
        sessionStorage.removeItem('jornada.block');
        UI.toast('Jornada concluída! Arquivo gerado localmente.');
        window.location.href = '/jornadas.html';
      }).catch(err => {
        UI.toast('Não foi possível gerar o PDF agora. Tente novamente.');
        console.error(err);
      });
    }
    function handleInput(textarea) {
      const score = analyzeSentiment(textarea.value);
      JORNADA_CHAMA.updateChama(score);
      saveAnswers();
      updateProgress();
    }
    function toggleSenha() {
      const input = document.getElementById('senha');
      if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
      }
    }
    function stamp() {
      const d = new Date(), p = n => String(n).padStart(2,'0');
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}-${p(d.getSeconds())}`;
    }
    // Inicialização
    window.JORNADA_RENDER = window.JORNADA_RENDER || {};
    JC.init = function initJornada() {
        const auth = JSTATE.get('auth', '');
        if (auth === 'ok') {
            document.body.classList.add('jornada-active');
            showSection('sec-wizard');
            renderBlocoPerguntas(state.blocoIndex);
            setTimeout(() => showPergunta(state.perguntaIndex), 100);
        } else {
            showSection('sec-auth');
        }

        // Adiciona event listeners
        document.getElementById('btnEntrar').addEventListener('click', debounce(startJourney, 300));
        const chkTermo = document.getElementById('chkTermo');
        const btnIniciar = document.getElementById('btnIniciar');
        if (chkTermo && btnIniciar) {
            chkTermo.addEventListener('change', () => { btnIniciar.disabled = !chkTermo.checked; });
        }
        if (btnIniciar) btnIniciar.addEventListener('click', () => {
            showSection('sec-wizard');
            renderBlocoPerguntas(0);
            state.blocoIndex = 0;
            state.perguntaIndex = 0;
            sessionStorage.setItem('jornada.block', '0');
            sessionStorage.setItem('jornada.step', '0');
        });
        document.getElementById('btnProxima').addEventListener('click', goNext);
        document.getElementById('btnVoltar').addEventListener('click', goPrev);
        document.getElementById('btnRevisar').addEventListener('click', () => {
            state.blocoIndex = 0; state.perguntaIndex = 0; showSection('sec-wizard'); renderBlocoPerguntas(0);
            setTimeout(() => showPergunta(0), 100);
        });
        document.getElementById('btnGerarPDFHQ').addEventListener('click', finalize);
        document.getElementById('btnNovaJornada').addEventListener('click', () => {
            JSTATE.clearAll(); window.location.href = '/jornadas.html';
        });
        document.querySelectorAll('.password-toggle').forEach(btn => btn.addEventListener('click', toggleSenha));
    };
    
    // ** CORREÇÃO CIRÚRGICA: Otimiza a inicialização para evitar o loop. **
    function boot() {
        if (window.JC && !window.JC._initialized) {
            window.JC.init();
            window.JC._initialized = true;
        }
    }
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', boot);
    } else {
      boot();
    }
</script>
