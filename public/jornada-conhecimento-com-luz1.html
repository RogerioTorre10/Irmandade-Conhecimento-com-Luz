<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png">

  <style>
    /* ===== BASE ===== */
    body { margin:0; font-family: Arial, sans-serif; background:#f9f9f9; color:#333; }
    .site-header { display:flex; align-items:center; gap:12px; padding:16px; background:#1f2937; color:#fff; box-shadow:0 2px 4px rgba(0,0,0,.1); position:relative; z-index:1000 }
    .container { max-width:900px; margin:24px auto; padding:0 16px }
    .card { background:#f6efe0!important; border-radius:14px; box-shadow:0 8px 28px rgba(0,0,0,.12); padding:32px; position:relative; z-index:10 }

    /* ===== PERGAMINHO ===== */
    .pergaminho-v { background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important; background-size:cover!important; background-position:center!important; min-height:82vh!important }
    .pergaminho-h { background-image:url('/assets/img/pergaminho-rasgado-horiz.png')!important; background-size:cover!important; background-position:center!important; min-height:82vh!important }
    .pergaminho-h.fallback { background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important }
    .conteudo-pergaminho { background:transparent!important; position:relative; z-index:20; padding:20px; min-height:100%; overflow:visible }

    /* ===== CHAMA VIVA (recipiente + chama livre) ===== */
    .chama-viva {
      --altura: 90px;          /* altura base da chama */
      --largura: 60px;         /* largura base */
      --pulso: 1.8s;           /* velocidade do pulso */
      --glow: 16px;            /* intensidade do brilho */
      --hue: 32;               /* matiz laranja (0=vermelho, 60=amarelo) */
      --satur: 95%;
      --light: 58%;
      --op: .95;

      position: relative;
      width: var(--largura);
      height: calc(var(--altura) + 26px); /* 26px do recipiente */
      display: inline-block;
      filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.65));
      z-index: 40; /* Garantir visibilidade */
    }

    /* Recipiente (vaso) */
    .chama-viva::after {
      content:"";
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * 1.25);
      height: 26px;
      background:
        radial-gradient(120% 100% at 50% 0%,
          rgba(0,0,0,.15) 0%,
          rgba(0,0,0,.25) 55%,
          rgba(0,0,0,.35) 100%);
      border-radius: 0 0 18px 18px;
      box-shadow:
        inset 0 6px 10px rgba(255,255,255,.12),
        inset 0 -6px 10px rgba(0,0,0,.35);
    }

    /* Brasa (base) */
    .chama-viva .brasa {
      position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
      width: calc(var(--largura) * .9);
      height: 16px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 40%,
          hsla(var(--hue),var(--satur),95%,.9) 0%,
          hsla(var(--hue),var(--satur),70%,.8) 35%,
          hsla(var(--hue),var(--satur),40%,.0) 70%);
      filter: blur(1.5px);
      animation: brasaPulse var(--pulso) infinite ease-in-out;
      opacity: var(--op);
    }

    /* Línguas da chama (3 camadas) */
    .chama-viva .lingua {
      position:absolute; left:50%; bottom:18px; transform:translateX(-50%);
      width: var(--largura);
      height: var(--altura);
      border-radius: 44% 44% 30% 30%; /* Base larga, topo fino */
      background:
        radial-gradient(60% 60% at 50% 28%,
          hsla(var(--hue),var(--satur),98%,1) 0%,
          hsla(var(--hue),var(--satur),70%,.95) 35%,
          hsla(calc(var(--hue) - 8),calc(var(--satur) - 15%),50%,.85) 65%,
          transparent 82%);
      mix-blend-mode: screen;
      filter: blur(0.6px);
      animation: lingua 1.2s infinite ease-in-out;
      transform-origin: 50% 100%;
      opacity: var(--op);
    }
    .chama-viva .lingua:nth-child(2) {
      width: calc(var(--largura) * .78);
      height: calc(var(--altura) * .88);
      animation-duration: 1.5s;
      animation-delay:.05s;
    }
    .chama-viva .lingua:nth-child(3) {
      width: calc(var(--largura) * .62);
      height: calc(var(--altura) * .76);
      animation-duration: 1.8s;
      animation-delay:.12s;
    }

    /* Brilho / aura */
    .chama-viva .brilho {
      position:absolute; left:50%; bottom:16px; transform:translateX(-50%);
      width: calc(var(--largura) * 1.3);
      height: calc(var(--altura) * 1.1);
      background: radial-gradient(circle,
        hsla(var(--hue),var(--satur),70%,.35) 0%,
        transparent 65%);
      filter: blur(12px);
      pointer-events:none;
      mix-blend-mode: screen;
      animation: aura var(--pulso) infinite ease-in-out;
      opacity: .6;
    }

    /* Pico breve quando intensidade = forte */
    .chama-viva.chama-pico .lingua {
      animation-timing-function: ease-out;
      transform: translateX(-50%) scaleY(1.1) skewX(1.6deg);
    }

    /* Animações */
    @keyframes lingua {
      0%,100% { transform: translateX(-50%) scaleY(1) skewX(0deg); }
      50% { transform: translateX(-50%) scaleY(1.06) skewX(1.2deg); }
    }
    @keyframes brasaPulse {
      0%,100% { transform:translateX(-50%) scale(1); opacity:.7; }
      50% { transform:translateX(-50%) scale(1.05); opacity:1; }
    }
    @keyframes aura {
      0%,100% { opacity:.5; }
      50% { opacity:.8; }
    }

    /* ===== Modos emocionais ===== */
    .chama-viva[data-intensidade="fraca"] {
      --altura: 70px; --largura: 52px; --pulso: 2.8s; --glow: 8px;
      --hue: 40; --satur: 80%; --light: 65%; --op: .65;
    }
    .chama-viva[data-intensidade="media"] {
      --altura: 90px; --largura: 60px; --pulso: 1.8s; --glow: 16px;
      --hue: 32; --satur: 95%; --light: 58%; --op: .95;
    }
    .chama-viva[data-intensidade="forte"] {
      --altura: 110px; --largura: 66px; --pulso: 1.1s; --glow: 26px;
      --hue: 20; --satur: 100%; --light: 52%; --op: 1;
    }

    /* Respeitar preferências do usuário */
    @media (prefers-reduced-motion: reduce) {
      .chama-viva .lingua, .chama-viva .brasa, .chama-viva .brilho {
        animation: none !important;
      }
    }

    /* ===== CHAMA FLAMEJANTE (antiga bola) ===== */
    #chama-bola {
      --altura: 80px;          /* altura base da chama */
      --largura: 40px;         /* largura reduzida pra base estreita */
      --pulso: 1.6s;           /* velocidade do pulso */
      --glow: 20px;            /* intensidade do brilho */
      --hue: 28;               /* matiz laranja */
      --satur: 90%;
      --light: 60%;
      --op: .9;

      position: relative;
      width: var(--largura);
      height: var(--altura);
      display: inline-block;
      filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.65));
      z-index: 40;
    }

    /* Recipiente (vaso) */
    #chama-bola::after {
      content:"";
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * 1.2);
      height: 20px;
      background:
        radial-gradient(120% 100% at 50% 0%,
          rgba(0,0,0,.15) 0%,
          rgba(0,0,0,.25) 55%,
          rgba(0,0,0,.35) 100%);
      border-radius: 0 0 12px 12px;
      box-shadow:
        inset 0 4px 8px rgba(255,255,255,.12),
        inset 0 -4px 8px rgba(0,0,0,.35);
    }

    /* Brasa (base) */
    #chama-bola .brasa {
      position:absolute; left:50%; bottom:15px; transform:translateX(-50%);
      width: calc(var(--largura) * .85);
      height: 12px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 40%,
          hsla(var(--hue),var(--satur),95%,.9) 0%,
          hsla(var(--hue),var(--satur),70%,.8) 35%,
          hsla(var(--hue),var(--satur),40%,.0) 70%);
      filter: blur(1px);
      animation: brasaPulse var(--pulso) infinite ease-in-out;
      opacity: var(--op);
    }

    /* Línguas da chama (3 camadas) */
    #chama-bola .lingua {
      position:absolute; left:50%; bottom:15px; transform:translateX(-50%);
      width: var(--largura);
      height: calc(var(--altura) * 0.8); /* Alongada pra efeito flamejante */
      border-radius: 40% 40% 20% 20%; /* Base estreita, topo mais fino */
      background:
        radial-gradient(60% 60% at 50% 30%,
          hsla(var(--hue),var(--satur),98%,1) 0%,
          hsla(var(--hue),var(--satur),70%,.95) 35%,
          hsla(calc(var(--hue) - 10),calc(var(--satur) - 20%),50%,.85) 65%,
          transparent 80%);
      mix-blend-mode: screen;
      filter: blur(0.5px);
      animation: linguaFlame 1.2s infinite ease-in-out;
      transform-origin: 50% 100%;
      opacity: var(--op);
    }
    #chama-bola .lingua:nth-child(2) {
      width: calc(var(--largura) * 0.75);
      height: calc(var(--altura) * 0.7);
      animation-duration: 1.5s;
      animation-delay: 0.05s;
    }
    #chama-bola .lingua:nth-child(3) {
      width: calc(var(--largura) * 0.6);
      height: calc(var(--altura) * 0.6);
      animation-duration: 1.8s;
      animation-delay: 0.1s;
    }

    /* Brilho / aura */
    #chama-bola .brilho {
      position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
      width: calc(var(--largura) * 1.4);
      height: calc(var(--altura) * 1.2);
      background: radial-gradient(circle,
        hsla(var(--hue),var(--satur),70%,.35) 0%,
        transparent 65%);
      filter: blur(10px);
      pointer-events:none;
      mix-blend-mode: screen;
      animation: auraFlame var(--pulso) infinite ease-in-out;
      opacity: 0.7;
    }

    /* Animações personalizadas pra chama flamejante */
    @keyframes linguaFlame {
      0%,100% { transform: translateX(-50%) scaleY(1) skewX(0deg); }
      50% { transform: translateX(-50%) scaleY(1.1) skewX(1.5deg); }
    }
    @keyframes brasaPulse {
      0%,100% { transform:translateX(-50%) scale(1); opacity:.7; }
      50% { transform:translateX(-50%) scale(1.05); opacity:1; }
    }
    @keyframes auraFlame {
      0%,100% { opacity:0.5; }
      50% { opacity:0.9; }
    }

    /* Intensidades emocionais pra chama */
    #chama-bola.fraca { --altura: 60px; --largura: 35px; --pulso: 2.5s; --glow: 10px; --hue: 40; --satur: 80%; --light: 65%; --op: 0.6; }
    #chama-bola.media { --altura: 80px; --largura: 40px; --pulso: 1.6s; --glow: 20px; --hue: 28; --satur: 90%; --light: 60%; --op: 0.9; }
    #chama-bola.forte { --altura: 100px; --largura: 45px; --pulso: 1.1s; --glow: 30px; --hue: 20; --satur: 100%; --light: 55%; --op: 1; }

    /* ===== GUIA ESPIRITUAL ===== */
    #guia-espiritual {
      position: fixed;
      right: 20px;
      bottom: 20px;
      z-index: 9999;
      pointer-events: none;
    }

    /* ===== UI ===== */
    .btn { display:inline-block; padding:12px 24px; border-radius:10px; border:0; background:#1f2937; color:#fff; font-weight:600; text-decoration:none; transition:background .3s ease, transform .2s ease; z-index:30 }
    .btn:hover { background:#374151; transform:scale(1.05) }
    .btn-primary { background:#6b21a8 }
    .btn-primary:hover { background:#7c3aed }
    .btn-secondary { background:#4b5563 }
    .btn-secondary:hover { background:#6b7280 }
    .btn + .btn { margin-left:12px }

    .progress-badge { position:fixed; top:16px; right:16px; padding:8px 16px; background:#6b21a8; color:#fff; border-radius:8px; font-size:.9rem; z-index:900; visibility:visible }
    .progress-bar { width:100%; height:8px; background:#e5e7eb; border-radius:4px; margin-top:12px; z-index:900; visibility:visible }
    .progress-bar-fill { height:100%; background:#6b21a8; border-radius:4px; transition:width .3s ease }
    .j-progress { margin-top:12px; z-index:900; visibility:visible }
    .j-progress__bar { width:100%; height:6px; background:#e5e7eb; border-radius:4px }
    .j-progress__fill { height:100%; background:#1f2937; border-radius:4px; transition:width .3s ease }
    .j-progress__meta { text-align:center; margin-top:8px; font-size:.9rem }

    .footer-actions { display:flex; gap:12px; justify-content:center; margin:16px 0; z-index:900 }

    .lumen-typing { white-space:pre-wrap; position:relative }
    .lumen-typing::after { content:"▌"; margin-left:2px; opacity:.75; animation:lumenBlink 1s steps(2,end) infinite }
    .lumen-typing.typing-done::after { content:""; animation:none }
    @keyframes lumenBlink { 50% { opacity:0 } }

    .j-section { height:100% }
    .j-bloco { background:transparent!important; display:none; z-index:50 }
    .j-pergunta { margin-bottom:24px; display:none; z-index:60; position:relative }
    .j-pergunta.active { display:block }
    .pergunta-enunciado { font-weight:600; margin-bottom:8px; display:block }
    .j-pergunta textarea { width:100%; padding:12px; border-radius:8px; border:1px solid #d1d5db; background:rgba(255,255,255,.8); resize:vertical; min-height:100px }

    #videoOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.8); display:flex; justify-content:center; align-items:center; z-index:2000 }
    #videoOverlay.hidden { display:none }
    .video-player { max-width:90vw; max-height:80vh; background:#000 }

    .site-footer { text-align:center; padding:16px; opacity:.6; font-size:.85rem; z-index:10 }
    .password-form { margin-top:20px; text-align:center }
    .password-input { position:relative }
    .password-input input { width:100%; padding:12px; border-radius:8px; border:1px solid #d1d5db }
    .password-toggle { position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer }

    .section-container { position:relative; min-height:85vh }
    .hidden { display:none!important }

    @media (max-width:600px) {
      .card { margin:16px; padding:20px }
      .site-header h1 { font-size:1.6rem }
      .btn { padding:10px 16px; font-size:.9rem }
      .chama.chama-md span { width:18px; height:44px }
      .chama.chama-lg span { width:28px; height:72px }
      .chama.chama-sm span { width:4px; height:8px }
      .progress-badge { top:8px; right:8px; padding:6px 12px; font-size:.8rem }
    }
    @media (max-width:400px) {
      .chama.chama-lg span { width:20px; height:50px }
      .btn { padding:8px 12px; font-size:.8rem }
      .card { padding:16px }
    }
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div class="chama chama-sm"><span></span><span></span><span></span></div>
    <h1>Jornada Essencial</h1>
  </header>

  <main id="page-shell" class="container">
    <div class="container">
      <a class="btn btn-primary" href="#intro">Ir para Introdução</a>
      <a class="btn btn-secondary" href="/jornadas.html">← Voltar</a>
    </div>

    <div class="section-container">
      <section id="jornada-canvas" class="card pergaminho pergaminho-v">
        <div id="jornada-conteudo" class="conteudo-pergaminho">
          <!-- INTRO -->
          <div id="section-intro" class="j-section">
            <div id="chama-intro" class="chama-viva chama-lg chama-strong chama-viva chama-fixed-hero">
              <div class="brasa"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="brilho"></div>
            </div>
            <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
            <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, ative sua senha." data-speed="50" data-cursor="true"></p>

            <div class="password-form">
              <h3>Ative sua Senha</h3>
              <div class="password-input">
                <input type="password" id="senha" placeholder="Digite sua senha...">
                <span class="password-toggle" data-action="toggle-password">👁️</span>
              </div>
              <button class="btn btn-primary" data-action="start">Ativar e Iniciar</button>
            </div>
          </div>

          <!-- PERGUNTAS -->
          <div id="section-perguntas" class="j-section hidden">
            <div id="chama-perguntas" class="chama-viva chama-md">
              <div class="brasa"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="brilho"></div>
            </div>
            <div id="perguntas-container"></div>
            <div class="footer-actions">
              <button id="btnPrevPerguntas" class="btn btn-secondary" data-action="prev">Voltar</button>
              <button id="btnNextPerguntas" class="btn btn-primary" data-action="next">Próxima</button>
            </div>
          </div>

          <!-- FINAL -->
          <div id="section-final" class="j-section hidden">
            <div id="chama-final" class="chama-viva chama-lg chama-strong chama-viva chama-fixed-hero">
              <div class="brasa"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="lingua"></div>
              <div class="brilho"></div>
            </div>
            <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
            <div class="footer-actions">
              <button id="btnRestart" class="btn btn-secondary" data-action="restart">Reiniciar</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer class="site-footer">
      <small>© 2025 Irmandade Conhecimento com Luz</small>
      <div id="envTag"></div>
    </footer>
  </main>

  <!-- PROGRESS -->
  <div class="progress-badge" id="jprog-pct">0% concluído</div>
  <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  <div class="j-progress">
    <div class="j-progress__bar"><div class="j-progress__fill"></div></div>
    <div class="j-progress__meta" id="j-meta"></div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="video-overlay hidden">
    <video id="videoTransicao" class="video-player" playsinline preload="metadata" controls></video>
    <button id="skipVideo" class="btn btn-secondary" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

 <!-- GUIA ESPIRITUAL: chama flamejante livre -->
<div id="guia-espiritual">
  <div id="chama-bola" class="chama-viva">
    <div class="brasa"></div>
    <div class="lingua"></div>
    <div class="lingua"></div>
    <div class="lingua"></div>
    <div class="brilho"></div>
  </div>
</div>

  <script>
    // Tag ambiente
    document.getElementById('envTag').textContent =
      `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/public`;

    /* =========================
       EMOÇÃO E DATILOGRAFIA
    ==========================*/
    const EMO = {
      POS: {'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperança':3,'paz':2,'fé':3,'gratidão':2,'vitória':3,'superação':3,'luz':2,'deus':3,'coragem':2,'força':2,'confiança':2,'propósito':3},
      NEG: {'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustração':-2,'decepcao':-2,'decepção':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solidão':-2,'desespero':-3,'cansaco':-2,'cansaço':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'dúvida':-2}
    };
    function analyzeSentiment(text) {
      let score = 0;
      const tokens = (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').split(/\s+/);
      for (const t of tokens) {
        if (EMO.POS[t] != null) score += EMO.POS[t];
        if (EMO.NEG[t] != null) score += EMO.NEG[t];
      }
      return score;
    }
    function typeWriter(el, text, speed, showCursor) {
      if (!el) return;
      el.textContent = '';
      if (showCursor) el.classList.add('lumen-typing');
      let i = 0;
      (function step() {
        if (i < text.length) {
          el.textContent += text.charAt(i++);
          setTimeout(step, speed);
        } else {
          el.classList.add('typing-done');
        }
      })();
    }
    function runTyping(root) {
      (root || document).querySelectorAll('[data-typing]').forEach(el => {
        if (el.dataset._typed) return;
        const t = el.getAttribute('data-text') || el.textContent || '';
        const spd = parseInt(el.getAttribute('data-speed') || '26', 10);
        const cur = String(el.getAttribute('data-cursor') || 'true') === 'true';
        el.dataset._typed = '1';
        typeWriter(el, t, spd, cur);
      });
    }

    /* =========================
       CHAMA (Integrado de jornada-chama.js)
    ==========================*/
    const JORNADA_CHAMA = {
      analyzeSentiment: analyzeSentiment,
      updateChama: function(scoreNum, targetId = 'chama-perguntas') {
        const el = document.getElementById(targetId);
        if (!el) {
          console.error('Elemento', targetId, 'não encontrado!');
          return;
        }
        el.classList.add('chama-viva');
        const modo = (scoreNum <= -2) ? 'fraca' : (scoreNum >= 2) ? 'forte' : 'media';
        el.setAttribute('data-intensidade', modo);
        if (modo === 'forte') {
          el.classList.add('chama-pico');
          clearTimeout(el._pulse_t);
          el._pulse_t = setTimeout(() => el.classList.remove('chama-pico'), 700);
        } else {
          el.classList.remove('chama-pico');
        }
        const bola = document.getElementById('chama-bola');
        if (bola) {
          bola.classList.remove('fraca', 'media', 'forte');
          bola.classList.add(modo);
          bola.setAttribute('data-intensidade', modo); // Sincronizar intensidade
        }
        console.log('Chama', targetId, 'atualizada para:', modo);
      },
      updateChamaFromText: function(text, targetId = 'chama-perguntas') {
      const score = analyzeSentiment(text);
      this.updateChama(score, targetId);
      return { score, intensidade: (score <= -2) ? 'fraca' : (score >= 2) ? 'forte' : 'media' };
      },
      setChamaIntensidade: function(target, modo) {
        const el = typeof target === 'string' ? document.getElementById(target) : target;
        if (!el) return;
        el.classList.add('chama-viva');
        el.setAttribute('data-intensidade', modo);
        if (!el.querySelector('.brasa')) {
          el.innerHTML = `
            <div class="brasa"></div>
            <div class="lingua"></div>
            <div class="lingua"></div>
            <div class="lingua"></div>
            <div class="brilho"></div>
          `;
        }
      },
      ensureHeroFlame: function(sectionId) {
        const introChama = document.getElementById('chama-intro');
        const finalChama = document.getElementById('chama-final');
        const perguntasChama = document.getElementById('chama-perguntas');
        if (introChama) introChama.style.visibility = (sectionId === 'section-intro') ? 'visible' : 'hidden';
        if (finalChama) finalChama.style.visibility = (sectionId === 'section-final') ? 'visible' : 'hidden';
        if (perguntasChama) perguntasChama.style.visibility = (sectionId === 'section-perguntas') ? 'visible' : 'hidden';
      },
      setChamaBola: function(intensidade, targetId = 'chama-bola') {
        const el = document.getElementById(targetId);
        if (el) {
          el.classList.remove('fraca', 'media', 'forte');
          el.classList.add(intensidade);
          el.setAttribute('data-intensidade', intensidade);
        }
      }
    };
    window.JORNADA_CHAMA = JORNADA_CHAMA;

    // micro-variação para cada chama
document.querySelectorAll('#chama-intro, #chama-perguntas, #chama-final, #chama-bola')
  .forEach(f => {
    // jitter horizontal sutil
    f.style.setProperty('--jitter', `${(Math.random() * 2 - 1).toFixed(2)}px`);
    // delays ligeiramente diferentes
    f.querySelectorAll('.lingua').forEach((n, i) => {
      n.style.animationDelay = `${i * 0.07 + Math.random() * 0.08}s`;
    });
  });


    /* =========================
       PROGRESSO & STORAGE
    ==========================*/
    function updateProgress() {
      const perguntas = document.querySelectorAll('.j-pergunta');
      const respondidas = Array.from(perguntas).filter(p => p.querySelector('textarea').value.trim() !== '').length;
      const progresso = (respondidas / (perguntas.length || 1)) * 100;
      const fill = document.getElementById('jprog-fill');
      const badge = document.getElementById('jprog-pct');
      const jFill = document.querySelector('.j-progress__fill');
      const jMeta = document.getElementById('j-meta');
      if (fill) fill.style.width = `${progresso}%`;
      if (badge) badge.textContent = `${Math.round(progresso)}% concluído`;
      if (jFill) jFill.style.width = `${progresso}%`;
      if (jMeta) jMeta.textContent = `Respondidas: ${respondidas} de ${perguntas.length}`;
      console.log('Progresso atualizado:', progresso);
    }
    function saveAnswers() {
      const respostas = {};
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => { respostas[`q${idx}`] = input.value || ''; });
      localStorage.setItem('jornada_respostas', JSON.stringify(respostas));
    }
    function loadAnswers(){
  try{
    const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
    document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{
      input.value = respostas[`q${idx}`] || '';
    });
  }catch(e){ console.warn('Falha ao carregar respostas:', e); }
  updateProgress();
}


    /* =========================
       ROTEAMENTO & RENDER
    ==========================*/
    function updateCanvasBackground(sectionId) {
      const canvas = document.getElementById('jornada-canvas');
      if (canvas) {
        if (sectionId === 'section-perguntas') {
          checkImage('/assets/img/pergaminho-rasgado-horiz.png', '/assets/img/pergaminho-rasgado-vert.png').then(bg => {
            canvas.className = `card pergaminho pergaminho-h${bg.includes('vert') ? ' fallback' : ''}`;
            canvas.style.backgroundImage = `url('${bg}')`;
          });
        } else {
          canvas.className = 'card pergaminho pergaminho-v';
          canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-vert.png)';
        }
      }
    }
    function showSection(sectionId) {
      document.querySelectorAll('.j-section').forEach(s => s.classList.add('hidden'));
      const active = document.getElementById(sectionId);
      if (active) active.classList.remove('hidden');
      updateCanvasBackground(sectionId);
      JORNADA_CHAMA.ensureHeroFlame(sectionId);
      if (sectionId === 'section-perguntas') {
        updateProgress();
        const perguntas = document.querySelectorAll('.j-pergunta');
        if (perguntas.length) {
          perguntas[0].classList.add('active');
          runTyping(perguntas[0]);
        } else {
          console.error('Nenhuma pergunta encontrada em section-perguntas!');
        }
      }
    }

    function loadDynamicBlocks() {
      const content = document.getElementById('perguntas-container');
      if (content && window.JORNADA_BLOCKS) {
        content.innerHTML = '';
        window.JORNADA_BLOCKS.forEach((block, idx) => {
          const bloco = document.createElement('section');
          bloco.className = 'j-bloco';
          bloco.dataset.bloco = idx;
          bloco.dataset.video = block.video_after || '';
          block.questions.forEach((q, qIdx) => {
            const pergunta = document.createElement('div');
            pergunta.className = 'j-pergunta';
            pergunta.dataset.pergunta = qIdx;
            pergunta.innerHTML = `
              <label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx + 1}:</b> ${q.label}" data-speed="40" data-cursor="true"></label>
              <textarea rows="4" class="input" placeholder="Digite sua resposta..." oninput="handleInput(this)"></textarea>
            `;
            bloco.appendChild(pergunta);
          });
          content.appendChild(bloco);
        });
        const firstBloco = content.querySelector('.j-bloco');
        if (firstBloco) {
          firstBloco.style.display = 'block';
          const firstPergunta = firstBloco.querySelector('.j-pergunta');
          if (firstPergunta) {
            firstPergunta.classList.add('active');
            runTyping(firstPergunta);
            const firstTa = firstPergunta.querySelector('textarea');
            if (firstTa) handleInput(firstTa);
          } else {
            console.error('Nenhuma primeira pergunta encontrada no primeiro bloco!');
          }
          loadAnswers();
        } else {
          console.error('Nenhum bloco encontrado após loadDynamicBlocks!');
        }
        console.log('Blocos carregados!');
      } else {
        console.error('Erro: #perguntas-container ou JORNADA_BLOCKS não encontrado!');
      }
    }

    function checkImage(url, fallbackUrl) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => resolve(fallbackUrl);
        img.src = url;
      });
    }

    /* =========================
       CONTROLES
    ==========================*/
    function handleInput(textarea) {
      const score = analyzeSentiment(textarea.value);
      JORNADA_CHAMA.updateChama(score);
      saveAnswers();
      updateProgress();
    }
    function toggleSenha() {
      const input = document.getElementById('senha');
      if (input) {
        input.type = input.type === 'password' ? 'text' : 'password';
        console.log('Toggle senha para:', input.type);
      } else {
        console.error('Campo senha não encontrado!');
      }
    }

    function goNext() {
      const perguntas = document.querySelectorAll('.j-pergunta');
      const current = document.querySelector('.j-pergunta.active');
      if (current) current.classList.remove('active');
      const nextIndex = Array.from(perguntas).indexOf(current) + 1;
      if (nextIndex < perguntas.length) {
        perguntas[nextIndex].classList.add('active');
        runTyping(perguntas[nextIndex]);
        updateProgress();
      } else {
        const blocos = document.querySelectorAll('.j-bloco');
        const currentBloco = current?.closest('.j-bloco');
        const nextBlocoIndex = Array.from(blocos).indexOf(currentBloco) + 1;
        if (nextBlocoIndex < blocos.length) {
          blocos.forEach(b => b.style.display = 'none');
          blocos[nextBlocoIndex].style.display = 'block';
          const nextPergunta = blocos[nextBlocoIndex].querySelector('.j-pergunta');
          if (nextPergunta) {
            nextPergunta.classList.add('active');
            runTyping(nextPergunta);
          } else {
            console.error('Nenhuma próxima pergunta encontrada no bloco seguinte!');
          }
          const videoSrc = blocos[nextBlocoIndex].dataset.video || '';
          if (videoSrc) playTransition(videoSrc, () => {});
        } else {
          showSection('section-final');
          updateProgress();
        }
      }
    }
  function goNext(){
  const perguntas = document.querySelectorAll('.j-pergunta');
  const current   = document.querySelector('.j-pergunta.active');

  if (current) current.classList.remove('active');
  const idxAtual = Array.from(perguntas).indexOf(current);
  const idxProx  = idxAtual + 1;

  // próxima pergunta no MESMO bloco?
  if (idxProx < perguntas.length) {
    const prox = perguntas[idxProx];
    const blocoAtual = current ? current.closest('.j-bloco') : null;
    const blocoProx  = prox.closest('.j-bloco');
    if (blocoAtual && blocoProx === blocoAtual) {
      prox.classList.add('active');
      runTyping(prox);
      updateProgress();
      return;
    }
  }

  // encerrou o bloco atual → toca vídeo do bloco que terminou
  const blocos = document.querySelectorAll('.j-bloco');
  const blocoAtual = current ? current.closest('.j-bloco') : null;
  const idxBlocoAtual = blocoAtual ? Array.from(blocos).indexOf(blocoAtual) : -1;
  const idxBlocoProx  = idxBlocoAtual + 1;

  const abrirProximo = () => {
    if (idxBlocoProx < blocos.length) {
      blocos.forEach(b => b.style.display = 'none');
      const bProx = blocos[idxBlocoProx];
      bProx.style.display = 'block';
      const p0 = bProx.querySelector('.j-pergunta');
      if (p0){ p0.classList.add('active'); runTyping(p0); }
      updateProgress();
    } else {
      showSection('section-final');
      updateProgress();
    }
  };

  if (idxBlocoAtual >= 0) {
    const videoSrc = blocos[idxBlocoAtual].dataset.video || '';
    if (videoSrc){ playTransition(videoSrc, abrirProximo); return; }
  }
  abrirProximo();
}

    function playTransition(src, onEnd) {
      const overlay = document.getElementById('videoOverlay');
      const video = document.getElementById('videoTransicao');
      const skip = document.getElementById('skipVideo');
      if (overlay && video && src) {
        video.src = src;
        overlay.classList.remove('hidden');
        video.controls = true;
        const cleanup = () => {
          video.pause();
          overlay.classList.add('hidden');
          video.removeAttribute('src');
          video.load();
          onEnd && onEnd();
        };
        video.onended = cleanup;
        video.onerror = () => {
          console.warn('Vídeo não carregou:', src);
          alert('Erro ao carregar vídeo de transição. Verifique o caminho ou conexão.');
          cleanup();
        };
        if (skip) skip.onclick = cleanup;
        video.play().catch(err => {
          console.warn('Erro ao reproduzir vídeo:', err);
          alert('O vídeo não pode ser reproduzido automaticamente. Clique em "Play" nos controles.');
          cleanup();
        });
        setTimeout(cleanup, 10000);
      } else {
        console.warn('Vídeo ou overlay não encontrado para:', src);
        onEnd && onEnd();
      }
    }

    function finalize() {
      const respostas = {};
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => { respostas[`q${idx}`] = input.value || ''; });
      console.log('[JORNADA] Finalizado. Respostas:', respostas);
      alert('Jornada concluída!');
      localStorage.removeItem('jornada_respostas');
      setTimeout(() => window.location.href = '/index.html', 1000);
    }

    function startJourney() {
      const senhaInput = document.getElementById('senha');
      if (!senhaInput) {
        console.error('Campo senha não encontrado!');
        alert('Erro: Campo de senha não carregou. Recarregue a página.');
        return;
      }
      const senha = senhaInput.value || '';
      const senhasValidas = ['iniciar', 'olho magico', 'olho mágico'];
      if (senhasValidas.includes(senha.toLowerCase())) {
        showSection('section-perguntas');
        loadDynamicBlocks();
        const perguntas = document.querySelectorAll('.j-pergunta');
        if (perguntas.length) {
          perguntas[0].classList.add('active');
          runTyping(perguntas[0]);
          const firstTa = perguntas[0].querySelector('textarea');
          if (firstTa) handleInput(firstTa);
        } else {
          console.error('Nenhuma pergunta encontrada após loadDynamicBlocks!');
        }
        document.querySelector('.progress-badge')?.classList.remove('hidden');
        document.querySelector('.progress-bar')?.classList.remove('hidden');
        document.querySelector('.j-progress')?.classList.remove('hidden');
        document.querySelector('.footer-actions')?.classList.remove('hidden');
        updateProgress();
        console.log('Jornada iniciada com sucesso!');
      } else {
        alert('Senha incorreta. Tente novamente.');
      }
    }

    function initJornada() {
      const prevBtn = document.getElementById('btnPrevPerguntas');
      const nextBtn = document.getElementById('btnNextPerguntas');
      const restartBtn = document.getElementById('btnRestart');
      if (nextBtn) nextBtn.addEventListener('click', goNext);
      if (prevBtn) prevBtn.addEventListener('click', goPrev);
      if (restartBtn) restartBtn.addEventListener('click', () => location.reload());

      // Delegação de cliques
      document.addEventListener('click', (ev) => {
        const n = ev.target.closest('[data-action="next"]');
        const p = ev.target.closest('[data-action="prev"]');
        const s = ev.target.closest('[data-action="start"]');
        const tp = ev.target.closest('[data-action="toggle-password"], .password-toggle');
        if (n) { ev.preventDefault(); goNext(); }
        if (p) { ev.preventDefault(); goPrev(); }
        if (s) { ev.preventDefault(); startJourney(); }
        if (tp) { ev.preventDefault(); toggleSenha(); }
      });

      console.log('Controlador da jornada inicializado!');
    }

    (function defineFallback() {
      window.JORNADA_BLOCKS = [
        { questions: [{ label: 'Qual é o seu maior sonho?' }, { label: 'O que te inspira no dia a dia?' }], video_after: '/assets/video/transicao1.mp4' },
        { questions: [{ label: 'Como você enfrenta desafios?' }, { label: 'Qual é sua maior conquista?' }], video_after: '/assets/video/transicao2.mp4' }
      ];
      window.JORNADA_QA = { positiveWords: Object.keys(EMO.POS), negativeWords: Object.keys(EMO.NEG) };
      console.log('JORNADA_BLOCKS/QA (fallback) definidos!');
    })();

    async function boot() {
      document.body.classList.add('jornada-active');
      const route = (location.hash || '#intro').slice(1);
      const canvas = document.getElementById('jornada-canvas');
      const progressBadge = document.querySelector('.progress-badge');
      const progressBar = document.querySelector('.progress-bar');
      const jProgress = document.querySelector('.j-progress');
      const footerActions = document.querySelector('.footer-actions');

      if (canvas) {
        if (route === 'perguntas') {
          showSection('section-perguntas');
          loadDynamicBlocks();
          [progressBadge, progressBar, jProgress, footerActions].forEach(el => el?.classList.remove('hidden'));
        } else if (route === 'final') {
          showSection('section-final');
          [progressBadge, progressBar, jProgress].forEach(el => el?.classList.remove('hidden'));
        } else {
          showSection('section-intro');
        }
      }
      runTyping(document);
      return true;
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
  // listeners explícitos
  const btnStart = document.querySelector('[data-action="start"]');
  if (btnStart) btnStart.addEventListener('click', e => { e.preventDefault(); startJourney(); });

  // inicialização padrão
  runTyping(document);
  initJornada();

  boot().then(() => {
    const visible = document.querySelector('.j-section:not(.hidden)');
    if (visible && window.JORNADA_CHAMA) window.JORNADA_CHAMA.ensureHeroFlame(visible.id);
  });

  // observar mudanças de conteúdo
  const target = document.getElementById('jornada-conteudo');
  if (target) {
    const obs = new MutationObserver(muts => {
      muts.forEach(m => {
        runTyping(m.target);
        if (m.target.id === 'perguntas-container') updateProgress();
      });
    });
    obs.observe(target, { childList: true, subtree: true });
  }

  // intensidade default da chama-bola (se faltar)
  const bola = document.getElementById('chama-bola');
  if (bola && !bola.hasAttribute('data-intensidade')) {
    bola.setAttribute('data-intensidade','media');
  }

  // micro-jitter (flamejar orgânico)
  document.querySelectorAll('#chama-intro, #chama-perguntas, #chama-final, #chama-bola').forEach(f=>{
    f.style.setProperty('--jitter', `${(Math.random()*2-1).toFixed(2)}px`);
    f.querySelectorAll('.lingua').forEach((n,i)=>{
      n.style.animationDelay = `${i*0.07 + Math.random()*0.08}s`;
    });
  });
});

    // BRIDGE GLOBAL para scripts externos
    window.JC = window.JC || {};
    window.toggleSenha = toggleSenha;
    window.startJourney = startJourney;
    window.showSection = showSection;
    window.JC.toggleSenha = toggleSenha;
    window.JC.startJourney = startJourney;
    window.JC.showSection = showSection;
  </script>

  <!-- Referências externas desativadas temporariamente -->
  <!-- <script defer src="/config.js" onerror="console.error('Falha ao carregar config.js, usando fallback inline');"></script>
  <script defer src="/jornada-utils.js" onerror="console.error('Falha ao carregar jornada-utils.js, usando fallback inline');"></script>
  <script defer src="/jornada-core.js" onerror="console.error('Falha ao carregar jornada-core.js, usando fallback inline');"></script>
  <script defer src="/jornada-auth.js" onerror="console.error('Falha ao carregar jornada-auth.js, usando fallback inline');"></script>
  <script defer src="/jornada-chama.js" onerror="console.error('Falha ao carregar jornada-chama.js, usando fallback inline');"></script>
  <script defer src="/jornada-paper-qa.js" onerror="console.error('Falha ao carregar jornada-paper-qa.js, usando fallback inline');"></script>
  <script defer src="/jornada-typing.js" onerror="console.error('Falha ao carregar jornada-typing.js, usando fallback inline');"></script>
  <script defer src="/jornada-controller.js" onerror="console.error('Falha ao carregar jornada-controller.js, usando fallback inline');"></script>
  <script defer src="/jornada-render.js" onerror="console.error('Falha ao carregar jornada-render.js, usando fallback inline');"></script>
  <script defer src="/jornada-bootstrap.js" onerror="console.error('Falha ao carregar jornada-bootstrap.js, usando fallback inline');"></script>
  <script defer src="/jornada-micro.js" onerror="console.error('Falha ao carregar jornada-micro.js, usando fallback inline');"></script>
  <script defer src="/i18n/i18n.js" onerror="console.error('Falha ao carregar i18n.js, usando fallback inline');"></script>
  <script defer src="/api.js" onerror="console.error('Falha ao carregar api.js, usando fallback inline');"></script> -->
</body>
</html>
