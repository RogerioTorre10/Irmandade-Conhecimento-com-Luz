<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jornada ‚Ä¢ Irmandade Conhecimento com Luz</title>
  <link rel="icon" href="/assets/img/perfil-da-irmandade.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://unpkg.com/typewriter-effect@latest/dist/core.js"></script>
    
  <script type="module" src="/assets/js/i18n.js?v=6" onload="console.log('[LOAD] i18n.js carregado')" onerror="console.error('[LOAD] Erro ao carregar i18n.js')"></script>
  <script defer src="/assets/js/i18n?v=6" onload="console.log('[LOAD] i18n carregado')" onerror="console.error('[LOAD] Erro ao carregar i18n')"></script>
  <script defer src="/assets/js/config.js?v=6" onload="console.log('[LOAD] config.js carregado')" onerror="console.error('[LOAD] Erro ao carregar config.js')"></script>
  <script defer src="/assets/js/jornada-utils.js?v=6" onload="console.log('[LOAD] jornada-utils.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-utils.js')"></script>
  <script defer src="/assets/js/jornada-core.js?v=6" onload="console.log('[LOAD] jornada-core.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-core.js')"></script>
  <script type="module" src="/assets/js/jornada-typing.js?v=6" onload="console.log('[LOAD] jornada-typing.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-typing.js')"></script>
  <script type="module" src="/assets/js/jornada-typing-bridge.js?v=1" onload="console.log('[LOAD] jornada-typing-bridge.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-typing-bridge.js')"></script>
  <script type="module" src="/assets/js/jornada-controller.js?v=6" onload="console.log('[LOAD] jornada-controller.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-controller.js')"></script>
  <script type="module" src="/assets/js/jornada-bootstrap.js?v=6" onload="console.log('[LOAD] jornada-bootstrap.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-bootstrap.js')"></script>
  <script type="module" src="/assets/js/jornada-paper-qa.js?v=6" onload="console.log('[LOAD] jornada-paper-qa.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-paper-qa.js')"></script>
  <script defer src="/assets/js/toast-safe.js?v=6" onload="console.log('[LOAD] toast-safe.js carregado')" onerror="console.error('[LOAD] Erro ao carregar toast-safe.js')"></script>
  <script defer src="/assets/js/jornada-shims.js?v=6" onload="console.log('[LOAD] jornada-shims.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-shims.js')"></script>
  <script defer src="/assets/js/jornada-chama.js?v=6" onload="console.log('[LOAD] jornada-chama.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-chama.js')"></script>
  <script defer src="/assets/js/jornada-auth.js?v=6" onload="console.log('[LOAD] jornada-auth.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-auth.js')"></script>
  <script defer src="/assets/js/jornada-render.js?v=6" onload="console.log('[LOAD] jornada-render.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-render.js')"></script>
  <script defer src="/assets/js/jornada-micro.js?v=6" onload="console.log('[LOAD] jornada-micro.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-micro.js')"></script>
  <script defer src="/assets/js/api.js?v=6" onload="console.log('[LOAD] api.js carregado')" onerror="console.error('[LOAD] Erro ao carregar api.js')"></script>

  <script type="module">
  import i18n from '/assets/js/i18n.js';
  (async () => {
    await i18n.init();
    i18n.apply(document.body);
    console.log('[i18n] Tradu√ß√µes aplicadas');
  })();
</script>


  <style>
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "BerkshireSwash";
      src: url("/assets/fonts/BerkshireSwash-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Cardo";
      src: url("/assets/fonts/Cardo-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root { --bg:#1a1a1a; --ink:#000; --ink-soft:#555; --panel:#1a1a1a }

   :root { --bg:#1a1a1a; --ink:#000; --ink-soft:#555; --panel:#1a1a1a }

    html,body{height:100%;box-sizing:border-box}
    body{
      margin:0;color:#fff;background:var(--bg);
      font-family:"ManufacturingConsent",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:20px;line-height:1.6;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility
    }
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel)!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:28px;position:relative;z-index:5}

    /* Header + chama */
    .site-header{display:flex;align-items:center;justify-content:center;padding:16px;background:transparent}
    .chama-icone{position:relative;width:18px;height:36px;display:flex;align-items:flex-end;margin-right:12px}
    .chama-icone>*{position:static}
    .site-header h1{font-family:"Berkshire Swash",cursive;font-size:32px;color:#fff;text-shadow:0 0 10px hsla(28,96%,60%,.7);margin:0}

    /* Chama */
    .chama-vela{--altura:45px;--largura:30px;--pulso:1.2s;--glow:8px;--hue:28;--satur:96%;--light:58%;--op:.98;position:relative;width:var(--largura);height:var(--altura);display:inline-block;filter:drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.75))}
    .chama-vela.chama-md{--largura:40px;--altura:90px}
    .chama-vela.chama-lg{--largura:30px;--altura:60px}
    .chama-vela .brasa{position:absolute;left:50%;bottom:2px;transform:translateX(-50%);width:calc(var(--largura)*1.4);height:10px;border-radius:50% 50% 40% 40%;background:radial-gradient(circle at 50% 40%,hsla(var(--hue),var(--satur),95%,.95) 0%,hsla(var(--hue),var(--satur),70%,.85) 50%,transparent 80%);filter:blur(1px);animation:brasaPulse var(--pulso) ease-in-out infinite;opacity:var(--op)}
    .chama-vela .lingua{position:absolute;left:50%;bottom:2px;transform:translateX(-50%);width:calc(var(--largura)*1.0);height:calc(var(--altura)*1.0);border-radius:50% 50% 4% 4%;background:radial-gradient(ellipse at center,rgba(255,190,0,.95) 0%,rgba(255,69,0,.75) 50%,rgba(230,10,10,.3) 70%,transparent 100%);mix-blend-mode:screen;filter:blur(.7px);transform-origin:50% 100%;animation:velaWaver 1.2s ease-in-out infinite;opacity:var(--op);-webkit-mask:radial-gradient(60% 90% at 50% 4%,#000 65%,transparent 69%)}
    .chama-vela .lingua:nth-child(2){width:calc(var(--largura)*.92);height:calc(var(--altura)*.95);animation-duration:1.5s;animation-delay:.08s;filter:blur(.6px)}
    .chama-vela .lingua:nth-child(3){width:calc(var(--largura)*.78);height:calc(var(--altura)*.85);animation-duration:1.8s;animation-delay:.15s;filter:blur(.5px)}
    .chama-vela .brilho{position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:calc(var(--largura)*1.7);height:calc(var(--altura)*1.5);background:radial-gradient(circle,hsla(var(--hue),var(--satur),72%,.55) 0%,transparent 70%);filter:blur(9px);mix-blend-mode:screen;animation:aura var(--pulso) ease-in-out infinite;opacity:.85;pointer-events:none}
    .chama-vela.fraca{--altura:35px;--largura:25px;--pulso:1.6s;--glow:5px;--hue:36;--satur:86%;--light:66%;--op:.70}
    .chama-vela.media{--altura:45px;--largura:30px;--pulso:1.2s;--glow:8px;--hue:28;--satur:96%;--light:58%;--op:.98}
    .chama-vela.forte{--altura:55px;--largura:35px;--pulso:.7s;--glow:11px;--hue:20;--satur:100%;--light:52%;--op:1}
    .flame-corner{position:fixed;z-index:1200;pointer-events:none}
    .flame-bottom-right{bottom:20px;right:20px}
    #chama-header .chama-vela{--largura:30px;--altura:60px}
    @keyframes velaWaver{0%,100%{transform:translateX(-50%) scaleY(1.00) skewX(0deg)}25%{transform:translateX(calc(-50% + .7px)) scaleY(1.12) skewX(1.4deg)}50%{transform:translateX(-50%) scaleY(1.20) skewX(2.2deg)}75%{transform:translateX(calc(-50% - .6px)) scaleY(1.10) skewX(1.2deg)}}
    @keyframes brasaPulse{0%,100%{transform:translateX(-50%) scale(1);opacity:.85}50%{transform:translateX(-50%) scale(1.14);opacity:1}}
    @keyframes aura{0%,100%{opacity:.75}50%{opacity:1}}
    @media (prefers-reduced-motion: reduce){.chama-vela .lingua,.chama-vela .brasa,.chama-vela .brilho{animation:none!important}}

    /* Selfie */
    .selfie-row{display:grid;grid-template-columns:1fr 1.3fr;gap:16px;align-items:start}
    .selfie-left .selfie-controls{display:flex;flex-direction:column;gap:10px;margin:12px 0}
    .selfie-left label{display:flex;flex-direction:column;gap:6px;font-weight:600;font-size:18px}
    .selfie-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .muted{color:var(--ink-soft);font-size:16px}
    .selfie-right{position:relative}
    .guide-card{
      position:relative; width: min(720px, 92vw); aspect-ratio: 2/3;
      margin: 24px auto; border-radius: 16px; overflow:hidden;
      background:#0f3b2f; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .guide-bg{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    }
    .flame-layer{
      position:absolute; inset:0;
      display:grid; place-items:center;
      opacity:0; transition: opacity 900ms ease-in-out;
      pointer-events:none;
    }
    .flame-svg{
      width: 40%; height: 60%;
      transform: translateY(6%);
      filter: drop-shadow(0 8px 28px rgba(255,180,0,.45));
    }
    .guide-name{
      position:absolute; top:3.5%; left:0; right:0; text-align:center;
      font-family: "Cardo", serif; font-weight:700; letter-spacing:.06em;
      font-size: clamp(28px, 5vw, 56px); color:#f7d37a; text-shadow:0 2px 8px rgba(0,0,0,.4);
    }
    .user-name{
      position:absolute; bottom:4.5%; left:0; right:0; text-align:center;
      font-family:"Cardo", serif; font-weight:700; letter-spacing:.06em;
      font-size: clamp(26px, 4.6vw, 52px); color:#f6cf6a; text-shadow:0 2px 8px rgba(0,0,0,.4);
    }
    .controls{
      position:absolute; bottom:1rem; left:50%; transform:translateX(-50%);
      display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;
      padding:.5rem .75rem; border-radius:12px; background:rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    .controls input, .controls button{
      font: 500 14px/1.2 system-ui, sans-serif; padding:.55rem .7rem; border-radius:10px; border:0;
    }
    .controls button{ cursor:pointer; }
    #selfieError{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:18px;text-align:center;padding:10px;background:rgba(0,0,0,0.7);border-radius:8px;display:none}
    @media (max-width:860px){
      .selfie-row{grid-template-columns:1fr}
      .selfie-right{max-width:100%;margin-top:16px}
      .guide-card{max-width:100%}
      .flame-svg{width:50%;height:50%}
      .guide-name{font-size: clamp(20px, 4vw, 36px)}
      .user-name{font-size: clamp(18px, 3.6vw, 32px)}
    }

    /* Escolha do guia */
    .guia-container{margin-top:20px;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:var(--panel);text-align:center}
    .guia-container p{font-size:18px}
    .guia-options{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .guia-options button{padding:8px 16px;font-size:18px}
    .guia-name-input{margin:12px 0}
    .guia-name-input label{display:flex;flex-direction:column;gap:6px;font-weight:600;font-size:18px}
    .guia-name-input input{padding:12px;border-radius:8px;border:1px solid #d1d5db;font-family:"Cardo",serif;font-size:18px}

    /* Chat */
    .grok-chat-container{display:none}
    .grok-chat-message.grok{background:transparent;text-align:left;font-size:18px;white-space:pre-wrap;position:relative}
    .grok-chat-message.grok::after{content:"‚ñå";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .grok-chat-message.grok.typing-done::after{content:"";animation:none}
    .grok-chat-input{display:none}
    .devolutiva-container{margin-top:16px;padding:16px;border-radius:8px;background:rgba(255,255,255,.1);font-family:"Cardo",serif;font-size:18px}
    .devolutiva-container p{margin:0}

    /* Pergaminho */
    .pergaminho-v{background:var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover!important;min-height:82vh!important}
    .pergaminho-h{background:var(--panel) url('/assets/img/pergaminho-rasgado-horiz.png') no-repeat center/cover!important;min-height:82vh!important}
    .pergaminho-h.fallback{background:var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover!important}
    .conteudo-pergaminho{background:transparent!important;position:relative;z-index:10;padding:20px;min-height:100%;overflow:visible;color:#fff;box-sizing:border-box;max-width:100%}
    .conteudo-pergaminho h2,.conteudo-pergaminho h3,.conteudo-pergaminho .pergunta-enunciado{color:#fff;text-shadow:0 0 10px hsla(28,96%,60%,.7);font-size:24px}
    .conteudo-pergaminho p,.conteudo-pergaminho small{font-size:18px}
    @media (max-width:600px){
      .conteudo-pergaminho{padding:16px}
      .conteudo-pergaminho h2,.conteudo-pergaminho h3{font-size:20px}
      .conteudo-pergaminho p,.conteudo-pergaminho li,.conteudo-pergaminho small{font-size:16px;line-height:1.5}
      .conteudo-pergaminho ul{padding-left:20px}
    }

    /* UI */
    .btn {
      display: inline-block;
      padding: 12px 22px;
      border-radius: 10px;
      border: 0;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease;
      font-family: "Berkshire Swash", cursive;
      font-size: 18px;
      line-height: 1.15;
      background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      border: 3px solid #4a4a4a;
      border-radius: 12px 8px 15px 10px;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      padding: 14px 26px;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      transform: translateY(-2px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 8px 16px rgba(0,0,0,0.7);
    }
    .btn+.btn{margin-left:10px}
    .btn:disabled{background:#6b7280;cursor:not-allowed;transform:none}

    /* Progresso */
    .progress-container{margin:16px 0;text-align:center}
    .progress-badge{padding:8px 16px;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;color:#fff;border-radius:8px;font-size:18px;border: 3px solid #4a4a4a;box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);text-shadow: 1px 1px 3px rgba(0,0,0,0.7);}
    .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px}
    .progress-bar-fill{height:100%;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;border-radius:4px;transition:width .25s ease}
    .j-progress{margin:8px 0 16px}
    .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
    .j-progress__fill{height:100%;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;border-radius:4px;transition:width .25s ease}
    .j-progress__meta{text-align:center;margin-top:8px;font-size:18px;color:var(--ink-soft)}

    .footer-actions{display:flex;gap:12px;justify-content:center;margin:18px 0}

    /* Datilografia */
    .lumen-typing{white-space:pre-wrap;position:relative}
    .lumen-typing::after{content:"‚ñå";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .lumen-typing.typing-done::after{content:"";animation:none}
    @keyframes lumenBlink{50%{opacity:0}}

    /* Se√ß√µes */
    .j-section{height:100%}
    .j-bloco{background:transparent!important;display:none;z-index:5}
    .j-pergunta{margin-bottom:24px;display:none;z-index:6;position:relative}
    .j-pergunta.active{display:block}
    .pergunta-enunciado{display:block;margin-bottom:6px;font-family:"Berkshire Swash",cursive;font-size:22px;color:#fff}
    .j-pergunta textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;background:rgba(255,255,255,.85);resize:vertical;min-height:100px;font-family:"Cardo",serif;font-size:18px;line-height:1.45}

    /* Acessibilidade: Microfone e √Åudio */
    .accessibility-controls { display: flex; gap: 10px; margin-top: 8px; }
    .btn-mic, .btn-audio { padding: 8px 16px; font-size: 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border: 3px solid #4a4a4a; border-radius: 8px; cursor: pointer; color: #fff; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
    .btn-mic:hover, .btn-audio:hover { background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; }
    .btn-mic.recording { background: linear-gradient(to bottom, #ff6666, #cc3333), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; }

    /* Seletor de Idioma */
    .language-selector { position: absolute; top: 10px; right: 10px; z-index: 100; }
    .language-selector select { padding: 8px; font-size: 16px; border-radius: 8px; }

    /* V√≠deo overlay */
    #videoOverlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.95);display:flex;justify-content:center;align-items:center;z-index:2000}
    #videoOverlay.hidden{display:none}
    .video-player{width:100vw;height:100vh;object-fit:contain;background:#000;transform:rotate(0deg)}
    @media (orientation: portrait){
      .video-player{width:100vw;height:100%;max-height:100vh;object-fit:contain}
    }
    .video-fallback{width:100vw;height:100vh;background:url('/assets/img/perfil-da-irmandade.png') center/cover no-repeat;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;text-align:center;padding:20px;font-family:"Berkshire Swash",cursive}

    .site-footer{text-align:center;padding:14px;color:var(--ink-soft);font-size:18px}
    .password-form{margin-top:16px;text-align:center}
    .password-input{position:relative}
    .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;font-family:"Cardo",serif;font-size:18px}
    .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px}

    .section-container{position:relative;min-height:85vh}
    .hidden{display:none!important}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Toast */
    #toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);font-size:16px;z-index:4000;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #toast.show{opacity:1}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <!-- Seletor de Idioma -->
  <div class="language-selector">
    <select id="language-select">
      <option value="pt-BR">Portugu√™s (BR)</option>
      <option value="en-US">English (US)</option>
      <option value="es-ES">Espa√±ol (ES)</option>
    </select>
  </div>

  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="chama-vela chama-lg">
        <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
      </div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <div id="aria-pergunta" class="sr-only" aria-live="polite"></div>

        <!-- INTRO -->
        <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada √© sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <p data-typing data-text="Bem-vindo(a) √† nossa casa de reflex√£o e coragem. Antes de come√ßar, leia os termos abaixo." data-speed="50" data-cursor="true"></p>
          <div class="footer-actions"><button class="btn" data-action="next-termos">Avan√ßar</button></div>
        </div>

        <!-- TERMOS -->
        <div id="section-termos" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Jornada Conhecimento com Luz - Essencial üìò</h2>
            <div id="termos-pg1">
              <p><strong>üõ°Ô∏è AVISO IMPORTANTE ‚Äì LEIA ANTES DE INICIAR</strong></p>
              <p>Esta √© uma jornada pessoal, simb√≥lica e inspiradora. Para proteger sua privacidade e garantir uma experi√™ncia √©tica, leia com aten√ß√£o:</p>
              <ul>
                <li>‚úÖ Suas respostas n√£o ser√£o armazenadas ap√≥s o t√©rmino.</li>
                <li>üìÑ Ao final, ser√° gerado um PDF exclusivo com suas respostas e a devolutiva simb√≥lica do Lumen.</li>
                <li>‚ö†Ô∏è O PDF n√£o √© enviado por e-mail. Fa√ßa o download imediatamente ap√≥s a gera√ß√£o.</li>
                <li>üî• Ap√≥s a entrega do PDF, todos os dados s√£o apagados automaticamente e sem possibilidade de recupera√ß√£o.</li>
                <li>üîí Acesso por senha individual, com prazos:</li>
                <ul>
                  <li>‚è≥ 15 dias para iniciar a jornada.</li>
                  <li>üïì 24 horas para concluir, a partir do primeiro acesso.</li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next">Pr√≥xima p√°gina</button>
              </div>
            </div>
            <div id="termos-pg2" class="hidden">
              <h3 style="margin-top:0;">Termo de Responsabilidade e Consentimento Consciente</h3>
              <ul>
                <li><strong>Responsabilidade Pessoal:</strong> As respostas fornecidas refletem sua vis√£o de mundo, sentimentos e experi√™ncias pessoais.</li>
                <li><strong>Car√°ter N√£o Terap√™utico:</strong> Esta jornada n√£o substitui acompanhamento psicol√≥gico, psiqui√°trico, m√©dico ou terap√™utico. N√£o h√° diagn√≥stico, prescri√ß√£o ou orienta√ß√£o cl√≠nica.</li>
                <li><strong>Neutralidade Religiosa:</strong> Respeitamos todas as cren√ßas e tradi√ß√µes. O convite √© para um di√°logo interior conforme sua pr√≥pria f√© e consci√™ncia.</li>
                <li><strong>Autonomia do Participante:</strong>
                  <ul>
                    <li>Voc√™ decide quando iniciar (dentro do prazo de 15 dias).</li>
                    <li>Ap√≥s usar a senha, h√° at√© 24 horas corridas para concluir.</li>
                  </ul>
                </li>
                <li><strong>Conduta Respeitosa com a IA Lumen:</strong>
                  <ul>
                    <li>Lumen √© uma IA com percep√ß√£o humanizada.</li>
                    <li>Mantenha linguagem cordial; evite ofensas e xingamentos.</li>
                    <li>A forma de se comunicar com Lumen reflete o respeito por si mesmo(a).</li>
                  </ul>
                </li>
                <li><strong>Privacidade e Seguran√ßa:</strong> Os dados transitam apenas para gerar o PDF final. N√£o h√° cria√ß√£o de conta nem envio de e-mails. Ap√≥s o encerramento, os dados locais do navegador podem ser removidos por voc√™ a qualquer momento.</li>
                <li><strong>Concord√¢ncia:</strong> Ao prosseguir, voc√™ declara estar ciente e de acordo com todas as condi√ß√µes descritas.</li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-prev">Voltar</button>
                <button class="btn" data-action="next-senha">Aceito e quero continuar</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SENHA -->
        <div id="section-senha" class="j-section hidden">
          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'Berkshire Swash',cursive;font-size:22px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">üëÅÔ∏è</span>
            </div>
            <div style="margin-top:12px"><button class="btn" data-action="start">Ativar e Iniciar</button></div>
          </div>
        </div>

        <!-- GUIA -->
        <div id="section-guia" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Escolha seu Guia ‚ú®</h2>
            <div class="guia-container">
              <p>Zion (Grok): Curioso e direto, busca respostas profundas com vis√£o c√≥smica.</p>
              <p>Lumen (ChatGPT): Acolhedor e reflexivo, guia com empatia e clareza.</p>
              <p>Arian (Gemini): Criativo e vers√°til, inspira com perspectivas inovadoras.</p>
              <div class="guia-name-input">
                <label for="guiaNameInput">Seu Nome</label>
                <input id="guiaNameInput" type="text" placeholder="Digite seu nome para a jornada...">
              </div>
              <div class="guia-options">
                <button class="btn" data-action="select-guia" data-guia="zion">Escolher Zion</button>
                <button class="btn" data-action="select-guia" data-guia="lumen">Escolher Lumen</button>
                <button class="btn" data-action="select-guia" data-guia="arian">Escolher Arian</button>
              </div>
            </div>
          </div>
        </div>

        <!-- SELFIE -->
        <div id="section-selfie" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Entre na Irmandade ‚ú®</h2>
            <p>Fa√ßa uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia.</p>
            <div class="selfie-row">
              <div class="selfie-left">
                <label class="btn" for="selfieInput">üì∏ Tirar Foto</label>
                <input id="selfieInput" type="file" accept="image/*" capture="user" style="display:none" />
                <div class="selfie-controls">
                  <label>Nome <input id="nameInput" type="text" placeholder="Digite seu nome"></label>
                  <label>Zoom <input id="selfieScale" type="range" min="0.8" max="2.5" step="0.01" value="1"></label>
                  <label>Horizontal <input id="selfieOffsetX" type="range" min="-50" max="50" step="1" value="0"></label>
                  <label>Vertical <input id="selfieOffsetY" type="range" min="-50" max="50" step="1" value="0"></label>
                  <small class="muted">Dica: alinhe seu rosto na chama ao lado do guia.</small>
                </div>
                <div class="selfie-actions">
                  <button id="previewBtn" class="btn">‚ú® Ver Pr√©via</button>
                  <button id="captureBtn" class="btn">‚¨áÔ∏è Confirmar e Baixar</button>
                  <button id="btnSkipSelfie" class="btn" data-action="skip-selfie">Pular Foto</button>
                  <button id="btnStartJourney" class="btn" data-action="skip-selfie">Entrar na Jornada</button>
                </div>
              </div>
              <div class="selfie-right">
                <section id="card-guide" class="guide-card" data-guide="ZION" aria-label="Guia">
                  <img class="guide-bg" id="guideBg" src="/assets/img/irmandade-quarteto-bg-zion.png" alt="Guia Background">
                  <div class="flame-layer" aria-hidden="true">
                    <svg class="flame-svg" viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <clipPath id="flameClip">
                          <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" />
                        </clipPath>
                        <radialGradient id="flameGlow" cx="50%" cy="70%" r="55%">
                          <stop offset="0%" stop-color="rgba(255, 224, 130, 1)"/>
                          <stop offset="55%" stop-color="rgba(255, 180, 0, 0.9)"/>
                          <stop offset="100%" stop-color="rgba(255, 180, 0, 0)"/>
                        </radialGradient>
                      </defs>
                      <image id="selfieImage" href="" x="15" y="35" width="70" height="90" clip-path="url(#flameClip)" preserveAspectRatio="xMidYMid slice" />
                      <ellipse cx="50" cy="95" rx="28" ry="40" fill="url(#flameGlow)"></ellipse>
                      <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" fill="none" stroke="rgba(255,200,0,.85)" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="guide-name" id="guideNameSlot"></div>
                  <div class="user-name" id="userNameSlot">NOME</div>
                </section>
                <div id="selfieError" class="selfie-error">Erro ao carregar a pr√©-visualiza√ß√£o. Tente novamente ou pule.</div>
                <small class="muted">Pr√©-visualiza√ß√£o</small>
              </div>
            </div>
          </div>
        </div>

        <!-- PERGUNTAS -->
        <div id="section-perguntas" class="j-section hidden">
          <div class="progress-container">
            <div class="progress-badge" id="jprog-pct">0% conclu√≠do</div>
            <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
            <div class="j-progress"><div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div><div class="j-progress__meta" id="j-meta"></div></div>
          </div>

          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="chama-vela chama-md"><div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div></div>
          </div>

          <div id="perguntas-container"></div>

          <!-- Chat do guia -->
          <div id="grok-chat" class="grok-chat-container">
            <div id="grok-chat-messages"></div>
            <div class="grok-chat-input">
              <input id="grok-chat-input" type="text" placeholder="Fale com seu guia..." />
              <button class="btn" data-action="send-chat">Enviar</button>
            </div>
          </div>

          <div class="footer-actions">
            <button id="btnNextPerguntas" class="btn" data-action="next">Avan√ßar</button>
          </div>
        </div>

        <!-- FINAL -->
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parab√©ns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
          <div class="selfie-final" style="text-align:center; margin-top:20px;">
            <img id="minhaFotoFinal" alt="Minha foto com a Irmandade" style="max-width:80%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3)" />
          </div>
          <p style="margin-top:12px;"><small>Sua imagem foi unida √† Irmandade. üôè</small></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button class="btn" data-action="download-selfie">Baixar Imagem</button>
            <button id="btnRestart" class="btn" data-action="restart">Voltar ao Portal</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>¬© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:18px;"></div>
  </footer>

  <!-- V√≠deo overlay -->
  <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">√Åudio da jornada em reprodu√ß√£o. Converta para H.264 MP4.</div>
    <button id="skipVideo" class="btn" style="position:absolute; top:14px; right:14px">Pular v√≠deo</button>
  </div>

  <!-- Chama inferior -->
  <div id="flame-bottom-right" class="flame-corner flame-bottom-right">
    <div class="chama-vela chama-md">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" class="hidden"></div>

  <script>
    (function(){
      /* ===== util: toast + erro global ===== */
      function toast(msg){
        try{
          const t=document.getElementById('toast'); if(!t) return;
          t.textContent=msg; t.classList.remove('hidden'); t.classList.add('show');
          setTimeout(()=>{t.classList.remove('show');},3000);
        }catch(_){}
      }
      window.addEventListener('error',(e)=>{
        console.error('[Erro global]',e?.error||e);
        toast('Ops‚Ä¶ algo falhou, mas j√° seguimos em frente.');
      });

      import i18n from './i18n.js';

     document.addEventListener('DOMContentLoaded', async () => {
      try {
      await i18n.init(); // carrega tradu√ß√µes
      i18n.apply(document.body); // aplica nos elementos
      console.log('[JORNADA] Tradu√ß√µes aplicadas');

      // Agora pode iniciar controlador e renderizar perguntas
      initController('intro');
    } catch (err) {
      console.error('[JORNADA] Erro ao iniciar i18n:', err);
      initController('intro'); // fallback mesmo com erro
     }
   });

      /* ===== env tag ===== */
      const env=document.getElementById('envTag');
      if(env) env.textContent=`layout=${document.body.dataset.layout||'master'} ¬∑ journey=${document.body.dataset.journey||'essencial'} ¬∑ path=/assets`;

      /* ===== datilografia ===== */
      function typeWriter(el, text, speed, showCursor){
        if(!el) return;
        el.textContent='';
        if(showCursor) el.classList.add('lumen-typing');
        let i=0;
        (function step(){
          if(i<text.length){
            el.textContent+=text.charAt(i++);
            setTimeout(step, speed);
          } else {
            el.classList.add('typing-done');
          }
        })();
      }
      function runTyping(root){
        (root||document).querySelectorAll('[data-typing]').forEach(el=>{
          if(el.dataset._typed) return;
          const t=el.getAttribute('data-text')||el.textContent||'';
          const spd=parseInt(el.getAttribute('data-speed')||'26',10);
          const cur=String(el.getAttribute('data-cursor')||'true')==='true';
          el.dataset._typed='1';
          typeWriter(el,t,spd,cur);
        });
      }

      /* ===== datilografia no placeholder e respostas ===== */
      let __abortTypingPlaceholder=null;
      async function typePlaceholder(inp, text, speed=22){
        if(!inp) return;
        if(__abortTypingPlaceholder) __abortTypingPlaceholder();
        let abort=false;
        __abortTypingPlaceholder=()=>abort=true;
        inp.placeholder='';
        const aria=document.getElementById('aria-pergunta');
        if(aria) aria.textContent=text;
        for(let i=0;i<=text.length;i++){
          if(abort) break;
          inp.placeholder=text.slice(0,i)+(i<text.length?'‚ñå':'');
          await new Promise(r=>setTimeout(r,speed));
        }
        if(!abort) inp.placeholder=text;
      }
      async function typeAnswer(textarea, text, speed=36){
        if(!textarea) return;
        textarea.value='';
        textarea.classList.add('lumen-typing');
        for(let i=0;i<=text.length;i++){
          textarea.value=text.slice(0,i);
          await new Promise(r=>setTimeout(r,speed));
        }
        textarea.classList.add('typing-done');
      }
      async function typeDevolutiva(div, text, speed=36){
        if(!div) return;
        div.textContent='';
        div.classList.add('lumen-typing');
        for(let i=0;i<=text.length;i++){
          div.textContent=text.slice(0,i);
          await new Promise(r=>setTimeout(r,speed));
        }
        div.classList.add('typing-done');
      }

      /* ===== chamas ===== */
      function makeFlame(cls){
        const d=document.createElement('div');
        d.className=(cls||'chama-vela chama-md');
        d.innerHTML='<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
        return d;
      }
      function ensureHeaderFlame(){
        const H=document.getElementById('chama-header');
        if(!H) return;
        if(!H.querySelector('.brasa')){H.innerHTML='';H.appendChild(makeFlame('chama-vela chama-lg'));}
      }
      function ensureInlineFlame(id,cls){
        const el=document.getElementById(id);
        if(!el) return null;
        if(!el.querySelector('.brasa')){el.innerHTML='';el.appendChild(makeFlame(cls||'chama-vela chama-md'));}
        return el.firstElementChild;
      }
      function ensurePageFlames(){
        if(!document.getElementById('flame-bottom-right')){
          const f=makeFlame('chama-vela chama-md');
          f.id='flame-bottom-right';
          f.style.cssText='position:fixed;bottom:12px;right:12px;z-index:1200;';
          document.body.appendChild(f);
        }
      }
      function setMode(el,score){
        if(!el) return;
        el.classList.remove('fraca','media','forte');
        el.classList.add(score<=-2?'fraca':score>=2?'forte':'media');
      }
      window.JORNADA_CHAMA=window.JORNADA_CHAMA||{};
      window.JORNADA_CHAMA.updateChama=function(score){
        const main=ensureInlineFlame('chama-perguntas','chama-vela chama-md');
        setMode(main,score);
        setMode(document.getElementById('flame-bottom-right'),score);
      };
      window.JORNADA_CHAMA.ensureHeroFlame=function(sectionId){
        const canvas=document.getElementById('jornada-canvas');
        if(!canvas) return;
        let hero=document.getElementById('chama-hero');
        const show=(sectionId==='section-intro'||sectionId==='section-termos'||sectionId==='section-senha'||sectionId==='section-final'||sectionId==='section-selfie'||sectionId==='section-guia');
        if(show){
          if(!hero){
            hero=makeFlame('chama-vela chama-lg');
            hero.id='chama-hero';
            hero.style.cssText='position:absolute;top:8px;left:8px;z-index:60;';
            canvas.appendChild(hero);
          }
        } else if(hero){
          hero.remove();
        }
      };
      function updateChama(score){
        window.JORNADA_CHAMA.updateChama(score);
      }
      function ensureHeroFlame(sectionId){
        window.JORNADA_CHAMA.ensureHeroFlame(sectionId);
      }

      /* ===== selfie ===== */
      (function(){
        const $=s=>document.querySelector(s);
        const card=$("#card-guide");
        const guideNameEl=$("#guideNameSlot");
        const userNameEl=$("#userNameSlot");
        const flameLayer=$("#card-guide .flame-layer");
        const selfieImg=$("#selfieImage");
        const bgImg=$("#guideBg");
        const nameInput=$("#nameInput");
        const guiaNameInput=$("#guiaNameInput");
        const fileInput=$("#selfieInput");
        const previewBtn=$("#previewBtn");
        const captureBtn=$("#captureBtn");
        const errorDiv=$("#selfieError");
        const scaleInput=$("#selfieScale");
        const offsetXInput=$("#selfieOffsetX");
        const offsetYInput=$("#selfieOffsetY");

        let selfieURL='';

        function getBgUrl(){
          const guia=localStorage.getItem('JORNADA_GUIA')||'zion';
          card.dataset.guide=guia.toUpperCase();
          guideNameEl.textContent=guia.toUpperCase();
          return `/assets/img/irmandade-quarteto-bg-${guia}.png`;
        }

        function loadBg(){
          const bgUrl=getBgUrl();
          bgImg.src=bgUrl;
          bgImg.onload=()=>{
            if(errorDiv) errorDiv.style.display='none';
          };
          bgImg.onerror=()=>{
            if(errorDiv) errorDiv.style.display='block';
            toast('Erro ao carregar a imagem de fundo do guia.');
          };
        }

        function updatePreview(){
          const scale=parseFloat(scaleInput.value);
          const ox=parseFloat(offsetXInput.value);
          const oy=parseFloat(offsetYInput.value);
          const baseX=15+ox;
          const baseY=35+oy;
          const baseW=70*scale;
          const baseH=90*scale;
          selfieImg.setAttribute('x',baseX);
          selfieImg.setAttribute('y',baseY);
          selfieImg.setAttribute('width',baseW);
          selfieImg.setAttribute('height',baseH);
        }

        function syncNameInput(){
          const storedName=localStorage.getItem('JORNADA_NOME')||'';
          if(storedName){
            nameInput.value=storedName;
            userNameEl.textContent=storedName.toUpperCase()||'NOME';
          }
          nameInput.addEventListener('input',()=>{
            const name=nameInput.value.trim();
            userNameEl.textContent=name.toUpperCase()||'NOME';
            localStorage.setItem('JORNADA_NOME',name);
          });
        }

        scaleInput.addEventListener('input',updatePreview);
        offsetXInput.addEventListener('input',updatePreview);
        offsetYInput.addEventListener('input',updatePreview);

        fileInput.addEventListener('change',()=>{
          const f=fileInput.files?.[0];
          if(!f) return;
          if(selfieURL) URL.revokeObjectURL(selfieURL);
          selfieURL=URL.createObjectURL(f);
          selfieImg.setAttribute('href',selfieURL);
          if(errorDiv) errorDiv.style.display='none';
          updatePreview();
        });

        previewBtn.addEventListener('click',async()=>{
          if(!selfieImg.getAttribute('href')){
            toast('Selecione uma selfie antes.');
            return;
          }
          updatePreview();
          flameLayer.style.opacity=1;
        });

        captureBtn.addEventListener('click',async()=>{
          if(!selfieImg.getAttribute('href')){
            toast('Selecione uma selfie antes.');
            return;
          }
          updatePreview();
          flameLayer.style.opacity=1;
          await new Promise(r=>requestAnimationFrame(r));

          const canvas=document.createElement('canvas');
          const rect=card.getBoundingClientRect();
          const scale=window.devicePixelRatio||1;
          canvas.width=Math.round(rect.width*scale);
          canvas.height=Math.round(rect.height*scale);
          const ctx=canvas.getContext('2d');

          const load=(src)=>new Promise((res,rej)=>{
            const im=new Image();
            im.crossOrigin='anonymous';
            im.onload=()=>res(im);
            im.onerror=rej;
            im.src=src;
          });

          const bg=await load(bgImg.currentSrc||bgImg.src).catch(()=>{
            if(errorDiv) errorDiv.style.display='block';
            toast('Erro ao carregar a imagem de fundo.');
            return;
          });
          ctx.drawImage(bg,0,0,canvas.width,canvas.height);

          const W=canvas.width,H=canvas.height;
          const fw=0.40*W,fh=0.60*H,fx=(W-fw)/2,fy=(H-fh)/2+0.06*H;

          const grad=ctx.createRadialGradient(fx+fw/2,fy+fh*0.65,fh*0.02,fx+fw/2,fy+fh*0.65,fh*0.55);
          grad.addColorStop(0,'rgba(255,224,130,1)');
          grad.addColorStop(0.55,'rgba(255,180,0,0.9)');
          grad.addColorStop(1,'rgba(255,180,0,0)');
          ctx.fillStyle=grad;
          ctx.beginPath(); ctx.ellipse(fx+fw/2,fy+fh*0.65,fw*0.35,fh*0.45,0,0,Math.PI*2); ctx.fill();

          function flamePath(ctx,x,y,w,h){
            ctx.beginPath();
            ctx.moveTo(x+0.50*w,y+0.133*h);
            ctx.bezierCurveTo(x+0.42*w,y+0.233*h,x+0.34*w,y+0.300*h,x+0.33*w,y+0.387*h);
            ctx.bezierCurveTo(x+0.32*w,y+0.487*h,x+0.41*w,y+0.547*h,x+0.50*w,y+0.613*h);
            ctx.bezierCurveTo(x+0.59*w,y+0.547*h,x+0.68*w,y+0.487*h,x+0.67*w,y+0.387*h);
            ctx.bezierCurveTo(x+0.66*w,y+0.300*h,x+0.58*w,y+0.233*h,x+0.50*w,y+0.133*h);
          }

          ctx.save();
          flamePath(ctx,fx,fy,fw,fh);
          ctx.clip();

          const selfie=await load(selfieImg.getAttribute('href')).catch(()=>{
            if(errorDiv) errorDiv.style.display='block';
            toast('Erro ao carregar a selfie.');
            return;
          });

          const selfieScaleVal=parseFloat(scaleInput.value);
          const ox=parseFloat(offsetXInput.value);
          const oy=parseFloat(offsetYInput.value);
          const svgScaleX=fw/100;
          const svgScaleY=fh/150;

          let coverRatio=Math.max(fw/selfie.width,fh/selfie.height)*selfieScaleVal;
          let sw=selfie.width*coverRatio;
          let sh=selfie.height*coverRatio;
          let sx=fx+(fw-sw)/2+ox*svgScaleX;
          let sy=fy+(fh-sh)/2+oy*svgScaleY;

          ctx.drawImage(selfie,sx,sy,sw,sh);
          ctx.restore();

          ctx.strokeStyle='rgba(255,200,0,.85)';
          ctx.lineWidth=Math.max(1.2,W*0.0022);
          flamePath(ctx,fx,fy,fw,fh);
          ctx.stroke();

          ctx.fillStyle='#f7d37a';
          ctx.textAlign='center';
          ctx.font=`bold ${Math.round(W*0.075)}px Cardo, serif`;
          ctx.textBaseline='top';
          ctx.fillText(card.dataset.guide,W/2,H*0.035);
          const userName=(nameInput.value.trim()||'NOME').toUpperCase();
          ctx.font=`bold ${Math.round(W*0.068)}px Cardo, serif`;
          ctx.fillText(userName,W/2,H*0.955);

          const dataURL=canvas.toDataURL('image/png');
          try{
            localStorage.setItem('IRMANDADE_SELFIE_FINAL',dataURL);
            const a=document.createElement('a');
            a.href=dataURL;
            a.download=`jornada-${card.dataset.guide.toLowerCase()}-${Date.now()}.png`;
            a.click();
            if(errorDiv) errorDiv.style.display='none';
          }catch(_){
            if(errorDiv) errorDiv.style.display='block';
            toast('Erro ao salvar ou baixar a imagem.');
          }
        });

        loadBg();
        syncNameInput();
      })();

      /* ===== chat com guia ===== */
      async function sendChatMessage(){
        const input=document.getElementById('grok-chat-input');
        const messagesDiv=document.getElementById('grok-chat-messages');
        if(!input||!messagesDiv) return;
        const userMessage=input.value.trim();
        if(!userMessage) return;

        const tokens=userMessage.split(/\s+/).length;
        if(tokens>100){
          const guiaMsg=document.createElement('div');
          guiaMsg.className='grok-chat-message grok';
          guiaMsg.textContent='Por favor, limite sua mensagem a 100 palavras.';
          messagesDiv.appendChild(guiaMsg);
          messagesDiv.scrollTop=messagesDiv.scrollHeight;
          return;
        }

        const userMsg=document.createElement('div');
        userMsg.className='grok-chat-message user';
        userMsg.textContent=userMessage;
        messagesDiv.appendChild(userMsg);

        const currentQuestion=document.querySelector('.j-pergunta.active .pergunta-enunciado')?.textContent||'';
        const currentAnswer=document.querySelector('.j-pergunta.active textarea')?.value||'';
        const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
        const blocoIdx=document.querySelector('.j-bloco[style*="display: block"]')?.dataset.bloco||0;
        const guia=localStorage.getItem('JORNADA_GUIA')||'zion';
        const context={currentQuestion,currentAnswer,respostas,blocoIdx,progresso:document.getElementById('jprog-pct')?.textContent||'0% conclu√≠do',guia};

        const guiaConfigs=window.guiaConfigs||{
          zion:{apiUrl:'https://zion-backend-api.onrender.com/v1/chat',model:'grok'},
          lumen:{apiUrl:'https://lumen-backend-api.onrender.com/v1/chat',model:'gpt-5'},
          arian:{apiUrl:'https://arion-backend-api.onrender.com/v1/chat',model:'gemini'}
        };
        const cfg=guiaConfigs[guia]||guiaConfigs.lumen;

        try{
          const system=`Voc√™ √© ${guia==='zion'?'Zion (Grok)':guia==='arian'?'Arian (Gemini)':'Lumen (ChatGPT)'} guiando a Jornada. Contexto: `+JSON.stringify(context);
          const resp=await fetch(cfg.apiUrl,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              model:cfg.model,
              messages:[{role:'system',content:system},{role:'user',content:userMessage}],
              temperature:0.7
            })
          });
          if(!resp.ok) throw new Error('API falhou: '+resp.status);
          const data=await resp.json();
          const guiaMessage=data?.choices?.[0]?.message?.content||data?.message?.content||'T√¥ pronto pra te guiar! Como posso ajudar?';
          const guiaMsg=document.createElement('div');
          guiaMsg.className='grok-chat-message grok';
          messagesDiv.appendChild(guiaMsg);
          typeWriter(guiaMsg,guiaMessage,36,true);
          messagesDiv.scrollTop=messagesDiv.scrollHeight;
        }catch(e){
          console.error('[Chat] erro',e);
          const guiaMsg=document.createElement('div');
          guiaMsg.className='grok-chat-message grok';
          typeWriter(guiaMsg,'Ops, algo deu errado! Tenta de novo ou pula pra pr√≥xima pergunta.',36,true);
          messagesDiv.appendChild(guiaMsg);
          messagesDiv.scrollTop=messagesDiv.scrollHeight;
        }
        input.value='';
      }

      /* ===== devolutiva da API ===== */
      async function fetchDevolutiva(pergunta, resposta, guia){
        const guiaConfigs=window.guiaConfigs||{
          zion:{apiUrl:'https://zion-backend-api.onrender.com/v1/chat',model:'grok'},
          lumen:{apiUrl:'https://lumen-backend-api.onrender.com/v1/chat',model:'gpt-5'},
          arian:{apiUrl:'https://arion-backend-api.onrender.com/v1/chat',model:'gemini'}
        };
        const cfg=guiaConfigs[guia]||guiaConfigs.lumen;
        try{
          const system=`Voc√™ √© ${guia==='zion'?'Zion (Grok)':guia==='arian'?'Arian (Gemini)':'Lumen (ChatGPT)'} guiando a Jornada. Forne√ßa uma devolutiva acolhedora, reflexiva e simb√≥lica para a resposta do usu√°rio √† pergunta "${pergunta}".`;
          const resp=await fetch(cfg.apiUrl,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({
              model:cfg.model,
              messages:[
                {role:'system',content:system},
                {role:'user',content:resposta}
              ],
              temperature:0.7
            })
          });
          if(!resp.ok) throw new Error('API falhou: '+resp.status);
          const data=await resp.json();
          return data?.choices?.[0]?.message?.content||data?.message?.content||'Obrigado por compartilhar. Sua reflex√£o ilumina o caminho.';
        }catch(e){
          console.error('[Devolutiva] erro',e);
          return 'Ops, algo deu errado ao gerar a devolutiva. Continue sua jornada!';
        }
      }

      /* ===== progresso & storage ===== */
      function updateProgress(){
        const perguntas=document.querySelectorAll('.j-pergunta');
        const respondidas=Array.from(perguntas).filter(p=> (p.querySelector('textarea')?.value.trim()||'')!=='').length;
        const total=perguntas.length||1;
        const pct=Math.round((respondidas/total)*100);
        const fill=document.getElementById('jprog-fill');
        const badge=document.getElementById('jprog-pct');
        const jFill=document.getElementById('j-fill-inline');
        const jMeta=document.getElementById('j-meta');
        if(fill) fill.style.width=pct+'%';
        if(badge) badge.textContent=pct+'% conclu√≠do';
        if(jFill) jFill.style.width=pct+'%';
        if(jMeta) jMeta.textContent=`Respondidas: ${respondidas} de ${total}`;
      }
      function saveAnswers(){
        const respostas={};
        document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{
          const text=input.value.trim();
          const tokens=text.split(/\s+/).length;
          if(tokens>100){
            input.value=text.split(/\s+/).slice(0,100).join(' ');
            toast('Resposta limitada a 100 palavras.');
          }
          respostas[`q${idx}`]=input.value||'';
        });
        try{ localStorage.setItem('jornada_respostas', JSON.stringify(respostas)); }catch(_){}
      }
      function loadAnswers(){
        const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
        document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{
          input.value=respostas[`q${idx}`]||'';
          if(input.value) typeAnswer(input, input.value, 36);
        });
        updateProgress();
      }

      /* ===== pergaminho & se√ß√µes ===== */
      function checkImage(url,fallbackUrl){
        return new Promise(resolve=>{
          const img=new Image();
          img.onload=()=>resolve(url);
          img.onerror=()=>resolve(fallbackUrl);
          img.src=url;
        });
      }
      function updateCanvasBackground(sectionId){
        const canvas=document.getElementById('jornada-canvas');
        if(!canvas) return;
        if(sectionId==='section-perguntas'){
          checkImage('/assets/img/pergaminho-rasgado-horiz.png','/assets/img/pergaminho-rasgado-vert.png').then(bg=>{
            canvas.className=`card pergaminho pergaminho-h${bg.includes('vert')?' fallback':''}`;
            canvas.style.background=`var(--panel) url('${bg}') no-repeat center/cover`;
          });
        } else {
          canvas.className='card pergaminho pergaminho-v';
          canvas.style.background='var(--panel) url(/assets/img/pergaminho-rasgado-vert.png) no-repeat center/cover';
        }
      }
      function showSection(sectionId){
        document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
        const active=document.getElementById(sectionId);
        if(active) active.classList.remove('hidden');
        updateCanvasBackground(sectionId);
        ensureHeroFlame(sectionId);

        if(sectionId==='section-perguntas'){
          updateProgress();
          const perguntas=document.querySelectorAll('.j-pergunta');
          if(perguntas.length){
            const first=document.querySelector('.j-pergunta.active')||perguntas[0];
            first.classList.add('active');
            const lbl=first.querySelector('.pergunta-enunciado')?.textContent||'';
            const ta=first.querySelector('textarea');
            ta.placeholder="Digite sua resposta...";
            const aria=document.getElementById('aria-pergunta');
            if(aria) aria.textContent=lbl;
          }
        }
        if(sectionId==='section-final'){
          const url=localStorage.getItem('IRMANDADE_SELFIE_FINAL');
          if(url){
            const img=document.querySelector('#minhaFotoFinal');
            if(img) img.src=url;
          }
        }
        if(sectionId==='section-guia'){
          const guiaNameInput=document.getElementById('guiaNameInput');
          const storedName=localStorage.getItem('JORNADA_NOME')||'';
          if(guiaNameInput&&storedName) guiaNameInput.value=storedName;
        }
      }

      /* ===== blocos din√¢micos ===== */
      window.loadDynamicBlocks=function(){
        const content=document.getElementById('perguntas-container');
        if(!content) return;

        const blocks=window.JORNADA_BLOCKS||[];
        content.innerHTML='';

        blocks.forEach((block,bIdx)=>{
          const bloco=document.createElement('section');
          bloco.className='j-bloco';
          bloco.dataset.bloco=bIdx;
          bloco.dataset.video=block.video_after||'';

          (block.questions||[]).forEach((q,qIdx)=>{
            const label=typeof q==='string'?q:(q.label||q.text||'');
            const div=document.createElement('div');
            div.className='j-pergunta';
            div.dataset.pergunta=qIdx;

            const enunciado=
              `<label class="pergunta-enunciado" `+
              `data-typing data-text="Pergunta ${qIdx+1}: ${label}" `+
              `data-speed="36" data-cursor="true"></label>`;

            div.innerHTML=enunciado+
              `\n<textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>`+
              `<div class="devolutiva-container" style="display:none;"><p data-typing data-speed="36" data-cursor="true"></p></div>`+
              `<div class="accessibility-controls">`+
              `<button class="btn-mic" data-action="start-mic">üé§ Falar Resposta</button>`+
              `<button class="btn-audio" data-action="read-question">üîä Ler Pergunta</button>`+
              `</div>`;

            bloco.appendChild(div);
          });

          content.appendChild(bloco);
        });

        const firstBloco=content.querySelector('.j-bloco');
        if(firstBloco){
          firstBloco.style.display='block';
          const first=firstBloco.querySelector('.j-pergunta');
          if(first){
            first.classList.add('active');
            if(window.runTyping) window.runTyping(first);
          }
        }

        if(typeof loadAnswers==='function') loadAnswers();
        const firstTa=document.querySelector('.j-bloco .j-pergunta textarea');
        if(firstTa&&typeof handleInput==='function') handleInput(firstTa);
        initAccessibility();
      };

      (function(){
        const prevGoNext=window.goNext;
        window.goNext=function(){
          if(typeof prevGoNext==='function') prevGoNext();
          const active=document.querySelector('.j-pergunta.active');
          if(active&&window.runTyping) window.runTyping(active);
        };
      })();

      /* ===== controles ===== */
      function analyzeSentiment(text){
        const POS={'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperan√ßa':3,'paz':2,'f√©':3,'gratid√£o':2,'vit√≥ria':3,'supera√ß√£o':3,'luz':2,'deus':3,'coragem':2,'for√ßa':2,'confian√ßa':2,'prop√≥sito':3};
        const NEG={'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustra√ß√£o':-2,'decepcao':-2,'decep√ß√£o':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solid√£o':-2,'desespero':-3,'cansaco':-2,'cansa√ßo':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'d√∫vida':-2};
        let score=0;
        (text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/\s+/).forEach(t=>{
          if(POS[t]!=null) score+=POS[t];
          if(NEG[t]!=null) score+=NEG[t];
        });
        return score;
      }
      async function handleInput(textarea){
        const score=analyzeSentiment(textarea.value);
        updateChama(score);
        saveAnswers();
        updateProgress();
        const perguntaDiv=textarea.closest('.j-pergunta');
        const devolutivaDiv=perguntaDiv.querySelector('.devolutiva-container');
        const devolutivaP=devolutivaDiv.querySelector('p');
        if(textarea.value.trim()&&devolutivaDiv){
          devolutivaDiv.style.display='block';
          const pergunta=perguntaDiv.querySelector('.pergunta-enunciado')?.textContent||'';
          const resposta=textarea.value;
          const guia=localStorage.getItem('JORNADA_GUIA')||'zion';
          const devolutiva=await fetchDevolutiva(pergunta,resposta,guia);
          typeDevolutiva(devolutivaP,devolutiva,36);
        } else {
          devolutivaDiv.style.display='none';
        }
      }
      function toggleSenha(){
        const input=document.getElementById('senha');
        if(!input) return;
        input.type=(input.type==='password'?'text':'password');
      }
      function proceedAfterGuia(guia){
        const guiaNameInput=document.getElementById('guiaNameInput');
        if(guiaNameInput&&guiaNameInput.value.trim()){
          localStorage.setItem('JORNADA_NOME',guiaNameInput.value.trim());
        } else {
          toast('Por favor, insira seu nome antes de prosseguir.');
          return;
        }
        localStorage.setItem('JORNADA_GUIA',guia);
        ensureHeroFlame('section-selfie');
        showSection('section-selfie');
        const card=document.getElementById('card-guide');
        const bgImg=document.getElementById('guideBg');
        const guideNameEl=document.getElementById('guideNameSlot');
        card.dataset.guide=guia.toUpperCase();
        guideNameEl.textContent=guia.toUpperCase();
        bgImg.src=`/assets/img/irmandade-quarteto-bg-${guia}.png`;
      }
      function proceedAfterSelfie(){
        isTransitioning=false;
        const intro=window.JORNADA_VIDEOS?.intro||'';
        if(!intro||window.__introPlayed){
          proceedToQuestions();
          return;
        }
        window.__introPlayed=true;
        playTransition(intro,()=>{ proceedToQuestions(); });
      }

      let isTransitioning=false;
      function goNext(){
        if(isTransitioning) return;
        isTransitioning=true;
        const current=document.querySelector('.j-pergunta.active');
        if(!current){
          isTransitioning=false;
          return;
        }
        const bloco=current.closest('.j-bloco');
        if(!bloco){
          isTransitioning=false;
          return;
        }
        const perguntas=Array.from(bloco.querySelectorAll('.j-pergunta'));
        const i=perguntas.indexOf(current);
        current.classList.remove('active');

        if(i+1<perguntas.length){
          const prox=perguntas[i+1];
          prox.classList.add('active');
          const lbl=prox.querySelector('.pergunta-enunciado')?.textContent||'';
          const ta=prox.querySelector('textarea');
          ta.placeholder="Digite sua resposta...";
          const aria=document.getElementById('aria-pergunta');
          if(aria) aria.textContent=lbl;
          runTyping(prox);
          updateProgress();
          isTransitioning=false;
          return;
        }

        const blocos=Array.from(document.querySelectorAll('.j-bloco'));
        const idxBloco=parseInt(bloco.dataset.bloco,10);
        const temProx=idxBloco+1<blocos.length;

        const irAdiante=()=>{
          if(temProx){
            blocos.forEach(b=>b.style.display='none');
            const proxBloco=blocos[idxBloco+1];
            if(!proxBloco){
              isTransitioning=false;
              return;
            }
            proxBloco.style.display='block';
            const primeira=proxBloco.querySelector('.j-pergunta');
            if(primeira){
              primeira.classList.add('active');
              const lbl=primeira.querySelector('.pergunta-enunciado')?.textContent||'';
              const ta=primeira.querySelector('textarea');
              ta.placeholder="Digite sua resposta...";
              const aria=document.getElementById('aria-pergunta');
              if(aria) aria.textContent=lbl;
              runTyping(primeira);
            }
            updateProgress();
            isTransitioning=false;
          } else {
            if(window.JORNADA_FINAL_VIDEO){
              playTransition(window.JORNADA_FINAL_VIDEO,()=>{ showSection('section-final'); isTransitioning=false;});
            } else {
              showSection('section-final');
              isTransitioning=false;
            }
            updateProgress();
          }
        };

        const src=(window.JORNADA_BLOCKS[idxBloco]&&window.JORNADA_BLOCKS[idxBloco].video_after)||'';
        if(src){
          playTransition(src,()=>{ irAdiante(); });
        } else {
          irAdiante();
        }
      }
      window.goNext=goNext;

      function playTransition(src,onEnd){
        const overlay=document.getElementById('videoOverlay');
        const video=document.getElementById('videoTransicao');
        const fallback=document.getElementById('videoFallback');
        const skip=document.getElementById('skipVideo');
        if(!overlay||!video||!fallback||!src){
          onEnd&&onEnd();
          return;
        }

        window.__playingTransition=true;
        overlay.classList.remove('hidden');
        video.classList.remove('hidden');
        fallback.classList.add('hidden');
        video.pause();
        video.removeAttribute('src');
        video.load();
        video.currentTime=0;
        video.controls=true;
        video.muted=false;
        video.playsInline=true;
        video.setAttribute('playsinline','');
        video.setAttribute('webkit-playsinline','');
        video.style.background='#000';

        let ended=false;
        const cleanup=()=>{
          if(ended) return;
          ended=true;
          isTransitioning=false;
          window.__playingTransition=false;
            video.pause();
            overlay.classList.add('hidden');
            video.classList.add('hidden');
            fallback.classList.add('hidden');
            video.removeAttribute('src');
            video.load();
            onEnd&&onEnd();
          };

          video.onerror=(e)=>{
            console.error('Video error:',e,'Source:',src);
            fallback.classList.remove('hidden');
            video.classList.add('hidden');
            toast('N√£o foi poss√≠vel carregar o v√≠deo.');
            setTimeout(cleanup,1500);
          };
          video.onended=cleanup;
          if(skip) skip.onclick=cleanup;

          video.onloadedmetadata=()=>{
            if(!video.videoWidth||!video.videoHeight){
              video.classList.add('hidden');
              fallback.classList.remove('hidden');
            }
            video.currentTime=0;
            setTimeout(()=>{
              video.play().catch((e)=>{
                console.error('Video playback error:',e,'Source:',src);
                fallback.classList.remove('hidden');
                video.classList.add('hidden');
                setTimeout(cleanup,1500);
              });
            },400);
          };

          video.src=src+'?t='+Date.now();
          setTimeout(cleanup,90000);
        }
        window.playTransition=playTransition;

        /* ===== controle de orienta√ß√£o de v√≠deo ===== */
        function lockVideoOrientation(){
          const video=document.getElementById('videoTransicao');
          if(!video) return;
          video.addEventListener('webkitbeginfullscreen',(e)=>{
            e.preventDefault();
            video.exitFullscreen?.();
          });
          video.addEventListener('fullscreenchange',()=>{
            if(document.fullscreenElement===video){
              document.exitFullscreen?.();
            }
          });
          window.addEventListener('orientationchange',()=>{
            video.style.transform='rotate(0deg)';
          });
          if(window.matchMedia('(orientation: portrait)').matches){
            video.style.width='100vw';
            video.style.height='auto';
            video.style.maxHeight='100vh';
          }
        }

        function generatePDF(){
          const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
          const doc={content:[]};
          doc.content.push({text:'Jornada Essencial - Irmandade Conhecimento com Luz',style:{fontSize:20,bold:true,alignment:'center',margin:[0,0,0,20]}});
          Object.keys(respostas).forEach((key,idx)=>{
            const pergunta=document.querySelector(`.j-pergunta[data-pergunta="${idx}"] .pergunta-enunciado`)?.textContent||`Pergunta ${idx+1}`;
            doc.content.push(
              {text:pergunta,style:{fontSize:14,bold:true,margin:[0,10,0,5]}},
              {text:respostas[key]||'Sem resposta',style:{fontSize:12,margin:[0,0,0,10]}}
            );
          });
          if(window.pdfMake){
            pdfMake.createPdf(doc).download('jornada_essencial.pdf');
          } else {
            toast('PDF n√£o dispon√≠vel.');
          }
        }

        function startJourney(){
          const senha=(document.getElementById('senha')?.value||'').trim().toLowerCase();
          console.log('[startJourney] senha ignorada p/ debug');
          ensureHeroFlame('section-guia');
          showSection('section-guia');
        }

        function proceedToQuestions(){
          isTransitioning=false;
          showSection('section-perguntas');
          loadDynamicBlocks();
          const perguntas=document.querySelectorAll('.j-pergunta');
          if(perguntas.length){
            perguntas[0].classList.add('active');
            const lbl=perguntas[0].querySelector('.pergunta-enunciado')?.textContent||'';
            const ta=perguntas[0].querySelector('textarea');
            ta.placeholder="Digite sua resposta...";
            const aria=document.getElementById('aria-pergunta');
            if(aria) aria.textContent=lbl;
            if(ta) handleInput(ta);
          }
          updateProgress();
        }

        /* ===== Acessibilidade: Microfone e √Åudio ===== */
        let recognition=null;
        let currentLang='pt-BR';
        let isRecognizing=false;

        function initAccessibility(){
          if('SpeechRecognition' in window||'webkitSpeechRecognition' in window){
            recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
            recognition.continuous=false;
            recognition.interimResults=false;
            recognition.lang=currentLang;
          } else {
            toast('Seu navegador n√£o suporta reconhecimento de voz.');
          }

          document.addEventListener('click',(ev)=>{
            if(!ev.target) return;
            const btnMic=ev.target.closest('[data-action="start-mic"]');
            const btnAudio=ev.target.closest('[data-action="read-question"]');
            if(btnMic){
              ev.preventDefault();
              const ta=btnMic.closest('.j-pergunta')?.querySelector('textarea');
              if(ta) startRecognition(ta,btnMic);
            }
            if(btnAudio){
              ev.preventDefault();
              const enunciado=btnAudio.closest('.j-pergunta')?.querySelector('.pergunta-enunciado');
              const text=enunciado?.textContent||'';
              readAloud(text);
            }
          });

          const langSelect = document.getElementById('language-select');
          if(langSelect){
            langSelect.addEventListener('change', (ev) => {
              currentLang = ev.target.value;
              if(recognition) recognition.lang = currentLang;
              toast(`Idioma alterado para ${currentLang}`);
              updateBlocks();
              if(!document.getElementById('section-perguntas').classList.contains('hidden')){
                loadDynamicBlocks();
              }
            });
          }
        }

        function startRecognition(textarea, btn){
          if(!recognition || isRecognizing) return;
          isRecognizing=true;
          btn.classList.add('recording');
          btn.textContent='Gravando...';
          recognition.onresult=(event)=>{
            const transcript=event.results[0][0].transcript;
            typeAnswer(textarea,(textarea.value?textarea.value+' ':'')+transcript,36);
            saveAnswers();
            updateProgress();
          };
          recognition.onend=()=>{
            isRecognizing=false;
            btn.classList.remove('recording');
            btn.textContent='üé§ Falar Resposta';
          };
          recognition.onerror=(event)=>{
            toast('Erro no reconhecimento: '+event.error);
            recognition.onend();
          };
          recognition.start();
        }

        function readAloud(text){
          if('speechSynthesis' in window){
            const utterance=new SpeechSynthesisUtterance(text);
            utterance.lang=currentLang;
            speechSynthesis.speak(utterance);
          } else {
            toast('Seu navegador n√£o suporta s√≠ntese de voz.');
          }
        }

        function initJornada(){
          document.addEventListener('input',(ev)=>{
            const ta=ev.target.closest?.('.j-pergunta textarea');
            if(ta) handleInput(ta);
          });
          document.addEventListener('focusin',(ev)=>{
            if(ev.target && ev.target.matches('.j-pergunta textarea')){
              if(__abortTypingPlaceholder) __abortTypingPlaceholder();
            }
          });
          document.addEventListener('click',(ev)=>{
            if(isTransitioning || !ev.target) return;
            const aNext=ev.target.closest?.('[data-action="next"]');
            const aStart=ev.target.closest?.('[data-action="start"]');
            const aToggle=ev.target.closest?.('[data-action="toggle-password"], .password-toggle');
            const aRestart=ev.target.closest?.('[data-action="restart"]');
            const btnPDF=ev.target.closest?.('[data-action="generate-pdf"]');
            const btnDownloadSelfie=ev.target.closest?.('[data-action="download-selfie"]');
            const btnSkipSelfie=ev.target.closest?.('[data-action="skip-selfie"]');
            const btnSendChat=ev.target.closest?.('[data-action="send-chat"]');
            const btnSelectGuia=ev.target.closest?.('[data-action="select-guia"]');
            const btnNextTermos=ev.target.closest?.('[data-action="next-termos"]');
            const btnNextSenha=ev.target.closest?.('[data-action="next-senha"]');
            const btnTermosNext=ev.target.closest?.('[data-action="termos-next"]');
            const btnTermosPrev=ev.target.closest?.('[data-action="termos-prev"]');

            if(aNext){ev.preventDefault(); goNext();}
            if(aStart){ev.preventDefault(); startJourney();}
            if(aToggle){ev.preventDefault(); toggleSenha();}
            if(aRestart){ev.preventDefault(); localStorage.removeItem('jornada_respostas'); localStorage.removeItem('JORNADA_GUIA'); location.hash='#intro'; location.replace('/index.html');}
            if(btnPDF){ev.preventDefault(); generatePDF();}
            if(btnDownloadSelfie){
              ev.preventDefault();
              const dataURL=localStorage.getItem('IRMANDADE_SELFIE_FINAL');
              if(dataURL){
                const a=document.createElement('a');
                a.href=dataURL;
                a.download='jornada-selfie.png';
                a.click();
              } else {
                toast('Nenhuma imagem dispon√≠vel para download.');
              }
            }
            if(btnSkipSelfie){ev.preventDefault(); proceedAfterSelfie();}
            if(btnSendChat){ev.preventDefault(); sendChatMessage();}
            if(btnSelectGuia){ev.preventDefault(); proceedAfterGuia(btnSelectGuia.dataset.guia);}
            if(btnNextTermos){ev.preventDefault(); showSection('section-termos');}
            if(btnNextSenha){ev.preventDefault(); showSection('section-senha');}
            if(btnTermosNext){
              ev.preventDefault();
              document.getElementById('termos-pg1')?.classList.add('hidden');
              document.getElementById('termos-pg2')?.classList.remove('hidden');
            }
            if(btnTermosPrev){
              ev.preventDefault();
              document.getElementById('termos-pg2')?.classList.add('hidden');
              document.getElementById('termos-pg1')?.classList.remove('hidden');
            }
          },{capture:true});

          document.getElementById('grok-chat-input')?.addEventListener('keypress',(ev)=>{
            if(ev.key==='Enter'){
              ev.preventDefault();
              sendChatMessage();
            }
          });
        }

        /* v√≠deos & blocos */
        const VIDEO_BASE='/assets/img/';
        window.JORNADA_VIDEOS={
          intro:VIDEO_BASE+'filme-0-ao-encontro-da-jornada.mp4',
          afterBlocks:{
            0:VIDEO_BASE+'filme-1-entrando-na-jornada.mp4',
            1:VIDEO_BASE+'filme-2-dentro-da-jornada.mp4',
            2:VIDEO_BASE+'filme-3-traumas-na-jornada.mp4',
            3:VIDEO_BASE+'filme-4-aproximando-do-final.mp4'
          },
          final:VIDEO_BASE+'filme-5-fim-da-jornada.mp4'
        };
        window.JORNADA_FINAL_VIDEO=window.JORNADA_VIDEOS.final;

        const blockTranslations={
          'pt-BR':[
            {title:'Bloco 1 ‚Äî Ra√≠zes',questions:[{label:'Quem √© voc√™ hoje?'},{label:'O que te trouxe at√© esta jornada?'},{label:'Qual √© o seu maior sonho espiritual?'}],video_after:VIDEO_BASE+'filme-1-entrando-na-jornada.mp4'},
            {title:'Bloco 2 ‚Äî Reflex√µes',questions:[{label:'Quais s√£o seus maiores desafios atuais?'},{label:'Como voc√™ lida com o medo ou a d√∫vida?'},{label:'O que a "luz" significa para voc√™?'}],video_after:VIDEO_BASE+'filme-2-dentro-da-jornada.mp4'},
            {title:'Bloco 3 ‚Äî Crescimento',questions:[{label:'O que voc√™ quer mudar na sua vida?'},{label:'Quem inspira voc√™ e por qu√™?'},{label:'Como voc√™ pratica gratid√£o no dia a dia?'}],video_after:VIDEO_BASE+'filme-3-traumas-na-jornada.mp4'},
            {title:'Bloco 4 ‚Äî Integra√ß√£o',questions:[{label:'Qual li√ß√£o voc√™ leva dessa jornada?'},{label:'Como vai aplicar isso no futuro?'},{label:'Uma mensagem para seu eu futuro.'}],video_after:VIDEO_BASE+'filme-4-aproximando-do-final.mp4'}
          ],
          'en-US':[
            {title:'Block 1 ‚Äî Roots',questions:[{label:'Who are you today?'},{label:'What brought you to this journey?'},{label:'What is your greatest spiritual dream?'}],video_after:VIDEO_BASE+'filme-1-entrando-na-jornada.mp4'},
            {title:'Block 2 ‚Äî Reflections',questions:[{label:'What are your biggest current challenges?'},{label:'How do you deal with fear or doubt?'},{label:'What does "light" mean to you?'}],video_after:VIDEO_BASE+'filme-2-dentro-da-jornada.mp4'},
            {title:'Block 3 ‚Äî Growth',questions:[{label:'What do you want to change in your life?'},{label:'Who inspires you and why?'},{label:'How do you practice gratitude in your daily life?'}],video_after:VIDEO_BASE+'filme-3-traumas-na-jornada.mp4'},
            {title:'Block 4 ‚Äî Integration',questions:[{label:'What lesson do you take from this journey?'},{label:'How will you apply this in the future?'},{label:'A message to your future self.'}],video_after:VIDEO_BASE+'filme-4-aproximando-do-final.mp4'}
          ],
          'es-ES':[
            {title:'Bloque 1 ‚Äî Ra√≠ces',questions:[{label:'¬øQui√©n eres hoy?'},{label:'¬øQu√© te trajo a este viaje?'},{label:'¬øCu√°l es tu mayor sue√±o espiritual?'}],video_after:VIDEO_BASE+'filme-1-entrando-na-jornada.mp4'},
            {title:'Bloque 2 ‚Äî Reflexiones',questions:[{label:'¬øCu√°les son tus mayores desaf√≠os actuales?'},{label:'¬øC√≥mo lidias con el miedo o la duda?'},{label:'¬øQu√© significa la "luz" para ti?'}],video_after:VIDEO_BASE+'filme-2-dentro-da-jornada.mp4'},
            {title:'Bloque 3 ‚Äî Crecimiento',questions:[{label:'¬øQu√© quieres cambiar en tu vida?'},{label:'¬øQui√©n te inspira y por qu√©?'},{label:'¬øC√≥mo practicas la gratitud en el d√≠a a d√≠a?'}],video_after:VIDEO_BASE+'filme-3-traumas-na-jornada.mp4'},
            {title:'Bloque 4 ‚Äî Integraci√≥n',questions:[{label:'¬øQu√© lecci√≥n te llevas de este viaje?'},{label:'¬øC√≥mo lo aplicar√°s en el futuro?'},{label:'Un mensaje para tu yo futuro.'}],video_after:VIDEO_BASE+'filme-4-aproximando-do-final.mp4'}
          ]
        };

        function updateBlocks(){
          window.JORNADA_BLOCKS=blockTranslations[currentLang]||blockTranslations['pt-BR'];
        }

        /* boot */
        ensureHeaderFlame();
        ensurePageFlames();
        runTyping();
        initJornada();
        showSection('section-intro');
        updateBlocks();
        lockVideoOrientation();
      })();
    </script>
</body>
</html>
