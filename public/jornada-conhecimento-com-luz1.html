<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png">

  <style>
    /* ===== BASE ===== */
    body { margin:0; font-family: Arial, sans-serif; background:#f9f9f9; color:#333; }
    .site-header{display:flex;align-items:center;gap:12px;padding:16px;background:#1f2937;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);position:relative;z-index:1000}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:#f6efe0!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:32px;position:relative;z-index:10}

    /* ===== PERGAMINHO ===== */
    .pergaminho-v{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h{background-image:url('/assets/img/pergaminho-rasgado-horiz.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h.fallback{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important}
    .conteudo-pergaminho{background:transparent!important;position:relative;z-index:20;padding:20px;min-height:100%;overflow:visible}

    /* ===== CHAMA (estilo original) ===== */
    .chama{display:block;position:relative;overflow:hidden;z-index:40;visibility:visible}
    .chama span{position:absolute;bottom:0;width:100%;height:100%;
      background:linear-gradient(to top,#ff4500 0%,#ff8c00 40%,rgba(255,69,0,0) 100%);
      clip-path: polygon(50% 100%, 80% 60%, 70% 40%, 60% 20%, 50% 0%, 40% 20%, 30% 40%, 20% 60%);
      animation: flicker 1.5s infinite;border-radius:2px}
    .chama.chama-sm{display:inline-flex;gap:4px}
    .chama.chama-sm span{width:6px;height:12px;background:#ff4500;animation:flicker 1.5s infinite}
    .chama.chama-sm span:nth-child(2){animation-delay:.2s}
    .chama.chama-sm span:nth-child(3){animation-delay:.4s}
    .chama.chama-weak span{opacity:.5;animation:flicker-weak 2s infinite}
    .chama.chama-strong span{animation:flicker-strong 1s infinite}
    .chama.chama-viva span{animation:flicker-strong .85s infinite;filter:drop-shadow(0 0 12px rgba(255,140,0,.55))}
    .chama.chama-pulse span{animation:flicker-strong .6s infinite}
    .chama.chama-md span{width:22px;height:54px}
    .chama.chama-lg span{width:36px;height:88px}
    .chama-fixed-top{position:absolute;top:10px;right:14px;z-index:60}
    .chama-fixed-hero{position:absolute;top:-8px;left:-8px;z-index:60}

   /* === CHAMA DE VELA — formato refinado (sem vaso) ======================= */
/* base com variáveis */
.chama-viva{
  --altura: 90px;
  --largura: 60px;
  --pulso: 1.7s;
  --glow: 18px;
  --hue: 28;       /* laranja-ouro */
  --satur: 96%;
  --light: 58%;
  --op: .98;

  position: relative;
  width: var(--largura);
  height: var(--altura);
  display: inline-block;
  filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.70));
  z-index: 40;
}

/* tamanhos populares que você já usa */
.chama-viva.chama-md{ --largura:32px; --altura:64px; }
.chama-viva.chama-lg{ --largura:60px; --altura:120px; }

/* brasa (base) */
.chama-viva .brasa{
  position:absolute; left:50%; bottom:2px; transform:translateX(-50%);
  width: calc(var(--largura) * .86);
  height: 12px;
  border-radius: 50%;
  background: radial-gradient(circle at 50% 40%,
    hsla(var(--hue),var(--satur),95%,.95) 0%,
    hsla(var(--hue),var(--satur),70%,.85) 35%,
    transparent 72%);
  filter: blur(1px);
  animation: brasaPulse var(--pulso) ease-in-out infinite;
  opacity: var(--op);
}

/* línguas — formato “gota” com ponta afiada */
.chama-viva .lingua{
  position:absolute; left:50%; bottom:2px; transform:translateX(-50%);
  width: calc(var(--largura) * .96);
  height: calc(var(--altura) * .98);

  /* gota/vela: topo estreito, base arredondada (usa raio elíptico) */
  border-radius: 62% 62% 20% 20% / 94% 94% 16% 16%;

  /* cor e volume (duas camadas) */
  background:
    radial-gradient(48% 58% at 50% 18%,
      hsla(var(--hue),var(--satur),98%,1) 0%,
      hsla(var(--hue),var(--satur),78%,.98) 32%,
      transparent 68%),
    radial-gradient(110% 140% at 50% 72%,
      hsla(calc(var(--hue) - 8),calc(var(--satur) - 12%),50%,.85) 0%,
      transparent 72%);

  mix-blend-mode: screen;
  filter: blur(.45px);
  transform-origin: 50% 100%;
  animation: velaWaver 1.6s ease-in-out infinite;
  opacity: var(--op);

  /* afia a ponta com máscara (suporta webkit/modernos) */
  -webkit-mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%);
          mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%);
}

/* “filete” quente na ponta para parecer vela */
.chama-viva .lingua::after{
  content:"";
  position:absolute; left:50%; top:5%;
  transform:translateX(-50%);
  width: 16%; height: 38%;
  background: radial-gradient(50% 60% at 50% 40%, rgba(255,255,255,.95), rgba(255,255,255,0));
  filter: blur(1px);
  opacity:.95; pointer-events:none;
}

/* camadas internas menores (dão profundidade) */
.chama-viva .lingua:nth-child(2){
  width: calc(var(--largura) * .76);
  height: calc(var(--altura) * .86);
  animation-duration: 1.9s; animation-delay: .05s;
  filter: blur(.35px);
}
.chama-viva .lingua:nth-child(3){
  width: calc(var(--largura) * .60);
  height: calc(var(--altura) * .74);
  animation-duration: 2.2s; animation-delay: .10s;
  filter: blur(.3px);
}

/* brilho/aura ao redor */
.chama-viva .brilho{
  position:absolute; left:50%; bottom:0; transform:translateX(-50%);
  width: calc(var(--largura) * 1.28);
  height: calc(var(--altura) * 1.06);
  background: radial-gradient(circle,
    hsla(var(--hue),var(--satur),72%,.36) 0%,
    transparent 64%);
  filter: blur(12px);
  mix-blend-mode: screen;
  animation: aura var(--pulso) ease-in-out infinite;
  opacity:.62; pointer-events:none;
}

/* pico breve (quando “forte”) */
.chama-viva.chama-pico .lingua{
  animation-timing-function: ease-out;
  transform: translateX(-50%) scaleY(1.12) skewX(1.4deg);
}

/* intensidades emocionais */
.chama-viva[data-intensidade="fraca"]{
  --altura: 72px; --largura: 50px; --pulso: 2.6s; --glow: 10px;
  --hue: 36; --satur: 86%; --light: 66%; --op: .70;
}
.chama-viva[data-intensidade="media"]{
  --altura: 94px; --largura: 60px; --pulso: 1.7s; --glow: 18px;
  --hue: 28; --satur: 96%; --light: 58%; --op: .98;
}
.chama-viva[data-intensidade="forte"]{
  --altura: 112px; --largura: 66px; --pulso: 1.1s; --glow: 28px;
  --hue: 20; --satur: 100%; --light: 52%; --op: 1;
}

/* guia (#chama-bola) com o mesmo “corte” na ponta */
#chama-bola{
  --altura: 84px; --largura: 40px; --pulso:1.5s; --glow:22px; --hue:28; --satur:94%; --light:60%; --op:.95;
  position: relative; width:var(--largura); height:var(--altura); display:inline-block;
  filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.70));
}
#chama-bola .brasa{ /* igual à de cima, ajustada ao tamanho */
  position:absolute; left:50%; bottom:2px; transform:translateX(-50%);
  width: calc(var(--largura) * .84); height: 10px; border-radius: 50%;
  background: radial-gradient(circle at 50% 40%,
    hsla(var(--hue),var(--satur),95%,.95) 0%,
    hsla(var(--hue),var(--satur),70%,.85) 35%,
    transparent 72%);
  filter: blur(.9px); animation: brasaPulse var(--pulso) ease-in-out infinite; opacity:var(--op);
}
#chama-bola .lingua{
  position:absolute; left:50%; bottom:2px; transform:translateX(-50%);
  width: var(--largura); height: calc(var(--altura) * .86);
  border-radius: 60% 60% 18% 18% / 92% 92% 14% 14%;
  background:
    radial-gradient(48% 58% at 50% 18%, rgba(255,255,255,.98) 0%, rgba(255,214,120,.96) 32%, transparent 68%),
    radial-gradient(110% 140% at 50% 72%, rgba(255,140,0,.85) 0%, transparent 72%);
  mix-blend-mode: screen; filter: blur(.45px);
  animation: velaWaver 1.6s ease-in-out infinite; transform-origin:50% 100%; opacity:var(--op);
  -webkit-mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%);
          mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%);
}
#chama-bola .lingua:nth-child(2){ width: calc(var(--largura)*.76); height: calc(var(--altura)*.72); animation-duration:1.9s; animation-delay:.05s; }
#chama-bola .lingua:nth-child(3){ width: calc(var(--largura)*.60); height: calc(var(--altura)*.60); animation-duration:2.2s; animation-delay:.10s; }
#chama-bola .brilho{
  position:absolute; left:50%; bottom:0; transform:translateX(-50%);
  width: calc(var(--largura) * 1.36); height: calc(var(--altura) * 1.18);
  background: radial-gradient(circle, hsla(var(--hue),var(--satur),72%,.36) 0%, transparent 64%);
  filter: blur(11px); mix-blend-mode: screen; animation: aura var(--pulso) ease-in-out infinite; opacity:.66;
}

/* animações */
@keyframes velaWaver{
  0%,100% { transform: translateX(-50%) scaleY(1.00) skewX(0deg); }
  25%     { transform: translateX(calc(-50% + .6px)) scaleY(1.04) skewX(.6deg); }
  50%     { transform: translateX(-50%) scaleY(1.08) skewX(1.2deg); }
  75%     { transform: translateX(calc(-50% - .5px)) scaleY(1.03) skewX(.4deg); }
}
@keyframes brasaPulse{
  0%,100% { transform:translateX(-50%) scale(1);   opacity:.70; }
  50%     { transform:translateX(-50%) scale(1.06); opacity:1;   }
}
@keyframes aura{
  0%,100% { opacity:.50; } 50% { opacity:.82; }
}
/* ====================================================================== */

    /* Intensidades emocionais (por data-atributo) */
    .chama-viva[data-intensidade="fraca"]{
      --altura:70px; --largura:52px; --pulso:2.8s; --glow:8px;
      --hue:40; --satur:80%; --light:65%; --op:.65;
    }
    .chama-viva[data-intensidade="media"]{
      --altura:90px; --largura:60px; --pulso:1.8s; --glow:16px;
      --hue:32; --satur:95%; --light:58%; --op:.95;
    }
    .chama-viva[data-intensidade="forte"]{
      --altura:110px; --largura:66px; --pulso:1.1s; --glow:26px;
      --hue:20; --satur:100%; --light:52%; --op:1;
    }

    /* Respeitar preferências do usuário */
    @media (prefers-reduced-motion: reduce){
      .chama-viva .lingua, .chama-viva .brasa, .chama-viva .brilho{ animation:none !important; }
    }

    /* ===== CHAMA FLAMEJANTE GUIA (#chama-bola) — formato do 2º arquivo (SEM vaso) ===== */
    #chama-bola{
      --altura: 80px; --largura: 40px; --pulso:1.6s; --glow:20px; --hue:28; --satur:90%; --light:60%; --op:.9;
      position: relative; width: var(--largura); height: var(--altura);
      display:inline-block; filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.65));
      z-index:40;
    }
    #chama-bola .brasa{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * .85); height: 12px; border-radius: 50%;
      background:
        radial-gradient(circle at 50% 40%,
          hsla(var(--hue),var(--satur),95%,.9) 0%,
          hsla(var(--hue),var(--satur),70%,.8) 35%,
          hsla(var(--hue),var(--satur),40%,.0) 70%);
      filter: blur(1px); animation: brasaPulse var(--pulso) infinite ease-in-out; opacity: var(--op);
    }
    #chama-bola .lingua{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: var(--largura); height: calc(var(--altura) * .8);
      border-radius:40% 40% 20% 20%;
      background:
        radial-gradient(60% 60% at 50% 30%,
          hsla(var(--hue),var(--satur),98%,1) 0%,
          hsla(var(--hue),var(--satur),70%,.95) 35%,
          hsla(calc(var(--hue) - 10),calc(var(--satur) - 20%),50%,.85) 65%,
          transparent 80%);
      mix-blend-mode: screen; filter: blur(0.5px);
      animation: linguaFlame 1.2s infinite ease-in-out; transform-origin:50% 100%; opacity: var(--op);
    }
    #chama-bola .lingua:nth-child(2){ width: calc(var(--largura)*.75); height: calc(var(--altura)*.7); animation-duration:1.5s; animation-delay:.05s; }
    #chama-bola .lingua:nth-child(3){ width: calc(var(--largura)*.6);  height: calc(var(--altura)*.6); animation-duration:1.8s; animation-delay:.1s; }
    #chama-bola .brilho{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * 1.4); height: calc(var(--altura) * 1.2);
      background: radial-gradient(circle, hsla(var(--hue),var(--satur),70%,.35) 0%, transparent 65%);
      filter: blur(10px); pointer-events:none; mix-blend-mode:screen; animation: auraFlame var(--pulso) infinite ease-in-out; opacity:.7;
    }
    @keyframes linguaFlame{
      0%,100%{ transform: translateX(-50%) scaleY(1) skewX(0deg); }
      50%{    transform: translateX(-50%) scaleY(1.1) skewX(1.5deg); }
    }
    @keyframes auraFlame{
      0%,100%{ opacity:.5; } 50%{ opacity:.9; }
    }
    /* Intensidades para o guia */
    #chama-bola.fraca{ --altura:60px; --largura:35px; --pulso:2.5s; --glow:10px; --hue:40; --satur:80%; --light:65%; --op:.6; }
    #chama-bola.media{ --altura:80px; --largura:40px; --pulso:1.6s; --glow:20px; --hue:28; --satur:90%; --light:60%; --op:.9; }
    #chama-bola.forte{ --altura:100px; --largura:45px; --pulso:1.1s; --glow:30px; --hue:20; --satur:100%; --light:55%; --op:1; }

    /* Destaque palavras */
    .mark-emocao{background:linear-gradient(90deg,rgba(255,196,0,.35),rgba(255,140,0,.2));border-radius:4px;padding:0 2px}

    /* keyframes antigos (usados pela .chama clássica) */
    @keyframes flicker{0%,100%{transform:scaleY(1);opacity:1}50%{transform:scaleY(1.2);opacity:.8}}
    @keyframes flicker-weak{0%,100%{transform:scaleY(.8);opacity:.6}50%{transform:scaleY(1);opacity:.4}}
    @keyframes flicker-strong{0%,100%{transform:scaleY(1.5);opacity:1}50%{transform:scaleY(1.8);opacity:.9}}

    /* ===== UI ===== */
    .btn{display:inline-block;padding:12px 24px;border-radius:10px;border:0;background:#1f2937;color:#fff;font-weight:600;text-decoration:none;transition:background .3s ease, transform .2s ease;z-index:30}
    .btn:hover{background:#374151;transform:scale(1.05)}
    .btn-primary{background:#6b21a8}
    .btn-primary:hover{background:#7c3aed}
    .btn-secondary{background:#4b5563}
    .btn-secondary:hover{background:#6b7280}
    .btn + .btn{margin-left:12px}

    .progress-badge{position:fixed;top:16px;right:16px;padding:8px 16px;background:#6b21a8;color:#fff;border-radius:8px;font-size:.9rem;z-index:900;visibility:visible}
    .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px;z-index:900;visibility:visible}
    .progress-bar-fill{height:100%;background:#6b21a8;border-radius:4px;transition:width .3s ease}
    .j-progress{margin-top:12px;z-index:900;visibility:visible}
    .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
    .j-progress__fill{height:100%;background:#1f2937;border-radius:4px;transition:width .3s ease}
    .j-progress__meta{text-align:center;margin-top:8px;font-size:.9rem}

    .footer-actions{display:flex;gap:12px;justify-content:center;margin:16px 0;z-index:900}

    .lumen-typing{white-space:pre-wrap;position:relative}
    .lumen-typing::after{content:"▌";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .lumen-typing.typing-done::after{content:"";animation:none}
    @keyframes lumenBlink{50%{opacity:0}}

    .j-section{height:100%}
    .j-bloco{background:transparent!important;display:none;z-index:50}
    .j-pergunta{margin-bottom:24px;display:none;z-index:60;position:relative}
    .j-pergunta.active{display:block}
    .pergunta-enunciado{font-weight:600;margin-bottom:8px;display:block}
    .j-pergunta textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;background:rgba(255,255,255,.8);resize:vertical;min-height:100px}

    #videoOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:2000}
    #videoOverlay.hidden{display:none}
    .video-player{max-width:90vw;max-height:80vh;background:#000}

    .site-footer{text-align:center;padding:16px;opacity:.6;font-size:.85rem;z-index:10}
    .password-form{margin-top:20px;text-align:center}
    .password-input{position:relative}
    .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db}
    .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer}

    .section-container{position:relative;min-height:85vh}
    .hidden{display:none!important}

    /* Bola/guia da chama flutuante */
    #guia-espiritual{position:fixed;bottom:20px;right:20px;z-index:1200}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div class="chama chama-sm"><span></span><span></span><span></span></div>
    <h1>Jornada Essencial</h1>
  </header>

  <main id="page-shell" class="container">
    <div class="container">
      <a class="btn btn-primary" href="#intro">Ir para Introdução</a>
      <a class="btn btn-secondary" href="/jornadas.html">← Voltar</a>
    </div>

    <div class="section-container">
      <section id="jornada-canvas" class="card pergaminho pergaminho-v">
        <div id="jornada-conteudo" class="conteudo-pergaminho">
          <!-- INTRO -->
          <div id="section-intro" class="j-section">
            <!-- Hero será injetado pela API de chama -->
            <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
            <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, ative sua senha." data-speed="50" data-cursor="true"></p>

            <div class="password-form">
              <h3>Ative sua Senha</h3>
              <div class="password-input">
                <input type="password" id="senha" placeholder="Digite sua senha...">
                <span class="password-toggle" data-action="toggle-password">👁️</span>
              </div>
              <button class="btn btn-primary" data-action="start">Ativar e Iniciar</button>
            </div>
          </div>

          <!-- PERGUNTAS -->
          <div id="section-perguntas" class="j-section hidden">
            <div class="chama chama-md" id="chama-perguntas"><span></span></div>
            <div id="perguntas-container"></div>
            <div class="footer-actions">              
              <button id="btnNextPerguntas" class="btn btn-primary" data-action="next">Próxima</button>
            </div>
          </div>

          <!-- FINAL -->
          <div id="section-final" class="j-section hidden">
            <!-- Hero será injetado pela API de chama -->
            <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
            <div class="footer-actions">
              <button id="btnRestart" class="btn btn-secondary" data-action="restart">Reiniciar</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer class="site-footer">
      <small>© 2025 Irmandade Conhecimento com Luz</small>
      <div id="envTag"></div>
    </footer>
  </main>

  <!-- PROGRESS -->
  <div class="progress-badge" id="jprog-pct">0% concluído</div>
  <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  <div class="j-progress">
    <div class="j-progress__bar"><div class="j-progress__fill"></div></div>
    <div class="j-progress__meta" id="j-meta"></div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="video-overlay hidden">
    <video id="videoTransicao" class="video-player" playsinline preload="metadata" controls></video>
    <button id="skipVideo" class="btn btn-secondary" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

  <!-- GUIA ESPIRITUAL: chama flamejante livre -->
  <div id="guia-espiritual">
    <div id="chama-bola" class="chama-viva chama-md">
      <div class="brasa"></div>
      <div class="lingua"></div>
      <div class="lingua"></div>
      <div class="lingua"></div>
      <div class="brilho"></div>
    </div>
  </div>

  <script>
    // Tag ambiente
    document.getElementById('envTag').textContent =
      `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/public`;

    /* =========================
       EMOÇÃO & DATILOGRAFIA
    ==========================*/
    const EMO = {
      POS:{'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperança':3,'paz':2,'fé':3,'gratidão':2,'vitória':3,'superação':3,'luz':2,'deus':3,'coragem':2,'força':2,'confiança':2,'propósito':3},
      NEG:{'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustração':-2,'decepcao':-2,'decepção':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solidão':-2,'desespero':-3,'cansaco':-2,'cansaço':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'dúvida':-2}
    };
    function analyzeSentiment(text){
      let score=0;
      const tokens=(text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/\s+/);
      for(const t of tokens){ if(EMO.POS[t]!=null) score+=EMO.POS[t]; if(EMO.NEG[t]!=null) score+=EMO.NEG[t]; }
      return score;
    }
    function typeWriter(el,text,speed,showCursor){
      if(!el) return;
      el.textContent=''; if(showCursor) el.classList.add('lumen-typing');
      let i=0;(function step(){ if(i<text.length){ el.textContent+=text.charAt(i++); setTimeout(step,speed);} else{ el.classList.add('typing-done'); } })();
    }
    function runTyping(root){
      (root||document).querySelectorAll('[data-typing]').forEach(el=>{
        if(el.dataset._typed) return;
        const t=el.getAttribute('data-text')||el.textContent||'';
        const spd=parseInt(el.getAttribute('data-speed')||'26',10);
        const cur=String(el.getAttribute('data-cursor')||'true')==='true';
        el.dataset._typed='1'; typeWriter(el,t,spd,cur);
      });
    }

    /* =========================
       CHAMA — API unificada (traz do arquivo 2)
    ==========================*/
    window.JORNADA_CHAMA = {
      updateChama(scoreNum, targetId='chama-perguntas'){
        const el=document.getElementById(targetId); if(!el) return;
        // se ainda for a chama simples, converte para estrutura viva
        if(!el.classList.contains('chama-viva')){
          el.classList.add('chama-viva');
          el.innerHTML = '<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
        }
        const modo = (scoreNum <= -2) ? 'fraca' : (scoreNum >= 2) ? 'forte' : 'media';
        el.dataset.intensidade = modo;
        // efeito pico
        el.classList.add('chama-pico');
        clearTimeout(el._pulse_t);
        el._pulse_t=setTimeout(()=>el.classList.remove('chama-pico'),700);
        // guia flutuante acompanha
        const bola=document.getElementById('chama-bola');
        if(bola){ bola.classList.add('chama-viva'); bola.dataset.intensidade=modo; }
      },
      ensureHeroFlame(sectionId){
        const canvas=document.getElementById('jornada-canvas'); if(!canvas) return;
        let hero=document.getElementById('chama-hero');
        const show=(sectionId==='section-intro'||sectionId==='section-final');
        if(show){
          if(!hero){
            hero=document.createElement('div'); hero.id='chama-hero';
            hero.className='chama-viva chama-lg chama-strong chama-fixed-top';
            hero.innerHTML='<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
            canvas.appendChild(hero);
          }
        } else if(hero){ hero.remove(); }
      }
    };
    // compat: mapear funções antigas
    function updateChama(score){ window.JORNADA_CHAMA.updateChama(score); }
    function ensureHeroFlame(sectionId){ window.JORNADA_CHAMA.ensureHeroFlame(sectionId); }

    /* =========================
       PROGRESSO & STORAGE
    ==========================*/
    function updateProgress(){
      const perguntas=document.querySelectorAll('.j-pergunta');
      const respondidas=Array.from(perguntas).filter(p=>p.querySelector('textarea').value.trim()!=='').length;
      const progresso=(respondidas/(perguntas.length||1))*100;
      const fill=document.getElementById('jprog-fill');
      const badge=document.getElementById('jprog-pct');
      const jFill=document.querySelector('.j-progress__fill');
      const jMeta=document.getElementById('j-meta');
      if(fill) fill.style.width=`${progresso}%`;
      if(badge) badge.textContent=`${Math.round(progresso)}% concluído`;
      if(jFill) jFill.style.width=`${progresso}%`;
      if(jMeta) jMeta.textContent=`Respondidas: ${respondidas} de ${perguntas.length}`;
    }
    function saveAnswers(){
      const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
      localStorage.setItem('jornada_respostas',JSON.stringify(respostas));
    }
    function loadAnswers(){
      const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
      document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ input.value=respostas[`q${idx}`]||''; });
      updateProgress();
    }

    /* =========================
       ROTEAMENTO & RENDER
    ==========================*/
    function updateCanvasBackground(sectionId){
      const canvas=document.getElementById('jornada-canvas');
      if(canvas){
        if(sectionId==='section-perguntas'){
          checkImage('/assets/img/pergaminho-rasgado-horiz.png','/assets/img/pergaminho-rasgado-vert.png').then(bg=>{
            canvas.className=`card pergaminho pergaminho-h${bg.includes('vert')?' fallback':''}`;
            canvas.style.backgroundImage=`url('${bg}')`;
          });
        } else {
          canvas.className='card pergaminho pergaminho-v';
          canvas.style.backgroundImage='url(/assets/img/pergaminho-rasgado-vert.png)';
        }
      }
    }
    function showSection(sectionId){
      document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
      const active=document.getElementById(sectionId); if(active) active.classList.remove('hidden');
      updateCanvasBackground(sectionId); ensureHeroFlame(sectionId);
      if(sectionId==='section-perguntas'){
        updateProgress();
        const perguntas=document.querySelectorAll('.j-pergunta'); if(perguntas.length) runTyping(perguntas[0]);
      }
    }

    function loadDynamicBlocks(){
      const content=document.getElementById('perguntas-container');
      if(content && window.JORNADA_BLOCKS){
        content.innerHTML='';
        window.JORNADA_BLOCKS.forEach((block,idx)=>{
          const bloco=document.createElement('section'); bloco.className='j-bloco'; bloco.dataset.bloco=idx; bloco.dataset.video=block.video_after||'';
          block.questions.forEach((q,qIdx)=>{
            const pergunta=document.createElement('div'); pergunta.className='j-pergunta'; pergunta.dataset.pergunta=qIdx;
            const label = (typeof q === 'string') ? q : (q.label || q.text || '');
            pergunta.innerHTML=`<label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx+1}:</b> ${label}" data-speed="40" data-cursor="true"></label>
              <textarea rows="4" class="input" placeholder="Digite sua resposta..." oninput="handleInput(this)"></textarea>`;
            bloco.appendChild(pergunta);
          });
          content.appendChild(bloco);
        });
        const firstBloco=content.querySelector('.j-bloco'); if(firstBloco){ firstBloco.style.display='block';
          const firstPergunta=firstBloco.querySelector('.j-pergunta'); if(firstPergunta){ firstPergunta.classList.add('active'); runTyping(firstPergunta); }
          loadAnswers();
          const firstTa=content.querySelector('.j-bloco .j-pergunta textarea'); if(firstTa) handleInput(firstTa);
        }
        console.log('Blocos carregados!');
      } else {
        console.error('Erro: #perguntas-container ou JORNADA_BLOCKS não encontrado!');
      }
    }

    function checkImage(url,fallbackUrl){
      return new Promise(resolve=>{
        const img=new Image(); img.onload=()=>resolve(url); img.onerror=()=>resolve(fallbackUrl); img.src=url;
      });
    }

    /* =========================
       CONTROLES
    ==========================*/
    function handleInput(textarea){ const score=analyzeSentiment(textarea.value); updateChama(score); saveAnswers(); updateProgress(); }
    function toggleSenha(){ const input=document.getElementById('senha'); if(input){ input.type=(input.type==='password'?'text':'password'); } }

    function goNext(){
      const perguntas=document.querySelectorAll('.j-pergunta');
      const current=document.querySelector('.j-pergunta.active');
      if(current) current.classList.remove('active');
      const nextIndex=Array.from(perguntas).indexOf(current)+1;
      if(nextIndex<perguntas.length){
        perguntas[nextIndex].classList.add('active'); runTyping(perguntas[nextIndex]); updateProgress();
      } else {
        const blocos=document.querySelectorAll('.j-bloco');
        const currentBloco=current?.closest('.j-bloco'); const nextBlocoIndex=Array.from(blocos).indexOf(currentBloco)+1;
        if(nextBlocoIndex<blocos.length){
          const currentIdx = Number(currentBloco.dataset.bloco||0);
          const videoSrc = (window.JORNADA_BLOCKS[currentIdx]?.video_after)||'';
          blocos.forEach(b=>b.style.display='none'); blocos[nextBlocoIndex].style.display='block';
          const nextPergunta=blocos[nextBlocoIndex].querySelector('.j-pergunta');
          const proceed = ()=>{ if(nextPergunta){ nextPergunta.classList.add('active'); runTyping(nextPergunta); } };
          if(videoSrc) playTransition(videoSrc, proceed); else proceed();
        } else { if(window.JORNADA_FINAL_VIDEO) playTransition(window.JORNADA_FINAL_VIDEO, ()=>showSection('section-final')); else { showSection('section-final'); } updateProgress(); }
      }
    }
    function goPrev(){
      const perguntas=document.querySelectorAll('.j-pergunta');
      const current=document.querySelector('.j-pergunta.active');
      if(current) current.classList.remove('active');
      const prevIndex=Array.from(perguntas).indexOf(current)-1;
      if(prevIndex>=0){
        perguntas[prevIndex].classList.add('active'); runTyping(perguntas[prevIndex]); updateProgress();
      } else {
        const blocos=document.querySelectorAll('.j-bloco');
        const currentBloco=current?.closest('.j-bloco'); const prevBlocoIndex=Array.from(blocos).indexOf(currentBloco)-1;
        if(prevBlocoIndex>=0){
          blocos.forEach(b=>b.style.display='none'); blocos[prevBlocoIndex].style.display='block';
          const lastPergunta=Array.from(blocos[prevBlocoIndex].querySelectorAll('.j-pergunta')).pop();
          if(lastPergunta){ lastPergunta.classList.add('active'); runTyping(lastPergunta); }
        } else { showSection('section-intro'); }
        updateProgress();
      }
    }

    function playTransition(src,onEnd){
      const overlay=document.getElementById('videoOverlay');
      const video=document.getElementById('videoTransicao');
      const skip=document.getElementById('skipVideo');
      if(overlay && video && src){
        video.src=src; overlay.classList.remove('hidden');
        const cleanup=()=>{ try{video.pause();}catch(e){} overlay.classList.add('hidden'); video.removeAttribute('src'); video.load(); onEnd&&onEnd(); };
        video.onended=cleanup;
        video.onerror=()=>{ console.warn('Vídeo não carregou:',src); cleanup(); };
        if(skip) skip.onclick=cleanup;
        video.muted=false;
        video.play().catch(err=>{ console.warn('Erro ao reproduzir vídeo:',err); cleanup(); });
        setTimeout(cleanup,12000);
      } else { onEnd&&onEnd(); }
    }

    function finalize(){
      const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
      console.log('[JORNADA] Finalizado. Respostas:', respostas);
      alert('Jornada concluída!'); localStorage.removeItem('jornada_respostas');
      setTimeout(()=>location.replace('/index.html'),1000);
    }

    function startJourney(){
      const senha=document.getElementById('senha')?.value || '';
      const senhasValidas=['iniciar','olho magico','olho mágico'];
      if(senhasValidas.includes(senha.toLowerCase())){      
        (window.showSection||showSection)('section-perguntas');        
        loadDynamicBlocks();
        const perguntas=document.querySelectorAll('.j-pergunta');
        if(perguntas.length){
          perguntas[0].classList.add('active'); runTyping(perguntas[0]);
          const firstTa=document.querySelector('.j-pergunta.active textarea'); if(firstTa) handleInput(firstTa);
        } else { console.error('Nenhuma pergunta encontrada após loadDynamicBlocks!'); }
        document.querySelector('.progress-badge')?.classList.remove('hidden');
        document.querySelector('.progress-bar')?.classList.remove('hidden');
        document.querySelector('.j-progress')?.classList.remove('hidden');
        document.querySelector('.footer-actions')?.classList.remove('hidden');
        updateProgress(); console.log('Jornada iniciada com sucesso!');
      } else { alert('Senha incorreta. Tente novamente.'); }
    }

    function initJornada(){
      const prevBtn=document.getElementById('btnPrevPerguntas');
      const nextBtn=document.getElementById('btnNextPerguntas');
      const restartBtn=document.getElementById('btnRestart');
      if(nextBtn) nextBtn.addEventListener('click', goNext);
      if(prevBtn) prevBtn.addEventListener('click', goPrev);
      if(restartBtn) restartBtn.addEventListener('click', ()=>location.reload());

      // Delegação de cliques (sem onclick no HTML)
      document.addEventListener('click',(ev)=>{
        const n = ev.target.closest('[data-action="next"]');
        const p = ev.target.closest('[data-action="prev"]');
        const s = ev.target.closest('[data-action="start"]');
        const tp= ev.target.closest('[data-action="toggle-password"], .password-toggle');
        if(n){ev.preventDefault();goNext();}
        if(p){ev.preventDefault();goPrev();}
        if(s){ev.preventDefault();startJourney();}
        if(tp){ev.preventDefault();toggleSenha();}
      });

      console.log('Controlador da jornada inicializado!');
    }

    // Fallback/blocos + vídeos padronizados
    (function defineFallback(){
      window.JORNADA_BLOCKS=[
        { title:'Bloco 1 — Raízes', questions:[ 'Quem é você hoje?', 'O que a Luz te pede agora?' ], video_after:'/assets/img/filme-1-entrando-na-jornada.mp4' },
        { title:'Bloco 2 — Caminho', questions:[ 'Qual verdade você precisa admitir para seguir?', 'O que precisa ser curado neste momento?' ], video_after:'/assets/img/filme-2-dentro-da-jornada.mp4' }
      ];
      window.JORNADA_FINAL_VIDEO='/assets/img/filme-5-fim-da-jornada.mp4';
      console.log('JORNADA_BLOCKS (fallback) prontos.');
    })();

    async function boot(){
      document.body.classList.add('jornada-active');
      const route=(location.hash||'#intro').slice(1);
      const canvas=document.getElementById('jornada-canvas');
      const progressBadge=document.querySelector('.progress-badge');
      const progressBar=document.querySelector('.progress-bar');
      const jProgress=document.querySelector('.j-progress');
      const footerActions=document.querySelector('.footer-actions');

      if(canvas){
        if(route==='perguntas'){
          showSection('section-perguntas'); loadDynamicBlocks();
          [progressBadge,progressBar,jProgress,footerActions].forEach(el=>el?.classList.remove('hidden'));
        } else if(route==='final'){
          showSection('section-final'); [progressBadge,progressBar,jProgress].forEach(el=>el?.classList.remove('hidden'));
        } else { showSection('section-intro'); }
      }
      runTyping(document); return true;
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      runTyping(document);
      initJornada();

      boot().then(() => {
        const visible = document.querySelector('.j-section:not(.hidden)');
        if (visible) ensureHeroFlame(visible.id);
      });

      const target = document.getElementById('jornada-conteudo');
      if (target) {
        const obs = new MutationObserver(muts => {
          muts.forEach(m => {
            runTyping(m.target);
            if (m.target.id === 'perguntas-container') updateProgress();
          });
        });
        window.ensureHeroFlame = ensureHeroFlame;
        obs.observe(target, { childList: true, subtree: true });
      }
    });

    // Ponte global
    window.JC = window.JC || {};
    window.toggleSenha  = toggleSenha;
    window.startJourney = startJourney;
    window.showSection  = showSection;
    window.JC.toggleSenha  = toggleSenha;
    window.JC.startJourney = startJourney;
    window.JC.showSection  = showSection;
    window.JC.Chama = window.JORNADA_CHAMA;
    
 // === VÍDEOS DA JORNADA ====================================================
const VIDEO_BASE = '/assets/img/'; // se seus arquivos exigirem /public, troque para '/public/assets/img/'

window.JORNADA_VIDEOS = {
  intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
  afterBlocks: {
    0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4',
    1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4'
  },
  final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
};

// === Garantir video_after + normalizar perguntas (strings -> {label}) ===
(function ensureBlocksAndFinal(){
  // Fallback se não vier nada de fora
  var fallback = [
    {
      title: 'Bloco 1 — Raízes',
      questions: [
        { label: 'Quem é você hoje?' },
        { label: 'O que a Luz te pede agora?' }
      ],
      video_after: window.JORNADA_VIDEOS.afterBlocks[0]
    },
    {
      title: 'Bloco 2 — Caminho',
      questions: [
        { label: 'Qual verdade você precisa admitir para seguir?' },
        { label: 'O que precisa ser curado neste momento?' }
      ],
      video_after: window.JORNADA_VIDEOS.afterBlocks[1]
    }
  ];

  // Usa os blocos existentes OU o fallback acima
  var blocks = window.JORNADA_BLOCKS || fallback;

  // Normaliza perguntas e completa video_after quando faltar
  window.JORNADA_BLOCKS = blocks.map(function(block, idx){
    var qs = (block.questions || []).map(function(q){
      if (typeof q === 'string') return { label: q };
      if (q && typeof q === 'object') {
        if ('label' in q) return { label: q.label || '' };
        if ('text'  in q) return { label: q.text  || '' };
      }
      return { label: String(q || '') };
    });

    return Object.assign({}, block, {
      questions: qs,
      video_after: block.video_after || (window.JORNADA_VIDEOS && window.JORNADA_VIDEOS.afterBlocks
                    ? window.JORNADA_VIDEOS.afterBlocks[idx] : undefined)
    });
  });

  // Vídeo final garantido
  if (!window.JORNADA_FINAL_VIDEO && window.JORNADA_VIDEOS && window.JORNADA_VIDEOS.final){
    window.JORNADA_FINAL_VIDEO = window.JORNADA_VIDEOS.final;
  }

  console.log('JORNADA_BLOCKS normalizados:', window.JORNADA_BLOCKS);
})();


// === FILME 0: tocar 1x antes de iniciar (intercepta o 1º clique em [data-action="start"])
;(() => {
  if (typeof window.playTransition !== 'function') {
    console.warn('[Filme0] playTransition indisponível (não vou interceptar).');
    return;
  }
  if (typeof window.startJourney !== 'function') {
    console.warn('[Filme0] startJourney indisponível ainda.');
    return;
  }

  let once = false;

  document.addEventListener(
    'click',
    function onClickStart(ev) {
      const btn = ev.target.closest('[data-action="start"]');
      if (!btn || once) return;

      once = true;                // roda só uma vez
      ev.preventDefault();
      ev.stopPropagation();

      try {
        playTransition(window.JORNADA_VIDEOS.intro, () => {
          try { window.startJourney(); }
          catch (e) { console.error('[Filme0] erro ao chamar startJourney:', e); }
        });
      } catch (e) {
        console.error('[Filme0] falha ao iniciar vídeo 0:', e);
        try { window.startJourney(); } catch (_) {}
      }
    },
    true // CAPTURA: intercepta antes dos outros handlers
  );

  console.log('[Filme0] hook instalado.');
})(); // <-- NÃO REMOVER
  </script>
  <script>
;(() => {
  if (typeof window.playTransition !== 'function') {
    console.warn('[PatchVideo] playTransition não encontrado.');
    return;
  }

  const ORIG = window.playTransition;

  function overlayVisivel(){
    const ov = document.getElementById('videoOverlay');
    return ov && !ov.classList.contains('hidden');
  }

  function silenciarDuranteVideo(){
    const origAlert   = window.alert;
    const origConfirm = window.confirm;
    const origPrompt  = window.prompt;

    window.alert = function(msg){
      if (overlayVisivel()) { console.warn('[alert suprimido durante vídeo]:', msg); return; }
      return origAlert(msg);
    };
    window.confirm = function(msg){
      if (overlayVisivel()) { console.warn('[confirm suprimido durante vídeo]:', msg); return false; }
      return origConfirm(msg);
    };
    window.prompt = function(msg, def){
      if (overlayVisivel()) { console.warn('[prompt suprimido durante vídeo]:', msg); return null; }
      return origPrompt(msg, def);
    };

    return () => {
      window.alert   = origAlert;
      window.confirm = origConfirm;
      window.prompt  = origPrompt;
    };
  }

  // Wrapper: só silencia no vídeo FINAL
  window.playTransition = function(src, onEnd){
    const isFinal = (window.JORNADA_FINAL_VIDEO && src === window.JORNADA_FINAL_VIDEO);
    let restore = null;

    if (isFinal) restore = silenciarDuranteVideo();

    ORIG(src, function(){
      try { if (restore) restore(); } catch(e){}
      try { onEnd && onEnd(); } catch(e){}
    });

    // Failsafe: restaura em 20s mesmo se algo der errado
    if (isFinal) setTimeout(() => { try { restore && restore(); } catch(_){} }, 20000);
  };
})();
    <script>
;(() => {
  if (typeof window.showSection !== 'function' || typeof window.playTransition !== 'function') {
    console.warn('[FinalLock] showSection/playTransition indisponível.');
    return;
  }

  // 1) Wrap de showSection: respeita um lock temporário para a página final
  const _origShow = window.showSection;
  const LOCK_MS = 1500;           // tempo de proteção após o vídeo final (1.5s)
  let ROUTE_LOCK_UNTIL = 0;

  window.showSection = function(sectionId){
    const locked = Date.now() < ROUTE_LOCK_UNTIL;
    // Se estamos protegendo o final, ignore tentativas de trocar para outra seção
    if (locked && sectionId !== 'section-final') {
      console.warn('[FinalLock] Ignorando troca de seção durante lock:', sectionId);
      return;
    }
    return _origShow.apply(this, arguments);
  };

  // 2) Wrap de playTransition: quando for o vídeo final, fixa hash e ativa lock
  const _origPlay = window.playTransition;
  window.playTransition = function(src, onEnd){
    const isFinal = (window.JORNADA_FINAL_VIDEO && src === window.JORNADA_FINAL_VIDEO);

    return _origPlay(src, function(){
      if (isFinal) {
        // fixa rota e mostra final imediatamente
        try { location.hash = '#final'; } catch(_) {}
        ROUTE_LOCK_UNTIL = Date.now() + LOCK_MS;
        try { _origShow('section-final'); } catch(_) {}
      }
      try { onEnd && onEnd(); } catch(_) {}
    });
  };
})();
<script>
<script>
;(() => {
  if (typeof window.gerarPDFEHQ !== 'function') return;
  const original = window.gerarPDFEHQ;
  window.gerarPDFEHQ = async function(...args){
    console.warn('[API] gerarPDFEHQ desativado temporariamente (staging).');
    // resolvemos rápido para não bloquear o fluxo
    return { ok:false, skipped:true };
  };
})();
<script>
</script>
      
  <!-- Referências externas (mantidas para evitar 404, mas não necessárias) -->
  <script defer src="/config.js" onerror="console.error('Falha ao carregar config.js, usando fallback inline');"></script>
  <script defer src="/jornada-utils.js" onerror="console.error('Falha ao carregar jornada-utils.js, usando fallback inline');"></script>
  <script defer src="/jornada-core.js" onerror="console.error('Falha ao carregar jornada-core.js, usando fallback inline');"></script>
  <script defer src="/jornada-auth.js" onerror="console.error('Falha ao carregar jornada-auth.js, usando fallback inline');"></script>
  <script defer src="/jornada-chama.js" onerror="console.error('Falha ao carregar jornada-chama.js, usando fallback inline');"></script>
  <script defer src="/jornada-paper-qa.js" onerror="console.error('Falha ao carregar jornada-paper-qa.js, usando fallback inline');"></script>
  <script defer src="/jornada-typing.js" onerror="console.error('Falha ao carregar jornada-typing.js, usando fallback inline');"></script>
  <script defer src="/jornada-controller.js" onerror="console.error('Falha ao carregar jornada-controller.js, usando fallback inline');"></script>
  <script defer src="/jornada-progress-inline.js"="console.error('Falha ao carregar jornada-progress-inline.js, usando fallback inline');"></script>
  <script defer src="/jornada-render.js" onerror="console.error('Falha ao carregar jornada-render.js, usando fallback inline');"></script>
  <script defer src="/jornada-bootstrap.js" onerror="console.error('Falha ao carregar jornada-bootstrap.js, usando fallback inline');"></script>
  <script defer src="/jornada-micro.js" onerror="console.error('Falha ao carregar jornada-micro.js, usando fallback inline');"></script>
  <script defer src="/i18n/i18n.js" onerror="console.error('Falha ao carregar i18n.js, usando fallback inline');"></script>
  <script defer src="/api.js" onerror="console.error('Falha ao carregar api.js, usando fallback inline');"></script>
</body>
</html>
