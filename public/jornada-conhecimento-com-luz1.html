<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada Conhecimento com Luz ‚Äî Essencial</title>
  <meta name="description" content="Jornada Conhecimento com Luz ‚Äî Essencial. Responda com sinceridade e baixe seu PDF ao final.">
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">

  <!-- Tailwind via CDN (garante estilo mesmo sem build) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- (Opcional) Seu CSS adicional -->
  <link rel="stylesheet" href="/assets/styles.css">

  <!-- √çcones Lucide -->
  <script defer src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gradient-to-br from-gray-950 via-gray-900 to-gray-800 text-gray-100 antialiased selection:bg-yellow-500/30">

<header class="fixed top-0 inset-x-0 z-50 backdrop-blur bg-gray-900/70 border-b border-white/10">
  <nav class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
    <a href="/index.html" class="flex items-center gap-2">
      <img src="/assets/logo.svg" alt="Logo Irmandade" class="h-7 w-7">
      <span class="font-bold text-white">Irmandade Conhecimento com Luz</span>
    </a>
    <span class="text-xs text-gray-300">Jornada Essencial</span>
  </nav>
</header>

<main class="pt-24">
  <!-- Aviso legal -->
  <section class="max-w-3xl mx-auto px-4">
    <div class="rounded-2xl border border-yellow-400/30 bg-yellow-400/10 p-4 text-sm text-yellow-200">
      <p class="font-semibold mb-1">üõ°Ô∏è Aviso Importante</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>Suas respostas ser√£o usadas apenas para gerar um PDF exclusivo.</li>
        <li>O PDF <u>n√£o</u> √© enviado por e-mail ‚Äî fa√ßa o download ao final.</li>
        <li>Ap√≥s o download, os dados s√£o limpos deste dispositivo.</li>
        <li>O acesso √© protegido por senha (validade: 15 dias para iniciar e 24h para concluir ap√≥s o in√≠cio).</li>
      </ul>
    </div>
  </section>

  <!-- Container das perguntas -->
  <section class="max-w-3xl mx-auto px-4 mt-8">
    <div id="feedback" class="hidden rounded-xl p-4 mb-4 text-sm"></div>
    <div id="area-jornada" class="hidden">
      <h1 class="text-2xl font-extrabold tracking-wide mb-4">
        Jornada Conhecimento com Luz ‚Äî <span class="text-yellow-300">Essencial</span>
      </h1>
      <div id="lista-perguntas"></div>
    </div>
  </section>

  <!-- Respiro antes do rodap√© fixo -->
  <div class="h-24"></div>
</main>
  
<!-- Painel fixo (senha + a√ß√µes) -->
<div id="painel-controles"
     class="fixed bottom-0 left-0 right-0 z-40 bg-gray-900/95 border-t border-white/10 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
    <div class="flex items-center gap-3">
      <label for="senha" class="text-sm text-gray-300">Senha de acesso</label>
      <input id="senha" type="password" placeholder="Digite sua senha"
             class="rounded-lg bg-gray-800 border border-white/10 px-3 py-2 text-sm w-56" />
    </div>
    <div class="flex gap-3">
  <button id="btnIniciar"
          class="px-4 py-2 rounded-xl bg-yellow-400 text-gray-900 font-semibold hover:bg-yellow-300">
    Iniciar
  </button>
  <button id="btnLimpar"
          class="px-4 py-2 rounded-xl border border-yellow-400/50 text-yellow-300 hover:bg-yellow-400/10"
          disabled>
    Limpar respostas
  </button>
  <button id="btnEnviar"
          class="px-4 py-2 rounded-xl bg-yellow-400/60 text-gray-900 font-semibold"
          disabled>
    Enviar respostas
  </button>
</div>
    
<!-- Ajuste de espa√ßo para o painel fixo -->
<script>
  (function padBottomForFooter() {
    const painel = document.getElementById('painel-controles');
    function ajusta() {
      const h = painel?.getBoundingClientRect().height || 80;
      document.body.style.paddingBottom = (h + 16) + 'px';
    }
    window.addEventListener('load', ajusta);
    window.addEventListener('resize', ajusta);
    setTimeout(ajusta, 0);
  })();
</script>

<script>
  // === LISTA OFICIAL DE PERGUNTAS (32) ===
  const PERGUNTAS = [
    // BLOCO 1 ‚Äì Reflex√µes da Alma e da Exist√™ncia (10)
    "Como voc√™ tem percebido sua pr√≥pria vida at√© aqui?",
    "E a vida das pessoas ao seu redor, como voc√™ a enxerga?",
    "Como lida com seus traumas? Consegue falar sobre eles?",
    "Voc√™ acredita que a verdade existe ou tudo √© relativo? Explique.",
    "O que significa a doen√ßa para voc√™? Est√° enfrentando alguma? Fale livremente.",
    "H√° algu√©m que voc√™ gostaria de ter ao seu lado agora? Quem √© essa pessoa e por que ela n√£o est√°?",
    "Qual √© o seu maior v√≠cio? Por que voc√™ acha que ele surgiu? J√° tentou venc√™-lo?",
    "Sente que tem outros v√≠cios, mesmo que sutis ou emocionais? Quais?",
    "Como voc√™ percebe a morte? Ela te assusta, conforta ou provoca curiosidade?",
    "Voc√™ acredita em continuidade ap√≥s a morte? O que imagina que exista?",

    // BLOCO 2 ‚Äì Ra√≠zes e Experi√™ncias de Vida (8)
    "Com quem foi criado: ambos os pais biol√≥gicos, s√≥ um dos pais biol√≥gicos (div√≥rcio ou morte), pais afetivos (ado√ß√£o) ou parentes?",
    "√â filho √∫nico?",
    "Quantos irm√£os tem? √â primog√™nito, do meio ou ca√ßula?",
    "Passou fome quando crian√ßa?",
    "N√≠vel de escolaridade e forma√ß√£o acad√™mica.",
    "Estado civil: solteiro, namorando, casado, divorciado, vi√∫vo?",
    "Tem alguma defici√™ncia f√≠sica?",
    "Voc√™ j√° sofreu algum tipo de preconceito? Foi superado ou ainda interfere nas suas decis√µes?",

    // BLOCO 3 ‚Äì Futuro e Prop√≥sito (5)
    "Quais s√£o os seus maiores sonhos para o futuro?",
    "O que voc√™ considera essencial para ter uma vida plena?",
    "Se pudesse mudar algo na sociedade, o que mudaria?",
    "Qual legado gostaria de deixar?",
    "Se pudesse passar uma mensagem para o mundo inteiro agora, qual seria?",

    // BLOCO 4 ‚Äì Jornada Iluminada (9)
    "Voc√™ se recorda da idade em que, pela primeira vez, percebeu que era algu√©m neste mundo?",
    "Se encontrasse seu 'eu' de 10 anos atr√°s, o que diria?",
    "O que significa f√© para voc√™?",
    "J√° teve alguma experi√™ncia que mudou sua forma de ver a vida?",
    "Quais pessoas mais marcaram sua caminhada? Por qu√™?",
    "Voc√™ acredita que tudo tem um prop√≥sito?",
    "Se pudesse receber uma resposta direta de Deus agora, qual pergunta faria?",
    "Que h√°bito voc√™ pode iniciar hoje que te aproximaria do seu prop√≥sito?",
    "Qual √© a decis√£o corajosa que voc√™ vem adiando e precisa tomar?"
  ];

  // T√≠tulos por bloco (√≠ndices de in√≠cio)
  const BLOCO_TITULOS = {
    0: "Reflex√µes da Alma e da Exist√™ncia",
    10: "Ra√≠zes e Experi√™ncias de Vida",
    18: "Futuro e Prop√≥sito",
    23: "Jornada Iluminada"
  };

  // Renderiza√ß√£o
  const lista = document.getElementById("lista-perguntas");
  const parts = [];
  PERGUNTAS.forEach((texto, i) => {
    if (BLOCO_TITULOS[i]) {
      parts.push(`
        <h3 class="mt-10 mb-4 text-xl font-extrabold tracking-wide text-yellow-300">
          ${BLOCO_TITULOS[i]}
        </h3>
      `);
    }
    parts.push(`
      <div class="mb-6 rounded-2xl bg-white/5 p-4 border border-white/10">
        <label class="block font-semibold mb-2 break-words">${i + 1}. ${texto}</label>
        <textarea name="q${i + 1}" rows="4"
          class="w-full min-h-[110px] rounded-xl bg-gray-900/60 border border-white/10 p-3"
          placeholder="Escreva com sinceridade..."></textarea>
      </div>
    `);
  });
  lista.innerHTML = parts.join("");
  
<script>
  // === CONFIG com fallback ===
  const APIS = [
    'https://conhecimento-com-luz-api.onrender.com', // principal
    'https://lumen-backend-api.onrender.com'          // backup
  ];
  const MIN_CAMPOS = 10;
  const KEY_PREFIX = 'jornada_essencial_';

  // === Helpers ===
  const campos = () => Array.from(document.querySelectorAll('textarea[name^="q"]'));

  function mostrarFeedback(mensagem, tipo = 'erro') {
    const el = document.getElementById('feedback');
    el.className = `rounded-xl p-4 mb-4 text-sm ${
      tipo === 'sucesso' ? 'bg-green-500/20 text-green-200' : 'bg-red-500/20 text-red-200'
    }`;
    el.textContent = mensagem;
    el.classList.remove('hidden');
    setTimeout(() => el.classList.add('hidden'), 5000);
  }

  // Auto-save local
  function salvarAuto() { campos().forEach((t, i) => localStorage.setItem(KEY_PREFIX + (i + 1), t.value)); }
  function restaurarAuto() { campos().forEach((t, i) => { const v = localStorage.getItem(KEY_PREFIX + (i + 1)); if (v) t.value = v; }); }

  // started_at (primeiro acesso)
  (function ensureStartedAt(){
    const k = KEY_PREFIX + 'started_at';
    if (!localStorage.getItem(k)) localStorage.setItem(k, new Date().toISOString());
  })();

  // Restaura e registra autosave
  setTimeout(restaurarAuto, 0);
  document.addEventListener('input', (e) => { if (e.target && e.target.matches('textarea[name^="q"]')) salvarAuto(); });

  // Limpar
  document.getElementById('btnLimpar').addEventListener('click', () => {
    if (!confirm('Deseja limpar todas as respostas desta p√°gina?')) return;
    campos().forEach(t => t.value = '');
    salvarAuto();
  });

  // Aquece ambos os backends
  window.addEventListener('load', () => {
    APIS.forEach(api => fetch(api + '/ping').catch(()=>{}));
    window.lucide && lucide.createIcons();
  });

  // Post com fallback de host e timeout
  async function postComFallback(path, body) {
    const supportsAbortTimeout = typeof AbortSignal !== 'undefined' && 'timeout' in AbortSignal;
    for (const api of APIS) {
      let controller, timer;
      const opts = {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json, application/pdf' },
        body: JSON.stringify(body),
        mode: 'cors'
      };
      if (supportsAbortTimeout) {
        opts.signal = AbortSignal.timeout(30000);
      } else {
        controller = new AbortController();
        timer = setTimeout(() => controller.abort(), 30000);
        opts.signal = controller.signal;
      }
      try {
        const res = await fetch(api + path, opts);
        if (timer) clearTimeout(timer);
        return { res, api };
      } catch (e) {
        // tenta o pr√≥ximo host
      }
    }
    throw new Error('Falha de rede. Tente novamente em instantes.');
  }

  // === Enviar ===
  document.getElementById('btnEnviar').addEventListener('click', async () => {
    const btn = document.getElementById('btnEnviar');
    const senhaEl = document.getElementById('senha');

    if (!senhaEl?.value.trim()) {
      mostrarFeedback('Por favor, digite a senha de acesso.');
      senhaEl?.focus(); return;
    }

    const respostas = campos().map((el, i) => ({
      indice: i + 1,
      pergunta: PERGUNTAS[i] || `Pergunta ${i + 1}`,
      resposta: el.value.trim()
    }));

    const preenchidas = respostas.filter(r => r.resposta.length);
    if (!preenchidas.length) return mostrarFeedback('Preencha ao menos uma resposta antes de enviar.');
    if (preenchidas.length < MIN_CAMPOS) {
      if (!confirm(`Somente ${preenchidas.length} respostas preenchidas. Deseja enviar assim mesmo?`)) return;
    }

    const payload = {
      senha: senhaEl.value.trim(),
      origem: 'site-irmandade',
      jornada: 'essencial',
      respostas,
      meta: {
        dispositivo: navigator.userAgent,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        started_at: localStorage.getItem(KEY_PREFIX + 'started_at') || new Date().toISOString(),
        enviado_em: new Date().toISOString()
      }
    };

    // UI
    const oldTxt = btn.textContent;
    btn.disabled = true; btn.textContent = 'Enviando...';

    try {
      const { res } = await postComFallback('/jornada/essencial', payload);

      const contentType = res.headers.get('Content-Type') || '';
      let data = null, blob = null, text = null;

      if (contentType.includes('application/pdf')) {
        blob = await res.blob();
      } else if (contentType.includes('application/json')) {
        data = await res.json().catch(() => null);
      } else {
        text = await res.text().catch(() => null);
      }

      if (!res.ok) {
        let msg = 'Erro ao enviar.';
        if (res.status === 401) msg = 'Senha inv√°lida. Verifique e tente novamente.';
        else if (res.status === 400) msg = (data && (data.detail || data.message)) || 'Dados inv√°lidos. Verifique suas respostas.';
        else if (res.status >= 500) msg = 'Erro no servidor. Tente novamente mais tarde.';
        else msg = (data && (data.detail || data.message)) || text || `Erro ${res.status}`;
        throw new Error(msg);
      }

      mostrarFeedback((data && (data.message || data.msg)) || 'Respostas enviadas com sucesso!', 'sucesso');

      if (blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'jornada-essencial.pdf'; a.click();
        URL.revokeObjectURL(url);
      } else if (data?.pdf_url) {
        location.href = data.pdf_url;
      } else if (data?.pdf_base64) {
        const a = document.createElement('a');
        a.href = `data:application/pdf;base64,${data.pdf_base64}`;
        a.download = data?.pdf_filename || 'jornada-essencial.pdf';
        a.click();
            } else {
        mostrarFeedback('Nenhum PDF retornado pelo servidor.', 'erro');
      }

      // limpar local depois do sucesso
      campos().forEach((_, i) => localStorage.removeItem(KEY_PREFIX + (i + 1)));
      localStorage.removeItem(KEY_PREFIX + 'started_at');

    } catch (err) {
      console.error(err);
      mostrarFeedback(err.message || 'Falha de rede. Tente novamente.', 'erro');
    } finally {
      btn.disabled = false;
      btn.textContent = oldTxt || 'Enviar respostas';
    }
  }); <!-- fecha o addEventListener -->
</script> <!-- fecha o script inline -->

<script src="/assets/jornada-essencial.js?v=1" defer></script>
</body>
</html>

