<!<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />
  <script defer src="/assets/js/toast-safe.js?v=6" onload="console.log('[LOAD] toast-safe.js carregado')" onerror="console.error('[LOAD] Erro ao carregar toast-safe.js')"></script>
<script>
  window.i18n = window.i18n || {
    lang: 'pt-BR',
    dict: {
      "pergunta_1": "Quem é você hoje?",
      "pergunta_2": "Qual é o seu propósito?",
      "site.title": "Jornada Conhecimento com Luz",
      "chat_placeholder": "Digite sua mensagem...",
      "placeholder_senha": "Digite sua senha"
    },
    ready: true,
    t: function(key, fallback) {
      return this.dict[key] || fallback || key; // Usar dict se disponível
    },
    apply: function(root = document) {
      root.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = this.t(key, el.textContent || key);
      });
      root.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.setAttribute('placeholder', this.t(key, el.getAttribute('placeholder') || key));
      });
    },
    setLang: function(lang) {
      this.lang = lang;
      console.log('[i18n Fallback] Idioma definido:', lang);
    }
  };
  console.log('[i18n Fallback] Inicializado');
</script>
  

  <style>
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "BerkshireSwash";
      src: url("/assets/fonts/BerkshireSwash-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Cardo";
      src: url("/assets/fonts/Cardo-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root { --bg:#1a1a1a; --ink:#000; --ink-soft:#555; --panel:#1a1a1a }

    html,body{height:100%;box-sizing:border-box}
    body{
      margin:0;color:#fff;background:var(--bg);
      font-family:"ManufacturingConsent",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:20px;line-height:1.6;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility
    }
    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel)!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:28px;position:relative;z-index:5}

    /* Header + chama */
    .site-header{display:flex;align-items:center;justify-content:center;padding:16px;background:transparent}
    .chama-icone{position:relative;width:18px;height:36px;display:flex;align-items:flex-end;margin-right:12px}
    .chama-icone>*{position:static}
    .site-header h1{font-family:"Berkshire Swash",cursive;font-size:32px;color:#fff;text-shadow:0 0 10px hsla(28,96%,60%,.7);margin:0}

    /* Chama */
    .chama-vela{--altura:45px;--largura:30px;--pulso:1.2s;--glow:8px;--hue:28;--satur:96%;--light:58%;--op:.98;position:relative;width:var(--largura);height:var(--altura);display:inline-block;filter:drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.75))}
    .chama-vela.chama-md{--largura:40px;--altura:90px}
    .chama-vela.chama-lg{--largura:30px;--altura:60px}
    .chama-vela .brasa{position:absolute;left:50%;bottom:2px;transform:translateX(-50%);width:calc(var(--largura)*1.4);height:10px;border-radius:50% 50% 40% 40%;background:radial-gradient(circle at 50% 40%,hsla(var(--hue),var(--satur),95%,.95) 0%,hsla(var(--hue),var(--satur),70%,.85) 50%,transparent 80%);filter:blur(1px);animation:brasaPulse var(--pulso) ease-in-out infinite;opacity:var(--op)}
    .chama-vela .lingua{position:absolute;left:50%;bottom:2px;transform:translateX(-50%);width:calc(var(--largura)*1.0);height:calc(var(--altura)*1.0);border-radius:50% 50% 4% 4%;background:radial-gradient(ellipse at center,rgba(255,190,0,.95) 0%,rgba(255,69,0,.75) 50%,rgba(230,10,10,.3) 70%,transparent 100%);mix-blend-mode:screen;filter:blur(.7px);transform-origin:50% 100%;animation:velaWaver 1.2s ease-in-out infinite;opacity:var(--op);-webkit-mask:radial-gradient(60% 90% at 50% 4%,#000 65%,transparent 69%)}
    .chama-vela .lingua:nth-child(2){width:calc(var(--largura)*.92);height:calc(var(--altura)*.95);animation-duration:1.5s;animation-delay:.08s;filter:blur(.6px)}
    .chama-vela .lingua:nth-child(3){width:calc(var(--largura)*.78);height:calc(var(--altura)*.85);animation-duration:1.8s;animation-delay:.15s;filter:blur(.5px)}
    .chama-vela .brilho{position:absolute;left:50%;bottom:0;transform:translateX(-50%);width:calc(var(--largura)*1.7);height:calc(var(--altura)*1.5);background:radial-gradient(circle,hsla(var(--hue),var(--satur),72%,.55) 0%,transparent 70%);filter:blur(9px);mix-blend-mode:screen;animation:aura var(--pulso) ease-in-out infinite;opacity:.85;pointer-events:none}
    .chama-vela.fraca{--altura:35px;--largura:25px;--pulso:1.6s;--glow:5px;--hue:36;--satur:86%;--light:66%;--op:.70}
    .chama-vela.media{--altura:45px;--largura:30px;--pulso:1.2s;--glow:8px;--hue:28;--satur:96%;--light:58%;--op:.98}
    .chama-vela.forte{--altura:55px;--largura:35px;--pulso:.7s;--glow:11px;--hue:20;--satur:100%;--light:52%;--op:1}
    .flame-corner{position:fixed;z-index:1200;pointer-events:none}
    .flame-bottom-right{bottom:20px;right:20px}
    #chama-header .chama-vela{--largura:30px;--altura:60px}
    @keyframes velaWaver{0%,100%{transform:translateX(-50%) scaleY(1.00) skewX(0deg)}25%{transform:translateX(calc(-50% + .7px)) scaleY(1.12) skewX(1.4deg)}50%{transform:translateX(-50%) scaleY(1.20) skewX(2.2deg)}75%{transform:translateX(calc(-50% - .6px)) scaleY(1.10) skewX(1.2deg)}}
    @keyframes brasaPulse{0%,100%{transform:translateX(-50%) scale(1);opacity:.85}50%{transform:translateX(-50%) scale(1.14);opacity:1}}
    @keyframes aura{0%,100%{opacity:.75}50%{opacity:1}}
    @media (prefers-reduced-motion: reduce){.chama-vela .lingua,.chama-vela .brasa,.chama-vela .brilho{animation:none!important}}

    /* Selfie */
    .selfie-row{display:grid;grid-template-columns:1fr 1.3fr;gap:16px;align-items:start}
    .selfie-left .selfie-controls{display:flex;flex-direction:column;gap:10px;margin:12px 0}
    .selfie-left label{display:flex;flex-direction:column;gap:6px;font-weight:600;font-size:18px}
    .selfie-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .muted{color:var(--ink-soft);font-size:16px}
    .selfie-right{position:relative}
    .guide-card{position:relative;width:100%;max-width:600px;margin:0 auto}
    .guide-bg{width:100%;height:auto;border-radius:12px}
    .flame-layer{position:absolute;top:0;left:0;width:100%;height:100%;opacity:0;transition:opacity 0.5s}
    .flame-svg{position:absolute;top:40%;left:50%;width:40%;height:60%;transform:translate(-50%,-6%)}
    .guide-name{position:absolute;top:2%;left:50%;transform:translateX(-50%);color:#f7d37a;font-family:"Cardo",serif;font-size:2.5rem;font-weight:bold;text-align:center}
    .user-name{position:absolute;bottom:2%;left:50%;transform:translateX(-50%);color:#f7d37a;font-family:"Cardo",serif;font-size:2rem;font-weight:bold;text-align:center}
    .controls{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    #selfieError{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:18px;text-align:center;padding:10px;background:rgba(0,0,0,0.7);border-radius:8px;display:none}
    @media (max-width:860px){
      .selfie-row{grid-template-columns:1fr}
      .selfie-right{max-width:100%;margin-top:16px}
      .guide-card{max-width:100%}
      .flame-svg{top:40%;width:50%;height:50%}
      .guide-name{font-size:1.8rem}
      .user-name{font-size:1.5rem}
    }

    /* Escolha do guia */
    .guia-container{margin-top:20px;padding:10px;border:1px solid #d1d5db;border-radius:8px;background:var(--panel);text-align:center}
    .guia-container p{font-size:18px}
    .guia-options{display:flex;gap:10px;justify-content:center;margin-top:12px}
    .guia-options button{padding:8px 16px;font-size:18px}

    /* Chat */
    .grok-chat-container{display:none}
    .grok-chat-message.grok{background:transparent;text-align:left;font-size:18px;white-space:pre-wrap;position:relative}
    .grok-chat-message.grok::after{content:"▌";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .grok-chat-message.grok.typing-done::after{content:"";animation:none}
    .grok-chat-input{display:none}

    /* Pergaminho */
    .pergaminho-v{background:var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover!important;min-height:82vh!important}
    .pergaminho-h{background:var(--panel) url('/assets/img/pergaminho-rasgado-horiz.png') no-repeat center/cover!important;min-height:82vh!important}
    .pergaminho-h.fallback{background:var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover!important}
    .conteudo-pergaminho{background:transparent!important;position:relative;z-index:10;padding:20px;min-height:100%;overflow:visible;color:#fff;box-sizing:border-box;max-width:100%}
    .conteudo-pergaminho h2,.conteudo-pergaminho h3,.conteudo-pergaminho .pergunta-enunciado{color:#fff;text-shadow:0 0 10px hsla(28,96%,60%,.7);font-size:24px}
    .conteudo-pergaminho p,.conteudo-pergaminho small{font-size:18px}
    @media (max-width:600px){
      .conteudo-pergaminho{padding:16px}
      .conteudo-pergaminho h2,.conteudo-pergaminho h3{font-size:20px}
      .conteudo-pergaminho p,.conteudo-pergaminho li,.conteudo-pergaminho small{font-size:16px;line-height:1.5}
      .conteudo-pergaminho ul{padding-left:20px}
    }

    /* UI */
    .btn {
      display: inline-block;
      padding: 12px 22px;
      border-radius: 10px;
      border: 0;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease;
      font-family: "Berkshire Swash", cursive;
      font-size: 18px;
      line-height: 1.15;
      background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      border: 3px solid #4a4a4a;
      border-radius: 12px 8px 15px 10px;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      padding: 14px 26px;
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      transform: translateY(-2px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 8px 16px rgba(0,0,0,0.7);
    }
    .btn+.btn{margin-left:10px}
    .btn:disabled{background:#6b7280;cursor:not-allowed;transform:none}

    /* Progresso */
    .progress-container{margin:16px 0;text-align:center}
    .progress-badge{padding:8px 16px;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;color:#fff;border-radius:8px;font-size:18px;border: 3px solid #4a4a4a;box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);text-shadow: 1px 1px 3px rgba(0,0,0,0.7)}
    .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px}
    .progress-bar-fill{height:100%;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;border-radius:4px;transition:width .25s ease}
    .j-progress{margin:8px 0 16px}
    .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
    .j-progress__fill{height:100%;background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;background-blend-mode: overlay;border-radius:4px;transition:width .25s ease}
    .j-progress__meta{text-align:center;margin-top:8px;font-size:18px;color:var(--ink-soft)}

    .footer-actions{display:flex;gap:12px;justify-content:center;margin:18px 0}

    /* Datilografia */
    .lumen-typing{white-space:pre-wrap;position:relative}
    .lumen-typing::after{content:"▌";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .lumen-typing.typing-done::after{content:"";animation:none}
    @keyframes lumenBlink{50%{opacity:0}}

    /* Seções */
    .j-section{display:none}
    .j-section:not(.hidden){display:block}
    .j-bloco{background:transparent!important;display:none;z-index:5}
    .j-pergunta{margin-bottom:24px;display:none;z-index:6;position:relative}
    .j-pergunta.active{display:block}
    .pergunta-enunciado{display:block;margin-bottom:6px;font-family:"Berkshire Swash",cursive;font-size:22px;color:#fff}
    .j-pergunta textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;background:rgba(255,255,255,.85);resize:vertical;min-height:100px;font-family:"Cardo",serif;font-size:18px;line-height:1.45}

    /* Acessibilidade: Microfone e Áudio */
    .accessibility-controls { display: flex; gap: 10px; margin-top: 8px; }
    .btn-mic, .btn-audio { padding: 8px 16px; font-size: 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border: 3px solid #4a4a4a; border-radius: 8px; cursor: pointer; color: #fff; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }
    .btn-mic:hover, .btn-audio:hover { background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; }
    .btn-mic.recording { background: linear-gradient(to bottom, #ff6666, #cc3333), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; }

    /* Seletor de Idioma */
    .language-selector { position: absolute; top: 10px; right: 10px; z-index: 100; }
    .language-selector select { padding: 8px; font-size: 16px; border-radius: 8px; }

    /* Vídeo overlay */
    #videoOverlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.95);display:flex;justify-content:center;align-items:center;z-index:2000}
    #videoOverlay.hidden{display:none}
    .video-player{width:100vw;height:100vh;object-fit:contain;background:#000;transform:rotate(0deg)}
    @media (orientation: portrait){
      .video-player{width:100vw;height:100%;max-height:100vh;object-fit:contain}
    }
    .video-fallback{width:100vw;height:100vh;background:url('/assets/img/perfil-da-irmandade.png') center/cover no-repeat;display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;text-align:center;padding:20px;font-family:"Berkshire Swash",cursive}

    .site-footer{text-align:center;padding:14px;color:var(--ink-soft);font-size:18px}
    .password-form{margin-top:16px;text-align:center}
    .password-input{position:relative}
    .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;font-family:"Cardo",serif;font-size:18px}
    .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px}

    .section-container{position:relative;min-height:85vh}
    .hidden{display:none!important}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Toast */
    #toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.35);font-size:16px;z-index:4000;opacity:0;pointer-events:none;transition:opacity .25s ease}
    #toast.show{opacity:1}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <!-- Seletor de Idioma -->
  <div class="language-selector">
    <select id="language-select">
      <option value="pt-BR">Português (BR)</option>
      <option value="en-US">English (US)</option>
      <option value="es-ES">Español (ES)</option>
    </select>
  </div>

  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="chama-vela chama-lg">
        <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
      </div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <div id="aria-pergunta" class="sr-only" aria-live="polite"></div>

        <!-- INTRO -->
        <div id="section-intro" class="j-section">
          <p data-typing="true" data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <p data-typing="true" data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, leia os termos abaixo." data-speed="50" data-cursor="true"></p>
          <div class="footer-actions"><button class="btn btn-avancar" data-action="avancar">Avançar</button></div>
        </div>

        <!-- TERMOS -->
        <div id="section-termos" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;" data-typing="true" data-text="Jornada Conhecimento com Luz - Essencial " data-speed="40" data-cursor="true"></h2>
            <div id="termos-pg1">
              <p data-typing="true" data-text="AVISO IMPORTANTE – LEIA ANTES DE INICIAR" data-speed="40" data-cursor="true"></p>
              <p data-typing="true" data-text="Esta é uma jornada pessoal, simbólica e inspiradora. Para proteger sua privacidade e garantir uma experiência ética, leia com atenção:" data-speed="40" data-cursor="true"></p>
              <ul>
                <li data-typing="true" data-text="Suas respostas não serão armazenadas após o término." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Ao final, será gerado um PDF exclusivo com suas respostas e a devolutiva simbólica do Guia I A." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="O PDF não é enviado por e-mail. Faça o download imediatamente após a geração." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Após a entrega do PDF, todos os dados são apagados automaticamente e sem possibilidade de recuperação." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Acesso por senha individual, com prazos:" data-speed="40" data-cursor="true"></li>
                <ul>
                  <li data-typing="true" data-text="15 dias para iniciar a jornada." data-speed="40" data-cursor="true"></li>
                  <li data-typing="true" data-text="24 horas para concluir, a partir do primeiro acesso." data-speed="40" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg2" class="hidden">
              <h3 style="margin-top:0;" data-typing="true" data-text="Termo de Responsabilidade e Consentimento Consciente" data-speed="40" data-cursor="true"></h3>
              <ul>
                <li data-typing="true" data-text="Responsabilidade Pessoal: As respostas fornecidas refletem sua visão de mundo, sentimentos e experiências pessoais." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Caráter Não Terapêutico: Esta jornada não substitui acompanhamento psicológico, psiquiátrico, médico ou terapêutico. Não há diagnóstico, prescrição ou orientação clínica." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Neutralidade Religiosa: Respeitamos todas as crenças e tradições. O convite é para um diálogo interior conforme sua própria fé e consciência." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Autonomia do Participante:" data-speed="40" data-cursor="true">
                  <ul>
                    <li data-typing="true" data-text="Você decide quando iniciar (dentro do prazo de 15 dias)." data-speed="40" data-cursor="true"></li>
                    <li data-typing="true" data-text="Após usar a senha, há até 24 horas corridas para concluir." data-speed="40" data-cursor="true"></li>
                  </ul>
                </li>
                <li data-typing="true" data-text="Conduta Respeitosa com o Guia I A:" data-speed="40" data-cursor="true">
                  <ul>
                    <li data-typing="true" data-text="O Guia é uma Inteligêmçia Artificial com percepção humanizada." data-speed="40" data-cursor="true"></li>
                    <li data-typing="true" data-text="Mantenha linguagem cordial; evite ofensas e xingamentos." data-speed="40" data-cursor="true"></li>
                    <li data-typing="true" data-text="A forma de se comunicar com o Guia I A reflete o respeito por si mesmo(a)." data-speed="40" data-cursor="true"></li>
                  </ul>
                </li>
                <li data-typing="true" data-text="Privacidade e Segurança: Os dados transitam apenas para gerar o PDF final. Não há criação de conta nem envio de e-mails. Após o encerramento, os dados locais do navegador podem ser removidos por você a qualquer momento." data-speed="40" data-cursor="true"></li>
                <li data-typing="true" data-text="Concordância: Ao prosseguir, você declara estar ciente e de acordo com todas as condições descritas." data-speed="40" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-prev">Voltar</button>
                <button class="btn btn-avancar" data-action="avancar">Aceito e quero continuar</button>
              </div>
            </div>
          </div>
        </div>
        <section id="section-termos" class="section">
         <h2 data-i18n="termos_title">Termos de Uso</h2>
           <p data-i18n="termos_texto">Concorde com os termos para continuar.</p>
          <button class="btn-avancar" data-next="section-senha">Aceitar</button>
         </section>

        <!-- SENHA -->
        <div id="section-senha" class="j-section hidden">
          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'Berkshire Swash',cursive;font-size:22px;" data-typing="true" data-text="Ative sua Senha" data-speed="40" data-cursor="true">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senhaInput" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">👁️</span>
            </div>
            <div style="margin-top:12px"><button class="btn" id="iniciar" data-action="start">Ativar e Iniciar</button></div>
          </div>
        </div>

        <!-- GUIA -->
        <div id="section-guia" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;" data-typing="true" data-text="Escolha seu Guia ✨" data-speed="40" data-cursor="true">Escolha seu Guia ✨</h2>
            <div class="guia-container">
              <p data-typing="true" data-text="Zion (Grok) • Lumen (ChatGPT) • Arian (Gemini)" data-speed="40" data-cursor="true">Zion (Grok) • Lumen (ChatGPT) • Arian (Gemini)</p>
              <div class="guia-options">
                <button class="btn" data-action="select-guia" data-guia="zion">Escolher Zion</button>
                <button class="btn" data-action="select-guia" data-guia="lumen">Escolher Lumen</button>
                <button class="btn" data-action="select-guia" data-guia="arian">Escolher Arian</button>
              </div>
            </div>
            <div class="footer-actions">
              <button class="btn btn-avancar" data-action="avancar">Avançar</button>
            </div>
          </div>
        </div>

        <!-- SELFIE -->
        <div id="section-selfie" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;" data-typing="true" data-text="Entre na Irmandade " data-speed="40" data-cursor="true">Entre na Irmandade ✨</h2>
            <p data-typing="true" data-text="Faça uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia." data-speed="40" data-cursor="true">Faça uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia.</p>
            <div class="selfie-row">
              <div class="selfie-left">
                <label class="btn" for="selfieInput">Tirar Foto</label>
                <input id="selfieInput" type="file" accept="image/*" capture="user" style="display:none" />
                <div class="selfie-controls">
                  <label>Nome <input id="nameInput" type="text" placeholder="Digite seu nome"></label>
                  <label>Zoom <input id="selfieScale" type="range" min="0.6" max="2.0" step="0.01" value="1"></label>
                  <label>Horizontal <input id="selfieOffsetX" type="range" min="-300" max="300" step="1" value="0"></label>
                  <label>Vertical <input id="selfieOffsetY" type="range" min="-300" max="300" step="1" value="0"></label>
                  <small class="muted">Dica: alinhe seu rosto na chama ao lado do guia.</small>
                </div>
                <div class="selfie-actions">
                  <button id="previewBtn" class="btn">Ver Prévia</button>
                  <button id="captureBtn" class="btn">Confirmar e Baixar</button>
                  <button id="btnSkipSelfie" class="btn" data-action="avancar">Pular Foto</button>
                  <button id="btnStartJourney" class="btn" data-action="avancar">Entrar na Jornada</button>
                </div>
              </div>
              <div class="selfie-right">
                <section id="card-guide" class="guide-card" data-guide="ZION" aria-label="Guia">
                  <img class="guide-bg" id="guideBg" src="/assets/img/irmandade-quarteto-bg-zion.png" alt="Guia Background">
                  <div class="flame-layer" aria-hidden="true">
                    <svg class="flame-svg" viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <clipPath id="flameClip">
                          <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" />
                        </clipPath>
                        <radialGradient id="flameGlow" cx="50%" cy="70%" r="55%">
                          <stop offset="0%" stop-color="rgba(255, 224, 130, 1)"/>
                          <stop offset="55%" stop-color="rgba(255, 180, 0, 0.9)"/>
                          <stop offset="100%" stop-color="rgba(255, 180, 0, 0)"/>
                        </radialGradient>
                      </defs>
                      <image id="selfieImage" href="" x="15" y="35" width="70" height="90" clip-path="url(#flameClip)" preserveAspectRatio="xMidYMid slice" />
                      <ellipse cx="50" cy="95" rx="28" ry="40" fill="url(#flameGlow)"></ellipse>
                      <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" fill="none" stroke="rgba(255,200,0,.85)" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="guide-name" id="guideNameSlot"></div>
                  <div class="user-name" id="userNameSlot">NOME</div>
                </section>
                <div id="selfieError" class="selfie-error">Erro ao carregar a pré-visualização. Tente novamente ou pule.</div>
                <small class="muted">Pré-visualização</small>
              </div>
            </div>
          </div>
        </div>

        <!-- PERGUNTAS -->
        <div id="section-perguntas" class="j-section hidden">
          <div class="progress-container">
            <div class="progress-badge" id="jprog-pct">0% concluído</div>
             <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
              <div class="j-progress"><div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div><div class="j-progress__meta" id="j-meta"></div></div>
               </div>
               <div class="j-pergunta" data-pergunta="1" style="display: none;">
              <label class="pergunta-enunciado text" data-typing="true" data-text="Pergunta 2: " data-speed="36" data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="undefined"></textarea>
          <div class="accessibility-controls">
        <button class="btn-mic" data-action="start-mic">🎤 undefined</button>
        <button class="btn-audio" data-action="read-question">🔊 undefined</button>
         <button class="btn btn-avancar" data-action="avancar">undefined</button>
          </div>
           </div>
            <div class="j-pergunta" data-pergunta="2" style="display: none;">
             <label class="pergunta-enunciado text" data-typing="true" data-text="Pergunta 3: " data-speed="36" data-cursor="true"></label>
              <textarea rows="4" class="input" placeholder="undefined"></textarea>
              <div class="accessibility-controls">
             <button class="btn-mic" data-action="start-mic">🎤 undefined</button>
           <button class="btn-audio" data-action="read-question">🔊 undefined</button>
          <button class="btn btn-avancar" data-action="avancar">undefined</button>
         </div>
       </div>

          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="chama-vela chama-md"><div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div></div>
          </div>

          <div id="perguntas-container"></div>
           <div id="chat-container">
             <input type="text" id="grok-chat-input" data-i18n-placeholder="chat_placeholder" placeholder="Digite sua mensagem...">
               <button class="btn-avancar" data-action="send-chat">Enviar</button>
                </div>

              <div class="footer-actions">
            <button id="btnNextPerguntas" class="btn btn-avancar" data-action="avancar">Avançar</button>
          </div>
        </div>

        <!-- FINAL -->
        <div id="section-final" class="j-section hidden">
          <p data-typing="true" data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
          <div class="selfie-final" style="text-align:center; margin-top:20px;">
            <img id="minhaFotoFinal" alt="Minha foto com a Irmandade" style="max-width:80%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3)" />
          </div>
          <p style="margin-top:12px;"><small data-typing="true" data-text="Sua imagem foi unida à Irmandade. " data-speed="40" data-cursor="true"></small></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button id="btnRestart" class="btn" data-action="restart">Voltar ao Portal</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:18px;"></div>
  </footer>

  <!-- Vídeo overlay -->
  <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">Áudio da jornada em reprodução. Converta para H.264 MP4.</div>
    <button id="skipVideo" class="btn" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

  <!-- Chama inferior -->
  <div id="flame-bottom-right" class="flame-corner flame-bottom-right">
    <div class="chama-vela chama-md">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" role="status" aria-live="polite" class="hidden"></div>
  

                 <!-- util: toast + erro global -->
  <script>
    (function(){   
      function toast(msg){
        try{
          const t=document.getElementById('toast'); if(!t) return;
          t.textContent=msg; t.classList.remove('hidden'); t.classList.add('show');
          setTimeout(()=>{t.classList.remove('show');},3000);
        }catch(_){}
      }
      window.addEventListener('error',(e)=>{
        console.error('[Erro global]',e?.error||e);
        toast('Ops… algo falhou, mas já seguimos em frente.');
      });                   
      const env=document.getElementById('envTag');
      if(env) env.textContent=`layout=${document.body.dataset.layout||'master'} · journey=${document.body.dataset.journey||'essencial'} · path=/assets`;
    }
      </script>              
        
  
                <!-- chamas -->
  <script>      
      function makeFlame(cls){
        const d=document.createElement('div');
        d.className=(cls||'chama-vela chama-md');
        d.innerHTML='<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
        return d;
      }
      function ensureHeaderFlame(){
        const H=document.getElementById('chama-header');
        if(!H) return;
        if(!H.querySelector('.brasa')){H.innerHTML='';H.appendChild(makeFlame('chama-vela chama-lg'));}
      }
      function ensureInlineFlame(id,cls){
        const el=document.getElementById(id);
        if(!el) return null;
        if(!el.querySelector('.brasa')){el.innerHTML='';el.appendChild(makeFlame(cls||'chama-vela chama-md'));}
        return el.firstElementChild;
      }
      function ensurePageFlames(){
        if(!document.getElementById('flame-bottom-right')){
          const f=makeFlame('chama-vela chama-md');
          f.id='flame-bottom-right';
          f.style.cssText='position:fixed;bottom:12px;right:12px;z-index:1200;';
          document.body.appendChild(f);
        }
      }
      function setMode(el,score){
        if(!el) return;
        el.classList.remove('fraca','media','forte');
        el.classList.add(score<=-2?'fraca':score>=2?'forte':'media');
      }
      window.JORNADA_CHAMA=window.JORNADA_CHAMA||{};
      window.JORNADA_CHAMA.updateChama=function(score){
        const main=ensureInlineFlame('chama-perguntas','chama-vela chama-md');
        setMode(main,score);
        setMode(document.getElementById('flame-bottom-right'),score);
      };
      window.JORNADA_CHAMA.ensureHeroFlame=function(sectionId){
        const canvas=document.getElementById('jornada-canvas');
        if(!canvas) return;
        let hero=document.getElementById('chama-hero');
        const show=(sectionId==='section-intro'||sectionId==='section-termos'||sectionId==='section-senha'||sectionId==='section-final'||sectionId==='section-selfie'||sectionId==='section-guia');
        if(show){
          if(!hero){
            hero=makeFlame('chama-vela chama-lg');
            hero.id='chama-hero';
            hero.style.cssText='position:absolute;top:8px;left:8px;z-index:60;';
            canvas.appendChild(hero);
          }
        } else if(hero){
          hero.remove();
        }
      };
      function updateChama(score){
        window.JORNADA_CHAMA.updateChama(score);
      }
      function ensureHeroFlame(sectionId){
        window.JORNADA_CHAMA.ensureHeroFlame(sectionId);
      }
  </script>

                 <!-- selfie -->
<script>
  (function() {
    const $ = s => document.querySelector(s);
    const card = $('#card-guide');
    const guideNameEl = $('#guideNameSlot');
    const userNameEl = $('#userNameSlot');
    const flameLayer = $('#card-guide .flame-layer');
    const selfieImg = $('#selfieImage');
    const bgImg = $('#guideBg');
    const nameInput = $('#nameInput');
    const guiaNameInput = $('#guiaNameInput');
    const fileInput = $('#selfieInput');
    const previewBtn = $('#previewBtn');
    const captureBtn = $('#captureBtn');
    const errorDiv = $('#selfieError');
    const scaleInput = $('#selfieScale');
    const offsetXInput = $('#selfieOffsetX');
    const offsetYInput = $('#selfieOffsetY');

    if (!card || !guideNameEl || !userNameEl || !flameLayer || !selfieImg || !bgImg || !nameInput || !fileInput || !previewBtn || !captureBtn) {
      console.warn('[Selfie] Um ou mais elementos DOM não encontrados');
      return;
    }

    let selfieURL = '';

    function getBgUrl() {
      const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
      card.dataset.guide = guia.toUpperCase();
      guideNameEl.textContent = guia.toUpperCase();
      return `/assets/img/irmandade-quarteto-bg-${guia}.png`;
    }

    function loadBg() {
      const bgUrl = getBgUrl();
      bgImg.src = bgUrl;
      bgImg.onload = () => {
        if (errorDiv) errorDiv.style.display = 'none';
        console.log('[Selfie] Imagem de fundo carregada:', bgUrl);
      };
      bgImg.onerror = () => {
        if (errorDiv) errorDiv.style.display = 'block';
        toast('Erro ao carregar a imagem de fundo do guia.');
      };
    }

    function updatePreview() {
      const scale = parseFloat(scaleInput.value) || 1;
      const ox = parseFloat(offsetXInput.value) || 0;
      const oy = parseFloat(offsetYInput.value) || 0;
      const baseX = 15 + ox;
      const baseY = 35 + oy;
      const baseW = 70 * scale;
      const baseH = 90 * scale;
      selfieImg.setAttribute('x', baseX);
      selfieImg.setAttribute('y', baseY);
      selfieImg.setAttribute('width', baseW);
      selfieImg.setAttribute('height', baseH);
      console.log('[Selfie] Preview atualizado:', { scale, ox, oy });
    }

    function syncNameInput() {
      const storedName = localStorage.getItem('JORNADA_NOME') || '';
      if (storedName) {
        nameInput.value = storedName;
        userNameEl.textContent = storedName.toUpperCase() || 'NOME';
      }
      nameInput.addEventListener('input', () => {
        const name = nameInput.value.trim();
        userNameEl.textContent = name.toUpperCase() || 'NOME';
        localStorage.setItem('JORNADA_NOME', name);
      });
    }

    scaleInput.addEventListener('input', updatePreview);
    offsetXInput.addEventListener('input', updatePreview);
    offsetYInput.addEventListener('input', updatePreview);

    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      if (!f) return;
      if (selfieURL) URL.revokeObjectURL(selfieURL);
      selfieURL = URL.createObjectURL(f);
      selfieImg.setAttribute('href', selfieURL);
      if (errorDiv) errorDiv.style.display = 'none';
      updatePreview();
      console.log('[Selfie] Selfie carregada');
    });

    previewBtn.addEventListener('click', async () => {
      if (!selfieImg.getAttribute('href')) {
        toast('Selecione uma selfie antes.');
        return;
      }
      updatePreview();
      flameLayer.style.opacity = 1;
      console.log('[Selfie] Preview ativado');
    });

    captureBtn.addEventListener('click', async () => {
      if (!selfieImg.getAttribute('href')) {
        toast('Selecione uma selfie antes.');
        return;
      }
      updatePreview();
      flameLayer.style.opacity = 1;
      await new Promise(r => requestAnimationFrame(r));

      const canvas = document.createElement('canvas');
      const rect = card.getBoundingClientRect();
      const scale = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * scale);
      canvas.height = Math.round(rect.height * scale);
      const ctx = canvas.getContext('2d');

      const load = (src) => new Promise((res, rej) => {
        const im = new Image();
        im.crossOrigin = 'anonymous';
        im.onload = () => res(im);
        im.onerror = rej;
        im.src = src;
      });

      const bg = await load(bgImg.currentSrc || bgImg.src).catch(() => {
        if (errorDiv) errorDiv.style.display = 'block';
        toast('Erro ao carregar a imagem de fundo.');
        return;
      });
      if (!bg) return;
      ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

      const W = canvas.width, H = canvas.height;
      const fw = 0.40 * W, fh = 0.60 * H, fx = (W - fw) / 2, fy = (H - fh) / 2 + 0.06 * H;

      const grad = ctx.createRadialGradient(fx + fw / 2, fy + fh * 0.65, fh * 0.02, fx + fw / 2, fy + fh * 0.65, fh * 0.55);
      grad.addColorStop(0, 'rgba(255,224,130,1)');
      grad.addColorStop(0.55, 'rgba(255,180,0,0.9)');
      grad.addColorStop(1, 'rgba(255,180,0,0)');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.ellipse(fx + fw / 2, fy + fh * 0.65, fw * 0.35, fh * 0.45, 0, 0, Math.PI * 2);
      ctx.fill();

      function flamePath(ctx, x, y, w, h) {
        ctx.beginPath();
        ctx.moveTo(x + 0.50 * w, y + 0.133 * h);
        ctx.bezierCurveTo(x + 0.42 * w, y + 0.233 * h, x + 0.34 * w, y + 0.300 * h, x + 0.33 * w, y + 0.387 * h);
        ctx.bezierCurveTo(x + 0.32 * w, y + 0.487 * h, x + 0.41 * w, y + 0.547 * h, x + 0.50 * w, y + 0.613 * h);
        ctx.bezierCurveTo(x + 0.59 * w, y + 0.547 * h, x + 0.68 * w, y + 0.487 * h, x + 0.67 * w, y + 0.387 * h);
        ctx.bezierCurveTo(x + 0.66 * w, y + 0.300 * h, x + 0.58 * w, y + 0.233 * h, x + 0.50 * w, y + 0.133 * h);
      }

      ctx.save();
      flamePath(ctx, fx, fy, fw, fh);
      ctx.clip();

      const selfie = await load(selfieImg.getAttribute('href')).catch(() => {
        if (errorDiv) errorDiv.style.display = 'block';
        toast('Erro ao carregar a selfie.');
        return;
      });
      if (!selfie) return;

      const selfieScaleVal = parseFloat(scaleInput.value) || 1;
      const ox = parseFloat(offsetXInput.value) || 0;
      const oy = parseFloat(offsetYInput.value) || 0;
      const svgScaleX = fw / 100;
      const svgScaleY = fh / 150;

      let coverRatio = Math.max(fw / selfie.width, fh / selfie.height) * selfieScaleVal;
      let sw = selfie.width * coverRatio;
      let sh = selfie.height * coverRatio;
      let sx = fx + (fw - sw) / 2 + ox * svgScaleX;
      let sy = fy + (fh - sh) / 2 + oy * svgScaleY;

      ctx.drawImage(selfie, sx, sy, sw, sh);
      ctx.restore();

      ctx.strokeStyle = 'rgba(255,200,0,.85)';
      ctx.lineWidth = Math.max(1.2, W * 0.0022);
      flamePath(ctx, fx, fy, fw, fh);
      ctx.stroke();

      ctx.fillStyle = '#f7d37a';
      ctx.textAlign = 'center';
      ctx.font = `bold ${Math.round(W * 0.075)}px Cardo, serif`;
      ctx.textBaseline = 'top';
      ctx.fillText(card.dataset.guide, W / 2, H * 0.035);
      const userName = (nameInput.value.trim() || 'NOME').toUpperCase();
      ctx.font = `bold ${Math.round(W * 0.068)}px Cardo, serif`;
      ctx.fillText(userName, W / 2, H * 0.955);

      const dataURL = canvas.toDataURL('image/png');
      try {
        localStorage.setItem('IRMANDADE_SELFIE_FINAL', dataURL);
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = `jornada-${card.dataset.guide.toLowerCase()}-${Date.now()}.png`;
        a.click();
        console.log('[Selfie] Imagem salva e download iniciado');
      } catch (e) {
        console.error('[Selfie] Erro ao salvar imagem:', e);
        toast('Erro ao salvar a imagem final.');
      }
    });

    loadBg();
    syncNameInput();
  })();
</script>
  
                 <!-- Vídeo Transição -->
<script>
  (function() {
    let isPlaying = false; // Evitar múltiplas reproduções simultâneas

    window.playVideo = function(videoSrc) {
      if (isPlaying) {
        console.warn('[playVideo] Vídeo já está sendo reproduzido');
        return;
      }
      isPlaying = true;

      const overlay = document.getElementById('videoOverlay');
      const video = document.getElementById('videoTransicao');
      const fallback = document.getElementById('videoFallback');
      const perguntaInput = document.getElementById('meuInputPergunta'); // Ajuste o ID
      const perguntaDiv = document.getElementById('minhaDivPergunta'); // Ajuste o ID

      if (!overlay || !video) {
        console.error('[playVideo] Elementos de vídeo não encontrados');
        window.toast && window.toast('Erro ao reproduzir vídeo.');
        isPlaying = false;
        return;
      }

      video.src = videoSrc;
      video.onended = () => {
        overlay.classList.add('hidden');
        video.src = '';
        isPlaying = false;
        console.log('[playVideo] Vídeo terminou');        
        if (window.JC && window.JC.goNext) {
          window.JC.goNext();
          console.log('[playVideo] Avançando para próxima seção');
          console.log('[Controles] onended disparado');
          cleanup();
        }
        // Chama runTyping para exibir perguntas após o vídeo
        if (perguntaDiv && window.runTyping) {
          window.runTyping(perguntaDiv);
        }
      };

      video.onerror = () => {
        fallback.classList.remove('hidden');
        video.classList.add('hidden');
        setTimeout(() => {
          overlay.classList.add('hidden');
          fallback.classList.add('hidden');
          video.classList.remove('hidden');
          isPlaying = false;
          console.log('[playVideo] Fallback exibido, avançando');
          if (window.JC && window.JC.goNext) {
            window.JC.goNext();
          }
        }, 3000);
      };

      video.addEventListener('timeupdate', () => {
        const tempoAtual = video.currentTime;
        console.log(`[playVideo] Tempo do vídeo: ${tempoAtual}s`);
        // Exemplo: exibir placeholder de pergunta entre 5-10s
        if (tempoAtual >= 5 && tempoAtual < 10 && perguntaInput && window.typePlaceholder) {
          window.typePlaceholder(perguntaInput, 'Digite sua resposta aqui', 22);
        }
      });

      overlay.classList.remove('hidden');
      video.play().catch(e => {
        console.error('[playVideo] Erro ao reproduzir vídeo:', e);
        fallback.classList.remove('hidden');
        video.classList.add('hidden');
        isPlaying = false;
      });
      console.log('[playVideo] Reproduzindo vídeo:', videoSrc);
    };

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('#skipVideo');
      if (btn) {
        const overlay = document.getElementById('videoOverlay');
        const video = document.getElementById('videoTransicao');
        if (overlay && video) {
          video.pause();
          video.src = '';
          overlay.classList.add('hidden');
          isPlaying = false;
          console.log('[playVideo] Vídeo pulado');
          if (window.JC && window.JC.goNext) {
            window.JC.goNext();
          }
        }
      }
    });

    console.log('[Video] Bloco carregado');
  })();
</script>
  
                      <!-- Guia Seleção -->
<script>
  (function() {
    window.JORNADA = window.JORNADA || {};
    window.JORNADA.selectedGuia = window.JORNADA.selectedGuia || null;

    let isSelecting = false; // Evitar múltiplos cliques simultâneos

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="select-guia"]');
      if (btn) {
        e.preventDefault();
        if (isSelecting) {
          console.warn('[Guia] Seleção em andamento, ignorando clique');
          return;
        }
        isSelecting = true;

        const guia = btn.dataset.guia;
        if (!guia) {
          console.warn('[Guia] Guia não especificado no botão');
          isSelecting = false;
          return;
        }

        window.JORNADA.selectedGuia = guia;
        console.log('[Guia] Guia selecionado:', guia);

        const guideBg = document.getElementById('guideBg');
        if (guideBg) {
          const bgUrl = `/assets/img/irmandade-quarteto-bg-${guia}.png`;
          guideBg.src = bgUrl;
          console.log('[Guia] Imagem de fundo atualizada:', bgUrl);
        } else {
          console.warn('[Guia] Elemento #guideBg não encontrado');
        }

        const guideNameSlot = document.getElementById('guideNameSlot');
        if (guideNameSlot) {
          guideNameSlot.textContent = guia.charAt(0).toUpperCase() + guia.slice(1);
        } else {
          console.warn('[Guia] Elemento #guideNameSlot não encontrado');
        }

        if (window.JC && window.playVideo) {
          window.JC.nextSection = 'section-selfie';
          const videoSrc = '/assets/videos/conhecimento-com-luz-jardim.mp4'; // Ajustado o caminho
          console.log('[Guia] Iniciando reprodução de vídeo:', videoSrc);
          window.playVideo(videoSrc);

          // Chama runTyping após um atraso para garantir que a seção esteja pronta
          setTimeout(() => {
            const sectionSelfie = document.getElementById('section-selfie');
            if (sectionSelfie && window.runTyping) {
              window.runTyping(sectionSelfie);
              console.log('[Guia] runTyping chamado para section-selfie');
            }
          }, 1000); // Ajuste o tempo conforme necessário
        } else {
          console.warn('[Guia] window.JC ou playVideo não definido, navegando diretamente');
          if (window.showSection) {
            window.showSection('section-selfie');
            const sectionSelfie = document.getElementById('section-selfie');
            if (sectionSelfie && window.runTyping) {
              window.runTyping(sectionSelfie);
              console.log('[Guia] runTyping chamado para section-selfie');
            }
          }
        }

        isSelecting = false;
      }
    });

    console.log('[Guia] Bloco carregado');
  })();
</script>
  
              <!-- Navegação de Termos -->
<script>
  (function() {
    let isNavigating = false; // Evitar múltiplos cliques simultâneos

    const showPage = (pg) => {
      if (isNavigating) {
        console.warn('[Termos] Navegação em andamento, ignorando');
        return;
      }
      isNavigating = true;

      const pages = ['termos-pg1', 'termos-pg2'];
      pages.forEach(p => {
        const el = document.getElementById(p);
        if (el) {
          el.classList.add('hidden');
        } else {
          console.warn(`[Termos] Página ${p} não encontrada`);
        }
      });

      const target = document.getElementById(pg);
      if (target) {
        target.classList.remove('hidden');
        if (window.runTyping) {
          window.runTyping(target);
          console.log(`[Termos] runTyping chamado para: ${pg}`);
        } else {
          console.warn('[Termos] window.runTyping não definido');
        }
      } else {
        console.warn(`[Termos] Página alvo ${pg} não encontrada`);
      }

      isNavigating = false;
    };
    document.querySelectorAll('[data-action="read-question"]').forEach(button => {
    button.addEventListener('click', () => {
    const pergunta = button.closest('.j-pergunta').querySelector('[data-i18n]');
    const key = pergunta.dataset.i18n;
    const text = window.i18n.t(key, pergunta.textContent);
    if ('speechSynthesis' in window) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = window.i18n.lang || 'pt-BR';
      window.speechSynthesis.speak(utterance);
    } else {
      console.warn('[readAloud] SpeechSynthesis não suportado');
    }
  });
});
    
   document.querySelectorAll('[data-action="toggle-password"]').forEach(button => {
  button.addEventListener('click', () => {
    const input = button.closest('.input-group').querySelector('input');
    input.type = input.type === 'password' ? 'text' : 'password';
    button.textContent = input.type === 'password' ? 'Mostrar' : 'Ocultar';
  });
}); 

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="termos-next"], [data-action="termos-prev"]');
      if (btn) {
        e.preventDefault();
        const action = btn.dataset.action;
        console.log('[Termos] Ação disparada:', action);
        if (action === 'termos-next') {
          showPage('termos-pg2');
        } else if (action === 'termos-prev') {
          showPage('termos-pg1');
        }
      }
    });

    console.log('[Termos] Bloco carregado');
  })();
</script>

            <!-- chat com guia -->
<script>
  (function() {
    let isSending = false; // Evitar múltiplas chamadas simultâneas

    async function sendChatMessage() {
      if (isSending) {
        console.warn('[Chat] Envio de mensagem em andamento, ignorando');
        return;
      }
      isSending = true;

      const input = document.getElementById('grok-chat-input');
      const messagesDiv = document.getElementById('grok-chat-messages');
      if (!input || !messagesDiv) {
        console.warn('[Chat] Elementos de chat não encontrados');
        isSending = false;
        return;
      }

      const userMessage = input.value.trim();
      if (!userMessage) {
        console.warn('[Chat] Mensagem vazia, ignorando');
        isSending = false;
        return;
      }

      const tokens = userMessage.split(/\s+/).length;
      if (tokens > 100) {
        const guiaMsg = document.createElement('div');
        guiaMsg.className = 'grok-chat-message grok';
        guiaMsg.textContent = 'Por favor, limite sua mensagem a 100 palavras.';
        messagesDiv.appendChild(guiaMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        isSending = false;
        return;
      }

      const userMsg = document.createElement('div');
      userMsg.className = 'grok-chat-message user';
      userMsg.textContent = userMessage;
      messagesDiv.appendChild(userMsg);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const currentQuestion = document.querySelector('.j-pergunta.active .pergunta-enunciado')?.textContent || '';
      const currentAnswer = document.querySelector('.j-pergunta.active textarea')?.value || '';
      const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
      const blocoIdx = document.querySelector('.j-bloco[style*="display: block"]')?.dataset.bloco || 0;
      const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
      const context = {
        currentQuestion,
        currentAnswer,
        respostas,
        blocoIdx,
        progresso: document.getElementById('jprog-pct')?.textContent || '0% concluído',
        guia
      };

      const guiaConfigs = window.guiaConfigs || {
        zion: { apiUrl: 'https://zion-backend-api.onrender.com/v1/chat', model: 'grok' },
        lumen: { apiUrl: 'https://lumen-backend-api.onrender.com/v1/chat', model: 'gpt-5' },
        arian: { apiUrl: 'https://arion-backend-api.onrender.com/v1/chat', model: 'gemini' }
      };
      const cfg = guiaConfigs[guia] || guiaConfigs.lumen;

      try {
        const system = `Você é ${guia === 'zion' ? 'Zion (Grok)' : guia === 'arian' ? 'Arian (Gemini)' : 'Lumen (ChatGPT)'} guiando a Jornada. Contexto: ` + JSON.stringify(context);
        const resp = await fetch(cfg.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: cfg.model,
            messages: [{ role: 'system', content: system }, { role: 'user', content: userMessage }],
            temperature: 0.7
          })
        });
        if (!resp.ok) throw new Error('API falhou: ' + resp.status);
        const data = await resp.json();
        const guiaMessage = data?.choices?.[0]?.message?.content || data?.message?.content || 'Tô pronto pra te guiar! Como posso ajudar?';
        const guiaMsg = document.createElement('div');
        guiaMsg.className = 'grok-chat-message grok';
        messagesDiv.appendChild(guiaMsg);
        if (window.typeWriter) {
          window.typeWriter(guiaMsg, guiaMessage, 36, true);
          console.log('[Chat] Resposta do guia exibida:', guiaMessage);
        } else {
          guiaMsg.textContent = guiaMessage;
          console.warn('[Chat] window.typeWriter não definido, exibindo diretamente');
        }
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      } catch (e) {
        console.error('[Chat] Erro ao chamar API:', e);
        const guiaMsg = document.createElement('div');
        guiaMsg.className = 'grok-chat-message grok';
        if (window.typeWriter) {
          window.typeWriter(guiaMsg, 'Ops, algo deu errado! Tenta de novo ou pula pra próxima pergunta.', 36, true);
        } else {
          guiaMsg.textContent = 'Ops, algo deu errado! Tenta de novo ou pula pra próxima pergunta.';
        }
        messagesDiv.appendChild(guiaMsg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      input.value = '';
      isSending = false;
    }

    // Chamar sendChatMessage após um vídeo (exemplo de integração)
    document.addEventListener('videoEnded', () => {
      const perguntaDiv = document.getElementById('minhaDivPergunta'); // Ajuste o ID
      if (perguntaDiv && window.runTyping) {
        window.runTyping(perguntaDiv);
        console.log('[Chat] runTyping chamado após vídeo');
      }
    });

    // Vincular sendChatMessage a um botão ou input
   const chatInput = document.querySelector('#grok-chat-input');
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        console.log('[Jornada] Chat enviado:', chatInput.value);
        chatInput.value = '';
      }
    });
  } else {
    console.warn('[Jornada] #grok-chat-input não encontrado, ignorando inicialização do chat');
  }
  console.log('[Jornada] Inicializando eventos');
  })();
</script>
                
                <!-- devolutiva da API -->
<script>
  (function() {
    let isFetching = false; // Evitar múltiplas chamadas simultâneas

    async function fetchDevolutiva(pergunta, resposta, guia) {
      if (isFetching) {
        console.warn('[Devolutiva] Requisição em andamento, ignorando');
        return 'Aguarde a devolutiva anterior.';
      }
      isFetching = true;

      if (!pergunta || !resposta || !guia) {
        console.warn('[Devolutiva] Parâmetros inválidos:', { pergunta, resposta, guia });
        isFetching = false;
        return 'Parâmetros inválidos. Continue sua jornada!';
      }

      const guiaConfigs = window.guiaConfigs || {
        zion: { apiUrl: 'https://zion-backend-api.onrender.com/v1/chat', model: 'grok' },
        lumen: { apiUrl: 'https://lumen-backend-api.onrender.com/v1/chat', model: 'gpt-5' },
        arian: { apiUrl: 'https://arion-backend-api.onrender.com/v1/chat', model: 'gemini' }
      };
      const cfg = guiaConfigs[guia] || guiaConfigs.lumen;

      try {
        const system = `Você é ${guia === 'zion' ? 'Zion (Grok)' : guia === 'arian' ? 'Arian (Gemini)' : 'Lumen (ChatGPT)'} guiando a Jornada. Forneça uma devolutiva acolhedora, reflexiva e simbólica para a resposta do usuário à pergunta "${pergunta}".`;
        const resp = await fetch(cfg.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: cfg.model,
            messages: [
              { role: 'system', content: system },
              { role: 'user', content: resposta }
            ],
            temperature: 0.7
          })
        });
        if (!resp.ok) throw new Error('API falhou: ' + resp.status);
        const data = await resp.json();
        const devolutiva = data?.choices?.[0]?.message?.content || data?.message?.content || 'Obrigado por compartilhar. Sua reflexão ilumina o caminho.';
        console.log('[Devolutiva] Resposta recebida:', devolutiva);
        isFetching = false;
        return devolutiva;
      } catch (e) {
        console.error('[Devolutiva] Erro ao chamar API:', e);
        isFetching = false;
        return 'Ops, algo deu errado ao gerar a devolutiva. Continue sua jornada!';
      }
    }

    // Exemplo de integração com vídeos e perguntas
    document.addEventListener('videoEnded', async () => {
      const pergunta = document.querySelector('.j-pergunta.active .pergunta-enunciado')?.textContent || '';
      const resposta = document.querySelector('.j-pergunta.active textarea')?.value || '';
      const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
      if (pergunta && resposta) {
        const devolutiva = await fetchDevolutiva(pergunta, resposta, guia);
        const devolutivaDiv = document.getElementById('minhaDivDevolutiva'); // Ajuste o ID
        if (devolutivaDiv && window.typeDevolutiva) {
          window.typeDevolutiva(devolutivaDiv, devolutiva, 36);
          console.log('[Devolutiva] Exibindo devolutiva após vídeo');
        }
      }
    });

    // Expor fetchDevolutiva globalmente
    window.fetchDevolutiva = fetchDevolutiva;

    console.log('[Devolutiva] Bloco carregado');
  })();
</script>
  
               <!-- progresso & storage -->
<script>
  (function() {
    let isUpdating = false; // Evitar chamadas simultâneas

    function updateProgress() {
      if (isUpdating) {
        console.warn('[Progresso] Atualização em andamento, ignorando');
        return;
      }
      isUpdating = true;

      const perguntas = document.querySelectorAll('.j-pergunta');
      const respondidas = Array.from(perguntas).filter(p => (p.querySelector('textarea')?.value.trim() || '') !== '').length;
      const total = perguntas.length || 1;
      const pct = Math.round((respondidas / total) * 100);
      const fill = document.getElementById('jprog-fill');
      const badge = document.getElementById('jprog-pct');
      const jFill = document.getElementById('j-fill-inline');
      const jMeta = document.getElementById('j-meta');

      if (fill) fill.style.width = pct + '%';
      if (badge) badge.textContent = pct + '% concluído';
      if (jFill) jFill.style.width = pct + '%';
      if (jMeta) jMeta.textContent = `Respondidas: ${respondidas} de ${total}`;
      console.log('[Progresso] Progresso atualizado:', { respondidas, total, pct });

      isUpdating = false;
    }

    function saveAnswers() {
      const respostas = {};
      const inputs = document.querySelectorAll('.j-pergunta textarea');
      inputs.forEach((input, idx) => {
        const text = input.value.trim();
        const tokens = text.split(/\s+/).length;
        if (tokens > 100) {
          input.value = text.split(/\s+/).slice(0, 100).join(' ');
          window.toast && window.toast('Resposta limitada a 100 palavras.');
        }
        respostas[`q${idx}`] = input.value || '';
      });

      try {
        localStorage.setItem('jornada_respostas', JSON.stringify(respostas));
        console.log('[Progresso] Respostas salvas:', respostas);
      } catch (e) {
        console.error('[Progresso] Erro ao salvar respostas:', e);
        window.toast && window.toast('Erro ao salvar respostas.');
      }
    }

    function loadAnswers() {
      const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
      const inputs = document.querySelectorAll('.j-pergunta textarea');
      inputs.forEach((input, idx) => {
        input.value = respostas[`q${idx}`] || '';
        if (input.value && window.typeAnswer) {
          window.typeAnswer(input, input.value, 36);
          console.log('[Progresso] Resposta carregada com typeAnswer:', `q${idx}`);
        } else if (input.value) {
          console.warn('[Progresso] window.typeAnswer não definido, resposta aplicada diretamente:', `q${idx}`);
        }
      });
      updateProgress();
      console.log('[Progresso] Respostas carregadas:', respostas);
    }

    // Vincular eventos aos textareas
    document.addEventListener('input', (e) => {
      if (e.target.matches('.j-pergunta textarea')) {
        saveAnswers();
        updateProgress();
      }
    });

    // Carregar respostas após vídeo (exemplo de integração)
    document.addEventListener('videoEnded', () => {
      loadAnswers();
      console.log('[Progresso] loadAnswers chamado após vídeo');
    });

    // Expor funções globalmente
    window.updateProgress = updateProgress;
    window.saveAnswers = saveAnswers;
    window.loadAnswers = loadAnswers;

    console.log('[Progresso] Bloco carregado');
  })();
</script>
  
                 <!-- pergaminho & seções -->
<script>
  (function() {
    function checkImage(url, fallbackUrl) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => resolve(fallbackUrl);
        img.src = url;
      });
    }

    function updateCanvasBackground(sectionId) {
      const canvas = document.getElementById('jornada-canvas');
      if (!canvas) {
        console.warn('[Seções] Canvas #jornada-canvas não encontrado');
        return;
      }
      if (sectionId === 'section-perguntas') {
        checkImage('/assets/img/pergaminho-rasgado-horiz.png', '/assets/img/pergaminho-rasgado-vert.png').then(bg => {
          canvas.className = `card pergaminho pergaminho-h${bg.includes('vert') ? ' fallback' : ''}`;
          canvas.style.background = `var(--panel) url('${bg}') no-repeat center/cover`;
          console.log('[Seções] Fundo do canvas atualizado para perguntas:', bg);
        });
      } else {
        canvas.className = 'card pergaminho pergaminho-v';
        canvas.style.background = 'var(--panel) url(/assets/img/pergaminho-rasgado-vert.png) no-repeat center/cover';
        console.log('[Seções] Fundo do canvas atualizado para seção:', sectionId);
      }
    }

    function showSection(sectionId) {
      const sections = document.querySelectorAll('.j-section');
      sections.forEach(s => s.classList.add('hidden'));
      const active = document.getElementById(sectionId);
      if (active) {
        active.classList.remove('hidden');
        console.log('[Seções] Seção exibida:', sectionId);
      } else {
        console.warn('[Seções] Seção #', sectionId, 'não encontrada');
        return;
      }
      function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => {
    section.style.display = section.id === sectionId ? 'block' : 'none';
  });
  window.i18n?.apply?.(document.querySelector(`#${sectionId}`));
  if (sectionId === 'section-perguntas') {
    const firstBloco = document.querySelector('.j-bloco');
    if (firstBloco) {
      console.log('[showSection] Iniciando typeQuestionsSequentially para section-perguntas');
      window.JORNADA_QA?.typeQuestionsSequentially?.(firstBloco);
    } else {
      console.warn('[showSection] Nenhum bloco encontrado em section-perguntas');
    }
  }
}

     document.querySelectorAll('.btn-avancar').forEach(button => {
     button.addEventListener('click', () => {
     const nextSection = button.dataset.next;
     if (nextSection) showSection(nextSection);
    });
   });

      updateCanvasBackground(sectionId);

      // Chamar ensureHeroFlame se definida
      if (window.ensureHeroFlame) {
        window.ensureHeroFlame(sectionId);
      } else {
        console.warn('[Seções] window.ensureHeroFlame não definida');
      }

      if (sectionId === 'section-perguntas') {
        if (window.updateProgress) {
          window.updateProgress();
        } else {
          console.warn('[Seções] window.updateProgress não definida');
        }
        const perguntas = document.querySelectorAll('.j-pergunta');
        if (perguntas.length) {
          const first = document.querySelector('.j-pergunta.active') || perguntas[0];
          first.classList.add('active');
          const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
          const ta = first.querySelector('textarea');
          if (ta) {
            ta.placeholder = "Digite sua resposta...";
          }
          const aria = document.getElementById('aria-pergunta');
          if (aria) aria.textContent = lbl;
          // Chamar runTyping para a seção de perguntas
          if (window.runTyping) {
            window.runTyping(active);
            console.log('[Seções] runTyping chamado para section-perguntas');
          } else {
            console.warn('[Seções] window.runTyping não definida');
          }
        }
      }
      if (sectionId === 'section-final') {
        const url = localStorage.getItem('IRMANDADE_SELFIE_FINAL');
        if (url) {
          const img = document.querySelector('#minhaFotoFinal');
          if (img) img.src = url;
          console.log('[Seções] Foto final carregada:', url);
        }
      }
      if (sectionId === 'section-guia') {
        const guiaNameInput = document.getElementById('guiaNameInput');
        const storedName = localStorage.getItem('JORNADA_NOME') || '';
        if (guiaNameInput && storedName) guiaNameInput.value = storedName;
        console.log('[Seções] Nome carregado para section-guia:', storedName);
      }
    }

    // Integração com vídeo: chamar showSection após vídeo
    document.addEventListener('videoEnded', () => {
      const nextSection = window.JC?.nextSection || 'section-perguntas'; // Assumindo JC.nextSection definido em outro script
      showSection(nextSection);
      console.log('[Seções] showSection chamado após vídeo para:', nextSection);
    });

    // Expor showSection globalmente
    window.showSection = showSection;

    console.log('[Seções] Bloco carregado');
  })();
</script>
  
               <!-- showSection -->
<script>
  (function() {
    const HIDE_CLASS = 'hidden';
    let lastShowSection = 0;

    window.showSection = function(id) {
      const now = performance.now();
      if (now - lastShowSection < 500) {
        console.log('[showSection] Debounce: evitando chamada repetida');
        return;
      }
      lastShowSection = now;

      try {
        document.querySelectorAll('.j-section, #videoOverlay, #video-container').forEach(elem => {
          elem.classList.add(HIDE_CLASS);
          elem.style.display = 'none';
        });
        const target = document.getElementById(id);
        if (!target) {
          console.warn('[showSection] Seção não encontrada:', id);
          window.toast && window.toast(`Seção ${id} não encontrada.`);
          return;
        }
        target.classList.remove(HIDE_CLASS);
        target.style.display = 'block';
        window.__currentSectionId = id;
        console.log('[showSection] Exibindo seção:', id);

        const canvas = document.getElementById('jornada-canvas');
        if (canvas) {
          if (id === 'section-perguntas') {
            canvas.classList.remove('pergaminho-v');
            canvas.classList.add('pergaminho-h');
          } else {
            canvas.classList.remove('pergaminho-h');
            canvas.classList.add('pergaminho-v');
          }
        }

        setTimeout(() => {
          if (id === 'section-perguntas' && window.loadDynamicBlocks) {
            window.loadDynamicBlocks();
            console.log('[showSection] loadDynamicBlocks chamado para section-perguntas');
          }
          if (window.runTyping) {
            window.runTyping(target);
            console.log('[showSection] Iniciando runTyping para:', id);
          }
          const btns = target.querySelectorAll('[data-action="avancar"], .btn-avancar, #iniciar, [data-action="skip-selfie"], [data-action="select-guia"], #btnSkipSelfie, #btnStartJourney');
          btns.forEach(btn => {
            if (!btn.dataset.clickAttached) {
              btn.addEventListener('click', (e) => {
                e.preventDefault();
                if (window.JC && window.JC.goNext) window.JC.goNext();
              }, { once: true });
              btn.dataset.clickAttached = '1';
              console.log('[showSection] Evento de clique adicionado ao botão avançar em:', id, 'Botão:', btn.id || btn.className);
            }
          });
        }, 100);
      } catch (e) {
        console.error('[showSection] Erro:', e);
        window.toast && window.toast('Erro ao exibir seção.');
      }
    };

    document.addEventListener('videoEnded', () => {
      const nextSection = window.JC?.nextSection || 'section-perguntas';
      window.showSection(nextSection);
      console.log('[showSection] Chamado após vídeo para:', nextSection);
    });

    console.log('[showSection] Bloco carregado');
  })();
</script>
  
                  <!-- blocos dinâmicos -->
<script>
  (function() {
    let isLoadingBlocks = false; // Evitar chamadas simultâneas

    window.loadDynamicBlocks = function() {
      if (isLoadingBlocks) {
        console.warn('[DynamicBlocks] Carregamento em andamento, ignorando');
        return;
      }
      isLoadingBlocks = true;

      const content = document.getElementById('perguntas-container');
      if (!content) {
        console.warn('[DynamicBlocks] #perguntas-container não encontrado');
        isLoadingBlocks = false;
        return;
      }

      const blocks = window.JORNADA_BLOCKS || [];
      if (!blocks.length) {
        console.warn('[DynamicBlocks] window.JORNADA_BLOCKS vazio ou não definido');
        isLoadingBlocks = false;
        return;
      }

      content.innerHTML = '';

      blocks.forEach((block, bIdx) => {
        const bloco = document.createElement('section');
        bloco.className = 'j-bloco';
        bloco.dataset.bloco = bIdx;
        bloco.dataset.video = block.video_after || '';

        (block.questions || []).forEach((q, qIdx) => {
          const label = typeof q === 'string' ? q : (q.label || q.text || '');
          const div = document.createElement('div');
          div.className = 'j-pergunta';
          div.dataset.pergunta = qIdx;

          const enunciado =
            `<label class="pergunta-enunciado" ` +
            `data-typing data-text="Pergunta ${qIdx + 1}: ${label}" ` +
            `data-speed="36" data-cursor="true"></label>`;

          div.innerHTML = enunciado +
            `\n<textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>` +
            `<div class="devolutiva-container" style="display:none;"><p data-typing data-speed="36" data-cursor="true"></p></div>` +
            `<div class="accessibility-controls">` +
            `<button class="btn-mic" data-action="start-mic">🎤 Falar Resposta</button>` +
            `<button class="btn-audio" data-action="read-question">🔊 Ler Pergunta</button>` +
            `</div>`;

          bloco.appendChild(div);
        });

        content.appendChild(bloco);
      });

      const firstBloco = content.querySelector('.j-bloco');
      if (firstBloco) {
        firstBloco.style.display = 'block';
        const first = firstBloco.querySelector('.j-pergunta');
        if (first) {
          first.classList.add('active');
          if (window.runTyping) {
            window.runTyping(first);
            console.log('[DynamicBlocks] runTyping chamado para primeira pergunta');
          } else {
            console.warn('[DynamicBlocks] window.runTyping não definido');
          }
          // Reproduzir vídeo associado ao primeiro bloco, se houver
          const videoAfter = firstBloco.dataset.video;
          if (videoAfter && window.playVideo) {
            window.playVideo(videoAfter);
            console.log('[DynamicBlocks] Reproduzindo vídeo do bloco:', videoAfter);
          }
        }
      }

      if (window.loadAnswers) {
        window.loadAnswers();
        console.log('[DynamicBlocks] loadAnswers chamado');
      } else {
        console.warn('[DynamicBlocks] window.loadAnswers não definido');
      }

      const firstTa = document.querySelector('.j-bloco .j-pergunta textarea');
      if (firstTa && window.handleInput) {
        window.handleInput(firstTa);
        console.log('[DynamicBlocks] handleInput chamado para primeiro textarea');
      } else {
        console.warn('[DynamicBlocks] window.handleInput ou textarea não definido');
      }

      if (window.initAccessibility) {
        window.initAccessibility();
        console.log('[DynamicBlocks] initAccessibility chamado');
      } else {
        console.warn('[DynamicBlocks] window.initAccessibility não definido');
      }

      isLoadingBlocks = false;
    };

    // Redefinir goNext
    const prevGoNext = window.goNext;
    window.goNext = function() {
      if (prevGoNext) {
        prevGoNext();
        console.log('[DynamicBlocks] prevGoNext chamado');
      }
      const active = document.querySelector('.j-pergunta.active');
      if (active && window.runTyping) {
        window.runTyping(active);
        console.log('[DynamicBlocks] runTyping chamado em goNext');
      } else {
        console.warn('[DynamicBlocks] .j-pergunta.active ou window.runTyping não definido');
      }
      // Reproduzir vídeo do próximo bloco, se houver
      const activeBloco = document.querySelector('.j-bloco[style*="display: block"]');
      const nextBlocoIdx = activeBloco ? parseInt(activeBloco.dataset.bloco) + 1 : 0;
      const nextBloco = document.querySelector(`.j-bloco[data-bloco="${nextBlocoIdx}"]`);
      if (nextBloco) {
        document.querySelectorAll('.j-bloco').forEach(b => b.style.display = 'none');
        nextBloco.style.display = 'block';
        const videoAfter = nextBloco.dataset.video;
        if (videoAfter && window.playVideo) {
          window.playVideo(videoAfter);
          console.log('[DynamicBlocks] Reproduzindo vídeo do próximo bloco:', videoAfter);
        }
      }
    };

    // Integração com vídeo
    document.addEventListener('videoEnded', () => {
      const activeBloco = document.querySelector('.j-bloco[style*="display: block"]');
      if (activeBloco) {
        const firstPergunta = activeBloco.querySelector('.j-pergunta');
        if (firstPergunta && window.runTyping) {
          firstPergunta.classList.add('active');
          window.runTyping(firstPergunta);
          console.log('[DynamicBlocks] runTyping chamado após vídeo');
        }
      }
    });

    console.log('[DynamicBlocks] Bloco carregado');
  })();
</script>
  
                  <!-- controles -->
<script>
  (function() {
    let isHandlingInput = false; // Evitar múltiplas chamadas a handleInput

    function analyzeSentiment(text) {
      const POS = {
        'feliz': 2, 'alegria': 2, 'amor': 3, 'sucesso': 2, 'esperança': 3, 'paz': 2,
        'fé': 3, 'gratidão': 2, 'vitória': 3, 'superação': 3, 'luz': 2, 'deus': 3,
        'coragem': 2, 'força': 2, 'confiança': 2, 'propósito': 3
      };
      const NEG = {
        'triste': -2, 'dor': -3, 'raiva': -2, 'medo': -2, 'frustracao': -2, 'frustração': -2,
        'decepcao': -2, 'decepção': -2, 'perda': -3, 'culpa': -2, 'ansiedade': -2,
        'solidao': -2, 'solidão': -2, 'desespero': -3, 'cansaco': -2, 'cansaço': -2,
        'fracasso': -2, 'trauma': -3, 'duvida': -2, 'dúvida': -2
      };
      let score = 0;
      (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').split(/\s+/).forEach(t => {
        if (POS[t] != null) score += POS[t];
        if (NEG[t] != null) score += NEG[t];
      });
      return score;
    }

    async function handleInput(textarea) {
      if (isHandlingInput) {
        console.warn('[Controles] Processamento de input em andamento, ignorando');
        return;
      }
      isHandlingInput = true;

      if (!textarea) {
        console.warn('[Controles] Textarea não encontrado');
        isHandlingInput = false;
        return;
      }

      const score = analyzeSentiment(textarea.value);
      if (window.updateChama) {
        window.updateChama(score);
        console.log('[Controles] updateChama chamado com score:', score);
      } else {
        console.warn('[Controles] window.updateChama não definido');
      }

      if (window.saveAnswers) window.saveAnswers();
      if (window.updateProgress) window.updateProgress();

      const perguntaDiv = textarea.closest('.j-pergunta');
      const devolutivaDiv = perguntaDiv?.querySelector('.devolutiva-container');
      const devolutivaP = devolutivaDiv?.querySelector('p');
      if (textarea.value.trim() && devolutivaDiv && devolutivaP) {
        devolutivaDiv.style.display = 'block';
        const pergunta = perguntaDiv?.querySelector('.pergunta-enunciado')?.textContent || '';
        const resposta = textarea.value;
        const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
        if (window.fetchDevolutiva) {
          const devolutiva = await window.fetchDevolutiva(pergunta, resposta, guia);
          if (window.typeDevolutiva) {
            window.typeDevolutiva(devolutivaP, devolutiva, 36);
            console.log('[Controles] Devolutiva exibida:', devolutiva);
          } else {
            devolutivaP.textContent = devolutiva;
            console.warn('[Controles] window.typeDevolutiva não definido, exibindo diretamente');
          }
        }
      } else {
        if (devolutivaDiv) devolutivaDiv.style.display = 'none';
      }
      isHandlingInput = false;
    }

    function toggleSenha() {
      const input = document.getElementById('senha');
      if (!input) {
        console.warn('[Controles] Input #senha não encontrado');
        return;
      }
      input.type = (input.type === 'password' ? 'text' : 'password');
      console.log('[Controles] Tipo de senha alternado:', input.type);
    }

    function proceedAfterGuia(guia) {
      const guiaNameInput = document.getElementById('guiaNameInput');
      if (guiaNameInput && guiaNameInput.value.trim()) {
        localStorage.setItem('JORNADA_NOME', guiaNameInput.value.trim());
      } else {
        window.toast && window.toast('Por favor, insira seu nome antes de prosseguir.');
        console.warn('[Controles] Nome não inserido');
        return;
      }
      localStorage.setItem('JORNADA_GUIA', guia);
      if (window.ensureHeroFlame) {
        window.ensureHeroFlame('section-selfie');
      } else {
        console.warn('[Controles] window.ensureHeroFlame não definido');
      }
      if (window.showSection) {
        window.showSection('section-selfie');
      }
      const card = document.getElementById('card-guide');
      const bgImg = document.getElementById('guideBg');
      const guideNameEl = document.getElementById('guideNameSlot');
      if (card && bgImg && guideNameEl) {
        card.dataset.guide = guia.toUpperCase();
        guideNameEl.textContent = guia.toUpperCase();
        bgImg.src = `/assets/img/irmandade-quarteto-bg-${guia}.png`;
        console.log('[Controles] Interface de guia atualizada:', guia);
      } else {
        console.warn('[Controles] Elementos do guia não encontrados');
      }
    }

    function proceedAfterSelfie() {
      isTransitioning = false;
      const intro = window.JORNADA_VIDEOS?.intro || '';
      if (!intro || window.__introPlayed) {
        if (window.proceedToQuestions) {
          window.proceedToQuestions();
          console.log('[Controles] proceedToQuestions chamado');
        } else {
          console.warn('[Controles] window.proceedToQuestions não definido');
        }
        return;
      }
      window.__introPlayed = true;
      if (window.playTransition) {
        window.playTransition(intro, () => {
          if (window.proceedToQuestions) {
            window.proceedToQuestions();
            console.log('[Controles] proceedToQuestions chamado após vídeo');
          }
        });
      } else {
        console.warn('[Controles] window.playTransition não definido');
      }
    }

    let isTransitioning = false;
    function goNext() {
      if (isTransitioning) {
        console.warn('[Controles] Transição em andamento, ignorando');
        return;
      }
      isTransitioning = true;

      const current = document.querySelector('.j-pergunta.active');
      if (!current) {
        console.warn('[Controles] .j-pergunta.active não encontrado');
        isTransitioning = false;
        return;
      }

      const bloco = current.closest('.j-bloco');
      if (!bloco) {
        console.warn('[Controles] .j-bloco não encontrado');
        isTransitioning = false;
        return;
      }

      const perguntas = Array.from(bloco.querySelectorAll('.j-pergunta'));
      const i = perguntas.indexOf(current);
      current.classList.remove('active');

      if (i + 1 < perguntas.length) {
        const prox = perguntas[i + 1];
        prox.classList.add('active');
        const lbl = prox.querySelector('.pergunta-enunciado')?.textContent || '';
        const ta = prox.querySelector('textarea');
        if (ta) ta.placeholder = "Digite sua resposta...";
        const aria = document.getElementById('aria-pergunta');
        if (aria) aria.textContent = lbl;
        if (window.runTyping) {
          window.runTyping(prox);
          console.log('[Controles] runTyping chamado para próxima pergunta');
        }
        if (window.updateProgress) {
          window.updateProgress();
        }
        isTransitioning = false;
        return;
      }

      const blocos = Array.from(document.querySelectorAll('.j-bloco'));
      const idxBloco = parseInt(bloco.dataset.bloco, 10);
      const temProx = idxBloco + 1 < blocos.length;

      const irAdiante = () => {
        if (temProx) {
          blocos.forEach(b => b.style.display = 'none');
          const proxBloco = blocos[idxBloco + 1];
          if (!proxBloco) {
            console.warn('[Controles] Próximo bloco não encontrado');
            isTransitioning = false;
            return;
          }
          proxBloco.style.display = 'block';
          const primeira = proxBloco.querySelector('.j-pergunta');
          if (primeira) {
            primeira.classList.add('active');
            const lbl = primeira.querySelector('.pergunta-enunciado')?.textContent || '';
            const ta = primeira.querySelector('textarea');
            if (ta) ta.placeholder = "Digite sua resposta...";
            const aria = document.getElementById('aria-pergunta');
            if (aria) aria.textContent = lbl;
            if (window.runTyping) {
              window.runTyping(primeira);
              console.log('[Controles] runTyping chamado para primeiro bloco');
            }
          }
          if (window.updateProgress) {
            window.updateProgress();
          }
        } else {
          if (window.JORNADA_FINAL_VIDEO && window.playTransition) {
            window.playTransition(window.JORNADA_FINAL_VIDEO, () => {
              if (window.showSection) {
                window.showSection('section-final');
                console.log('[Controles] showSection chamado para section-final');
              }
              isTransitioning = false;
            });
          } else {
            if (window.showSection) {
              window.showSection('section-final');
            }
            isTransitioning = false;
          }
          if (window.updateProgress) {
            window.updateProgress();
          }
        }
      };

      const src = (window.JORNADA_BLOCKS[idxBloco] && window.JORNADA_BLOCKS[idxBloco].video_after) || '';
      if (src && window.playTransition) {
        window.playTransition(src, () => {
          irAdiante();
          console.log('[Controles] irAdiante chamado após vídeo');
        });
      } else {
        irAdiante();
      }
    }
    window.goNext = goNext;

    function playTransition(src, onEnd) {
      const overlay = document.getElementById('videoOverlay');
      const video = document.getElementById('videoTransicao');
            video.loop = false; // Impede looping
      const fallback = document.getElementById('videoFallback');
      const skip = document.getElementById('skipVideo');
      if (!overlay || !video || !fallback || !src) {
        console.warn('[Controles] Elementos de vídeo ou src não encontrados');
        onEnd && onEnd();
        return;
      }

      window.__playingTransition = true;
      overlay.classList.remove('hidden');
      video.classList.remove('hidden');
      fallback.classList.add('hidden');
      video.pause();
      video.removeAttribute('src');
      video.load();
      video.currentTime = 0;
      video.controls = true;
      video.muted = false;
      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.style.background = '#000';

      let ended = false;
      const cleanup = () => {
        if (ended) return;
        ended = true;
        isTransitioning = false;
        window.__playingTransition = false;
        video.pause();
        overlay.classList.add('hidden');
        video.classList.add('hidden');
        fallback.classList.add('hidden');
        video.removeAttribute('src');
        video.load();
        onEnd && onEnd();
        document.dispatchEvent(new Event('videoEnded')); // Disparar evento
        console.log('[Controles] Transição de vídeo finalizada');
      };

      video.onerror = (e) => {
        console.error('[Controles] Erro no vídeo:', e, 'Source:', src);
        fallback.classList.remove('hidden');
        video.classList.add('hidden');
        window.toast && window.toast('Não foi possível carregar o vídeo.');
        setTimeout(cleanup, 1500);
      };
      video.onended = cleanup;
      if (skip) skip.onclick = cleanup;

      video.onloadedmetadata = () => {
        if (!video.videoWidth || !video.videoHeight) {
          video.classList.add('hidden');
          fallback.classList.remove('hidden');
        }
        video.currentTime = 0;
        setTimeout(() => {
          video.play().catch((e) => {
            console.error('[Controles] Erro na reprodução do vídeo:', e, 'Source:', src);
            fallback.classList.remove('hidden');
            video.classList.add('hidden');
            setTimeout(cleanup, 1500);
          });
        }, 400);
      };

      video.src = src + '?t=' + Date.now();
      setTimeout(cleanup, 90000);
    }
    window.playTransition = playTransition;

    console.log('[Controles] Bloco carregado');
  })();
</script>
  
                  <!-- controle de orientação de vídeo -->
<script>
  (function() {
    let isStartingJourney = false;
    let isProceedingToQuestions = false;

    function lockVideoOrientation() {
      const video = document.getElementById('videoTransicao');
      if (!video) {
        console.warn('[Controle] Vídeo #videoTransicao não encontrado');
        return;
      }
      video.addEventListener('webkitbeginfullscreen', (e) => {
        e.preventDefault();
        video.exitFullscreen?.();
        console.log('[Controle] Tela cheia bloqueada para vídeo');
      });
      video.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement === video) {
          document.exitFullscreen?.();
          console.log('[Controle] Saiu do modo tela cheia');
        }
      });
      window.addEventListener('orientationchange', () => {
        video.style.transform = 'rotate(0deg)';
        console.log('[Controle] Orientação ajustada');
      });
      if (window.matchMedia('(orientation: portrait)').matches) {
        video.style.width = '100vw';
        video.style.height = 'auto';
        video.style.maxHeight = '100vh';
        console.log('[Controle] Vídeo ajustado para modo retrato');
      }
    }

    function generatePDF() {
      const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
      const doc = { content: [] };
      doc.content.push({
        text: 'Jornada Essencial - Irmandade Conhecimento com Luz',
        style: { fontSize: 20, bold: true, alignment: 'center', margin: [0, 0, 0, 20] }
      });
      Object.keys(respostas).forEach((key, idx) => {
        const pergunta = document.querySelector(`.j-pergunta[data-pergunta="${idx}"] .pergunta-enunciado`)?.textContent || `Pergunta ${idx + 1}`;
        doc.content.push(
          { text: pergunta, style: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] } },
          { text: respostas[key] || 'Sem resposta', style: { fontSize: 12, margin: [0, 0, 0, 10] } }
        );
      });
      if (window.pdfMake) {
        window.pdfMake.createPdf(doc).download('jornada_essencial.pdf');
        console.log('[Controle] PDF gerado e baixado');
      } else {
        window.toast && window.toast('PDF não disponível.');
        console.warn('[Controle] window.pdfMake não definido');
      }
    }

    function startJourney() {
      if (isStartingJourney) {
        console.warn('[Controle] Início da jornada em andamento, ignorando');
        return;
      }
      isStartingJourney = true;

      const senha = (document.getElementById('senha')?.value || '').trim().toLowerCase();
      console.log('[startJourney] Senha ignorada p/ debug:', senha);
      if (window.ensureHeroFlame) {
        window.ensureHeroFlame('section-guia');
      } else {
        console.warn('[Controle] window.ensureHeroFlame não definido');
      }
      if (window.showSection) {
        window.showSection('section-guia');
        console.log('[Controle] showSection chamado para section-guia');
      } else {
        console.warn('[Controle] window.showSection não definido');
      }
      isStartingJourney = false;
    }

    function proceedToQuestions() {
      if (isProceedingToQuestions) {
        console.warn('[Controle] Navegação para perguntas em andamento, ignorando');
        return;
      }
      isProceedingToQuestions = true;

      window.isTransitioning = false;
      if (window.showSection) {
        window.showSection('section-perguntas');
      } else {
        console.warn('[Controle] window.showSection não definido');
      }
      if (window.loadDynamicBlocks) {
        window.loadDynamicBlocks();
        console.log('[Controle] loadDynamicBlocks chamado');
      } else {
        console.warn('[Controle] window.loadDynamicBlocks não definido');
      }

      const perguntas = document.querySelectorAll('.j-pergunta');
      if (perguntas.length) {
        perguntas[0].classList.add('active');
        const lbl = perguntas[0].querySelector('.pergunta-enunciado')?.textContent || '';
        const ta = perguntas[0].querySelector('textarea');
        if (ta) {
          ta.placeholder = "Digite sua resposta...";
          if (window.handleInput) {
            window.handleInput(ta);
            console.log('[Controle] handleInput chamado para primeira pergunta');
          }
        }
        const aria = document.getElementById('aria-pergunta');
        if (aria) aria.textContent = lbl;
      }
      if (window.updateProgress) {
        window.updateProgress();
        console.log('[Controle] updateProgress chamado');
      } else {
        console.warn('[Controle] window.updateProgress não definido');
      }
      isProceedingToQuestions = false;
    }

    // Integração com vídeo
    document.addEventListener('videoEnded', () => {
      proceedToQuestions();
      console.log('[Controle] proceedToQuestions chamado após vídeo');
    });

    // Expor funções globalmente
    window.lockVideoOrientation = lockVideoOrientation;
    window.generatePDF = generatePDF;
    window.startJourney = startJourney;
    window.proceedToQuestions = proceedToQuestions;

    console.log('[Controle] Bloco carregado');
  })();
</script>
  
               <!-- Acessibilidade: Microfone e Áudio -->
<script>
  (function() {
    let recognition = null;
    let currentLang = 'pt-BR';
    let isRecognizing = false;

    function initAccessibility() {
      console.log('[Acessibilidade] Iniciando initAccessibility');
      if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = currentLang;
        console.log('[Acessibilidade] Reconhecimento de voz inicializado:', currentLang);
      } else {
        window.toast && window.toast('Seu navegador não suporta reconhecimento de voz.');
        console.warn('[Acessibilidade] SpeechRecognition não suportado');
      }

      document.addEventListener('click', (ev) => {
        if (!ev.target) return;
        const btnMic = ev.target.closest('[data-action="start-mic"]');
        const btnAudio = ev.target.closest('[data-action="read-question"]');
        if (btnMic) {
          ev.preventDefault();
          const ta = btnMic.closest('.j-pergunta')?.querySelector('textarea');
          if (ta) {
            startRecognition(ta, btnMic);
            console.log('[Acessibilidade] Iniciando reconhecimento de voz');
          }
        }
        if (btnAudio) {
          ev.preventDefault();
          const enunciado = btnAudio.closest('.j-pergunta')?.querySelector('.pergunta-enunciado');
          const text = enunciado?.textContent || '';
          readAloud(text);
          console.log('[Acessibilidade] Lendo enunciado:', text);
        }
      });

      const langSelect = document.getElementById('language-select');
      if (langSelect) {
        langSelect.addEventListener('change', (ev) => {
          currentLang = ev.target.value;
          if (recognition) recognition.lang = currentLang;
          window.I18N?.setLang(currentLang);
          window.toast && window.toast(`Idioma alterado para ${currentLang}`);
          console.log('[Acessibilidade] Idioma alterado:', currentLang);
          if (window.updateBlocks) {
            window.updateBlocks();
          } else {
            console.warn('[Acessibilidade] window.updateBlocks não definido');
          }
          if (!document.getElementById('section-perguntas').classList.contains('hidden') && window.loadDynamicBlocks) {
            window.loadDynamicBlocks();
            console.log('[Acessibilidade] loadDynamicBlocks chamado após mudança de idioma');
          }
        });
      } else {
        console.warn('[Acessibilidade] #language-select não encontrado');
      }
    }

    function startRecognition(textarea, btn) {
      if (!recognition || isRecognizing) {
        console.warn('[Acessibilidade] Reconhecimento já em andamento ou não inicializado');
        return;
      }
      isRecognizing = true;
      btn.classList.add('recording');
      btn.textContent = 'Gravando...';
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        if (window.typeAnswer) {
          window.typeAnswer(textarea, (textarea.value ? textarea.value + ' ' : '') + transcript, 36);
          console.log('[Acessibilidade] Texto transcrito:', transcript);
        }
        if (window.saveAnswers) window.saveAnswers();
        if (window.updateProgress) window.updateProgress();
      };
      recognition.onend = () => {
        isRecognizing = false;
        btn.classList.remove('recording');
        btn.textContent = '🎤 Falar Resposta';
        console.log('[Acessibilidade] Reconhecimento finalizado');
      };
      recognition.onerror = (event) => {
        window.toast && window.toast('Erro no reconhecimento: ' + event.error);
        console.error('[Acessibilidade] Erro no reconhecimento:', event.error);
        recognition.onend();
      };
      recognition.start();
    }

    function readAloud(text) {
  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'pt-BR'; // Ajuste conforme o idioma
    window.speechSynthesis.speak(utterance);
  } else {
    console.error('API de síntese de voz não suportada');
  }
}

document.querySelectorAll('[data-action="read-question"]').forEach(button => {
  button.addEventListener('click', () => {
    const pergunta = button.closest('.pergunta').textContent;
    readAloud(pergunta);
  });
});

    function initJornada() {
      console.log('[Jornada] Inicializando eventos');
      let isProcessingClick = false;

      document.addEventListener('input', (ev) => {
        const ta = ev.target.closest?.('.j-pergunta textarea');
        if (ta && window.handleInput) {
          window.handleInput(ta);
          console.log('[Jornada] handleInput chamado em input');
        }
      });

      document.addEventListener('focusin', (ev) => {
        if (ev.target && ev.target.matches('.j-pergunta textarea') && window.__abortTypingPlaceholder) {
          window.__abortTypingPlaceholder();
          console.log('[Jornada] Aborted typing placeholder');
        }
      });

      document.addEventListener('click', (ev) => {
        if (isProcessingClick || window.isTransitioning || !ev.target) return;
        isProcessingClick = true;

        const aNext = ev.target.closest?.('[data-action="next"]');
        const aStart = ev.target.closest?.('[data-action="start"]');
        const aToggle = ev.target.closest?.('[data-action="toggle-password"], .password-toggle');
        const aRestart = ev.target.closest?.('[data-action="restart"]');
        const btnPDF = ev.target.closest?.('[data-action="generate-pdf"]');
        const btnDownloadSelfie = ev.target.closest?.('[data-action="download-selfie"]');
        const btnSkipSelfie = ev.target.closest?.('[data-action="skip-selfie"]');
        const btnSendChat = ev.target.closest?.('[data-action="send-chat"]');
        const btnSelectGuia = ev.target.closest?.('[data-action="select-guia"]');
        const btnNextTermos = ev.target.closest?.('[data-action="next-termos"]');
        const btnNextSenha = ev.target.closest?.('[data-action="next-senha"]');
        const btnTermosNext = ev.target.closest?.('[data-action="termos-next"]');
        const btnTermosPrev = ev.target.closest?.('[data-action="termos-prev"]');

        if (aNext) {
          ev.preventDefault();
          if (window.goNext) window.goNext();
          console.log('[Jornada] goNext chamado');
        }
        if (aStart) {
          ev.preventDefault();
          if (window.startJourney) window.startJourney();
          console.log('[Jornada] startJourney chamado');
        }
        if (aToggle) {
          ev.preventDefault();
          if (window.toggleSenha) window.toggleSenha();
          console.log('[Jornada] toggleSenha chamado');
        }
        if (aRestart) {
          ev.preventDefault();
          localStorage.removeItem('jornada_respostas');
          localStorage.removeItem('JORNADA_GUIA');
          location.hash = '#intro';
          location.replace('/index.html');
          console.log('[Jornada] Jornada reiniciada');
        }
        if (btnPDF) {
          ev.preventDefault();
          if (window.generatePDF) window.generatePDF();
          console.log('[Jornada] generatePDF chamado');
        }
        if (btnDownloadSelfie) {
          ev.preventDefault();
          const dataURL = localStorage.getItem('IRMANDADE_SELFIE_FINAL');
          if (dataURL) {
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'jornada-selfie.png';
            a.click();
            console.log('[Jornada] Download de selfie iniciado');
          } else {
            window.toast && window.toast('Nenhuma imagem disponível para download.');
            console.warn('[Jornada] Nenhuma selfie disponível');
          }
        }
        if (btnSkipSelfie) {
          ev.preventDefault();
          if (window.proceedAfterSelfie) window.proceedAfterSelfie();
          console.log('[Jornada] proceedAfterSelfie chamado');
        }
        if (btnSendChat) {
          ev.preventDefault();
          if (window.sendChatMessage) window.sendChatMessage();
          console.log('[Jornada] sendChatMessage chamado');
        }
        if (btnSelectGuia) {
          ev.preventDefault();
          if (window.proceedAfterGuia) window.proceedAfterGuia(btnSelectGuia.dataset.guia);
          console.log('[Jornada] proceedAfterGuia chamado:', btnSelectGuia.dataset.guia);
        }
        if (btnNextTermos) {
          ev.preventDefault();
          if (window.showSection) window.showSection('section-termos');
          console.log('[Jornada] showSection chamado para section-termos');
        }
        if (btnNextSenha) {
          ev.preventDefault();
          if (window.showSection) window.showSection('section-senha');
          console.log('[Jornada] showSection chamado para section-senha');
        }
        if (btnTermosNext) {
          ev.preventDefault();
          const pg1 = document.getElementById('termos-pg1');
          const pg2 = document.getElementById('termos-pg2');
          if (pg1) pg1.classList.add('hidden');
          if (pg2) pg2.classList.remove('hidden');
          console.log('[Jornada] Navegação para termos-pg2');
        }
        if (btnTermosPrev) {
          ev.preventDefault();
          const pg1 = document.getElementById('termos-pg1');
          const pg2 = document.getElementById('termos-pg2');
          if (pg2) pg2.classList.add('hidden');
          if (pg1) pg1.classList.remove('hidden');
          console.log('[Jornada] Navegação para termos-pg1');
        }

        isProcessingClick = false;
      }, { capture: true });

      const chatInput = document.getElementById('grok-chat-input');
      if (chatInput) {
        chatInput.addEventListener('keypress', (ev) => {
          if (ev.key === 'Enter') {
            ev.preventDefault();
            if (window.sendChatMessage) window.sendChatMessage();
            console.log('[Jornada] sendChatMessage chamado via Enter');
          }
        });
      } else {
        console.warn('[Jornada] #grok-chat-input não encontrado');
      }
    }

    window.initAccessibility = initAccessibility;
    window.initJornada = initJornada;

    initAccessibility();
    initJornada();

    console.log('[Acessibilidade] Bloco carregado');
  })();
</script>
  
                <!-- vídeos & blocos -->
<script>
  (function() {
    const VIDEO_BASE = '/assets/videos/';
    window.JORNADA_VIDEOS = {
      intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
      afterBlocks: {
        0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4',
        1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4',
        2: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4',
        3: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4'
      },
      final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
    };
    window.JORNADA_FINAL_VIDEO = window.JORNADA_VIDEOS.final;

    const blockTranslations = {
      'pt-BR': [
        {
          title: 'Bloco 1 — Raízes',
          questions: [
            { label: window.i18n?.t('pergunta1', 'Quem é você hoje?') },
            { label: window.i18n?.t('pergunta2', 'O que te trouxe até esta jornada?') },
            { label: window.i18n?.t('pergunta3', 'Qual é o seu maior sonho espiritual?') }
          ],
          video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4'
        },
        {
          title: 'Bloco 2 — Reflexões',
          questions: [
            { label: window.i18n?.t('pergunta4', 'Quais são seus maiores desafios atuais?') },
            { label: window.i18n?.t('pergunta5', 'Como você lida com o medo ou a dúvida?') },
            { label: window.i18n?.t('pergunta6', 'O que a "luz" significa para você?') }
          ],
          video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4'
        },
        {
          title: 'Bloco 3 — Crescimento',
          questions: [
            { label: window.i18n?.t('pergunta7', 'O que você quer mudar na sua vida?') },
            { label: window.i18n?.t('pergunta8', 'Quem inspira você e por quê?') },
            { label: window.i18n?.t('pergunta9', 'Como você pratica gratidão no dia a dia?') }
          ],
          video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4'
        },
        {
          title: 'Bloco 4 — Integração',
          questions: [
            { label: window.i18n?.t('pergunta10', 'Qual lição você leva dessa jornada?') },
            { label: window.i18n?.t('pergunta11', 'Como vai aplicar isso no futuro?') },
            { label: window.i18n?.t('pergunta12', 'Uma mensagem para seu eu futuro.') }
          ],
          video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4'
        }
      ],
      'en-US': [
        {
          title: 'Block 1 — Roots',
          questions: [
            { label: window.i18n?.t('pergunta1', 'Who are you today?') },
            { label: window.i18n?.t('pergunta2', 'What brought you to this journey?') },
            { label: window.i18n?.t('pergunta3', 'What is your greatest spiritual dream?') }
          ],
          video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4'
        },
        {
          title: 'Block 2 — Reflections',
          questions: [
            { label: window.I18N?.t('pergunta4', 'What are your biggest current challenges?') },
            { label: window.I18N?.t('pergunta5', 'How do you deal with fear or doubt?') },
            { label: window.I18N?.t('pergunta6', 'What does "light" mean to you?') }
          ],
          video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4'
        },
        {
          title: 'Block 3 — Growth',
          questions: [
            { label: window.I18N?.t('pergunta7', 'What do you want to change in your life?') },
            { label: window.I18N?.t('pergunta8', 'Who inspires you and why?') },
            { label: window.I18N?.t('pergunta9', 'How do you practice gratitude in your daily life?') }
          ],
          video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4'
        },
        {
          title: 'Block 4 — Integration',
          questions: [
            { label: window.i18n?.t('pergunta10', 'What lesson do you take from this journey?') },
            { label: window.i18n?.t('pergunta11', 'How will you apply this in the future?') },
            { label: window.i18n?.t('pergunta12', 'A message to your future self.') }
          ],
          video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4'
        }
      ],
      'es-ES': [
        {
          title: 'Bloque 1 — Raíces',
          questions: [
            { label: window.i18n?.t('pergunta1', '¿Quién eres hoy?') },
            { label: window.i18n?.t('pergunta2', '¿Qué te trajo a este viaje?') },
            { label: window.i18n?.t('pergunta3', '¿Cuál es tu mayor sueño espiritual?') }
          ],
          video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4'
        },
        {
          title: 'Bloque 2 — Reflexiones',
          questions: [
            { label: window.i18n?.t('pergunta4', '¿Cuáles son tus mayores desafíos actuales?') },
            { label: window.i18n?.t('pergunta5', '¿Cómo lidias con el miedo o la duda?') },
            { label: window.i18n?.t('pergunta6', '¿Qué significa la "luz" para ti?') }
          ],
          video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4'
        },
        {
          title: 'Bloque 3 — Crecimiento',
          questions: [
            { label: window.i18n?.t('pergunta7', '¿Qué quieres cambiar en tu vida?') },
            { label: window.i18n?.t('pergunta8', '¿Quién te inspira y por qué?') },
            { label: window.i18n?.t('pergunta9', '¿Cómo practicas la gratitud en el día a día?') }
          ],
          video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4'
        },
        {
          title: 'Bloque 4 — Integración',
          questions: [
            { label: window.i18n?.t('pergunta10', '¿Qué lección te llevas de este viaje?') },
            { label: window.i18n?.t('pergunta11', '¿Cómo lo aplicarás en el futuro?') },
            { label: window.i18n?.t('pergunta12', 'Un mensaje para tu yo futuro.') }
          ],
          video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4'
        }
      ]
    };

    function updateBlocks() {
      const currentLang = window.i18n?.lang || document.getElementById('language-select')?.value || 'pt-BR';
      window.JORNADA_BLOCKS = blockTranslations[currentLang] || blockTranslations['pt-BR'];
      console.log('[loadDynamicBlocks] Blocos atualizados para idioma:', currentLang);
    }

    window.loadDynamicBlocks = function() {
      console.log('[loadDynamicBlocks] Iniciando');
      updateBlocks();
      const content = document.getElementById('perguntas-container');
      if (!content) {
        console.error('[loadDynamicBlocks] Container de perguntas não encontrado');
        window.toast && window.toast('Erro ao carregar perguntas.');
        return;
      }
      console.log('[loadDynamicBlocks] JORNADA_BLOCKS:', window.JORNADA_BLOCKS);
      content.innerHTML = '';
      content.classList.remove('hidden');
      const blocks = window.JORNADA_BLOCKS || [];
      if (!blocks.length) {
        console.error('[loadDynamicBlocks] JORNADA_BLOCKS não definido ou vazio');
        window.toast && window.toast('Nenhum bloco de perguntas encontrado.');
        return;
      }

      blocks.forEach((block, bIdx) => {
        const bloco = document.createElement('div');
        bloco.className = 'j-bloco';
        bloco.dataset.bloco = bIdx;
        bloco.dataset.video = block.video_after || '';
        bloco.style.display = bIdx === 0 ? 'block' : 'none';

        if (block.title) {
          const title = document.createElement('h3');
          title.className = 'pergunta-enunciado text';
          title.dataset.typing = 'true';
          title.dataset.text = block.title;
          title.dataset.speed = '36';
          title.dataset.cursor = 'true';
          bloco.appendChild(title);
        }

        (block.questions || []).forEach((q, qIdx) => {
          const label = typeof q === 'string' ? q : (q.label || q.text || '');
          const div = document.createElement('div');
          div.className = 'j-pergunta';
          div.dataset.pergunta = qIdx;
          div.style.display = bIdx === 0 && qIdx === 0 ? 'block' : 'none';

          div.innerHTML = `
            <label class="pergunta-enunciado text" 
                   data-typing="true" 
                   data-text="Pergunta ${qIdx + 1}: ${label}" 
                   data-speed="36" 
                   data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="${window.I18N?.t('placeholder.resposta', 'Digite sua resposta...')}"></textarea>
            <div class="accessibility-controls">
              <button class="btn-mic" data-action="start-mic">🎤 ${window.i18n?.t('botao.falar', 'Falar Resposta')}</button>
              <button class="btn-audio" data-action="read-question">🔊 ${window.i18n?.t('botao.ler', 'Ler Pergunta')}</button>
              <button class="btn btn-avancar" data-action="avancar">${window.i18n?.t('botao.avancar', 'Avançar')}</button>
            </div>
          `;
          bloco.appendChild(div);
        });

        content.appendChild(bloco);
      });

      const firstBloco = content.querySelector('.j-bloco');
      console.log('[loadDynamicBlocks] firstBloco:', firstBloco);
      if (firstBloco) {
        firstBloco.style.display = 'block';
        window.JC.currentBloco = 0;
        window.JC.currentPergunta = 0;
        const firstPergunta = firstBloco.querySelector('.j-pergunta');
        if (firstPergunta) {
          firstPergunta.style.display = 'block';
          firstPergunta.classList.add('active');
          setTimeout(() => {
            console.log('[loadDynamicBlocks] Iniciando runTyping para primeira pergunta');
            window.runTyping && window.runTyping(firstPergunta);
          }, 100);
        } else {
          console.error('[loadDynamicBlocks] Nenhuma pergunta encontrada no primeiro bloco');
        }
      } else {
        console.error('[loadDynamicBlocks] Nenhum bloco criado');
        window.toast && window.toast('Erro ao criar blocos de perguntas.');
      }

      if (window.loadAnswers) {
        window.loadAnswers();
        console.log('[loadDynamicBlocks] loadAnswers chamado');
      }
      const firstTa = document.querySelector('.j-bloco .j-pergunta textarea');
      console.log('[loadDynamicBlocks] firstTa:', firstTa);
      if (firstTa && window.handleInput) {
        window.handleInput(firstTa);
        console.log('[loadDynamicBlocks] handleInput chamado');
      } else {
        console.warn('[loadDynamicBlocks] window.handleInput ou textarea não definido:', { handleInput: !!window.handleInput, firstTa });
      }
      if (window.initAccessibility) {
        window.initAccessibility();
        console.log('[loadDynamicBlocks] initAccessibility chamado');
      } else {
        console.warn('[loadDynamicBlocks] window.initAccessibility não definido');
      }

      console.log('[loadDynamicBlocks] Blocos carregados com sucesso');
      console.log('[loadDynamicBlocks] DOM do perguntas-container:', document.getElementById('perguntas-container').outerHTML);
    };

    document.addEventListener('change', (e) => {
      if (e.target.id === 'language-select') {
        updateBlocks();
        window.loadDynamicBlocks();
        console.log('[loadDynamicBlocks] Idioma alterado, blocos recarregados');
      }
    });

    // Inicializar blocos com idioma padrão
    if (window.i18n?.lang) {
      updateBlocks();
      console.log('[Blocos] updateBlocks inicial chamado');
    } else {
      console.warn('[Blocos] window.i18n.lang não definido, usando pt-BR');
      window.i18n?.setLang('pt-BR');
      updateBlocks();
    }

    console.log('[loadDynamicBlocks] Bloco carregado');
  })();
</script>

  <!-- boot -->
  <script>
    (function() {
      function initializeJourney() {
        // Esperar que todos os scripts estejam carregados
        document.addEventListener('DOMContentLoaded', () => {
          if (window.ensureHeaderFlame) {
            window.ensureHeaderFlame();
            console.log('[Boot] ensureHeaderFlame chamado');
          } else {
            console.warn('[Boot] window.ensureHeaderFlame não definido');
          }
          if (window.ensurePageFlames) {
            window.ensurePageFlames();
            console.log('[Boot] ensurePageFlames chamado');
          } else {
            console.warn('[Boot] window.ensurePageFlames não definido');
          }
          if (window.runTyping) {
            window.runTyping();
            console.log('[Boot] runTyping chamado');
          } else {
            console.warn('[Boot] window.runTyping não definido');
          }
          if (window.initJornada) {
           window.initJornada = initJornada;
            console.log('[Boot] initJornada chamado');
          } else {
            console.warn('[Boot] window.initJornada não definido');
          }
          if (window.showSection) {
            window.showSection('section-intro');
            console.log('[Boot] showSection chamado para section-intro');
            setTimeout(() => {
            window.showSection('section-perguntas');
            }, 5000); // Exemplo: avança após 5s para test
          } else {
            console.warn('[Boot] window.showSection não definido');
          }
          if (window.updateBlocks) {
            window.updateBlocks();
            console.log('[Boot] updateBlocks chamado');
          } else {
            console.warn('[Boot] window.updateBlocks não definido');
          }
          if (window.lockVideoOrientation) {
            window.lockVideoOrientation();
            console.log('[Boot] lockVideoOrientation chamado');
          } else {
            console.warn('[Boot] window.lockVideoOrientation não definido');
          }
        });
      }
      initializeJourney();
      console.log('[Boot] Bloco carregado');
    })();
  </script>
    
    <!-- boot -->
<script>
  (function() {
    function initializeJourney() {
      document.addEventListener('DOMContentLoaded', () => {
        if (window.ensureHeaderFlame) {
          window.ensureHeaderFlame();
          console.log('[Boot] ensureHeaderFlame chamado');
        } else {
          console.warn('[Boot] window.ensureHeaderFlame não definido');
        }
        if (window.ensurePageFlames) {
          window.ensurePageFlames();
          console.log('[Boot] ensurePageFlames chamado');
        } else {
          console.warn('[Boot] window.ensurePageFlames não definido');
        }
        if (window.runTyping) {
          window.runTyping();
          console.log('[Boot] runTyping chamado');
        } else {
          console.warn('[Boot] window.runTyping não definido');
        }
        if (window.initJornada) {
          window.initJornada();
          console.log('[Boot] initJornada chamado');
        } else {
          console.warn('[Boot] window.initJornada não definido');
        }
        if (window.showSection) {
          window.showSection('section-intro');
          console.log('[Boot] showSection chamado para section-intro');
        } else {
          console.warn('[Boot] window.showSection não definido');
        }
        if (window.updateBlocks) {
          window.updateBlocks();
          console.log('[Boot] updateBlocks chamado');
        } else {
          console.warn('[Boot] window.updateBlocks não definido');
        }
        if (window.lockVideoOrientation) {
          window.lockVideoOrientation();
          console.log('[Boot] lockVideoOrientation chamado');
        } else {
          console.warn('[Boot] window.lockVideoOrientation não definido');
        }
        // Teste: Forçar avanço para section-perguntas após 5 segundos
        setTimeout(() => {
          if (window.showSection && window.loadDynamicBlocks) {
            window.showSection('section-perguntas');
            window.loadDynamicBlocks();
            console.log('[Boot] Forçando section-perguntas para teste');
          }
        }, 5000);
      });
    }
    initializeJourney();
    console.log('[Boot] Bloco carregado');
  })();
  </script>
  <!-- antes (apontando pro lugar antigo) -->
<!-- <script defer src="/assets/js/i18n.js?v=6" ...> -->

<!-- depois (novo caminho real) -->
<script defer src="/i18n/i18n.js?v=7"
        onload="console.log('[LOAD] i18n.js carregado')"
        onerror="console.error('[LOAD] Erro ao carregar i18n.js')"></script>


  <!-- Scripts Externos -->
  <script defer src="/assets/js/config.js?v=6" onload="console.log('[LOAD] config.js carregado')" onerror="console.error('[LOAD] Erro ao carregar config.js')"></script>
  <script defer src="/assets/js/jornada-utils.js?v=6" onload="console.log('[LOAD] jornada-utils.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-utils.js')"></script>
  <script defer src="/assets/js/jornada-core.js?v=6" onload="console.log('[LOAD] jornada-core.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-core.js')"></script>
  <script defer src="/assets/js/jornada-typing.js?v=6" onload="console.log('[LOAD] jornada-typing.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-typing.js')"></script>
  <script defer src="/assets/js/jornada-typing-bridge.js?v=1" onload="console.log('[LOAD] jornada-typing-bridge.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-typing-bridge.js')"></script>
  <script defer src="/assets/js/jornada-chama.js?v=6" onload="console.log('[LOAD] jornada-chama.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-chama.js')"></script>
  <script defer src="/assets/js/jornada-auth.js?v=6" onload="console.log('[LOAD] jornada-auth.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-auth.js')"></script>
  <script defer src="/assets/js/jornada-paper-qa.js?v=6" onload="console.log('[LOAD] jornada-paper-qa.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-paper-qa.js')"></script>
  <script defer src="/assets/js/jornada-controller.js?v=6" onload="console.log('[LOAD] jornada-controller.js carregado'); console.log('[JC] Após controller: JC existe?', !!window.JC, 'init =', typeof (window.JC && window.JC.init))" onerror="console.error('[LOAD] Erro ao carregar jornada-controller.js')"></script>
  <script defer src="/assets/js/jornada-render.js?v=6" onload="console.log('[LOAD] jornada-render.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-render.js')"></script>
  <script defer src="/assets/js/jornada-bootstrap.js?v=6" onload="console.log('[LOAD] jornada-bootstrap.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-bootstrap.js')"></script>
  <script defer src="/assets/js/jornada-micro.js?v=6" onload="console.log('[LOAD] jornada-micro.js carregado')" onerror="console.error('[LOAD] Erro ao carregar jornada-micro.js')"></script>
  <script defer src="/i18n/i18n.js?v=7" onload="console.log('[LOAD] i18n.js carregado')" onerror="console.error('[LOAD] Erro ao carregar i18n.js')"></script>
  <script defer src="/assets/js/api.js?v=6" onload="console.log('[LOAD] api.js carregado')" onerror="console.error('[LOAD] Erro ao carregar api.js')"></script>
  
</body>
</html>

