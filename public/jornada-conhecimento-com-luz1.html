<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jornada ‚Ä¢ Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />

  <style>
  /* ===================== FONTES ===================== */
  @font-face{
    font-family:'ManufacturingConsent';
    src:url('/assets/fonts/ManufacturingConsent-Regular.ttf') format('truetype');
    font-display:swap;
  }
  @font-face{
    font-family:'BerkshireSwash';
    src:url('/assets/fonts/BerkshireSwash-Regular.ttf') format('truetype');
    font-display:swap;
  }
  @font-face{
    font-family:'Cardo';
    src:url('/assets/fonts/Cardo-Regular.ttf') format('truetype');
    font-display:swap;
  }

  /* ===== BASE ===== */
  html,body{height:100%}
  body{
    margin:0;
    background:#f9f9f9;
    color:#333;
    font-family:'ManufacturingConsent',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
  }
  .site-header{display:flex;align-items:center;gap:12px;padding:16px;background:#1f2937;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);position:relative;z-index:1000}
  .container{max-width:900px;margin:24px auto;padding:0 16px}
  .card{background:#f6efe0!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:32px;position:relative;z-index:10}

  /* ===== PERGAMINHO ===== */
  .pergaminho-v{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
  .pergaminho-h{background-image:url('/assets/img/pergaminho-rasgado-horiz.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
  .pergaminho-h.fallback{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important}
  .conteudo-pergaminho{background:transparent!important;position:relative;z-index:20;padding:20px;min-height:100%;overflow:visible}

  /* ===== CHAMA header (simples) ===== */
  .chama-icone{position:relative;width:26px;height:38px}
  .chama-icone .halo{
    position:absolute;inset:-8px;pointer-events:none;border-radius:50%;
    background:radial-gradient(circle,rgba(255,200,120,.45),rgba(255,200,120,0) 65%);
    filter:blur(6px)
  }
  .chama-icone .gota{
    position:absolute;left:50%;bottom:4px;transform:translateX(-50%);
    width:16px;height:28px;border-radius:60% 60% 30% 30%/90% 90% 18% 18%;
    background:radial-gradient(60% 70% at 50% 25%,#fff 0%,#ffd77a 40%,rgba(255,166,0,.9) 75%,transparent 90%);
    animation:wave 1.6s ease-in-out infinite;transform-origin:50% 100%;
    -webkit-mask:radial-gradient(60% 90% at 50% 5%,#000 72%,transparent 76%);
            mask:radial-gradient(60% 90% at 50% 5%,#000 72%,transparent 76%);
  }
  .chama-icone .brasa{
    position:absolute;left:50%;bottom:0;transform:translateX(-50%);
    width:18px;height:8px;border-radius:50%;
    background:radial-gradient(circle at 50% 40%,#fff 0%,#ffd27a 45%,transparent 74%);
    filter:blur(.8px);opacity:.9;animation:pulse 1.8s ease-in-out infinite;
  }
  @keyframes wave{0%,100%{transform:translateX(-50%) scaleY(1)}50%{transform:translateX(-50%) scaleY(1.08)}}
  @keyframes pulse{0%,100%{transform:translateX(-50%) scale(1);opacity:.7}50%{transform:translateX(-50%) scale(1.06);opacity:1}}

  /* ===== CHAMA viva (perguntas/guia) ‚Äì‚Äì (seu bloco original mantido) ===== */
  .chama{display:block;position:relative;overflow:hidden;z-index:40;visibility:visible}
  .chama span{position:absolute;bottom:0;width:100%;height:100%;
    background:linear-gradient(to top,#ff4500 0%,#ff8c00 40%,rgba(255,69,0,0) 100%);
    clip-path: polygon(50% 100%, 80% 60%, 70% 40%, 60% 20%, 50% 0%, 40% 20%, 30% 40%, 20% 60%);
    animation:flicker 1.5s infinite;border-radius:2px}
  .chama.chama-sm{display:inline-flex;gap:4px}
  .chama.chama-sm span{width:6px;height:12px;background:#ff4500;animation:flicker 1.5s infinite}
  .chama.chama-sm span:nth-child(2){animation-delay:.2s}
  .chama.chama-sm span:nth-child(3){animation-delay:.4s}
  .chama.chama-weak span{opacity:.5;animation:flicker-weak 2s infinite}
  .chama.chama-strong span{animation:flicker-strong 1s infinite}
  .chama.chama-viva span{animation:flicker-strong .85s infinite;filter:drop-shadow(0 0 12px rgba(255,140,0,.55))}
  .chama.chama-pulse span{animation:flicker-strong .6s infinite}
  .chama.chama-md span{width:22px;height:54px}
  .chama.chama-lg span{width:36px;height:88px}
  .chama-fixed-top{position:absolute;top:10px;right:14px;z-index:60}
  .chama-fixed-hero{position:absolute;top:-8px;left:-8px;z-index:60}

  /* (mantive seu bloco extenso de .chama-viva / #chama-bola ‚Äì igual ao que voc√™ j√° tinha) */
  /* ... para encurtar a mensagem, estou omitindo coment√°rios aqui ‚Äî √© o mesmo bloco do seu HTML anterior ... */

  /* Destaque palavras */
  .mark-emocao{background:linear-gradient(90deg,rgba(255,196,0,.35),rgba(255,140,0,.2));border-radius:4px;padding:0 2px}

  /* keyframes antigos (usados pela .chama cl√°ssica) */
  @keyframes flicker{0%,100%{transform:scaleY(1);opacity:1}50%{transform:scaleY(1.2);opacity:.8}}
  @keyframes flicker-weak{0%,100%{transform:scaleY(.8);opacity:.6}50%{transform:scaleY(1);opacity:.4}}
  @keyframes flicker-strong{0%,100%{transform:scaleY(1.5);opacity:1}50%{transform:scaleY(1.8);opacity:.9}}

  /* ===== UI ===== */
  .btn{display:inline-block;padding:12px 24px;border-radius:10px;border:0;background:#1f2937;color:#fff;font-weight:600;text-decoration:none;transition:background .3s ease, transform .2s ease;z-index:30}
  .btn:hover{background:#374151;transform:scale(1.05)}
  .btn-primary{background:#6b21a8}
  .btn-primary:hover{background:#7c3aed}
  .btn-secondary{background:#4b5563}
  .btn-secondary:hover{background:#6b7280}
  .btn + .btn{margin-left:12px}

  .progress-badge{position:fixed;top:16px;right:16px;padding:8px 16px;background:#6b21a8;color:#fff;border-radius:8px;font-size:.9rem;z-index:900;visibility:visible}
  .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px;z-index:900;visibility:visible}
  .progress-bar-fill{height:100%;background:#6b21a8;border-radius:4px;transition:width .3s ease}
  .j-progress{margin-top:12px;z-index:900;visibility:visible}
  .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
  .j-progress__fill{height:100%;background:#1f2937;border-radius:4px;transition:width .3s ease}
  .j-progress__meta{text-align:center;margin-top:8px;font-size:.9rem}

  .footer-actions{display:flex;gap:12px;justify-content:center;margin:16px 0;z-index:900}

  .lumen-typing{white-space:pre-wrap;position:relative}
  .lumen-typing::after{content:"‚ñå";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
  .lumen-typing.typing-done::after{content:"";animation:none}
  @keyframes lumenBlink{50%{opacity:0}}

  .j-section{height:100%}
  .j-bloco{background:transparent!important;display:none;z-index:50}
  .j-pergunta{margin-bottom:24px;display:none;z-index:60;position:relative}
  .j-pergunta.active{display:block}

  /* ENUNCIADO = Berkshire */
  .pergunta-enunciado,
  .j-pergunta .pergunta-enunciado,
  #perguntas-container .pergunta-enunciado{
    font-family:'BerkshireSwash', cursive !important;
    font-weight:400;
    letter-spacing:.5px;
    margin-bottom:8px;display:block;
  }

  /* RESPOSTAS = Cardo */
  .j-pergunta textarea,
  #perguntas-container textarea,
  #perguntas-container input[type="text"],
  #perguntas-container input[type="email"],
  #perguntas-container input[type="search"]{
    font-family:'Cardo', Georgia, 'Times New Roman', serif !important;
    width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;background:rgba(255,255,255,.8);
    resize:vertical;min-height:100px;line-height:1.5;
  }

  .site-footer{text-align:center;padding:16px;opacity:.6;font-size:.85rem;z-index:10}
  .password-form{margin-top:20px;text-align:center}
  .password-input{position:relative}
  .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db}
  .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer}

  .section-container{position:relative;min-height:85vh}
  .hidden{display:none!important}

  /* Bola/guia da chama flutuante */
  #guia-espiritual{position:fixed;bottom:20px;right:20px;z-index:1200}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
  <div class="halo"></div><div class="gota"></div><div class="brasa"></div>
</div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <!-- INTRO -->
        <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada √© sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <p data-typing data-text="Bem-vindo(a) √† nossa casa de reflex√£o e coragem. Antes de come√ßar, ative sua senha." data-speed="50" data-cursor="true"></p>

          <div class="password-form">
            <h3>Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-primary" data-action="start">Ativar e Iniciar</button>
          </div>
        </div>

        <!-- PERGUNTAS -->
        <div id="section-perguntas" class="j-section hidden">
          <div class="chama chama-md" id="chama-perguntas"><span></span></div>
          <div id="perguntas-container"></div>
          <div class="footer-actions">
            <button id="btnNextPerguntas" class="btn btn-primary" data-action="next">Pr√≥xima</button>
          </div>
        </div>

        <!-- FINAL -->
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parab√©ns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions">
            <button id="btnRestart" class="btn btn-secondary" data-action="restart">Reiniciar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>¬© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag"></div>
  </footer>

  <!-- PROGRESS -->
  <div class="progress-badge" id="jprog-pct">0% conclu√≠do</div>
  <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  <div class="j-progress">
    <div class="j-progress__bar"><div class="j-progress__fill"></div></div>
    <div class="j-progress__meta" id="j-meta"></div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="video-overlay hidden">
    <video id="videoTransicao" class="video-player" playsinline preload="metadata" controls></video>
    <button id="skipVideo" class="btn btn-secondary" style="position:absolute; top:14px; right:14px">Pular v√≠deo</button>
  </div>

  <!-- GUIA ESPIRITUAL -->
  <div id="guia-espiritual">
    <div id="chama-bola" class="chama-viva chama-md">
      <div class="brasa"></div>
      <div class="lingua"></div>
      <div class="lingua"></div>
      <div class="lingua"></div>
      <div class="brilho"></div>
    </div>
  </div>

  <script>
  // Tag ambiente
  document.getElementById('envTag').textContent =
    `layout=${document.body.dataset.layout || 'master'} ¬∑ journey=${document.body.dataset.journey || 'essencial'} ¬∑ path=/assets`;

  /* ========================= EMO√á√ÉO & DATILOGRAFIA ========================= */
  const EMO = {
    POS:{'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperan√ßa':3,'paz':2,'f√©':3,'gratid√£o':2,'vit√≥ria':3,'supera√ß√£o':3,'luz':2,'deus':3,'coragem':2,'for√ßa':2,'confian√ßa':2,'prop√≥sito':3},
    NEG:{'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustra√ß√£o':-2,'decepcao':-2,'decep√ß√£o':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solid√£o':-2,'desespero':-3,'cansaco':-2,'cansa√ßo':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'d√∫vida':-2}
  };
  function analyzeSentiment(text){
    let score=0;
    const tokens=(text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/\s+/);
    for(const t of tokens){ if(EMO.POS[t]!=null) score+=EMO.POS[t]; if(EMO.NEG[t]!=null) score+=EMO.NEG[t]; }
    return score;
  }
  function typeWriter(el,text,speed,showCursor){
    if(!el) return;
    el.textContent='';
    if(showCursor) el.classList.add('lumen-typing');
    let i=0;(function step(){ if(i<text.length){ el.textContent+=text.charAt(i++); setTimeout(step,speed);} else{ el.classList.add('typing-done'); } })();
  }
  function runTyping(root){
    (root||document).querySelectorAll('[data-typing]').forEach(el=>{
      if(el.dataset._typed) return;
      const t=el.getAttribute('data-text')||el.textContent||'';
      const spd=parseInt(el.getAttribute('data-speed')||'26',10);
      const cur=String(el.getAttribute('data-cursor')||'true')==='true';
      el.dataset._typed='1'; typeWriter(el,t,spd,cur);
    });
  } 
 /* ===== Garante chamas (t√≠tulo e perguntas) ===== */
(function(){
  // Cabe√ßalho (√≠cone do t√≠tulo)
  const H = document.getElementById('chama-header');
  if (H && !H.querySelector('.halo')){
    H.classList.add('chama-icone');
    H.innerHTML = '<div class="halo"></div><div class="gota"></div><div class="brasa"></div>';
  }

  // Assim que a se√ß√£o de perguntas aparecer, inicializa a chama-viva
  const ensurePerguntasFlame = () => {
    const el = document.getElementById('chama-perguntas');
    if (!el) return;
    // usa a API para montar a estrutura viva imediatamente (score neutro)
    if (window.JORNADA_CHAMA && typeof window.JORNADA_CHAMA.updateChama === 'function'){
      window.JORNADA_CHAMA.updateChama(0, 'chama-perguntas');
    }
  };

  // tenta agora e tamb√©m observa mudan√ßas de DOM
  ensurePerguntasFlame();
  const mo = new MutationObserver(ensurePerguntasFlame);
  mo.observe(document.body, {childList:true, subtree:true});
})();

window.JORNADA_CHAMA.updateChama = function(scoreNum, targetId='chama-perguntas'){
  const el = (typeof targetId === 'string') ? document.getElementById(targetId) : targetId;
  if (!el) return;

  // chama do tipo-√≠cone (a do t√≠tulo/hero)
  ensureChamaIcon(el);

  // intensidade por sentimento
  const modo = (scoreNum <= -2) ? 'fraca' : (scoreNum >= 2) ? 'forte' : 'media';
  el.dataset.intensidade = modo;

  // ‚Äúpico‚Äù curto
  el.classList.add('chama-pico');
  clearTimeout(el._pulse_t);
  el._pulse_t = setTimeout(() => el.classList.remove('chama-pico'), 700);

  // guia acompanha
  const guia = document.getElementById('chama-bola');
  if (guia) guia.dataset.intensidade = modo;
};

window.JORNADA_CHAMA.ensureHeroFlame = function(sectionId){
  const canvas = document.getElementById('jornada-canvas');
  if (!canvas) return;

  const show = (sectionId === 'section-intro' || sectionId === 'section-final');
  let hero = document.getElementById('chama-hero');

  if (show){
    if (!hero){
      hero = document.createElement('div');
      hero.id = 'chama-hero';
      hero.className = 'chama-icone chama-lg chama-fixed-top';
      hero.innerHTML = '<div class="halo"></div><div class="gota"></div><div class="brasa"></div>';
      hero.dataset.intensidade = 'media';
      canvas.appendChild(hero);
    } else {
      ensureChamaIcon(hero);
      if (!hero.dataset.intensidade) hero.dataset.intensidade = 'media';
    }
  } else if (hero){
    hero.remove();
  }
};

// aliases se o restante do c√≥digo chamar fun√ß√µes antigas
function updateChama(score, targetId){ window.JORNADA_CHAMA.updateChama(score, targetId); }
function ensureHeroFlame(sectionId){ window.JORNADA_CHAMA.ensureHeroFlame(sectionId); }

  /* ========================= PROGRESSO & STORAGE ========================= */
  function updateProgress(){
    const perguntas=document.querySelectorAll('.j-pergunta');
    const respondidas=Array.from(perguntas).filter(p=>p.querySelector('textarea')?.value.trim()!=='').length;
    const progresso=(respondidas/(perguntas.length||1))*100;
    const fill=document.getElementById('jprog-fill');
    const badge=document.getElementById('jprog-pct');
    const jFill=document.querySelector('.j-progress__fill');
    const jMeta=document.getElementById('j-meta');
    if(fill) fill.style.width=`${progresso}%`;
    if(badge) badge.textContent=`${Math.round(progresso)}% conclu√≠do`;
    if(jFill) jFill.style.width=`${progresso}%`;
    if(jMeta) jMeta.textContent=`Respondidas: ${respondidas} de ${perguntas.length}`;
  }
  function saveAnswers(){
    const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
    localStorage.setItem('jornada_respostas',JSON.stringify(respostas));
  }
  function loadAnswers(){
    const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
    document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ input.value=respostas[`q${idx}`]||''; });
    updateProgress();
  }

  /* ========================= ROTEAMENTO & RENDER ========================= */
  function updateCanvasBackground(sectionId){
    const canvas=document.getElementById('jornada-canvas');
    if(!canvas) return;
    if(sectionId==='section-perguntas'){
      checkImage('/assets/img/pergaminho-rasgado-horiz.png','/assets/img/pergaminho-rasgado-vert.png').then(bg=>{
        canvas.className=`card pergaminho pergaminho-h${bg.includes('vert')?' fallback':''}`;
        canvas.style.backgroundImage=`url('${bg}')`;
      });
    } else {
      canvas.className='card pergaminho pergaminho-v';
      canvas.style.backgroundImage='url(/assets/img/pergaminho-rasgado-vert.png)';
    }
  }
  function showSection(sectionId){
    document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
    const active=document.getElementById(sectionId); if(active) active.classList.remove('hidden');
    updateCanvasBackground(sectionId); ensureHeroFlame(sectionId);
    if(sectionId==='section-perguntas'){
      updateProgress();
      const perguntas=document.querySelectorAll('.j-pergunta'); if(perguntas.length) runTyping(perguntas[0]);
    }
  }

  function loadDynamicBlocks(){
    const content=document.getElementById('perguntas-container');
    if(content && window.JORNADA_BLOCKS){
      content.innerHTML='';
      window.JORNADA_BLOCKS.forEach((block,idx)=>{
        const bloco=document.createElement('section'); bloco.className='j-bloco'; bloco.dataset.bloco=idx; bloco.dataset.video=block.video_after||'';
        (block.questions||[]).forEach((q,qIdx)=>{
          const label = (typeof q === 'string') ? q : (q.label || q.text || '');
          const pergunta=document.createElement('div'); pergunta.className='j-pergunta'; pergunta.dataset.pergunta=qIdx;
          pergunta.innerHTML=`<label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx+1}:</b> ${label}" data-speed="40" data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="Digite sua resposta..." oninput="handleInput(this)"></textarea>`;
          bloco.appendChild(pergunta);
        });
        content.appendChild(bloco);
      });
      const firstBloco=content.querySelector('.j-bloco'); if(firstBloco){ firstBloco.style.display='block';
        const firstPergunta=firstBloco.querySelector('.j-pergunta'); if(firstPergunta){ firstPergunta.classList.add('active'); runTyping(firstPergunta); }
        loadAnswers();
        const firstTa=content.querySelector('.j-bloco .j-pergunta textarea'); if(firstTa) handleInput(firstTa);
      }
      console.log('Blocos carregados!');
    } else {
      console.error('Erro: #perguntas-container ou JORNADA_BLOCKS n√£o encontrado!');
    }
  }
  function checkImage(url,fallbackUrl){ return new Promise(resolve=>{ const i=new Image(); i.onload=()=>resolve(url); i.onerror=()=>resolve(fallbackUrl); i.src=url; }); }

  /* ========================= CONTROLES ========================= */
  function handleInput(textarea){ const score=analyzeSentiment(textarea.value); updateChama(score); saveAnswers(); updateProgress(); }
  function toggleSenha(){ const input=document.getElementById('senha'); if(input){ input.type=(input.type==='password'?'text':'password'); } }

  function goNext(){
    const perguntas=document.querySelectorAll('.j-pergunta');
    const current=document.querySelector('.j-pergunta.active');
    if(current) current.classList.remove('active');
    const nextIndex=Array.from(perguntas).indexOf(current)+1;
    if(nextIndex<perguntas.length){
      perguntas[nextIndex].classList.add('active'); runTyping(perguntas[nextIndex]); updateProgress();
    } else {
      const blocos=document.querySelectorAll('.j-bloco');
      const currentBloco=current?.closest('.j-bloco'); const nextBlocoIndex=Array.from(blocos).indexOf(currentBloco)+1;
      if(nextBlocoIndex<blocos.length){
        const currentIdx = Number(currentBloco?.dataset.bloco||0);
        const videoSrc = (window.JORNADA_BLOCKS[currentIdx]?.video_after)||'';
        blocos.forEach(b=>b.style.display='none'); blocos[nextBlocoIndex].style.display='block';
        const nextPergunta=blocos[nextBlocoIndex].querySelector('.j-pergunta');
        const proceed = ()=>{ if(nextPergunta){ nextPergunta.classList.add('active'); runTyping(nextPergunta); } };
        if(videoSrc) playTransition(videoSrc, proceed); else proceed();
      } else {
        if(window.JORNADA_FINAL_VIDEO) playTransition(window.JORNADA_FINAL_VIDEO, ()=>showSection('section-final'));
        else showSection('section-final');
        updateProgress();
      }
    }
  }
  function goPrev(){
    const perguntas=document.querySelectorAll('.j-pergunta');
    const current=document.querySelector('.j-pergunta.active');
    if(current) current.classList.remove('active');
    const prevIndex=Array.from(perguntas).indexOf(current)-1;
    if(prevIndex>=0){
      perguntas[prevIndex].classList.add('active'); runTyping(perguntas[prevIndex]); updateProgress();
    } else {
      const blocos=document.querySelectorAll('.j-bloco');
      const currentBloco=current?.closest('.j-bloco'); const prevBlocoIndex=Array.from(blocos).indexOf(currentBloco)-1;
      if(prevBlocoIndex>=0){
        blocos.forEach(b=>b.style.display='none'); blocos[prevBlocoIndex].style.display='block';
        const lastPergunta=Array.from(blocos[prevBlocoIndex].querySelectorAll('.j-pergunta')).pop();
        if(lastPergunta){ lastPergunta.classList.add('active'); runTyping(lastPergunta); }
      } else { showSection('section-intro'); }
      updateProgress();
    }
  }

 /* ===== Reprodutor √∫nico no overlay (robusto) ===== */
(function(){
  const overlay = document.getElementById('videoOverlay');
  const video   = document.getElementById('videoTransicao');
  const skip    = document.getElementById('skipVideo');
  if(!overlay || !video) return;

  function showOverlay(src, onEnd){
    window.__playingTransition = true;

    // mostra overlay acima de tudo e trava scroll
    overlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // prepara player
    video.removeAttribute('src');
    video.load();
    video.src = src;
    video.currentTime = 0;
    video.controls = true;

    // limpeza padr√£o
    const cleanup = () => {
      try { video.pause(); } catch(e){}
      video.onloadedmetadata = video.onended = video.onerror = null;
      overlay.classList.add('hidden');
      document.body.style.overflow = '';
      video.removeAttribute('src'); video.load();
      window.__playingTransition = false;
    };

    const done = () => { cleanup(); try{ onEnd && onEnd(); }catch(e){} };

    // se meta n√£o vier, ainda assim garantimos failsafe
    let failSafe = setTimeout(done, 15000);

    video.onloadedmetadata = () => {
      clearTimeout(failSafe);
      // dura√ßao conhecida -> failsafe = dura√ß√£o + 1.5s (cap 30s)
      const dur = (isFinite(video.duration)&&video.duration>0) ? video.duration : 10;
      failSafe = setTimeout(done, Math.min(30000, (dur+1.5)*1000));
      try { video.play().catch(()=>{}); } catch(_) {}
    };

    video.onended  = done;
    video.onerror  = done;
    if (skip) skip.onclick = done;

    // caso onloadedmetadata nunca dispare
    failSafe = setTimeout(done, 15000);
  }

  // exp√µe no global
  window.playTransition = showOverlay;
})();

/* ===== Prote√ß√£o do FINAL (n√£o deixa voltar para intro) ===== */
(function(){
  if (typeof window.playTransition !== 'function' || typeof window.showSection !== 'function') return;

  const _origPlay = window.playTransition;
  const _origShow = window.showSection;
  let LOCK_UNTIL = 0;          // per√≠odo de prote√ß√£o ap√≥s o v√≠deo final (ms)

  // showSection respeita lock do final
  window.showSection = function(id){
    if (Date.now() < LOCK_UNTIL && id !== 'section-final') {
      console.warn('[FinalLock] Ignorando troca para', id);
      return;
    }
    return _origShow.apply(this, arguments);
  };

  // quando for o v√≠deo final, for√ßa rota #final e liga o lock
  window.playTransition = function(src, onEnd){
    const isFinal = (window.JORNADA_FINAL_VIDEO && src === window.JORNADA_FINAL_VIDEO);
    return _origPlay(src, function(){
      if (isFinal){
        try { location.hash = '#final'; } catch(_) {}
        LOCK_UNTIL = Date.now() + 1500;    // 1.5s protegidos
        try { _origShow('section-final'); } catch(_) {}
      }
      try { onEnd && onEnd(); } catch(_) {}
    });
  };
})();

  function finalize(){
    const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
    console.log('[JORNADA] Finalizado. Respostas:', respostas);
    alert('Jornada conclu√≠da!'); localStorage.removeItem('jornada_respostas');
    setTimeout(()=>location.replace('/index.html'),1000);
  }

  function startJourney(){
    const senha=document.getElementById('senha')?.value || '';
    const senhasValidas=['iniciar','olho magico','olho m√°gico'];
    if(senhasValidas.includes(senha.toLowerCase())){
      showSection('section-perguntas');
      loadDynamicBlocks();
      const perguntas=document.querySelectorAll('.j-pergunta');
      if(perguntas.length){
        perguntas[0].classList.add('active'); runTyping(perguntas[0]);
        const firstTa=document.querySelector('.j-pergunta.active textarea'); if(firstTa) handleInput(firstTa);
      } else { console.error('Nenhuma pergunta encontrada ap√≥s loadDynamicBlocks!'); }
      document.querySelector('.progress-badge')?.classList.remove('hidden');
      document.querySelector('.progress-bar')?.classList.remove('hidden');
      document.querySelector('.j-progress')?.classList.remove('hidden');
      document.querySelector('.footer-actions')?.classList.remove('hidden');
      updateProgress(); console.log('Jornada iniciada com sucesso!');
    } else { alert('Senha incorreta. Tente novamente.'); }
  }

  function initJornada(){
    const prevBtn=document.getElementById('btnPrevPerguntas');
    const nextBtn=document.getElementById('btnNextPerguntas');
    const restartBtn=document.getElementById('btnRestart');
    if(nextBtn) nextBtn.addEventListener('click', goNext);
    if(prevBtn) prevBtn.addEventListener('click', goPrev);
    if(restartBtn) restartBtn.addEventListener('click', ()=>location.reload());

    document.addEventListener('click',(ev)=>{
      const n = ev.target.closest('[data-action="next"]');
      const p = ev.target.closest('[data-action="prev"]');
      const s = ev.target.closest('[data-action="start"]');
      const tp= ev.target.closest('[data-action="toggle-password"], .password-toggle');
      if(n){ev.preventDefault();goNext();}
      if(p){ev.preventDefault();goPrev();}
      if(s){ev.preventDefault();startJourney();}
      if(tp){ev.preventDefault();toggleSenha();}
    });
    console.log('Controlador da jornada inicializado!');
  }

  // Fallback/blocos + v√≠deos padronizados
  (function defineFallback(){
    window.JORNADA_BLOCKS=[
      { title:'Bloco 1 ‚Äî Ra√≠zes',  questions:[ 'Quem √© voc√™ hoje?', 'O que a Luz te pede agora?' ],                                      video_after:'/assets/img/filme-1-entrando-na-jornada.mp4' },
      { title:'Bloco 2 ‚Äî Caminho', questions:[ 'Qual verdade voc√™ precisa admitir para seguir?', 'O que precisa ser curado neste momento?' ], video_after:'/assets/img/filme-2-dentro-da-jornada.mp4' }
    ];
    window.JORNADA_FINAL_VIDEO='/assets/img/filme-5-fim-da-jornada.mp4';
    console.log('JORNADA_BLOCKS (fallback) prontos.');
  })();

  // V√≠deos
  const VIDEO_BASE = '/assets/img/';
  window.JORNADA_VIDEOS = {
    intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
    afterBlocks: { 0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4', 1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4' },
    final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
  };

  // Normaliza√ß√£o de blocos (aceita strings/objetos)
  (function ensureBlocksAndFinal(){
    var blocks = window.JORNADA_BLOCKS || [];
    window.JORNADA_BLOCKS = blocks.map(function(block, idx){
      var qs = (block.questions || []).map(function(q){
        if (typeof q === 'string') return { label: q };
        if (q && typeof q === 'object') return { label: q.label || q.text || '' };
        return { label: String(q || '') };
      });
      return Object.assign({}, block, {
        questions: qs,
        video_after: block.video_after || (window.JORNADA_VIDEOS?.afterBlocks?.[idx])
      });
    });
    if (!window.JORNADA_FINAL_VIDEO && window.JORNADA_VIDEOS?.final){
      window.JORNADA_FINAL_VIDEO = window.JORNADA_VIDEOS.final;
    }
    console.log('JORNADA_BLOCKS normalizados:', window.JORNADA_BLOCKS);
  })();

  // FILME 0 ‚Äî toca 1x antes de iniciar
  (function hookFilme0(){
  <script>
/* FILME 0: s√≥ roda se a senha estiver OK; do contr√°rio n√£o toca nada */
(function hookFilme0(){
  if (typeof window.playTransition !== 'function') {
    console.warn('[Filme0] playTransition indispon√≠vel.');
    return;
  }
  if (typeof window.startJourney !== 'function') {
    console.warn('[Filme0] startJourney indispon√≠vel.');
    return;
  }

  let jaRodou = false;

  document.addEventListener('click', function onStart(ev){
    const btn = ev.target.closest('[data-action="start"]');
    if (!btn) return;

    // valida senha
    const senhaEl = document.getElementById('senha');
    const v = (senhaEl?.value || '').trim().toLowerCase();
    const ok = ['iniciar','olho magico','olho m√°gico'].includes(v);

    if (!ok) return;           // senha inv√°lida ‚Üí deixa o fluxo normal avisar

    if (jaRodou) return;       // garante 1x
    jaRodou = true;

    ev.preventDefault();
    ev.stopPropagation();

    try {
      const src = (window.JORNADA_VIDEOS && window.JORNADA_VIDEOS.intro)
                || '/assets/img/filme-0-ao-encontro-da-jornada.mp4';

      playTransition(src, () => {
        try { window.startJourney(); }
        catch (e) { console.error('[Filme0] startJourney falhou:', e); }
      });
    } catch (e) {
      console.error('[Filme0] falha ao iniciar v√≠deo 0:', e);
      try { window.startJourney(); } catch (_) {}
    }
  }, true); // CAPTURA: intercepta antes de outros handlers

  console.log('[Filme0] hook instalado.');
})();
</script>

  // Silenciar alert/confirm/prompt enquanto v√≠deo estiver vis√≠vel
  (function silenceDialogsDuringVideo(){
    function overlayVisivel(){
      const ov = document.getElementById('videoOverlay');
      return !!(ov && !ov.classList.contains('hidden'));
    }
    const A = window.alert, C = window.confirm, P = window.prompt;
    window.alert = function(m){ if (overlayVisivel() || window.__playingTransition){ console.warn('[alert silenciado]', m); return; } return A(m); };
    window.confirm = function(m){ if (overlayVisivel() || window.__playingTransition){ console.warn('[confirm silenciado]', m); return false; } return C(m); };
    window.prompt = function(m,d){ if (overlayVisivel() || window.__playingTransition){ console.warn('[prompt silenciado]', m); return d||''; } return P(m,d); };
  })();

  // Boot
  document.addEventListener('DOMContentLoaded', () => {
    runTyping(document);
    initJornada();

    (async function boot(){
      document.body.classList.add('jornada-active');
      const route=(location.hash||'#intro').slice(1);
      const canvas=document.getElementById('jornada-canvas');
      const els=[document.querySelector('.progress-badge'),document.querySelector('.progress-bar'),document.querySelector('.j-progress'),document.querySelector('.footer-actions')];
      if(canvas){
        if(route==='perguntas'){ showSection('section-perguntas'); loadDynamicBlocks(); els.forEach(el=>el?.classList.remove('hidden')); }
        else if(route==='final'){ showSection('section-final'); els.slice(0,3).forEach(el=>el?.classList.remove('hidden')); }
        else { showSection('section-intro'); }
      }
      const visible = document.querySelector('.j-section:not(.hidden)');
      if (visible) ensureHeroFlame(visible.id);

      const target = document.getElementById('jornada-conteudo');
      if (target) {
        const obs = new MutationObserver(muts => {
          muts.forEach(m => {
            runTyping(m.target);
            if (m.target.id === 'perguntas-container') updateProgress();
          });
        });
        obs.observe(target, { childList: true, subtree: true });
      }
    })();
  });

  // Ponte global
  window.JC = window.JC || {};
  window.toggleSenha  = toggleSenha;
  window.startJourney = startJourney;
  window.showSection  = showSection;
  window.JC.toggleSenha  = toggleSenha;
  window.JC.startJourney = startJourney;
  window.JC.showSection  = showSection;
  window.JC.Chama = window.JORNADA_CHAMA;
  </script>
</body>
</html>
