<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jornada • Conhecimento com Luz</title>
  <style>
    :root { --bg:#0f1226; --panel:#1b1f3a; --txt:#f5f7ff; --gold:#ffd54a; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--txt); background:linear-gradient(135deg,#0b0e22,#1b1f3a);
      min-height:100svh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .wrap{ width:100%; max-width:900px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px 20px 16px; backdrop-filter: blur(6px); }
    h1{ margin:0 0 4px; text-align:center; font-size:clamp(22px,3.6vw,32px); color:var(--gold) }
    p.sub{ text-align:center; margin:0 0 18px; opacity:.85 }
    form{ display:grid; gap:18px }
    .q{ background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px }
    .q label{ display:block; font-weight:600; margin-bottom:8px }
    .q textarea,.q input[type="text"]{
      width:100%; background:#101429; color:var(--txt); border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; min-height:84px; resize:vertical; outline:none;
    }
    .q textarea:focus,.q input[type="text"]:focus{ border-color:var(--gold); box-shadow:0 0 0 2px rgba(255,213,74,.25)}
    .row{ display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:720px){ .row{ grid-template-columns:1fr 1fr } }
    .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:6px }
    button{ background:var(--gold); color:#000; border:0; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer }
    button.secondary{ background:transparent; color:var(--gold); border:1px solid var(--gold) }
    .msg{ text-align:center; font-weight:700; min-height:24px }
    .hidden{ display:none !important }
    .downloads{ display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap }
    .downloads a{ background:#12d6ff; color:#001018; padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:800 }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Jornada — Conhecimento com Luz ✨</h1>
    <p class="sub">Responda com sinceridade. Seus dados são usados apenas para a Jornada.</p>

    <form id="jornada">
      <div class="row">
        <div class="q">
          <label for="nome">Seu nome</label>
          <input type="text" id="nome" name="nome" placeholder="Como quer ser chamado(a)?" required>
        </div>
        <div class="q">
          <label for="email">E-mail</label>
          <input type="text" id="email" name="email" placeholder="(opcional)">
        </div>
      </div>

      <!-- Perguntas virão daqui -->
      <div id="perguntas"></div>

      <div class="actions">
        <button type="button" class="secondary" id="btnLimpar">Limpar respostas</button>
        <button type="submit" id="btnEnviar">Enviar respostas</button>
      </div>
      <div id="mensagem" class="msg"></div>

      <!-- Área de download pós-envio -->
      <div id="downloads" class="downloads hidden">
        <a id="linkPdf" href="#" target="_blank" rel="noopener">Baixar PDF 📄</a>
        <a id="linkHq"  href="#" target="_blank" rel="noopener">Baixar HQ 📘</a>
      </div>
    </form>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://lumen-backend-api.onrender.com";
    const URL_PERGUNTAS  = API_BASE + "/perguntas";
    const URL_FORMULARIO = API_BASE + "/formulario";

    // ===== helpers =====
    const $ = (sel)=>document.querySelector(sel);
    const perguntasDiv = $("#perguntas");
    const form = $("#jornada");
    const msg  = $("#mensagem");
    const downloadsBox = $("#downloads");
    const linkPdf = $("#linkPdf");
    const linkHq  = $("#linkHq");
    const btnEnviar = $("#btnEnviar");

    // Renderiza perguntas vindas da API
    async function carregarPerguntas(){
      msg.textContent = "Carregando…";
      try{
        const r = await fetch(URL_PERGUNTAS);
        if(!r.ok) throw new Error("Falha ao carregar perguntas");
        const data = await r.json();
        perguntasDiv.innerHTML = "";
        const perguntas = data.perguntas || {};
        const keys = Object.keys(perguntas).sort((a,b)=>Number(a)-Number(b));
        keys.forEach(k=>{
          const texto = perguntas[k];
          const id = "q"+k;
          const bloco = document.createElement("div");
          bloco.className = "q";
          bloco.innerHTML = `
            <label for="\${id}">\${k}. \${texto}</label>
            <textarea id="\${id}" name="\${id}" rows="4" required></textarea>
          `;
          perguntasDiv.appendChild(bloco);
        });
        msg.textContent = "";
      }catch(e){
        console.error(e);
        msg.textContent = "Não foi possível carregar as perguntas. Tente novamente.";
      }
    }

    // Envio do formulário
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      msg.textContent = "Gerando sua devolutiva… isso pode levar alguns segundos.";
      btnEnviar.disabled = true;

      // monta payload
      const payload = {
        meta: {
          enviado_em: new Date().toISOString(),
          user_agent: navigator.userAgent
        },
        contato: {
          nome: $("#nome").value.trim(),
          email: $("#email").value.trim()
        },
        respostas: {}
      };

      // coleta respostas
      document.querySelectorAll("#perguntas textarea").forEach(area=>{
        const k = area.id.replace("q","");
        payload.respostas[k] = area.value.trim();
      });

      try{
        const r = await fetch(URL_FORMULARIO, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>({}));
        if(!r.ok || data.status!=="ok"){
          throw new Error(data.mensagem || "Falha no processamento");
        }

        msg.textContent = "✅ Pronto! Baixe seus arquivos abaixo.";

        // Só mostra os botões que vierem na resposta
        if (data?.links?.pdf) {
          linkPdf.href = API_BASE + data.links.pdf;
        } else {
          linkPdf.remove();
        }
        if (data?.links?.hq) {
          linkHq.href  = API_BASE + data.links.hq;
        } else {
          linkHq.remove();
        }

        downloadsBox.classList.remove("hidden");
        downloadsBox.scrollIntoView({behavior:"smooth", block:"center"});

      }catch(err){
        console.error(err);
        msg.textContent = "❌ Não foi possível gerar agora. Tente novamente em instantes.";
      }finally{
        btnEnviar.disabled = false;
      }
    });

    $("#btnLimpar").onclick = ()=> form.reset();

    // “Acorda” a instância free e carrega perguntas
    (async ()=>{
      try{
        const ctrl = new AbortController();
        setTimeout(()=>ctrl.abort(), 8000);
        await fetch(API_BASE + "/ping", { signal: ctrl.signal });
      }catch(_){}
      await carregarPerguntas();
    })();
  </script>
</body>
</html>
