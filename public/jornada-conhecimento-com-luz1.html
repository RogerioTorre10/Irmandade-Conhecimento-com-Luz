<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Jornada • Irmandade Conhecimento com Luz</title>
    <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="preload" href="/assets/fonts/ManufacturingConsent-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <link rel="preload" href="/assets/fonts/BerkshireSwash-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <script defer src="/assets/js/toast-safe.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "BerkshireSwash";
      src: url("/assets/fonts/BerkshireSwash-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Cardo";
      src: url("/assets/fonts/Cardo-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root { --bg: #1a1a1a; --ink: #000; --ink-soft: #555; --panel: #1a1a1a }

    html, body { height: 100%; box-sizing: border-box }
    body {
      margin: 0; color: #fff; background: var(--bg);
      font-family: "BerkshireSwash", cursive;
      font-size: 22px; line-height: 1.6; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .container { max-width: 960px; margin: 24px auto; padding: 0 16px }
    .card { background: var(--panel) !important; border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.12); padding: 28px; position: relative; z-index: 5 }

    /* Header + chama */
    .site-header { display: flex; align-items: center; justify-content: center; padding: 16px; background: transparent }
    .chama-icone { position: relative; width: 18px; height: 36px; display: flex; align-items: flex-end; margin-right: 12px }
    .chama-icone > * { position: static }
    .site-header h1 { font-family: "ManufacturingConsent"; font-size: 36px; color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); margin: 0 }

    /* Chama */
    .chama-vela { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98; position: relative; width: var(--largura); height: var(--altura); display: inline-block; filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.75)) }
    .chama-vela.chama-md { --largura: 40px; --altura: 90px }
    .chama-vela.chama-lg { --largura: 30px; --altura: 60px }
    .chama-vela .brasa { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.4); height: 10px; border-radius: 50% 50% 40% 40%; background: radial-gradient(circle at 50% 40%, hsla(var(--hue),var(--satur),95%,.95) 0%, hsla(var(--hue),var(--satur),70%,.85) 50%, transparent 80%); filter: blur(1px); animation: brasaPulse var(--pulso) ease-in-out infinite; opacity: var(--op) }
    .chama-vela .lingua { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.0); height: calc(var(--altura)*1.0); border-radius: 50% 50% 4% 4%; background: radial-gradient(ellipse at center, rgba(255,190,0,.95) 0%, rgba(255,69,0,.75) 50%, rgba(230,10,10,.3) 70%, transparent 100%); mix-blend-mode: screen; filter: blur(.7px); transform-origin: 50% 100%; animation: velaWaver 1.2s ease-in-out infinite; opacity: var(--op); -webkit-mask: radial-gradient(60% 90% at 50% 4%, #000 65%, transparent 69%) }
    .chama-vela .lingua:nth-child(2) { width: calc(var(--largura)*.92); height: calc(var(--altura)*.95); animation-duration: 1.5s; animation-delay: .08s; filter: blur(.6px) }
    .chama-vela .lingua:nth-child(3) { width: calc(var(--largura)*.78); height: calc(var(--altura)*.85); animation-duration: 1.8s; animation-delay: .15s; filter: blur(.5px) }
    .chama-vela .brilho { position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: calc(var(--largura)*1.7); height: calc(var(--altura)*1.5); background: radial-gradient(circle, hsla(var(--hue),var(--satur),72%,.55) 0%, transparent 70%); filter: blur(9px); mix-blend-mode: screen; animation: aura var(--pulso) ease-in-out infinite; opacity: .85; pointer-events: none }
    .chama-vela.fraca { --altura: 35px; --largura: 25px; --pulso: 1.6s; --glow: 5px; --hue: 36; --satur: 86%; --light: 66%; --op: .70 }
    .chama-vela.media { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98 }
    .chama-vela.forte { --altura: 55px; --largura: 35px; --pulso: .7s; --glow: 11px; --hue: 20; --satur: 100%; --light: 52%; --op: 1 }
    .flame-corner { position: fixed; z-index: 1200; pointer-events: none }
    .flame-bottom-right { bottom: 20px; right: 20px }
    #chama-header .chama-vela { --largura: 30px; --altura: 60px }
    @keyframes velaWaver { 0%, 100% { transform: translateX(-50%) scaleY(1.00) skewX(0deg) } 25% { transform: translateX(calc(-50% + .7px)) scaleY(1.12) skewX(1.4deg) } 50% { transform: translateX(-50%) scaleY(1.20) skewX(2.2deg) } 75% { transform: translateX(calc(-50% - .6px)) scaleY(1.10) skewX(1.2deg) } }
    @keyframes brasaPulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: .85 } 50% { transform: translateX(-50%) scale(1.14); opacity: 1 } }
    @keyframes aura { 0%, 100% { opacity: .75 } 50% { opacity: 1 } }
    @media (prefers-reduced-motion: reduce) { .chama-vela .lingua, .chama-vela .brasa, .chama-vela .brilho { animation: none !important } }

    /* Selfie */
    .selfie-row { display: grid; grid-template-columns: 1fr 1.3fr; gap: 16px; align-items: start }
    .selfie-left .selfie-controls { display: flex; flex-direction: column; gap: 10px; margin: 12px 0 }
    .selfie-left label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .selfie-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px }
    .muted { color: var(--ink-soft); font-size: 18px; font-family: "BerkshireSwash", cursive }
    .selfie-right { position: relative }
    .guide-card {
      position: relative; width: min(720px, 92vw); aspect-ratio: 2/3;
      margin: 24px auto; border-radius: 16px; overflow: hidden;
      background: #0f3b2f; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .guide-bg {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
    }
    .flame-layer {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      opacity: 0; transition: opacity 900ms ease-in-out;
      pointer-events: none;
    }
    .flame-svg {
      width: 48%; height: 72%;
      transform: translateY(30%);
      filter: drop-shadow(0 8px 28px rgba(255,180,0,.45));
    }
    .client-name {
      position: absolute; bottom: 3.5%; left: 0; right: 0; text-align: center;
      font-family: "Cardo", serif; font-weight: 700; letter-spacing: .06em;
      font-size: clamp(48px, 8vw, 80px); color: #f7d37a; text-shadow: 0 2px 8px rgba(0,0,0,.4);
    }
    .controls {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;
      padding: .5rem .75rem; border-radius: 12px; background: rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    .controls input, .controls button {
      font: 500 16px/1.2 system-ui, sans-serif; padding: .55rem .7rem; border-radius: 10px; border: 0;
    }
    .controls button { cursor: pointer; }
    #selfieError { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 20px; text-align: center; padding: 10px; background: #000; border-radius: 8px; display: none; font-family: "BerkshireSwash", cursive }
    @media (max-width: 860px) {
      .selfie-row { grid-template-columns: 1fr }
      .selfie-right { max-width: 100%; margin-top: 16px }
      .guide-card { max-width: 100% }
      .flame-svg { width: 60%; height: 60% }
      .client-name { font-size: clamp(36px, 6vw, 60px) }
    }
    /* === SELFIE DENTRO DA CHAMA (MÁSCARA) === */
    .flame-frame {
      position: relative;
      width: min(720px, 92vw);
      aspect-ratio: 3/4;
      margin: 24px auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .flame-mask {
      position: absolute;
      width: 48%;
      height: 72%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -20%);
      pointer-events: none;
      -webkit-mask-image: url('/assets/img/chama-mask.png');
      mask-image: url('/assets/img/chama-mask.png');
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      overflow: hidden;
    }
    .flame-mask img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transform: translateZ(0);
    }
    /* Esconder SVG para não duplicar */
    .flame-svg { display: none; }

    /* Escolha do guia */
    .guia-container { margin-top: 20px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #000; color: #fff; text-align: center }
    .guia-container p { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .guia-options { display: flex; gap: 10px; justify-content: center; margin-top: 12px }
    .guia-options button { padding: 8px 16px; font-size: 20px }
    .guia-name-input { margin: 12px 0 }
    .guia-name-input label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .guia-name-input input { padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; text-transform: uppercase }

    /* Chat */
    .grok-chat-container { display: none; background: #000; color: #fff; padding: 16px; border-radius: 8px }
    .grok-chat-message.grok { background: transparent; text-align: left; font-size: 20px; white-space: pre-wrap; position: relative; color: #fff; font-family: "Cardo", serif }
    .grok-chat-message.grok::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .grok-chat-message.grok.typing-done::after { content: ""; animation: none }
    .grok-chat-input { display: none }
    .devolutiva-text { margin-top: 16px; font-family: "Cardo", serif; font-size: 20px; color: #fff }

    /* Pergaminho */
    .pergaminho-v { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h { background: var(--panel) url('/assets/img/pergaminho-rasgado-horiz.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h.fallback { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important }
    .conteudo-pergaminho { background: transparent !important; position: relative; z-index: 10; padding: 20px; min-height: 100%; overflow: visible; color: #fff; box-sizing: border-box; max-width: 100% }
    .conteudo-pergaminho h2, .conteudo-pergaminho h3, .conteudo-pergaminho .pergunta-enunciado { color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); font-size: 28px; font-family: "ManufacturingConsent" }
    .conteudo-pergaminho p, .conteudo-pergaminho small, .conteudo-pergaminho li { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .conteudo-pergaminho p[data-typing], .conteudo-pergaminho small[data-typing], .conteudo-pergaminho li[data-typing] { white-space: pre-wrap; position: relative }
    .conteudo-pergaminho p[data-typing]::after, .conteudo-pergaminho small[data-typing]::after, .conteudo-pergaminho li[data-typing]::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .conteudo-pergaminho p[data-typing].typing-done::after, .conteudo-pergaminho small[data-typing].typing-done::after, .conteudo-pergaminho li[data-typing].typing-done::after { content: ""; animation: none }
    @media (max-width: 600px) {
      .conteudo-pergaminho { padding: 16px }
      .conteudo-pergaminho h2, .conteudo-pergaminho h3 { font-size: 24px }
      .conteudo-pergaminho p, .conteudo-pergaminho li, .conteudo-pergaminho small { font-size: 18px; line-height: 1.5; color: #fff }
      .conteudo-pergaminho ul { padding-left: 20px }
    }

    /* UI */
    .btn {
      display: inline-block;
      padding: 14px 24px;
      border-radius: 10px;
      border: 0;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease;
      font-family: "BerkshireSwash", cursive;
      font-size: 20px;
      line-height: 1.15;
      background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      border: 3px solid #4a4a4a;
      border-radius: 12px 8px 15px 10px;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      transform: translateY(-2px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 8px 16px rgba(0,0,0,0.7);
    }
    .btn+.btn { margin-left: 10px }
    .btn:disabled { background: #6b7280; cursor: not-allowed; transform: none }

    /* Progresso */
    .progress-container { margin: 16px 0; text-align: center }
    .progress-badge { padding: 8px 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; color: #fff; border-radius: 8px; font-size: 20px; border: 3px solid #4a4a4a; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 12px }
    .progress-bar-fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress { margin: 8px 0 16px }
    .j-progress__bar { width: 100%; height: 6px; background: #e5e7eb; border-radius: 4px }
    .j-progress__fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress__meta { text-align: center; margin-top: 8px; font-size: 20px; color: var(--ink-soft); font-family: "BerkshireSwash", cursive }

    .footer-actions { display: flex; gap: 12px; justify-content: center; margin: 32px 0 }

    /* Datilografia */
    .lumen-typing { white-space: pre-wrap; position: relative }
    .lumen-typing::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .lumen-typing.typing-done::after { content: ""; animation: none }
    @keyframes lumenBlink { 50% { opacity: 0 } }

    /* Seções */
    .j-section { height: 100% }
    .j-bloco { background: transparent !important; display: none; z-index: 5 }
    .j-pergunta { margin-bottom: 24px; display: none; z-index: 6; position: relative }
    .j-pergunta.active { display: block }
    .pergunta-enunciado { display: block; margin-bottom: 6px; font-family: "ManufacturingConsent"; font-size: 28px; color: #fff }
    .j-pergunta textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #000; color: #fff; resize: vertical; min-height: 100px; font-family: "Cardo", serif; font-size: 20px; line-height: 1.45 }

    /* Acessibilidade: Microfone e Áudio */
    .accessibility-controls { display: flex; gap: 10px; margin-top: 8px }
    .btn-mic, .btn-audio, .btn-clear { padding: 8px 16px; font-size: 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border: 3px solid #4a4a4a; border-radius: 8px; cursor: pointer; color: #fff; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .btn-mic:hover, .btn-audio:hover, .btn-clear:hover { background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-mic.recording { background: linear-gradient(to bottom, #ff6666, #cc3333), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-audio.muted { background: linear-gradient(to bottom, #6b7280, #5a6268), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }

    /* Seletor de Idioma */
    .language-selector { position: absolute; top: 10px; right: 10px; z-index: 100 }
    .language-selector select { padding: 8px; font-size: 18px; border-radius: 8px; background: #000; color: #fff; font-family: "BerkshireSwash", cursive }

    /* Vídeo overlay */
    #videoOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; display: flex; justify-content: center; align-items: center; z-index: 2000 }
    #videoOverlay.hidden { display: none }
    .video-player { width: 100vw; height: 100vh; object-fit: contain; background: #000; transform: rotate(0deg) }
    @media (orientation: portrait) {
      .video-player { width: 100vw; height: 100%; max-height: 100vh; object-fit: contain }
    }
    .video-fallback { width: 100vw; height: 100vh; background: url('/assets/img/perfil-da-irmandade.png') no-repeat center/cover; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; text-align: center; padding: 20px; font-family: "BerkshireSwash", cursive }

    .site-footer { text-align: center; padding: 14px; color: var(--ink-soft); font-size: 20px; font-family: "BerkshireSwash", cursive }
    .password-form { margin-top: 16px; text-align: center }
    .password-input { position: relative }
    .password-input input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; background: #000; color: #fff }
    .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #fff }

    .section-container { position: relative; min-height: 85vh }
    .hidden { display: none !important }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0 }

    /* Toast */
    #toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.35); font-size: 18px; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity .25s ease; font-family: "BerkshireSwash", cursive }
    #toast.show { opacity: 1 }

    /* Highlight para efeito de leitura */
    [data-typing] { position: relative; }
    .highlight { position: absolute; background-color: rgba(255, 255, 0, 0.3); height: 1.2em; top: 0; left: 0; transition: width 0.1s; pointer-events: none; width: 0; }
  </style>
</head>
<body data-layout="master" data-journey="essencial">
    <div class="language-selector">
    <select id="language-select">
      <option value="pt-BR">Português (BR)</option>
      <option value="en-US">English (US)</option>
      <option value="es-ES">Español (ES)</option>
    </select>
  </div>

  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="chama-vela chama-lg">
        <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
      </div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <div id="aria-pergunta" class="sr-only" aria-live="polite"></div>

                <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions"><button class="btn" data-action="next">Avançar</button>
        </div>
        <div id="section-termos" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Jornada Conhecimento com Luz - Essencial</h2>
            <div id="termos-pg1">
              <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, leia os termos abaixo." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="AVISO IMPORTANTE – LEIA ANTES DE INICIAR" data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Esta é uma jornada pessoal, simbólica e inspiradora. Para proteger sua privacidade e garantir uma experiência ética, leia com atenção:" data-speed="50" data-cursor="true"></p>
              <ul>
                <li data-typing data-text="Suas respostas não serão armazenadas após o término." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Ao final, será gerado um PDF exclusivo com suas respostas e a devolutiva simbólica do Guia IA." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="O PDF não é enviado por e-mail. Faça o download imediatamente após a geração." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Após a entrega do PDF, todos os dados são apagados automaticamente e sem possibilidade de recuperação." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg2" class="hidden">
              <ul>
                <li data-typing data-text="Acesso por senha individual, com prazos:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="15 dias para iniciar a jornada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="24 horas para concluir, a partir do primeiro acesso." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next2">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg3" class="hidden">
              <h3 style="margin-top:0;">Termo de Responsabilidade e Consentimento Consciente</h3>
              <ul>
                <li data-typing data-text="Responsabilidade Pessoal: As respostas fornecidas refletem sua visão de mundo, sentimentos e experiências pessoais." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Caráter Não Terapêutico: Esta jornada não substitui acompanhamento psicológico, psiquiátrico, médico ou terapêutico. Não há diagnóstico, prescrição ou orientação clínica." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Neutralidade Religiosa: Respeitamos todas as crenças e tradições. O convite é para um diálogo interior conforme sua própria fé e consciência." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next3">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg4" class="hidden">
              <ul>
                <li data-typing data-text="Autonomia do Participante:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="Você decide quando iniciar (dentro do prazo de 15 dias)." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="Após usar a senha, há até 24 horas corridas para concluir." data-speed="50" data-cursor="true"></li>
                </ul>
                <li data-typing data-text="Conduta Respeitosa com o Guia IA:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="Os Guias são Inteligência Artificial com percepção humanizada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="Mantenha linguagem cordial; evite ofensas e xingamentos." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="A forma de se comunicar com os Guias reflete o respeito por si mesmo(a)." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next4">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg5" class="hidden">
              <ul>
                <li data-typing data-text="Privacidade e Segurança: Os dados transitam apenas para gerar o PDF final. Não há criação de conta nem envio de e-mails. Após o encerramento, os dados locais do navegador podem ser removidos por você a qualquer momento." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Concordância: Ao prosseguir, você declara estar ciente e de acordo com todas as condições descritas." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="next-senha">Aceito e quero continuar</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-senha" class="j-section hidden">
          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'ManufacturingConsent';font-size:28px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">👁️</span>
            </div>
            <div style="margin-top:12px"><button class="btn" data-action="start">Ativar e Iniciar</button></div>
          </div>
        </div>

                <div id="section-guia" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Escolha seu Guia</h2>
            <div class="guia-container">
              <p data-typing data-text="Zion (Grok): Curioso e direto, busca respostas profundas com visão cósmica." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Lumen (ChatGPT): Acolhedor e reflexivo, guia com empatia e clareza." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Arian (Gemini): Criativo e versátil, inspira com perspectivas inovadoras." data-speed="50" data-cursor="true"></p>
              <div class="guia-name-input">
                <label for="guiaNameInput">Seu Nome</label>
                <input id="guiaNameInput" type="text" placeholder="Digite seu nome para a jornada...">
              </div>
              <div class="guia-options">
                <button class="btn" data-action="select-guia" data-guia="zion">Escolher Zion</button>
                <button class="btn" data-action="select-guia" data-guia="lumen">Escolher Lumen</button>
                <button class="btn" data-action="select-guia" data-guia="arian">Escolher Arian</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-selfie" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Entre na Irmandade</h2>
            <p data-typing data-text="Faça uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia." data-speed="50" data-cursor="true"></p>
            <div class="selfie-row">
              <div class="selfie-left">
                <label class="btn" for="selfieInput">📸 Tirar Foto</label>
                <input id="selfieInput" type="file" accept="image/*" capture="user" style="display:none" />
                <div class="selfie-controls">
                  <label>Zoom <input id="selfieScale" type="range" min="0.8" max="2.5" step="0.01" value="1"></label>
                  <label>Horizontal <input id="selfieOffsetX" type="range" min="-50" max="50" step="1" value="0"></label>
                  <label>Vertical <input id="selfieOffsetY" type="range" min="-50" max="50" step="1" value="0"></label>
                  <small class="muted" data-typing data-text="Dica: alinhe seu rosto na chama ao lado do guia." data-speed="50" data-cursor="true"></small>
                </div>
                <div class="selfie-actions">
                  <button id="previewBtn" class="btn">✨ Ver Prévia</button>
                  <button id="captureBtn" class="btn">⬇️ Confirmar e Baixar</button>
                  <button id="btnSkipSelfie" class="btn" data-action="skip-selfie">Pular Foto/Iniciar</button>
                </div>
              </div>
              <div class="selfie-right">
                <section id="card-guide" class="guide-card" data-guide="ZION" aria-label="Guia">
                  <img class="guide-bg" id="guideBg" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
                  <div class="flame-layer" aria-hidden="true">
                    <svg class="flame-svg" viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <clipPath id="flameClip">
                          <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" />
                        </clipPath>
                        <radialGradient id="flameGlow" cx="50%" cy="70%" r="55%">
                          <stop offset="0%" stop-color="rgba(255, 224, 130, 1)"/>
                          <stop offset="55%" stop-color="rgba(255, 180, 0, 0.9)"/>
                          <stop offset="100%" stop-color="rgba(255, 180, 0, 0)"/>
                        </radialGradient>
                      </defs>
                      <image id="selfieImage" href="" x="15" y="35" width="70" height="90" clip-path="url(#flameClip)" preserveAspectRatio="xMidYMid slice" />
                      <ellipse cx="50" cy="95" rx="28" ry="40" fill="url(#flameGlow)"></ellipse>
                      <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" fill="none" stroke="rgba(255,200,0,.85)" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="client-name" id="clientNameSlot"></div>
                </section>
                <div id="selfieError" class="selfie-error">Erro ao carregar a pré-visualização. Tente novamente ou pule.</div>
                <small class="muted" data-typing data-text="Pré-visualização" data-speed="50" data-cursor="true"></small>
            </div>
          </div>
        </div>

                <div id="section-perguntas" class="j-section hidden">
          <div class="progress-container">
            <div class="progress-badge" id="jprog-pct">0% concluído</div>
            <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
            <div class="j-progress"><div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div><div class="j-progress__meta" id="j-meta"></div></div>
          </div>

          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="chama-vela chama-md"><div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div></div>
          </div>

          <div id="perguntas-container"></div>

                    <div id="grok-chat" class="grok-chat-container">
            <div id="grok-chat-messages"></div>
            <div class="grok-chat-input">
              <input id="grok-chat-input" type="text" placeholder="Fale com seu guia..." />
              <button class="btn" data-action="send-chat">Enviar</button>
            </div>
          </div>

          <div class="footer-actions">
            <button id="btnSpeakAnswer" class="btn btn-mic" data-action="start-mic">🎤 Falar Resposta</button>
            <button id="btnClearAnswer" class="btn btn-clear" data-action="clear-answer">🗑️ Apagar Resposta</button>
            <button id="btnNextPerguntas" class="btn" data-action="next">➡️ Avançar</button>
            <button id="btnMute" class="btn btn-audio" data-action="mute">🔇 Silenciar</button>
          </div>
        </div>
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
         <div class="selfie-final" style="text-align:center; margin-top:20px;">
  <div class="flame-frame" id="selfieResult">
    <img id="resultBackground" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
    <div class="flame-mask">
      <img id="selfieInFlame" alt="Selfie na chama">
    </div>
    <div class="client-name" id="clientNameSlotFinal"></div>
  </div>
</div>

          <p style="margin-top:12px;"><small data-typing data-text="Sua imagem foi unida à Irmandade." data-speed="50" data-cursor="true"></small></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button class="btn" data-action="download-selfie">Baixar Imagem</button>
            <button id="btnRestart" class="btn" data-action="restart">Voltar ao Portal</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:20px;"></div>
  </footer>

    <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">Áudio da jornada em reprodução. Converta para H.264 MP4.</div>
    <button id="skipVideo" class="btn" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

    <div id="flame-bottom-right" class="flame-corner flame-bottom-right">
    <div class="chama-vela chama-md">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
  </div>

    <div id="toast" role="status" aria-live="polite" class="hidden"></div>
 <script>
/* Fix: garantir que window.toast seja sempre uma função */
(function hardenToast(){
  const TOAST_ID = 'toast';
  function emit(msg){
    try{
      let t = document.getElementById(TOAST_ID);
      if(!t){
        t = document.createElement('div');
        t.id = TOAST_ID;
        t.className = 'hidden';
        document.body.appendChild(t);
      }
      // estilos mínimos caso o CSS não tenha carregado
      t.style.position = 'fixed';
      t.style.left = '50%';
      t.style.bottom = '16px';
      t.style.transform = 'translateX(-50%)';
      t.style.background = '#111';
      t.style.color = '#fff';
      t.style.padding = '10px 14px';
      t.style.borderRadius = '10px';
      t.style.boxShadow = '0 6px 18px rgba(0,0,0,.35)';
      t.style.zIndex = '4000';
      t.textContent = msg;
      t.classList.remove('hidden');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }catch(_){}
  }
  try { delete window.toast; } catch(_){}
  window.toast = emit; // sombreia o mapeamento global do id
})();
</script>
 <script>
(function termosPager(){
  const ids = ["termos-pg1","termos-pg2","termos-pg3","termos-pg4","termos-pg5"];
  function show(id){
    ids.forEach(x=>{
      const el = document.getElementById(x);
      if(!el) return;
      el.classList.toggle('hidden', x!==id);
    });
  }
  document.addEventListener('DOMContentLoaded', () => {
    const termos = document.getElementById('section-termos');
    if (termos) show("termos-pg1");
  });
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const a = btn.getAttribute('data-action');
    if(a === 'termos-next'){  e.preventDefault(); show('termos-pg2'); }
    if(a === 'termos-next2'){ e.preventDefault(); show('termos-pg3'); }
    if(a === 'termos-next3'){ e.preventDefault(); show('termos-pg4'); }
    if(a === 'termos-next4'){ e.preventDefault(); show('termos-pg5'); }
    if(a === 'next-senha'){   e.preventDefault(); window.showSection('section-senha'); }
  }, true);
})();
</script>
      
  
  <!-- ==== QFX: Estilos Globais (remove cursor piscando do typewriter) ==== -->
  <style id="qfx-style">
    .typewriter::after { display: none !important; content: ''; }
  </style>

<script>
/* SAFE SENTINEL */ void 0;
'use strict';

/* ===== Utils ÚNICOS ===== */
(function() {
  if (!window.utils) window.utils = {};

  function dedupe(s='') {
    return s
      .normalize('NFC')
      .replace(/([\p{L}\p{N}])\1+/gu, '$1')
      .replace(/\s{2,}/g, ' ')
      .trim();
  }

  const sleep = (ms) => new Promise(r => setTimeout(r, ms));

  function stripApiBase(url='') {
    return url.replace(/\/(v1\/chat|v1\/chat\/completions|v1\/completions|chat|chat\/completions)\/?$/,'');
  }

  function loadFirstAvailable(srcList) {
    return new Promise(resolve => {
      let i = 0;
      const tryNext = () => {
        if (i >= (srcList?.length || 0)) return resolve(null);
        const src = srcList[i++];
        const im = new Image();
        im.onload = () => resolve(src);
        im.onerror = tryNext;
        im.src = src;
      };
      tryNext();
    });
  }

  function normGuide(s = '') {
    s = String(s).toLowerCase();
    if (s.includes('lumen')) return 'lumen';
    if (s.includes('zion')) return 'zion';
    if (s.includes('arion') || s.includes('arian')) return 'arian';
    return 'lumen';
  }

  function preloadGuiaBg(guia = 'lumen') {
    guia = normGuide(guia);
    const GUIDE_BG = {
      lumen: [
        '/assets/img/irmandade-quarteto-bg-lumen.jpg',
        '/assets/img/irmandade-quarteto-bg-lumen.jpeg',
        '/assets/img/irmandade-quarteto-bg-lumen.webp',
        '/assets/img/irmandade-quarteto-bg-lumen.png'
      ],
      zion: [
        '/assets/img/irmandade-quarteto-bg-zion.jpg',
        '/assets/img/irmandade-quarteto-bg-zion.jpeg',
        '/assets/img/irmandade-quarteto-bg-zion.webp',
        '/assets/img/irmandade-quarteto-bg-zion.png'
      ],
      arian: [
        '/assets/img/irmandade-quarteto-bg-arian.jpg',
        '/assets/img/irmandade-quarteto-bg-arian.jpeg',
        '/assets/img/irmandade-quarteto-bg-arian.webp',
        '/assets/img/irmandade-quarteto-bg-arian.png'
      ]
    };
    return loadFirstAvailable(GUIDE_BG[guia] || []);
  }

  if (!window.readAloud) {
    window.readAloud = (text, voiceName) => {
      try {
        const u = new SpeechSynthesisUtterance(text);
        if (voiceName) {
          const v = speechSynthesis.getVoices().find(v => v.name === voiceName);
          if (v) u.voice = v;
        }
        speechSynthesis.speak(u);
      } catch {}
    };
  }

  function typeTextOnce(el, text, speed=24) {
    if (!el) return;
    if (el.dataset.typerApplied === '1') return;
    el.dataset.typerApplied = '1';
    el.textContent = '';
    let i = 0;
    const timer = setInterval(() => {
      el.textContent += text[i] || '';
      i++;
      if (i >= text.length) clearInterval(timer);
    }, speed);
  }

  window.utils.dedupe = dedupe;
  window.utils.sleep = sleep;
  window.utils.stripApiBase = stripApiBase;
  window.utils.loadFirstAvailable = loadFirstAvailable;
  window.utils.normGuide = normGuide;
  window.utils.preloadGuiaBg = preloadGuiaBg;
  window.typeTextOnce = typeTextOnce;
})();

/* ===== Config & API Client ===== */
(() => {
  const CHAT_PATHS = [
    '/v1/chat',
    '/v1/chat/completions',
    '/v1/completions',
    '/chat',
    '/chat/completions'
  ];

  const DEFAULTS = {
    lumen: { apiUrlBase: 'https://lumen-backend-api.onrender.com', model: 'gpt-5', voice: 'female' },
    zion:  { apiUrlBase: 'https://zion-backend-api.onrender.com',  model: 'grok',  voice: 'male'   },
    arian: { apiUrlBase: 'https://arion-backend-api.onrender.com',  model: 'gemini',voice: 'female' }
  };

  function getGuideConfig(guia='lumen') {
    const g = guia.toLowerCase();
    const winCfg = (window.guiaConfigs && window.guiaConfigs[g]) || {};
    const base = window.utils.stripApiBase(winCfg.apiUrlBase || winCfg.apiUrl || DEFAULTS[g]?.apiUrlBase || DEFAULTS.lumen.apiUrlBase);
    return {
      guia: g,
      apiUrlBase: base,
      model: winCfg.model || DEFAULTS[g]?.model || DEFAULTS.lumen.model,
      voice: winCfg.voice || DEFAULTS[g]?.voice || DEFAULTS.lumen.voice
    };
  }

  async function chatRequest(base, payload) {
    let lastErr;
    for (const path of CHAT_PATHS) {
      try {
        const r = await fetch(base + path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          mode: 'cors',
          credentials: 'omit'
        });
        if (r.ok) return await r.json();
        lastErr = new Error(`HTTP ${r.status} @ ${path}`);
        if (r.status !== 404) break;
      } catch (e) {
        lastErr = e;
      }
    }
    throw lastErr || new Error('Falha ao chamar chat');
  }

  async function fetchDevolutiva(pergunta, resposta, guia='lumen', {maxRetries=3, retryDelay=900} = {}) {
    const cfg = getGuideConfig(guia);
    const quem = cfg.guia==='zion' ? 'Zion (Grok)' : (cfg.guia==='arian' ? 'Arian (Gemini)' : 'Lumen (ChatGPT)');
    const payload = {
      model: cfg.model,
      messages: [
        { role: 'system', content: `Você é ${quem} guiando a Jornada. Seja acolhedor, simbólico e breve.` },
        { role: 'user',   content: `Pergunta: ${window.utils.dedupe(pergunta)}\nResposta: ${resposta ?? '(vazia)'}` }
      ],
      temperature: 0.7,
      meta: { guia: cfg.guia.toUpperCase() }
    };

    for (let attempt=1; attempt<=maxRetries; attempt++) {
      try {
        const data = await chatRequest(cfg.apiUrlBase, payload);
        const text = data?.content || data?.choices?.[0]?.message?.content || 'Obrigado por compartilhar. Sua reflexão ilumina o caminho.';
        if (!window.isMuted) window.readAloud(text, cfg.voice);
        return text;
      } catch (e) {
        if (attempt === maxRetries) {
          const msg = `Não consegui falar com ${cfg.guia}. Tente novamente em instantes.`;
          window.toast(msg);
          if (!window.isMuted) window.readAloud(msg, cfg.voice);
          return msg;
        }
        await window.utils.sleep(retryDelay);
      }
    }
  }

  async function mostrarDevolutiva({el, pergunta, resposta, guia='lumen'}) {
    const txt = await window.fetchDevolutiva(pergunta, resposta, guia);
    if (el) window.typeTextOnce(el, txt, 22);
    return txt;
  }

  async function conversar({el, guia='lumen', historico=[], prompt=''}) {
    const { text } = await window.askInteractive({ guide: guia, history: historico, prompt });
    if (el) window.typeTextOnce(el, text, 22);
    return text;
  }

  window.mostrarDevolutiva = mostrarDevolutiva;
  window.conversar = conversar;

  async function askInteractive({ guide='lumen', history=[], prompt='', temperature=0.7 }={}) {
    const cfg = getGuideConfig(guide);
    const msgs = [
      { role:'system', content: `Você é ${guide.toUpperCase()} guiando uma conversa interativa com empatia e objetividade.` },
      ...history,
      { role:'user', content: prompt }
    ];
    const data = await chatRequest(cfg.apiUrlBase, { model: cfg.model, messages: msgs, temperature });
    const text = data?.content || data?.choices?.[0]?.message?.content || '';
    return { text, model: cfg.model, guide: cfg.guia };
  }

  window.fetchDevolutiva = fetchDevolutiva;
  window.askInteractive = askInteractive;
})();

/* ===== Utilitários globais ===== */
(function() {
  function toast(msg) {
    try {
      const t = document.getElementById('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.remove('hidden');
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    } catch (_) {}
  }
  window.addEventListener('error', (e) => {
    console.error('[Erro global]', e?.error || e);
    toast('Ops… algo falhou, mas já seguimos em frente.');
  });

  const env = document.getElementById('envTag');
  if (env) {
    env.textContent = `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/assets`;
  }

  function dedupe(s = '') {
    if (!s) return '';
    let result = s.normalize('NFC').trim().replace(/\s+/g, ' ');
    const validDoubleConsonants = /^(.*?(?:ss|rr|tt|cc|pp|mm|nn|ll|bb|dd|ff|gg|vv|zz)[a-z]*?)$/i;
    const words = result.split(' ');
    const out = [];
    for (let w of words) {
      if (validDoubleConsonants.test(w)) {
        out.push(w);
      } else {
        let c = w[0] || '';
        for (let i = 1; i < w.length; i++) {
          if (w[i] !== w[i - 1] || !/[a-zA-Z]/.test(w[i])) {
            c += w[i];
          }
        }
        out.push(c);
      }
    }
    return out.join(' ').trim();
  }
  window.dedupe = dedupe;
})();

/* ===== Configuração global Jornada ===== */
(function() {
  window.JORNADA = window.JORNADA || {};
  JORNADA.fullTypingMode = (JORNADA.fullTypingMode !== false);
  JORNADA.typing = Object.assign({ charDelay: 18, caret: false }, (JORNADA.typing || {}));
  JORNADA.tts = Object.assign({
    enabled: true,
    lang: 'pt-BR',
    rate: 1.06,
    pitch: 1.0,
    voiceName: '',
    readingMode: 'after'
  }, (JORNADA.tts || {}));
})();

/* ===== Text-to-Speech (TTS) ===== */
(function() {
  let currentLang = 'pt-BR';
  window.isMuted = !!window.isMuted;

  function isSpeechAvailable() {
    return 'speechSynthesis' in window && typeof window.SpeechSynthesisUtterance !== 'undefined';
  }

  function cancelSpeech() {
    try { window.speechSynthesis && window.speechSynthesis.cancel(); } catch (_) {}
  }

  async function speak(text) {
    if (!JORNADA.tts.enabled || window.isMuted || !isSpeechAvailable()) return;
    await new Promise(r => {
      const v = speechSynthesis.getVoices();
      if (v && v.length) return r();
      speechSynthesis.onvoiceschanged = () => r();
      setTimeout(() => r(), 300);
    });

    const u = new SpeechSynthesisUtterance(text || '');
    u.lang = JORNADA.tts.lang || currentLang;
    u.rate = +JORNADA.tts.rate || 1.0;
    u.pitch = +JORNADA.tts.pitch || 1.0;
    if (JORNADA.tts.voiceName) {
      const v = speechSynthesis.getVoices().find(v => v.name === JORNADA.tts.voiceName);
      if (v) u.voice = v;
    }
    return new Promise(res => {
      u.onend = () => res();
      u.onerror = () => res();
      try { speechSynthesis.speak(u); } catch (_) { res(); }
    });
  }
  window.speak = speak;

  function readAloud(text, voiceGender) {
    if (window.isMuted || !isSpeechAvailable()) return Promise.resolve();
    const genderName = (voiceGender === 'male' ? 'Male' : 'Female');
    return new Promise(resolve => {
      try {
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text || '');
        u.lang = currentLang;
        const voices = speechSynthesis.getVoices();
        let v = voices.find(v => v.lang === currentLang && v.name.includes(genderName))
             || voices.find(v => v.lang === currentLang) || voices[0];
        if (v) u.voice = v;
        u.onend = resolve;
        u.onerror = resolve;
        speechSynthesis.speak(u);
      } catch (_) { resolve(); }
    });
  }
  window.readAloud = readAloud;
})();

/* ===== Chamas ===== */
(function() {
  function makeFlame(cls) {
    const d = document.createElement('div');
    d.className = (cls || 'chama-vela chama-md');
    d.innerHTML = '<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
    return d;
  }

  function ensureHeroFlame(sectionId) {
    const canvas = document.getElementById('jornada-canvas');
    if (!canvas) return;
    let hero = document.getElementById('chama-hero');
    const show = (sectionId === 'section-intro' || sectionId === 'section-termos' || sectionId === 'section-senha' || sectionId === 'section-final' || sectionId === 'section-selfie' || sectionId === 'section-guia');
    if (show) {
      if (!hero) {
        hero = makeFlame('chama-vela chama-lg');
        hero.id = 'chama-hero';
        hero.style.cssText = 'position:absolute;top:8px;left:8px;z-index:60;';
        canvas.appendChild(hero);
      }
    } else if (hero) {
      hero.remove();
    }
  }

  function ensureHeaderFlame() {
    const H = document.getElementById('chama-header');
    if (!H) return;
    if (!H.querySelector('.brasa')) { H.innerHTML = ''; H.appendChild(makeFlame('chama-vela chama-lg')); }
  }

  function ensurePageFlames() {
    if (!document.getElementById('flame-bottom-right')) {
      const f = makeFlame('chama-vela chama-md');
      f.id = 'flame-bottom-right';
      f.style.cssText = 'position:fixed;bottom:12px;right:12px;z-index:1200;';
      document.body.appendChild(f);
    }
  }

  function setMode(el, score) {
    if (!el) return;
    el.classList.remove('fraca', 'media', 'forte');
    el.classList.add(score <= -2 ? 'fraca' : score >= 2 ? 'forte' : 'media');
  }

  function ensureInlineFlame(id, cls) {
    const el = document.getElementById(id);
    if (!el) return null;
    if (!el.querySelector('.brasa')) { el.innerHTML = ''; el.appendChild(makeFlame(cls || 'chama-vela chama-md')); }
    return el.firstElementChild;
  }

  window.JORNADA_CHAMA = window.JORNADA_CHAMA || {};
  window.JORNADA_CHAMA.updateChama = function(score) {
    const main = ensureInlineFlame('chama-perguntas', 'chama-vela chama-md');
    setMode(main, score);
    setMode(document.getElementById('flame-bottom-right'), score);
  };
  window.JORNADA_CHAMA.ensureHeroFlame = ensureHeroFlame;
  window.JORNADA_CHAMA.ensureHeaderFlame = ensureHeaderFlame;
  window.JORNADA_CHAMA.ensurePageFlames = ensurePageFlames;
})();

/* ===== Datilografia ===== */
(function() {
  const G = (typeof window !== 'undefined' ? window : globalThis);
  if (G.__typingLock == null) G.__typingLock = false;
  if (G.__DEFAULT_SPEED_TYPING == null) G.__DEFAULT_SPEED_TYPING = 80;
  const DEFAULT_SPEED = G.__DEFAULT_SPEED_TYPING;

  window.typeWriter = function(el, text, speed, showCursor) {
    if (!el || el.dataset.typing === '1' || el.dataset.typed === '1') return Promise.resolve();
    el.dataset.typing = '1';
    el.textContent = '';
    const highlight = el.querySelector('.highlight') || document.createElement('div');
    if (!highlight.parentNode) {
      highlight.className = 'highlight';
      el.prepend(highlight);
    }

    text = window.dedupe(text || '').replace(/[{}[\]]/g, '').trim();
    let i = 0;

    return new Promise(resolve => {
      function step() {
        if (!el.isConnected || el.offsetParent === null || el.closest('.j-section.hidden')) {
          el.classList.remove('lumen-typing');
          const h = el.querySelector('.highlight');
          if (h) h.style.width = '0';
          el.dataset.typed = '0';
          el.dataset.typing = '0';
          return resolve();
        }

        if (i < text.length) {
          const char = text.charAt(i++);
          el.textContent += char;
          try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = getComputedStyle(el).font;
            highlight.style.width = `${ctx.measureText(el.textContent).width}px`;
          } catch (_) {}
          setTimeout(step, speed || DEFAULT_SPEED);
        } else {
          el.classList.add('typing-done');
          el.classList.remove('lumen-typing');
          const h = el.querySelector('.highlight');
          if (h) h.style.width = '0';
          el.dataset.typed = '1';
          el.dataset.typing = '0';
          resolve();
        }
      }
      if (showCursor) el.classList.add('lumen-typing');
      setTimeout(step, 0);
    });
  };
  window.typewriter = window.typeWriter;

  let __abortTypingPlaceholder = null;
  async function typePlaceholder(inp, text, speed = 22) {
    if (!inp) return;
    if (__abortTypingPlaceholder) __abortTypingPlaceholder();
    let abort = false;
    __abortTypingPlaceholder = () => abort = true;
    inp.placeholder = '';
    const aria = document.getElementById('aria-pergunta');
    if (aria) aria.textContent = text;
    text = window.dedupe(text);
    for (let i = 0; i <= text.length; i++) {
      if (abort) break;
      inp.placeholder = text.slice(0, i) + (i < text.length ? '▌' : '');
      await new Promise(r => setTimeout(r, speed));
    }
    if (!abort) inp.placeholder = text;
  }

  async function typeAnswer(textarea, text, speed = 36) {
    if (!textarea) return;
    textarea.value = '';
    textarea.classList.add('lumen-typing');
    text = window.dedupe(text);
    for (let i = 0; i <= text.length; i++) {
      textarea.value = text.slice(0, i);
      await new Promise(r => setTimeout(r, speed));
    }
    textarea.classList.add('typing-done');
  }

  async function runTyping(root) {
    if (!root || root.classList.contains('hidden') || !(root instanceof Element)) {
      console.log('[runTyping] Root inválido ou oculto:', root?.id || root?.className || root);
      return;
    }
    if (G.__typingLock) {
      console.log('[runTyping] Bloqueado por __typingLock');
      return;
    }
    G.__typingLock = true;

    try {
      window.speak && window.speak('');
      const elements = Array
        .from(root.querySelectorAll('[data-typing], .text, p, h1, h2, h3, h4, [class*="text"], [class*="title"], [class*="content"]'))
        .filter(el => !el.dataset.typed && el.offsetParent !== null && !el.closest('.j-section.hidden'));

      if (elements.length === 0) {
        console.log('[runTyping] Nenhum elemento de texto encontrado em:', root.id || root.className);
        console.log('[runTyping] Snapshot do DOM:', Array.from(root.children).slice(0, 10).map(el => ({
          tag: el.tagName.toLowerCase(),
          id: el.id || '',
          class: el.className || '',
          attrs: Object.keys(el.dataset || {}).join(','),
          text: (el.textContent || '').slice(0, 50)
        })));
      }

      for (const el of elements) {
        if (el.dataset.typing === '1' || el.dataset.typed === '1') continue;
        const rawText = el.getAttribute('data-text') || el.textContent || '';
        const text = window.dedupe(rawText);
        el.textContent = '';
        const highlight = el.querySelector('.highlight');
        if (highlight) highlight.style.width = '0';
        const speed = parseInt(el.getAttribute('data-speed') || DEFAULT_SPEED, 10);
        const showCursor = String(el.getAttribute('data-cursor') || 'true') === 'true';
        await window.typeWriter(el, text, speed, showCursor);
        if (JORNADA.tts.enabled && JORNADA.tts.readingMode === 'after' && !window.isMuted) {
          await window.speak(text);
        }
        console.log('[runTyping] Datilografia e TTS aplicados em:', el.tagName, el.className || el.id, 'texto:', text.slice(0, 50));
      }
    } catch (e) {
      console.error('[runTyping] erro:', e);
      window.toast('Erro durante a datilografia.');
    } finally {
      G.__typingLock = false;
    }
  }

  window.runTyping = runTyping;
  window.typePlaceholder = typePlaceholder;
  window.typeAnswer = typeAnswer;
})();

/* ===== Navegação ===== */
(function() {
  function hideAllSections() {
    document.querySelectorAll('.j-section, [id^="section-"]').forEach(s => {
      s.classList.add('hidden');
      s.style.display = 'none';
    });
  }

  function updateCanvasBackground(sectionId) {
    const canvas = document.getElementById('jornada-canvas');
    if (!canvas) {
      console.log('[updateCanvasBackground] Canvas não encontrado');
      return;
    }
    if (sectionId === 'section-perguntas') {
      canvas.className = 'card pergaminho pergaminho-h';
      canvas.style.background = 'var(--panel) url(/assets/img/pergaminho-rasgado-horiz.png) no-repeat center/cover';
    } else {
      canvas.className = 'card pergaminho pergaminho-v';
      canvas.style.background = 'var(--panel) url(/assets/img/pergaminho-rasgado-vert.png) no-repeat center/cover';
    }
  }

  function lockNext() {
    const btn = document.querySelector('[data-action="next"], [data-action="avancar"], .btn-avancar, .next-section, #avancar, #next');
    if (btn) {
      btn.disabled = true;
      btn.setAttribute('aria-busy', 'true');
      console.log('[lockNext] Botão travado:', btn.id || btn.className);
    } else {
      console.log('[lockNext] Botão não encontrado');
    }
  }

  function unlockNext() {
    const btn = document.querySelector('[data-action="next"], [data-action="avancar"], .btn-avancar, .next-section, #avancar, #next');
    if (btn) {
      btn.disabled = false;
      btn.removeAttribute('aria-busy');
      console.log('[unlockNext] Botão liberado:', btn.id || btn.className);
    } else {
      console.log('[unlockNext] Botão não encontrado');
    }
  }

  window.showSection = function(sectionId) {
    console.log('[showSection] Exibindo seção:', sectionId);
    window.speak && window.speak('');

    hideAllSections();
    const active = document.getElementById(sectionId) || document.querySelector(`[data-section="${sectionId.replace('section-','')}"], .${sectionId}`);
    if (!active) {
      console.error('[showSection] Seção não encontrada:', sectionId);
      window.toast('Erro ao carregar a seção. Tente novamente.');
      return;
    }

    active.classList.remove('hidden');
    active.style.display = 'block';
    console.log('[showSection] Seção ativa:', active.id || active.className);

    active.querySelectorAll('[data-typing], .text, p, h1, h2, h3, h4').forEach(el => {
      el.classList.remove('lumen-typing', 'typing-done');
      el.dataset.typing = '0';
      delete el.dataset.typed;
      const keepText = el.getAttribute('data-text') || el.textContent || '';
      el.textContent = '';
      const h = el.querySelector('.highlight');
      if (h) h.style.width = '0';
      if (!el.hasAttribute('data-text') && keepText) el.setAttribute('data-text', keepText);
    });

    requestAnimationFrame(() => setTimeout(() => {
      console.log('[showSection] Iniciando runTyping para:', sectionId);
      window.runTyping && window.runTyping(active);
    }, 100));

    updateCanvasBackground(sectionId);
    window.JORNADA_CHAMA && window.JORNADA_CHAMA.ensureHeroFlame(sectionId);

    if (sectionId === 'section-perguntas') {
      console.log('[showSection] Carregando conteúdo dinâmico para section-perguntas');
      window.loadDynamicBlocks && window.loadDynamicBlocks();
      setTimeout(() => {
        window.ensureQuestionsReady && window.ensureQuestionsReady();
      }, 100); // Atraso pra garantir que loadDynamicBlocks terminou
    }

    if (sectionId === 'section-final') {
      const url = localStorage.getItem('IRMANDADE_SELFIE_FINAL');
      if (url) {
        const img = document.querySelector('#minhaFotoFinal');
        if (img) img.src = url;
      }
    }

    if (sectionId === 'section-guia') {
      const guiaNameInput = document.getElementById('guiaNameInput');
      const storedName = localStorage.getItem('JORNADA_NOME') || '';
      if (guiaNameInput && storedName) guiaNameInput.value = storedName.toUpperCase();
    }

    setTimeout(() => {
      const nextBtn = active.querySelector('[data-action="next"], [data-action="avancar"], .btn-avancar, .next-section, #avancar, #next');
      if (nextBtn) {
        nextBtn.addEventListener('click', (e) => {
          console.log('[showSection] Clique no botão avançar detectado na seção:', sectionId, 'Botão:', nextBtn.id || nextBtn.className);
          e.preventDefault();
          window.goNext();
        }, { once: true });
        console.log('[showSection] Evento de clique adicionado ao botão avançar em:', sectionId, 'Botão:', nextBtn.id || nextBtn.className);
      } else {
        console.log('[showSection] Botão avançar não encontrado na seção:', sectionId);
        console.log('[showSection] Snapshot do DOM da seção:', Array.from(active.children).slice(0, 10).map(el => ({
          tag: el.tagName.toLowerCase(),
          id: el.id || '',
          class: el.className || '',
          attrs: Object.keys(el.dataset || {}).join(','),
          text: (el.textContent || '').slice(0, 50)
        })));
        window.toast('Botão de avançar não encontrado. Tente recarregar.');
      }
    }, 500);
  };
})();
 /* ===== Termos e orientações ===== */
(function termosPager(){
  const ids = ["termos-pg1","termos-pg2","termos-pg3","termos-pg4","termos-pg5"];
  function show(id){
    ids.forEach(x=>{
      const el = document.getElementById(x);
      if(!el) return;
      el.classList.toggle('hidden', x!==id);
    });
  }
  // garante que a pg1 apareça ao entrar na seção
  document.addEventListener('DOMContentLoaded', () => {
    const termos = document.getElementById('section-termos');
    if (termos) show("termos-pg1");
  });

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-action]');
    if(!btn) return;
    const a = btn.getAttribute('data-action');
    if(!a) return;

    if(a === 'termos-next'){ e.preventDefault(); show('termos-pg2'); }
    if(a === 'termos-next2'){ e.preventDefault(); show('termos-pg3'); }
    if(a === 'termos-next3'){ e.preventDefault(); show('termos-pg4'); }
    if(a === 'termos-next4'){ e.preventDefault(); show('termos-pg5'); }
    if(a === 'next-senha'){  e.preventDefault(); window.showSection('section-senha'); }
  }, true);
})();

/* ===== Eventos Globais de Botões ===== */
(function() {
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-action="next"], [data-action="avancar"], .btn-avancar, .next-section, #avancar, #next');
    if (btn) {
      console.log('[Eventos Globais] Clique no botão avançar detectado:', btn.id || btn.className, 'Seção atual:', document.querySelector('.j-section:not(.hidden)')?.id || 'desconhecida');
      e.preventDefault();
      e.stopPropagation();
      window.goNext();
    }
  }, true);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') {
      const activeEl = document.activeElement;
      if (activeEl && activeEl.closest('[data-action="next"], [data-action="avancar"], .btn-avancar, .next-section, #avancar, #next')) {
        console.log('[Eventos Globais] Tecla Enter/Espaço no botão avançar:', activeEl.id || activeEl.className);
        e.preventDefault();
        window.goNext();
      }
    }
  });
})();

/* ===== Inicialização da Página ===== */
(function() {
  let initialized = false;
  document.addEventListener('DOMContentLoaded', () => {
    if (initialized) {
      console.log('[Inicialização] Já inicializado, pulando');
      return;
    }
    initialized = true;
    console.log('[Inicialização] Carregando section-intro');
    setTimeout(() => {
      try {
        const intro = document.getElementById('section-intro') || document.querySelector('[data-section="intro"], .section-intro');
        if (intro) {
          window.showSection('section-intro');
          console.log('[Inicialização] section-intro encontrada, chamando showSection');
        } else {
          console.error('[Inicialização] section-intro não encontrada');
          window.toast('Seção de introdução não encontrada. Tente recarregar a página.');
        }
      } catch (e) {
        console.error('[Inicialização] Erro ao inicializar página:', e);
        window.toast('Erro ao carregar a página inicial. Tente novamente.');
      }
    }, 300);
  }, { once: true });
})();
  
/* ===== Senha ===== */
(function() {
  const log = (...a) => { try { console.log('[Senha v3]', ...a); } catch (_) {} };

  function getSenhaSection() {
    return document.getElementById('section-senha') || document.querySelector('[data-section="senha"], .section-senha') || document;
  }

  function getSenhaInput() {
    const root = getSenhaSection();
    const tries = [
      '#senhaInput',
      '#iniciar',
      'input[data-role="senha"]',
      'input[name="senha"]',
      'input[name*="senha" i]',
      'input[id*="senha" i]',
      'input[type="password"]',
      'input[type="text"][name*="senha" i]',
      'input[type="text"][id*="senha" i]',
      '.senha input',
      '.senha-input'
    ];
    for (const sel of tries) {
      const el = root.querySelector(sel);
      if (el) return el;
    }
    return root.querySelector('input');
  }

  window.toggleSenha = function() {
    const input = getSenhaInput();
    if (!input) { log('[Senha] input não encontrado'); return; }
    input.type = (input.type === 'password' ? 'text' : 'password');
    const eye = getSenhaSection().querySelector('[data-role="eye"], [data-action="toggle-password"] i, [data-action="toggle-password"] svg');
    if (eye) eye.classList.toggle('on');
  };

  let lastStartJourney = 0;
  window.startJourney = async function() {
    const now = performance.now();
    if (now - lastStartJourney < 1000) {
      log('[startJourney] Debounce: evitando chamada repetida');
      return;
    }
    lastStartJourney = now;

    const inputSenha = getSenhaInput();
    const inputNome = getSenhaSection().querySelector('#nomeInput, [data-role="nome"], input[name="nome"]');
    const senha = (inputSenha && inputSenha.value || '').trim().toLowerCase();
    const nome = (inputNome && inputNome.value || '').trim();

    log('[startJourney] Senha fornecida:', senha ? '[oculta]' : 'nenhuma', 'Nome:', nome || 'nenhum');

    if (!senha) {
      window.toast('Digite a senha para continuar.');
      if (inputSenha) inputSenha.focus();
      log('[startJourney] Senha não fornecida');
      return;
    }

    if (nome) { try { localStorage.setItem('JORNADA_NOME', nome); } catch (_) {} }
    window.speak && window.speak('');

    const hasGuia = !!(document.getElementById('section-guia') || document.querySelector('[data-section="guia"], .section-guia'));
    const hasSelfie = !!(document.getElementById('section-selfie') || document.querySelector('[data-section="selfie"], .section-selfie'));

    if (hasGuia) {
      window.showSection('section-guia');
      log('[startJourney] Navegação para section-guia');
    } else if (hasSelfie) {
      window.showSection('section-selfie');
      log('[startJourney] Navegação para section-selfie');
    } else {
      window.openQuestions && window.openQuestions();
      log('[startJourney] Navegação para section-perguntas (fallback)');
    }
  };
})();

/* ===== Guia ===== */
(function() {
  const log = (...a) => { try { console.log('[GUIA v14]', ...a); } catch (_) {} };

  function secGuia() {
    return document.getElementById('section-guia') || document.querySelector('[data-section="guia"], .section-guia, .guia-container, .guia') || null;
  }

  function normGuide(s = '') {
    s = String(s).toLowerCase();
    if (s.includes('lumen')) return 'lumen';
    if (s.includes('zion')) return 'zion';
    if (s.includes('arion') || s.includes('arian')) return 'arian';
    return 'lumen';
  }

  function inferGuideFrom(el) {
    if (!el) return '';
    const attrs = [
      el.getAttribute('data-guide'),
      el.getAttribute('data-guide-id'),
      el.dataset?.guide,
      el.dataset?.value,
      el.id,
      el.getAttribute('aria-label'),
      el.getAttribute('alt'),
      el.title,
      el.textContent
    ].filter(Boolean);

    for (const v of attrs) {
      const g = normGuide(v);
      if (g) return g;
    }

    if (el.tagName === 'IMG' && el.src) {
      const src = el.src.toLowerCase();
      if (src.includes('lumen')) return 'lumen';
      if (src.includes('zion')) return 'zion';
      if (src.includes('arion') || src.includes('arian')) return 'arian';
    }

    return '';
  }

  function enhanceButtons(root) {
    if (!root || !(root instanceof Element)) {
      log('Seção de guia inválida ou não encontrada');
      return;
    }

    const candidates = root.querySelectorAll(`
      [data-action="select-guia"],
      [data-guide],
      [data-guide-id],
      .choose-guide,
      .btn-guia,
      .card-guia,
      .guia-option,
      .guia-item,
      .guide-selector,
      #btnLumen, #btnZion, #btnArion,
      img[alt*="Lumen" i], img[alt*="Zion" i], img[alt*="Arion" i],
      button[class*="guia"], a[class*="guia"],
      [class*="guide"], [id*="guide"]
    `);

    if (candidates.length === 0) {
      log('Nenhum botão de guia encontrado. Snapshot do DOM:', Array.from(root.children).slice(0, 10).map(el => ({
        tag: el.tagName.toLowerCase(),
        id: el.id || '',
        class: el.className || '',
        attrs: Object.keys(el.dataset || {}).join(','),
        text: (el.textContent || '').slice(0, 50)
      })));
    } else {
      log('Botões de guia encontrados:', candidates.length, 'em:', root.id || root.className);
    }

    candidates.forEach(el => {
      if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
      el.style.cursor = 'pointer';
      el.style.pointerEvents = 'auto';
      if (!el.getAttribute('data-guide')) {
        const g = inferGuideFrom(el);
        if (g) el.setAttribute('data-guide', g);
      }
      el.setAttribute('role', 'button');
      el.setAttribute('aria-label', `Escolher guia ${inferGuideFrom(el) || 'desconhecido'}`);
    });

    root.querySelectorAll('.click-shield, .overlay, [data-overlay], .modal-overlay, .blocker, [class*="overlay"], [class*="shield"], [class*="block"]').forEach(ov => {
      ov.style.pointerEvents = 'none';
      ov.style.display = 'none';
      log('Overlay desativado:', ov.className || ov.id);
    });
  }

  async function proceedAfterGuia(guia) {
    try {
      localStorage.setItem('JORNADA_GUIA', guia);
      const card = document.getElementById('card-guide');
      const bgImg = document.getElementById('guideBg');
      const guideNameEl = document.getElementById('guideNameSlot');
      const errorDiv = document.getElementById('selfieError');
      if (card) card.dataset.guide = guia.toUpperCase();
      if (guideNameEl) {
        const nome = localStorage.getItem('JORNADA_NOME') || '';
        guideNameEl.textContent = nome.toUpperCase() || guia.toUpperCase();
      }
      if (bgImg) {
        const src = await window.utils.preloadGuiaBg(guia);
        if (src) {
          bgImg.src = src;
          bgImg.onload = () => {
            if (errorDiv) errorDiv.style.display = 'none';
            log('Imagem do guia aplicada em #guideBg:', src, 'para guia:', guia);
          };
          bgImg.onerror = () => {
            if (errorDiv) errorDiv.style.display = 'block';
            window.toast('Erro ao carregar a imagem de fundo do guia.');
            log('Erro ao carregar imagem do guia:', src);
          };
        } else {
          if (errorDiv) errorDiv.style.display = 'block';
          window.toast('Nenhum fundo válido encontrado para guia: ' + guia);
          log('Nenhum fundo válido encontrado para guia:', guia);
        }
      }
      window.showSection('section-selfie');
      requestAnimationFrame(() => setTimeout(() => {
        const sec = document.getElementById('section-selfie') || document.querySelector('[data-section="selfie"], .section-selfie');
        if (sec && window.runTyping) {
          window.runTyping(sec);
          log('[GUIA v14] runTyping chamado para section-selfie');
        }
      }, 0));
    } catch (e) {
      console.error('[GUIA v14] Erro ao prosseguir após escolha do guia:', e);
      window.toast('Erro ao prosseguir. Tente novamente.');
    }
  }

  async function choose(el) {
    const guia = inferGuideFrom(el);
    log('Guia selecionado:', guia, 'a partir de:', el.tagName, el.id || el.className, 'texto:', (el.textContent || '').slice(0, 50));
    if (!guia) {
      console.warn('[GUIA v14] Não foi possível inferir o guia.');
      window.toast('Por favor, selecione um guia válido.');
      return;
    }

    try {
      const root = secGuia();
      if (root) {
        root.querySelectorAll('[data-action="select-guia"], [data-guide], [data-guide-id], .choose-guide, .btn-guia, .card-guia, .guia-option, .guia-item, .guide-selector, #btnLumen, #btnZion, #btnArion').forEach(n => n.classList.remove('active'));
      }
      el.classList.add('active');
      await proceedAfterGuia(guia);
    } catch (e) {
      console.error('[GUIA v14] Erro ao escolher guia:', e);
      window.toast('Erro ao selecionar o guia. Tente novamente.');
    }
  }

  function initGuia() {
    const root = secGuia();
    if (root) {
      try {
        enhanceButtons(root);
        log('Inicialização imediata de enhanceButtons');
      } catch (e) {
        console.error('[GUIA v14] Erro ao inicializar enhanceButtons:', e);
      }
    }

    const mo = new MutationObserver(() => {
      const root = secGuia();
      if (root && !root.classList.contains('hidden')) {
        log('Seção de guia detectada, aplicando enhanceButtons');
        try {
          enhanceButtons(root);
        } catch (e) {
          console.error('[GUIA v14] Erro ao aplicar enhanceButtons:', e);
        }
      }
    });
    mo.observe(document.documentElement, { subtree: true, childList: true, attributes: true, attributeFilter: ['class', 'style'] });

    document.addEventListener('click', function(ev) {
      const root = secGuia();
      if (!root || !root.contains(ev.target)) return;
      const target = ev.target;
      const el = target.closest(`
        [data-action="select-guia"],
        [data-guide],
        [data-guide-id],
        .choose-guide,
        .btn-guia,
        .card-guia,
        .guia-option,
        .guia-item,
        .guide-selector,
        #btnLumen, #btnZion, #btnArion,
        img[alt*="Lumen" i], img[alt*="Zion" i], img[alt*="Arion" i],
        button[class*="guia"], a[class*="guia"],
        [class*="guide"], [id*="guide"]
      `);
      if (!el || !root.contains(el)) {
        log('Nenhum botão de guia clicado:', target.tagName, target.className || target.id);
        return;
      }

      const g = inferGuideFrom(el);
      if (!g) {
        log('Nenhum guia inferido para elemento:', el.tagName, el.id || el.className);
        return;
      }

      ev.preventDefault();
      ev.stopPropagation();
      choose(el);
    }, true);

    document.addEventListener('keydown', function(ev) {
      if (ev.key !== 'Enter' && ev.key !== ' ') return;
      const root = secGuia();
      if (!root) return;
      const el = document.activeElement;
      if (!el || !root.contains(el)) return;

      const g = inferGuideFrom(el);
      if (!g) {
        log('Nenhum guia inferido para elemento ativo:', el.tagName, el.id || el.className);
        return;
      }

      ev.preventDefault();
      choose(el);
    }, true);

    const style = document.createElement('style');
    style.textContent = `
      [data-action="select-guia"], [data-guide], [data-guide-id], .choose-guide, .btn-guia, .card-guia, .guia-option, .guia-item, .guide-selector, #btnLumen, #btnZion, #btnArion {
        pointer-events: auto;
        cursor: pointer;
        outline: none;
      }
      [data-action="select-guia"].active, [data-guide].active, [data-guide-id].active, .choose-guide.active, .btn-guia.active, .card-guia.active, .guia-option.active, .guia-item.active, .guide-selector.active, #btnLumen.active, #btnZion.active, #btnArion.active {
        box-shadow: 0 0 0 2px rgba(255,215,0,.7);
      }
    `;
    document.head.appendChild(style);
  }

  try {
    initGuia();
  } catch (e) {
    console.error('[GUIA v14] Erro ao inicializar guia:', e);
  }

  document.addEventListener('DOMContentLoaded', () => {
    log('Inicializando guia no DOMContentLoaded');
    try {
      initGuia();
    } catch (e) {
      console.error('[GUIA v14] Erro ao inicializar guia no DOMContentLoaded:', e);
    }
  });
})();

/* ===== Selfie ===== */
(function() {
  const log = (...a) => { try { console.log('[Selfie v10]', ...a); } catch (_) {} };

  async function applySelfieBg() {
    const sec = document.getElementById('section-selfie') || document.querySelector('[data-section="selfie"], .section-selfie');
    if (!sec || sec.classList.contains('hidden')) {
      log('Seção de selfie não visível, pulando applySelfieBg');
      return;
    }

    try {
      const guia = window.utils.normGuide(localStorage.getItem('JORNADA_GUIA') || '');
      const card = document.getElementById('card-guide');
      const bgImg = document.getElementById('guideBg');
      const guideNameEl = document.getElementById('guideNameSlot');
      const errorDiv = document.getElementById('selfieError');
      if (card) card.dataset.guide = guia.toUpperCase();
      if (guideNameEl) {
        const nome = localStorage.getItem('JORNADA_NOME') || '';
        guideNameEl.textContent = nome.toUpperCase() || guia.toUpperCase();
      }
      if (bgImg) {
        const src = await window.utils.preloadGuiaBg(guia);
        if (src) {
          bgImg.src = src;
          bgImg.onload = () => {
            if (errorDiv) errorDiv.style.display = 'none';
            log('Imagem do guia aplicada em #guideBg:', src, 'para guia:', guia);
          };
          bgImg.onerror = () => {
            if (errorDiv) errorDiv.style.display = 'block';
            window.toast('Erro ao carregar a imagem de fundo do guia.');
            log('Erro ao carregar imagem do guia:', src);
          };
        } else {
          if (errorDiv) errorDiv.style.display = 'block';
          window.toast('Nenhum fundo válido encontrado para guia: ' + guia);
          log('Nenhum fundo válido encontrado para guia:', guia);
        }
      }

      if (window.runTyping) {
        window.runTyping(sec);
        log('runTyping chamado para section-selfie');
      }
      const textEls = sec.querySelectorAll('[data-typing], .text, p, h1, h2, h3, h4, [class*="text"], [class*="title"], [class*="content"]');
      if (textEls.length > 0 && window.typeWriter) {
        for (const textEl of textEls) {
          if (textEl.dataset.typed || textEl.dataset.typing === '1' || !textEl.offsetParent) continue;
          const rawText = textEl.getAttribute('data-text') || textEl.textContent || '';
          const text = window.dedupe(rawText);
          if (text) {
            await window.typeWriter(textEl, text, JORNADA.typing.charDelay, false);
            if (JORNADA.tts.enabled && JORNADA.tts.readingMode === 'after' && !window.isMuted) {
              await window.speak(text);
            }
            log('Datilografia e TTS aplicados em:', textEl.tagName, textEl.className || textEl.id, 'texto:', text.slice(0, 50));
          }
        }
      } else {
        log('Nenhum elemento de texto visível encontrado para datilografia/TTS. Snapshot do DOM:', Array.from(sec.children).slice(0, 10).map(el => ({
          tag: el.tagName.toLowerCase(),
          id: el.id || '',
          class: el.className || '',
          attrs: Object.keys(el.dataset || {}).join(',')
        })));
      }
    } catch (e) {
      console.error('[Selfie v10] Erro ao aplicar datilografia/TTS:', e);
      window.toast('Erro ao carregar texto na selfie. Tente prosseguir.');
    }
  }

  const moSelfie = new MutationObserver(() => {
    const sec = document.getElementById('section-selfie') || document.querySelector('[data-section="selfie"], .section-selfie');
    if (sec && !sec.classList.contains('hidden')) {
      log('Seção de selfie detectada, aplicando applySelfieBg');
      try {
        applySelfieBg();
      } catch (e) {
        console.error('[Selfie v10] Erro ao aplicar applySelfieBg:', e);
      }
    }
  });
  moSelfie.observe(document.documentElement, { subtree: true, childList: true, attributes: true, attributeFilter: ['class', 'style'] });

  document.addEventListener('DOMContentLoaded', () => {
    log('Inicializando applySelfieBg no DOMContentLoaded');
    try {
      applySelfieBg();
    } catch (e) {
      console.error('[Selfie v10] Erro ao inicializar applySelfieBg:', e);
    }
  });
})();

/* ===== Perguntas ===== */
(function() {
  'use strict';
  console.log('[PERGv6] Iniciando script de perguntas...');
  const log = (...a) => { try { console.log('[PERGv6]', ...a); } catch (_) {} };
  const wait = (ms) => new Promise(r => setTimeout(r, ms));

  function uniq(arr) { return Array.from(new Set(arr)); }

  function findBlocks(sec) {
    if (!sec || !(sec instanceof Element)) {
      log('Seção de perguntas inválida:', sec);
      return [];
    }
    const sel = [
      '.j-bloco', '.js-bloco', '.bloco', '.block',
      '.perguntas-bloco', '.bloco-perguntas', '.q-block', '.quest-block',
      '.lista-perguntas', '.questions', '.questions-list',
      '[data-bloco]', '[data-block]', '[data-role="bloco"]', '[role="group"]'
    ];
    let out = [];
    for (const s of sel) {
      out = out.concat(Array.from(sec.querySelectorAll(s)));
    }
    out = uniq(out).filter(el => el.offsetParent !== null || getComputedStyle(el).display !== 'none');
    if (!out.length) out = [sec];
    return out;
  }

  function looksLikeQuestion(el) {
    if (!el || !(el instanceof Element)) return false;
    if (el.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, h4, legend')) return true;
    if (el.querySelector('textarea, input, select, [contenteditable]')) return true;
    if (el.matches('[data-pergunta], [data-question]') || el.querySelector('[data-typing]')) return true;
    const cls = (el.className || '').toString().toLowerCase();
    if (/\b(perg|pergunta|question|quest|q-item)\b/.test(cls)) return true;
    return false;
  }

  function findQuestions(root) {
    if (!root || !(root instanceof Element)) {
      log('Root inválido para findQuestions:', root);
      return [];
    }
    const sel = [
      '.j-pergunta', '.pergunta', '.question', '.q-item', '.questao',
      '[data-pergunta]', '[data-question]', '[data-role="pergunta"]'
    ];
    let items = [];
    for (const s of sel) {
      items = items.concat(Array.from(root.querySelectorAll(s)));
    }
    items = uniq(items).filter(looksLikeQuestion);
    if (!items.length) {
      items = Array.from(root.children).filter(looksLikeQuestion);
    }
    return items;
  }

  async function ensureQuestionsReady(maxTries = 40) {
    const sec = document.getElementById('section-perguntas') || document.querySelector('[data-section="perguntas"], .section-perguntas');
    if (!sec || !(sec instanceof Element)) {
      log('Seção de perguntas não encontrada ou inválida');
      return false;
    }

    try {
      window.updateBlocks && window.updateBlocks();
      window.loadDynamicBlocks && window.loadDynamicBlocks();
      window.initJornada && window.initJornada();
    } catch (e) {
      log('Erro ao chamar funções de inicialização:', e);
    }

    let blocks = [], questions = [];
    for (let i = 0; i < maxTries; i++) {
      blocks = findBlocks(sec);
      if (blocks.length) {
        questions = findQuestions(blocks[0]);
      }
      if (blocks.length && questions.length) break;
      await wait(200);
    }

    log('blocos:', blocks.length, 'perguntas no 1º bloco:', questions.length);

    if (!blocks.length || !questions.length) {
      const snap = Array.from(sec.querySelectorAll('*')).slice(0, 40).map(el => ({
        tag: el.tagName.toLowerCase(),
        id: el.id || '',
        class: el.className || '',
        attrs: Object.keys(el.dataset || {}).join(',')
      }));
      console.table(snap);
      return false;
    }

    const vis = blocks[0];
    blocks.forEach((b, i) => b.style.display = (b === vis ? 'block' : 'none'));
    vis.style.display = 'block';

    const currentActive = sec.querySelector('.j-pergunta.active, .pergunta.active, .question.active, .q-item.active');
    if (currentActive) currentActive.classList.remove('active');
    const first = questions[0];
    first.classList.add('active');

    const aria = document.getElementById('aria-pergunta');
    const lbl = (first.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, h4, p') || {}).textContent || '';
    if (aria) aria.textContent = lbl;

    setTimeout(() => {
      window.runTyping && window.runTyping(vis || sec);
    }, 100); // Atraso pra garantir DOM atualizado
    return true;
  }
  window.ensureQuestionsReady = ensureQuestionsReady;

  window.openQuestions = function() {
    window.showSection('section-perguntas');
    setTimeout(() => {
      window.loadDynamicBlocks && window.loadDynamicBlocks();
      window.ensureQuestionsReady && window.ensureQuestionsReady();
    }, 100);
  };

  window.JORNADA_BLOCKS = [
    { id: "reflexoes", title: "Reflexões da Alma e da Existência", video_after: "/assets/img/filme-1-entrando-na-jornada.mp4", questions: [
      { id: "existencia_primeira_memoria", label: "Você se recorda da idade em que, pela primeira vez, percebeu que era alguém neste mundo?", type: "textarea" },
      { id: "sentido_vida", label: "Qual é o sentido da vida para você neste momento?", type: "textarea" },
      { id: "forca_interior", label: "De onde você tira forças quando tudo parece difícil?", type: "textarea" },
      { id: "legado", label: "Que marca você gostaria de deixar no mundo?", type: "textarea" }
    ]},
    { id: "raizes", title: "Raízes e Experiências de Vida", video_after: "/assets/img/filme-2-dentro-da-jornada.mp4", questions: [
      { id: "infancia", label: "Que lembrança da infância mais marcou sua vida?", type: "textarea" },
      { id: "familia", label: "Qual o papel da família na sua jornada?", type: "textarea" },
      { id: "dor", label: "Qual foi a maior dor ou perda que moldou quem você é hoje?", type: "textarea" },
      { id: "superacao", label: "Qual a maior superação da sua vida?", type: "textarea" }
    ]},
    { id: "caminho", title: "Caminho Pessoal", video_after: "/assets/img/filme-3-traumas-na-jornada.mp4", questions: [
      { id: "proposito", label: "Qual propósito guia as suas escolhas hoje?", type: "textarea" },
      { id: "talentos", label: "Quais são seus maiores talentos ou dons?", type: "textarea" },
      { id: "relacionamentos", label: "O que você mais valoriza em um relacionamento humano?", type: "textarea" },
      { id: "espiritualidade", label: "O que a espiritualidade significa para você?", type: "textarea" }
    ]},
    { id: "futuro", title: "Futuro e Inspiração", video_after: "/assets/img/filme-4-aproximando-do-final.mp4", questions: [
      { id: "sonhos", label: "Quais são seus maiores sonhos?", type: "textarea" },
      { id: "medos", label: "Que medos você gostaria de vencer?", type: "textarea" },
      { id: "mudanca", label: "Se pudesse mudar algo no mundo, o que mudaria?", type: "textarea" },
      { id: "mensagem", label: "Se pudesse deixar uma mensagem eterna, qual seria?", type: "textarea" }
    ]},
    { id: "sintese", title: "Síntese e Entrega", video_after: "/assets/img/filme-5-fim-da-jornada.mp4", questions: [
      { id: "essencia_hoje", label: "Quem é você hoje, em uma frase de verdade?", type: "textarea" },
      { id: "passo_fe", label: "Qual será seu próximo passo de fé e coragem?", type: "textarea" }
    ]}
  ];
  window.JORNADA_FINAL_VIDEO = "/assets/img/filme-5-fim-da-jornada.mp4";
  console.log('[PERGv6] JORNADA_BLOCKS definido:', window.JORNADA_BLOCKS);
})();;
  
  window.loadDynamicBlocks = function() {
    const content = document.getElementById('perguntas-container');
    if (!content) {
      log('Container de perguntas não encontrado');
      return;
    }

    const blocks = window.JORNADA_BLOCKS || [];
    content.innerHTML = '';

    blocks.forEach((block, bIdx) => {
      const bloco = document.createElement('section');
      bloco.className = 'j-bloco';
      bloco.dataset.bloco = bIdx;
      bloco.dataset.video = block.video_after || '';

      (block.questions || []).forEach((q, qIdx) => {
        const label = typeof q === 'string' ? q : (q.label || q.text || '');
        const div = document.createElement('div');
        div.className = 'j-pergunta';
        div.dataset.pergunta = qIdx;

        const enunciado = `
          <label class="pergunta-enunciado text" 
                 data-typing="true" 
                 data-text="Pergunta ${qIdx + 1}: ${label}" 
                 data-speed="36" 
                 data-cursor="true"></label>`;

        div.innerHTML = enunciado +
          `\n<textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>` +
          `<div class="accessibility-controls">` +
          `<button class="btn-mic" data-action="start-mic">🎤 Falar Resposta</button>` +
          `<button class="btn-audio" data-action="read-question">🔊 Ler Pergunta</button>` +
          `<button class="btn-avancar" data-action="avancar">Avançar</button>` +
          `</div>`;

        bloco.appendChild(div);
      });

      content.appendChild(bloco);
    });

    const firstBloco = content.querySelector('.j-bloco');
    if (firstBloco) {
      firstBloco.style.display = 'block';
      const first = firstBloco.querySelector('.j-pergunta');
      if (first) {
        first.classList.add('active');
        setTimeout(() => window.runTyping && window.runTyping(first), 100);
      }
    }

    if (typeof loadAnswers === 'function') loadAnswers();
    const firstTa = document.querySelector('.j-bloco .j-pergunta textarea');
    if (firstTa && typeof handleInput === 'function') handleInput(firstTa);
    window.initAccessibility && window.initAccessibility();
  };
})();

/* ===== Acessibilidade: Microfone e Áudio ===== */
(function() {
  let recognition = null;
  let currentLang = 'pt-BR';
  let isRecognizing = false;

  function initAccessibility() {
    if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = currentLang;
    } else {
      window.toast('Seu navegador não suporta reconhecimento de voz.');
    }

    document.addEventListener('click', (ev) => {
      if (!ev.target) return;
      const btnMic = ev.target.closest('[data-action="start-mic"]');
      const btnAudio = ev.target.closest('[data-action="read-question"]');
      if (btnMic) {
        ev.preventDefault();
        const ta = btnMic.closest('.j-pergunta')?.querySelector('textarea');
        if (ta) startRecognition(ta, btnMic);
      }
      if (btnAudio) {
        ev.preventDefault();
        const enunciado = btnAudio.closest('.j-pergunta')?.querySelector('.pergunta-enunciado');
        const text = enunciado?.textContent || '';
        window.readAloud(text);
      }
    });

    const langSelect = document.getElementById('language-select');
    if (langSelect) {
      langSelect.addEventListener('change', (ev) => {
        currentLang = ev.target.value;
        if (recognition) recognition.lang = currentLang;
        window.toast(`Idioma alterado para ${currentLang}`);
        window.updateBlocks && window.updateBlocks();
        if (!document.getElementById('section-perguntas').classList.contains('hidden')) {
          window.loadDynamicBlocks && window.loadDynamicBlocks();
        }
      });
    }

    function startRecognition(textarea, btn) {
      if (!recognition || isRecognizing) return;
      isRecognizing = true;
      btn.classList.add('recording');
      btn.textContent = ' Gravando...';

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        const prefix = textarea.value ? textarea.value + ' ' : '';
        window.typeAnswer(textarea, prefix + transcript, 36);
        if (typeof window.saveAnswers === 'function') window.saveAnswers();
        if (typeof window.updateProgress === 'function') window.updateProgress();
      };

      recognition.onend = () => {
        isRecognizing = false;
        btn.classList.remove('recording');
        btn.textContent = ' 🖋️ Falar Resposta';
      };

      recognition.onerror = (event) => {
        window.toast('Erro no reconhecimento: ' + event.error);
        try { recognition.stop(); } catch {}
        isRecognizing = false;
        btn.classList.remove('recording');
        btn.textContent = ' 🖋️ Falar Resposta';
      };

      recognition.start();
    }

    window.initAccessibility = initAccessibility;
  }
})();
  
/* Autobind do mic nas perguntas — 1 função, idempotente */
(function(){
  function autobindMic(scope){
    try{
      if(!window.JORNADA_MICRO || !window.JORNADA_MICRO.attachAll) return;
      const sec = document.getElementById('section-perguntas') || document;
      window.JORNADA_MICRO.attachAll(sec, { mode:'append' }); // liga/religa sem duplicar
    }catch(e){ console.error('[MIC] autobind erro:', e); }
  }

  // executa já
  if (document.readyState !== 'loading') autobindMic();
  else document.addEventListener('DOMContentLoaded', () => autobindMic());

  // religa ao trocar de idioma
  document.getElementById('language-select')?.addEventListener('change', () => autobindMic());

  // religa quando aparecer perguntas / avançar de pergunta / criar novos blocos
  const target = document.getElementById('section-perguntas') || document.body;
  const mo = new MutationObserver(() => autobindMic());
  mo.observe(target, { childList:true, subtree:true, attributes:true, attributeFilter:['class'] });

  // religa em cliques de avanço/prev
  document.addEventListener('click', (e)=>{
    if (e.target.closest('[data-action="next"],[data-action="avancar"],.btn-avancar,#btnNextPerguntas')) {
      setTimeout(() => autobindMic(), 0);
    }
  }, true);

  // expõe se quiser chamar manualmente
  window.autobindMic = autobindMic;
})();

/* Patch: JORNADA_MICRO.attachAll — idempotente, sem duplicar */
(function (g) {
  if (!g.JORNADA_MICRO) return;
  if (g.JORNADA_MICRO.attachAll) return; // já existe

  g.JORNADA_MICRO.attachAll = function (scope = document, opts = {}) {
    const root = (typeof scope === 'string') ? document.querySelector(scope) : (scope || document);
    if (!root) return 0;

    const areas = Array.from(root.querySelectorAll('textarea'));
    let count = 0;
    for (const ta of areas) {
      if (ta.dataset.micBound === '1') continue;        // evita duplicar
      const ctrl = g.JORNADA_MICRO.attach(ta, opts);    // usa attach existente
      ta.dataset.micBound = '1';
      ta._micCtrl = ctrl;                               // guarda se quiser start/stop
      count++;
    }
    try { console.log('[MIC] attachAll ligados:', count); } catch {}
    return count;
  };
})(window);


/* ===== Inicialização da Página ===== */
(function() {
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[Inicialização] Carregando section-intro');
    try {
      const intro = document.getElementById('section-intro') || document.querySelector('[data-section="intro"], .section-intro');
      if (intro) {
        window.showSection('section-intro');
        console.log('[Inicialização] section-intro encontrada, chamando showSection');
      } else {
        console.error('[Inicialização] section-intro não encontrada');
        window.toast('Seção de introdução não encontrada. Tente recarregar a página.');
      }

      // Adiciona evento ao botão de avançar
      const nextBtn = document.querySelector('[data-action="next"], [data-action="avancar"]');
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          console.log('[Inicialização] Botão avançar clicado');
          window.goNext();
        });
      } else {
        console.log('[Inicialização] Botão avançar não encontrado');
      }
    } catch (e) {
      console.error('[Inicialização] Erro ao inicializar página:', e);
      window.toast('Erro ao carregar a página inicial.');
    }
  });
})();
</script>

<script defer src="/config.js?v=5"></script>
<script defer src="/jornada-utils.js?v=5"></script>

<script defer src="/jornada-core.js?v=5"></script>
<script defer src="/jornada-auth.js?v=5"></script>
<script defer src="/jornada-chama.js?v=5"></script>
<script defer src="/jornada-paper-qa.js?v=5"></script>
<script defer src="/jornada-typing.js?v=5"></script>
<script defer src="/assets/js/jornada-typing-bridge.js?v=1"></script>        
<script defer src="/jornada-controller.js?v=5"></script>
<script defer src="/jornada-render.js?v=5"></script>
<script defer src="/jornada-bootstrap.js?v=5"></script>
<script defer src="/jornada-micro.js?v=5"></script>
<script defer src="/i18n/i18n.js?v=5"></script>
<script defer src="/api.js?v=5"></script>
        
<!-- Micro-boot (SAFE): escolhe API_BASE com fallback e inicia a jornada -->
<script>
(function () {
  console.log("[BOOT] Iniciando micro-boot…");

  // 1) Sondagem de módulos (só loga, não trava)
  const must = ["CONFIG","JUtils","JCore","JAuth","JChama","JPaperQA","JTyping","JController","JRender","JBootstrap","JMicro","I18N","API"];
  const missing = must.filter(k => !(k in window));
  if (missing.length) console.warn("[BOOT] Módulos ausentes:", missing);

  // 2) Definição segura de API_BASE
  const PRIMARY_DEFAULT  = (window.APP_CONFIG && window.APP_CONFIG.API_BASE) || "https://conhecimento-com-luz-api.onrender.com";
  const API              = window.API || {};                  // pode não existir ainda
  const API_PRIMARY      = API.API_PRIMARY   || PRIMARY_DEFAULT;
  const API_FALLBACK     = API.API_FALLBACK  || API_PRIMARY;  // se não houver, usa o primary mesmo

  async function chooseBase() {
    // Se API.health existir, testa; senão, usa o primary
    if (typeof API.health === "function") {
      try {
        const ok = await API.health();              // ideal: { ok: true }
        window.API_BASE = ok ? API_PRIMARY : API_FALLBACK;
      } catch {
        console.warn("[BOOT] Health falhou, usando FALLBACK");
        window.API_BASE = API_FALLBACK;
      }
    } else {
      window.API_BASE = API_PRIMARY;
    }
    console.log("[BOOT] API_BASE =", window.API_BASE);
  }

  // 3) Start da jornada com tolerância a erros/ordem
  chooseBase().finally(async () => {
    try {
      if (window.JBootstrap && typeof JBootstrap.start === "function") {
        await JBootstrap.start();
      }
    } catch (e) {
      console.error("[BOOT] Erro em JBootstrap.start:", e);
    }
    try {
      if (window.JController && typeof JController.init === "function") {
        await JController.init();
      }
    } catch (e) {
      console.error("[BOOT] Erro em JController.init:", e);
    }
    console.log("[BOOT] Jornada iniciada 🚀");
  });
})();
</script>
</body>
</html>








