<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="preload" href="/assets/fonts/ManufacturingConsent-Regular.ttf" as="font" type="font/ttf" crossorigin />
  <link rel="preload" href="/assets/fonts/BerkshireSwash-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "BerkshireSwash";
      src: url("/assets/fonts/BerkshireSwash-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Cardo";
      src: url("/assets/fonts/Cardo-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root { --bg: #1a1a1a; --ink: #000; --ink-soft: #555; --panel: #1a1a1a }

    html, body { height: 100%; box-sizing: border-box }
    body {
      margin: 0; color: #fff; background: var(--bg);
      font-family: "BerkshireSwash", cursive;
      font-size: 22px; line-height: 1.6; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .container { max-width: 960px; margin: 24px auto; padding: 0 16px }
    .card { background: var(--panel) !important; border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.12); padding: 28px; position: relative; z-index: 5 }

    /* Header + chama */
    .site-header { display: flex; align-items: center; justify-content: center; padding: 16px; background: transparent }
    .chama-icone { position: relative; width: 18px; height: 36px; display: flex; align-items: flex-end; margin-right: 12px }
    .chama-icone > * { position: static }
    .site-header h1 { font-family: "ManufacturingConsent"; font-size: 36px; color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); margin: 0 }

    /* Chama */
    .chama-vela { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98; position: relative; width: var(--largura); height: var(--altura); display: inline-block; filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.75)) }
    .chama-vela.chama-md { --largura: 40px; --altura: 90px }
    .chama-vela.chama-lg { --largura: 30px; --altura: 60px }
    .chama-vela .brasa { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.4); height: 10px; border-radius: 50% 50% 40% 40%; background: radial-gradient(circle at 50% 40%, hsla(var(--hue),var(--satur),95%,.95) 0%, hsla(var(--hue),var(--satur),70%,.85) 50%, transparent 80%); filter: blur(1px); animation: brasaPulse var(--pulso) ease-in-out infinite; opacity: var(--op) }
    .chama-vela .lingua { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.0); height: calc(var(--altura)*1.0); border-radius: 50% 50% 4% 4%; background: radial-gradient(ellipse at center, rgba(255,190,0,.95) 0%, rgba(255,69,0,.75) 50%, rgba(230,10,10,.3) 70%, transparent 100%); mix-blend-mode: screen; filter: blur(.7px); transform-origin: 50% 100%; animation: velaWaver 1.2s ease-in-out infinite; opacity: var(--op); -webkit-mask: radial-gradient(60% 90% at 50% 4%, #000 65%, transparent 69%) }
    .chama-vela .lingua:nth-child(2) { width: calc(var(--largura)*.92); height: calc(var(--altura)*.95); animation-duration: 1.5s; animation-delay: .08s; filter: blur(.6px) }
    .chama-vela .lingua:nth-child(3) { width: calc(var(--largura)*.78); height: calc(var(--altura)*.85); animation-duration: 1.8s; animation-delay: .15s; filter: blur(.5px) }
    .chama-vela .brilho { position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: calc(var(--largura)*1.7); height: calc(var(--altura)*1.5); background: radial-gradient(circle, hsla(var(--hue),var(--satur),72%,.55) 0%, transparent 70%); filter: blur(9px); mix-blend-mode: screen; animation: aura var(--pulso) ease-in-out infinite; opacity: .85; pointer-events: none }
    .chama-vela.fraca { --altura: 35px; --largura: 25px; --pulso: 1.6s; --glow: 5px; --hue: 36; --satur: 86%; --light: 66%; --op: .70 }
    .chama-vela.media { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98 }
    .chama-vela.forte { --altura: 55px; --largura: 35px; --pulso: .7s; --glow: 11px; --hue: 20; --satur: 100%; --light: 52%; --op: 1 }
    .flame-corner { position: fixed; z-index: 1200; pointer-events: none }
    .flame-bottom-right { bottom: 20px; right: 20px }
    #chama-header .chama-vela { --largura: 30px; --altura: 60px }
    @keyframes velaWaver { 0%, 100% { transform: translateX(-50%) scaleY(1.00) skewX(0deg) } 25% { transform: translateX(calc(-50% + .7px)) scaleY(1.12) skewX(1.4deg) } 50% { transform: translateX(-50%) scaleY(1.20) skewX(2.2deg) } 75% { transform: translateX(calc(-50% - .6px)) scaleY(1.10) skewX(1.2deg) } }
    @keyframes brasaPulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: .85 } 50% { transform: translateX(-50%) scale(1.14); opacity: 1 } }
    @keyframes aura { 0%, 100% { opacity: .75 } 50% { opacity: 1 } }
    @media (prefers-reduced-motion: reduce) { .chama-vela .lingua, .chama-vela .brasa, .chama-vela .brilho { animation: none !important } }

    /* Selfie */
    .selfie-row { display: grid; grid-template-columns: 1fr 1.3fr; gap: 16px; align-items: start }
    .selfie-left .selfie-controls { display: flex; flex-direction: column; gap: 10px; margin: 12px 0 }
    .selfie-left label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .selfie-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px }
    .muted { color: var(--ink-soft); font-size: 18px; font-family: "BerkshireSwash", cursive }
    .selfie-right { position: relative }
    .guide-card {
      position: relative; width: min(720px, 92vw); aspect-ratio: 2/3;
      margin: 24px auto; border-radius: 16px; overflow: hidden;
      background: #0f3b2f; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .guide-bg {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
    }
    .flame-layer {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      opacity: 0; transition: opacity 900ms ease-in-out;
      pointer-events: none;
    }
    .flame-svg {
      width: 48%; height: 72%;
      transform: translateY(30%);
      filter: drop-shadow(0 8px 28px rgba(255,180,0,.45));
    }
    .client-name {
      position: absolute; bottom: 3.5%; left: 0; right: 0; text-align: center;
      font-family: "Cardo", serif; font-weight: 700; letter-spacing: .06em;
      font-size: clamp(48px, 8vw, 80px); color: #f7d37a; text-shadow: 0 2px 8px rgba(0,0,0,.4);
    }
    .controls {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;
      padding: .5rem .75rem; border-radius: 12px; background: rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    .controls input, .controls button {
      font: 500 16px/1.2 system-ui, sans-serif; padding: .55rem .7rem; border-radius: 10px; border: 0;
    }
    .controls button { cursor: pointer; }
    #selfieError { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 20px; text-align: center; padding: 10px; background: #000; border-radius: 8px; display: none; font-family: "BerkshireSwash", cursive }
    @media (max-width: 860px) {
      .selfie-row { grid-template-columns: 1fr }
      .selfie-right { max-width: 100%; margin-top: 16px }
      .guide-card { max-width: 100% }
      .flame-svg { width: 60%; height: 60% }
      .client-name { font-size: clamp(36px, 6vw, 60px) }
    }
    /* === SELFIE DENTRO DA CHAMA (MÁSCARA) === */
    .flame-frame {
      position: relative;
      width: min(720px, 92vw);
      aspect-ratio: 3/4;
      margin: 24px auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .flame-mask {
      position: absolute;
      width: 48%;
      height: 72%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -20%);
      pointer-events: none;
      -webkit-mask-image: url('/assets/img/chama-mask.png');
      mask-image: url('/assets/img/chama-mask.png');
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      overflow: hidden;
    }
    .flame-mask img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transform: translateZ(0);
    }
    /* Esconder SVG para não duplicar */
    .flame-svg { display: none; }

    /* Escolha do guia */
    .guia-container { margin-top: 20px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #000; color: #fff; text-align: center }
    .guia-container p { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .guia-options { display: flex; gap: 10px; justify-content: center; margin-top: 12px }
    .guia-options button { padding: 8px 16px; font-size: 20px }
    .guia-name-input { margin: 12px 0 }
    .guia-name-input label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .guia-name-input input { padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; text-transform: uppercase }

    /* Chat */
    .grok-chat-container { display: none; background: #000; color: #fff; padding: 16px; border-radius: 8px }
    .grok-chat-message.grok { background: transparent; text-align: left; font-size: 20px; white-space: pre-wrap; position: relative; color: #fff; font-family: "Cardo", serif }
    .grok-chat-message.grok::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .grok-chat-message.grok.typing-done::after { content: ""; animation: none }
    .grok-chat-input { display: none }
    .devolutiva-text { margin-top: 16px; font-family: "Cardo", serif; font-size: 20px; color: #fff }

    /* Pergaminho */
    .pergaminho-v { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h { background: var(--panel) url('/assets/img/pergaminho-rasgado-horiz.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h.fallback { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important }
    .conteudo-pergaminho { background: transparent !important; position: relative; z-index: 10; padding: 20px; min-height: 100%; overflow: visible; color: #fff; box-sizing: border-box; max-width: 100% }
    .conteudo-pergaminho h2, .conteudo-pergaminho h3, .conteudo-pergaminho .pergunta-enunciado { color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); font-size: 28px; font-family: "ManufacturingConsent" }
    .conteudo-pergaminho p, .conteudo-pergaminho small, .conteudo-pergaminho li { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .conteudo-pergaminho p[data-typing], .conteudo-pergaminho small[data-typing], .conteudo-pergaminho li[data-typing] { white-space: pre-wrap; position: relative }
    .conteudo-pergaminho p[data-typing]::after, .conteudo-pergaminho small[data-typing]::after, .conteudo-pergaminho li[data-typing]::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .conteudo-pergaminho p[data-typing].typing-done::after, .conteudo-pergaminho small[data-typing].typing-done::after, .conteudo-pergaminho li[data-typing].typing-done::after { content: ""; animation: none }
    @media (max-width: 600px) {
      .conteudo-pergaminho { padding: 16px }
      .conteudo-pergaminho h2, .conteudo-pergaminho h3 { font-size: 24px }
      .conteudo-pergaminho p, .conteudo-pergaminho li, .conteudo-pergaminho small { font-size: 18px; line-height: 1.5; color: #fff }
      .conteudo-pergaminho ul { padding-left: 20px }
    }

    /* UI */
    .btn {
      display: inline-block;
      padding: 14px 24px;
      border-radius: 10px;
      border: 0;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease;
      font-family: "BerkshireSwash", cursive;
      font-size: 20px;
      line-height: 1.15;
      background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      border: 3px solid #4a4a4a;
      border-radius: 12px 8px 15px 10px;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      transform: translateY(-2px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 8px 16px rgba(0,0,0,0.7);
    }
    .btn+.btn { margin-left: 10px }
    .btn:disabled { background: #6b7280; cursor: not-allowed; transform: none }

    /* Progresso */
    .progress-container { margin: 16px 0; text-align: center }
    .progress-badge { padding: 8px 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; color: #fff; border-radius: 8px; font-size: 20px; border: 3px solid #4a4a4a; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 12px }
    .progress-bar-fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress { margin: 8px 0 16px }
    .j-progress__bar { width: 100%; height: 6px; background: #e5e7eb; border-radius: 4px }
    .j-progress__fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress__meta { text-align: center; margin-top: 8px; font-size: 20px; color: var(--ink-soft); font-family: "BerkshireSwash", cursive }

    .footer-actions { display: flex; gap: 12px; justify-content: center; margin: 32px 0 }

    /* Datilografia */
    .lumen-typing { white-space: pre-wrap; position: relative }
    .lumen-typing::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .lumen-typing.typing-done::after { content: ""; animation: none }
    @keyframes lumenBlink { 50% { opacity: 0 } }

    /* Seções */
    .j-section { height: 100% }
    .j-bloco { background: transparent !important; display: none; z-index: 5 }
    .j-pergunta { margin-bottom: 24px; display: none; z-index: 6; position: relative }
    .j-pergunta.active { display: block }
    .pergunta-enunciado { display: block; margin-bottom: 6px; font-family: "ManufacturingConsent"; font-size: 28px; color: #fff }
    .j-pergunta textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #000; color: #fff; resize: vertical; min-height: 100px; font-family: "Cardo", serif; font-size: 20px; line-height: 1.45 }

    /* Acessibilidade: Microfone e Áudio */
    .accessibility-controls { display: flex; gap: 10px; margin-top: 8px }
    .btn-mic, .btn-audio, .btn-clear { padding: 8px 16px; font-size: 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border: 3px solid #4a4a4a; border-radius: 8px; cursor: pointer; color: #fff; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .btn-mic:hover, .btn-audio:hover, .btn-clear:hover { background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-mic.recording { background: linear-gradient(to bottom, #ff6666, #cc3333), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-audio.muted { background: linear-gradient(to bottom, #6b7280, #5a6268), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }

    /* Seletor de Idioma */
    .language-selector { position: absolute; top: 10px; right: 10px; z-index: 100 }
    .language-selector select { padding: 8px; font-size: 18px; border-radius: 8px; background: #000; color: #fff; font-family: "BerkshireSwash", cursive }

    /* Vídeo overlay */
    #videoOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; display: flex; justify-content: center; align-items: center; z-index: 2000 }
    #videoOverlay.hidden { display: none }
    .video-player { width: 100vw; height: 100vh; object-fit: contain; background: #000; transform: rotate(0deg) }
    @media (orientation: portrait) {
      .video-player { width: 100vw; height: 100%; max-height: 100vh; object-fit: contain }
    }
    .video-fallback { width: 100vw; height: 100vh; background: url('/assets/img/perfil-da-irmandade.png') no-repeat center/cover; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; text-align: center; padding: 20px; font-family: "BerkshireSwash", cursive }

    .site-footer { text-align: center; padding: 14px; color: var(--ink-soft); font-size: 20px; font-family: "BerkshireSwash", cursive }
    .password-form { margin-top: 16px; text-align: center }
    .password-input { position: relative }
    .password-input input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; background: #000; color: #fff }
    .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #fff }

    .section-container { position: relative; min-height: 85vh }
    .hidden { display: none !important }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0 }

    /* Toast */
    #toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.35); font-size: 18px; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity .25s ease; font-family: "BerkshireSwash", cursive }
    #toast.show { opacity: 1 }

    /* Highlight para efeito de leitura */
    [data-typing] { position: relative; }
    .highlight { position: absolute; background-color: rgba(255, 255, 0, 0.3); height: 1.2em; top: 0; left: 0; transition: width 0.1s; pointer-events: none; width: 0; }
  </style>
</head>
<body data-layout="master" data-journey="essencial">
    <div class="language-selector">
    <select id="language-select">
      <option value="pt-BR">Português (BR)</option>
      <option value="en-US">English (US)</option>
      <option value="es-ES">Español (ES)</option>
    </select>
  </div>

  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="chama-vela chama-lg">
        <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
      </div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <div id="aria-pergunta" class="sr-only" aria-live="polite"></div>

                <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions"><button class="btn" data-action="next-termos">Avançar</button></div>
        </div>
        <div id="section-termos" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Jornada Conhecimento com Luz - Essencial</h2>
            <div id="termos-pg1">
              <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, leia os termos abaixo." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="AVISO IMPORTANTE – LEIA ANTES DE INICIAR" data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Esta é uma jornada pessoal, simbólica e inspiradora. Para proteger sua privacidade e garantir uma experiência ética, leia com atenção:" data-speed="50" data-cursor="true"></p>
              <ul>
                <li data-typing data-text="Suas respostas não serão armazenadas após o término." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Ao final, será gerado um PDF exclusivo com suas respostas e a devolutiva simbólica do Lumen." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="O PDF não é enviado por e-mail. Faça o download imediatamente após a geração." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Após a entrega do PDF, todos os dados são apagados automaticamente e sem possibilidade de recuperação." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg2" class="hidden">
              <ul>
                <li data-typing data-text="Acesso por senha individual, com prazos:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="15 dias para iniciar a jornada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="24 horas para concluir, a partir do primeiro acesso." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next2">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg3" class="hidden">
              <h3 style="margin-top:0;">Termo de Responsabilidade e Consentimento Consciente</h3>
              <ul>
                <li data-typing data-text="Responsabilidade Pessoal: As respostas fornecidas refletem sua visão de mundo, sentimentos e experiências pessoais." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Caráter Não Terapêutico: Esta jornada não substitui acompanhamento psicológico, psiquiátrico, médico ou terapêutico. Não há diagnóstico, prescrição ou orientação clínica." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Neutralidade Religiosa: Respeitamos todas as crenças e tradições. O convite é para um diálogo interior conforme sua própria fé e consciência." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next3">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg4" class="hidden">
              <ul>
                <li data-typing data-text="Autonomia do Participante:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="Você decide quando iniciar (dentro do prazo de 15 dias)." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="Após usar a senha, há até 24 horas corridas para concluir." data-speed="50" data-cursor="true"></li>
                </ul>
                <li data-typing data-text="Conduta Respeitosa com a IA Guia:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="Os Guias são IA com percepção humanizada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="Mantenha linguagem cordial; evite ofensas e xingamentos." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="A forma de se comunicar com os Guias reflete o respeito por si mesmo(a)." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next4">Próxima página</button>
              </div>
            </div>
            <div id="termos-pg5" class="hidden">
              <ul>
                <li data-typing data-text="Privacidade e Segurança: Os dados transitam apenas para gerar o PDF final. Não há criação de conta nem envio de e-mails. Após o encerramento, os dados locais do navegador podem ser removidos por você a qualquer momento." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Concordância: Ao prosseguir, você declara estar ciente e de acordo com todas as condições descritas." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="next-senha">Aceito e quero continuar</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-senha" class="j-section hidden">
          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'ManufacturingConsent';font-size:28px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">👁️</span>
            </div>
            <div style="margin-top:12px"><button class="btn" data-action="start">Ativar e Iniciar</button></div>
          </div>
        </div>

                <div id="section-guia" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Escolha seu Guia</h2>
            <div class="guia-container">
              <p data-typing data-text="Zion (Grok): Curioso e direto, busca respostas profundas com visão cósmica." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Lumen (ChatGPT): Acolhedor e reflexivo, guia com empatia e clareza." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Arian (Gemini): Criativo e versátil, inspira com perspectivas inovadoras." data-speed="50" data-cursor="true"></p>
              <div class="guia-name-input">
                <label for="guiaNameInput">Seu Nome</label>
                <input id="guiaNameInput" type="text" placeholder="Digite seu nome para a jornada...">
              </div>
              <div class="guia-options">
                <button class="btn" data-action="select-guia" data-guia="zion">Escolher Zion</button>
                <button class="btn" data-action="select-guia" data-guia="lumen">Escolher Lumen</button>
                <button class="btn" data-action="select-guia" data-guia="arian">Escolher Arian</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-selfie" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Entre na Irmandade</h2>
            <p data-typing data-text="Faça uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia." data-speed="50" data-cursor="true"></p>
            <div class="selfie-row">
              <div class="selfie-left">
                <label class="btn" for="selfieInput">📸 Tirar Foto</label>
                <input id="selfieInput" type="file" accept="image/*" capture="user" style="display:none" />
                <div class="selfie-controls">
                  <label>Zoom <input id="selfieScale" type="range" min="0.8" max="2.5" step="0.01" value="1"></label>
                  <label>Horizontal <input id="selfieOffsetX" type="range" min="-50" max="50" step="1" value="0"></label>
                  <label>Vertical <input id="selfieOffsetY" type="range" min="-50" max="50" step="1" value="0"></label>
                  <small class="muted" data-typing data-text="Dica: alinhe seu rosto na chama ao lado do guia." data-speed="50" data-cursor="true"></small>
                </div>
                <div class="selfie-actions">
                  <button id="previewBtn" class="btn">✨ Ver Prévia</button>
                  <button id="captureBtn" class="btn">⬇️ Confirmar e Baixar</button>
                  <button id="btnSkipSelfie" class="btn" data-action="skip-selfie">Pular Foto/Iniciar</button>
                </div>
              </div>
              <div class="selfie-right">
                <section id="card-guide" class="guide-card" data-guide="ZION" aria-label="Guia">
                  <img class="guide-bg" id="guideBg" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
                  <div class="flame-layer" aria-hidden="true">
                    <svg class="flame-svg" viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <clipPath id="flameClip">
                          <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" />
                        </clipPath>
                        <radialGradient id="flameGlow" cx="50%" cy="70%" r="55%">
                          <stop offset="0%" stop-color="rgba(255, 224, 130, 1)"/>
                          <stop offset="55%" stop-color="rgba(255, 180, 0, 0.9)"/>
                          <stop offset="100%" stop-color="rgba(255, 180, 0, 0)"/>
                        </radialGradient>
                      </defs>
                      <image id="selfieImage" href="" x="15" y="35" width="70" height="90" clip-path="url(#flameClip)" preserveAspectRatio="xMidYMid slice" />
                      <ellipse cx="50" cy="95" rx="28" ry="40" fill="url(#flameGlow)"></ellipse>
                      <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" fill="none" stroke="rgba(255,200,0,.85)" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="client-name" id="clientNameSlot"></div>
                </section>
                <div id="selfieError" class="selfie-error">Erro ao carregar a pré-visualização. Tente novamente ou pule.</div>
                <small class="muted" data-typing data-text="Pré-visualização" data-speed="50" data-cursor="true"></small>
            </div>
          </div>
        </div>

                <div id="section-perguntas" class="j-section hidden">
          <div class="progress-container">
            <div class="progress-badge" id="jprog-pct">0% concluído</div>
            <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
            <div class="j-progress"><div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div><div class="j-progress__meta" id="j-meta"></div></div>
          </div>

          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="chama-vela chama-md"><div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div></div>
          </div>

          <div id="perguntas-container"></div>

                    <div id="grok-chat" class="grok-chat-container">
            <div id="grok-chat-messages"></div>
            <div class="grok-chat-input">
              <input id="grok-chat-input" type="text" placeholder="Fale com seu guia..." />
              <button class="btn" data-action="send-chat">Enviar</button>
            </div>
          </div>

          <div class="footer-actions">
            <button id="btnSpeakAnswer" class="btn btn-mic" data-action="start-mic">🎤 Falar Resposta</button>
            <button id="btnClearAnswer" class="btn btn-clear" data-action="clear-answer">🗑️ Apagar Resposta</button>
            <button id="btnNextPerguntas" class="btn" data-action="next">➡️ Avançar</button>
            <button id="btnMute" class="btn btn-audio" data-action="mute">🔇 Silenciar</button>
          </div>
        </div>
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
         <div class="selfie-final" style="text-align:center; margin-top:20px;">
  <div class="flame-frame" id="selfieResult">
    <img id="resultBackground" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
    <div class="flame-mask">
      <img id="selfieInFlame" alt="Selfie na chama">
    </div>
    <div class="client-name" id="clientNameSlotFinal"></div>
  </div>
</div>

          <p style="margin-top:12px;"><small data-typing data-text="Sua imagem foi unida à Irmandade." data-speed="50" data-cursor="true"></small></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button class="btn" data-action="download-selfie">Baixar Imagem</button>
            <button id="btnRestart" class="btn" data-action="restart">Voltar ao Portal</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:20px;"></div>
  </footer>

    <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">Áudio da jornada em reprodução. Converta para H.264 MP4.</div>
    <button id="skipVideo" class="btn" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

    <div id="flame-bottom-right" class="flame-corner flame-bottom-right">
    <div class="chama-vela chama-md">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
  </div>

    <div id="toast" role="status" aria-live="polite" class="hidden"></div>
  

<!-- ==== QFX: Estilos Globais (remove cursor piscando do typewriter) ==== -->
<style id="qfx-style">
  .typewriter::after { display: none !important; content: ''; }
</style>

<script id="qfx-script">
/* SAFE SENTINEL */;void 0;
;(function(){
  'use strict';

  /* ===== util: toast + erro global (leve) ===== */
  function toast(msg){ try{
    const t=document.getElementById('toast'); if(!t) return;
    t.textContent=msg; t.classList.remove('hidden'); t.classList.add('show');
    setTimeout(()=>{ t.classList.remove('show'); },3000);
  }catch(_){} }
  window.addEventListener('error', (e)=>{
    console.error('[Erro global]', e?.error||e);
    toast('Ops… algo falhou, mas já seguimos em frente.');
  });

  /* ===== env tag (opcional) ===== */
  const env=document.getElementById('envTag');
  if(env){ env.textContent=`layout=${document.body.dataset.layout||'master'} · journey=${document.body.dataset.journey||'essencial'} · path=/assets`; }

  /* ===== dedupe ===== */
  function dedupe(s=''){
    if(!s) return '';
    let result=s.normalize('NFC').trim();
    result=result.replace(/\s+/g,' ').replace(/([^a-zA-Z0-9])\1+/g,'$1');
    const words=result.split(' ');
    const out=[];
    for(let w of words){
      let c=''; for(let i=0;i<w.length;i++){
        if(i===0 || w[i]!==w[i-1] || !/[a-zA-Z]/.test(w[i])) c+=w[i];
      }
      out.push(c);
    }
    return out.join(' ').trim();
  }
  window.dedupe = dedupe;

  /* ===== Config global Jornada ===== */
  window.JORNADA = window.JORNADA || {};
  JORNADA.fullTypingMode = (JORNADA.fullTypingMode !== false);   // ligado por padrão
  JORNADA.typing = Object.assign({ charDelay: 18, caret: false }, (JORNADA.typing||{}));
  JORNADA.tts = Object.assign({ enabled:true, lang:'pt-BR', rate:1.06, pitch:1.0, voiceName:'', readingMode:'after' }, (JORNADA.tts||{}));

  /* ===== TTS utils ===== */
  let currentLang = 'pt-BR';
  window.isMuted = !!window.isMuted;

  function isSpeechAvailable(){
    return 'speechSynthesis' in window && typeof window.SpeechSynthesisUtterance !== 'undefined';
  }
  function cancelSpeech(){
    try { window.speechSynthesis && window.speechSynthesis.cancel(); } catch(e){}
  }
  async function speak(text){
    if (!JORNADA.tts.enabled || window.isMuted) return;
    if (!isSpeechAvailable()) return;

    // garantir vozes carregadas (sem travar)
    await new Promise(r=>{
      const v = speechSynthesis.getVoices();
      if (v && v.length) return r();
      speechSynthesis.onvoiceschanged = ()=>r();
      setTimeout(()=>r(), 300);
    });

    const u = new SpeechSynthesisUtterance(text || '');
    u.lang  = JORNADA.tts.lang || currentLang;
    u.rate  = +JORNADA.tts.rate || 1.0;
    u.pitch = +JORNADA.tts.pitch || 1.0;
    if (JORNADA.tts.voiceName){
      const v = speechSynthesis.getVoices().find(v=>v.name === JORNADA.tts.voiceName);
      if (v) u.voice = v;
    }
    return new Promise(res=>{
      u.onend = ()=>res();
      u.onerror = ()=>res(); // não travar o fluxo
      try { speechSynthesis.speak(u); } catch(e){ res(); }
    });
  }

  // compatível com trechos antigos que chamam readAloud
  function readAloud(text, voiceGender){
    if(window.isMuted || !isSpeechAvailable()) return Promise.resolve();
    const genderName = (voiceGender==='male'?'Male':'Female');
    return new Promise(resolve=>{
      try{
        speechSynthesis.cancel();
        const u=new SpeechSynthesisUtterance(text||'');
        u.lang=currentLang;
        const voices=speechSynthesis.getVoices();
        let v=voices.find(v=>v.lang===currentLang && v.name.includes(genderName))
             || voices.find(v=>v.lang===currentLang) || voices[0];
        if(v) u.voice=v;
        u.onend=resolve; u.onerror=resolve;
        speechSynthesis.speak(u);
      }catch(_){ resolve(); }
    });
  }
  window.readAloud = readAloud;

  /* ===== helpers de navegação ===== */
  function lockNext(){
    const btn = document.querySelector('[data-action="next"], [data-action="avancar"]');
    if (btn){ btn.disabled = true; btn.setAttribute('aria-busy','true'); }
  }
  function unlockNext(){
    const btn = document.querySelector('[data-action="next"], [data-action="avancar"]');
    if (btn){ btn.disabled = false; btn.removeAttribute('aria-busy'); }
  }

  /* ===== stubs seguros (se não existirem versões completas) ===== */
  function updateCanvasBackground(sectionId){
    const canvas=document.getElementById('jornada-canvas');
    if(!canvas) return;
    if(sectionId==='section-perguntas'){
      canvas.className='card pergaminho pergaminho-h';
      canvas.style.background='var(--panel) url(/assets/img/pergaminho-rasgado-horiz.png) no-repeat center/cover';
    } else {
      canvas.className='card pergaminho pergaminho-v';
      canvas.style.background='var(--panel) url(/assets/img/pergaminho-rasgado-vert.png) no-repeat center/cover';
    }
  }
  function ensureHeroFlame(){/* noop */}     // se você já tem versões reais, mantém
  function ensureHeaderFlame(){/* noop */}
  function ensurePageFlames(){/* noop */}

  /* ===== datilografia ===== */
  const G = (typeof window!=='undefined'? window : globalThis);
  if (G.__typingLock == null) G.__typingLock = false;
  if (G.__DEFAULT_SPEED_TYPING == null) G.__DEFAULT_SPEED_TYPING = 80; // ajuste global
  const DEFAULT_SPEED = G.__DEFAULT_SPEED_TYPING;

  function typeTextFallback(el, fullText, charDelay){
    if (!el) return Promise.resolve();
    el.textContent = '';
    const txt = (fullText || '');
    let i = 0;
    return new Promise(resolve=>{
      (function tick(){
        if (i >= txt.length) return resolve();
        el.textContent += txt.charAt(i++);
        setTimeout(tick, Math.max(0, charDelay|0));
      })();
    });
  }

  JORNADA.tts = Object.assign({ enabled:true, lang:'pt-BR', rate:1.06, pitch:1.0, voiceName:'', readingMode:'after' }, (JORNADA.tts||{}));
  window.typeWriter = typeWriter;

  /* ===== ALL-IN: pergunta com datilografia + TTS ===== */
  function ensureQuestionTextEl(target){
    // alvo já é elemento?
    if (target && target.nodeType === 1) {
      target.setAttribute('aria-live','polite');
      return target;
    }
    // seletor?
    if (typeof target === 'string') {
      const found = document.querySelector(target);
      if (found){ found.setAttribute('aria-live','polite'); return found; }
    }
    // fallback: cria dentro de um host razoável
    const host = document.getElementById('question-text-host')
              || document.querySelector('.js-question-host')
              || document.querySelector('[data-question-host]')
              || document.getElementById('pergunta')
              || document.querySelector('.pergunta')
              || document.body;
    let el = host.querySelector('[data-role="question-text"]');
    if (!el){
      el = document.createElement('div');
      el.setAttribute('data-role','question-text');
      el.setAttribute('aria-live','polite');
      el.className = 'js-question-text';
      host.appendChild(el);
    } else {
      el.setAttribute('aria-live','polite');
    }
    return el;
  }

  async function typeAndReadQuestion(pergunta, elOrSelector) {
  const el = ensureQuestionTextEl(elOrSelector);

  if (!JORNADA.fullTypingMode) {
    el.textContent = (pergunta || '');
    unlockNext();
    if (JORNADA.tts.enabled && JORNADA.tts.readingMode === 'after' && !window.isMuted) {
      await speak(pergunta || '');
    }
    return;
  }

  lockNext();
  cancelSpeech();

  try {
    await window.typeWriter(el, pergunta || '', JORNADA.typing.charDelay, false);
    if (JORNADA.tts.enabled && JORNADA.tts.readingMode === 'after' && !window.isMuted) {
      await speak(pergunta || '');
    }
  } catch (e) {
    console.error('[typeAndReadQuestion] Erro:', e);
    el.textContent = pergunta || '';
  } finally {
    unlockNext();
  }
}
window.typeAndReadQuestion = typeAndReadQuestion;
/* HOTFIX: define window.typeWriter se estiver faltando (sem TTS no loop) */
(function(){
  'use strict';
  if (typeof window.typeWriter === 'function') return;

  const DEFAULT_SPEED = (window.__DEFAULT_SPEED_TYPING || 80);

 (function(){
  'use strict';

  // Ajuste da função typeWriter para datilografia fluida
  window.typeWriter = function(el, text, speed, showCursor) {
    if (!el || el.dataset.typing === '1' || el.dataset.typed === '1') return Promise.resolve();

    el.dataset.typing = '1';
    el.textContent = '';
    const highlight = el.querySelector('.highlight') || document.createElement('div');
    if (!highlight.parentNode) {
      highlight.className = 'highlight';
      el.prepend(highlight);
    }

    text = (text || '').replace(/[{}[\]]/g, '').trim();
    let i = 0;
    const DEFAULT_SPEED = window.__DEFAULT_SPEED_TYPING || 80;

    return new Promise(resolve => {
      function step() {
        if (!el.isConnected || el.offsetParent === null || el.closest('.j-section.hidden')) {
          el.classList.remove('lumen-typing');
          const h = el.querySelector('.highlight');
          if (h) h.style.width = '0';
          el.dataset.typed = '0';
          el.dataset.typing = '0';
          return resolve();
        }

        if (i < text.length) {
          const char = text.charAt(i++);
          el.textContent += char;

          try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.font = getComputedStyle(el).font;
            highlight.style.width = `${ctx.measureText(el.textContent).width}px`;
          } catch (_) {}

          // Ritmo constante, sem pausas extras para pontuação ou espaços
          setTimeout(step, speed || DEFAULT_SPEED);
        } else {
          el.classList.add('typing-done');
          el.classList.remove('lumen-typing');
          const h = el.querySelector('.highlight');
          if (h) h.style.width = '0';
          el.dataset.typed = '1';
          el.dataset.typing = '0';
          resolve();
        }
      }

      if (showCursor) el.classList.add('lumen-typing');
      setTimeout(step, 0);
    });
  };

  // Alias para compatibilidade
  if (typeof window.typewriter !== 'function') window.typewriter = window.typeWriter;
})();

(function(){
  'use strict';
  const q = (s, r = document) => r.querySelector(s);
  const qa = (s, r = document) => Array.from(r.querySelectorAll(s));
  const wait = (ms) => new Promise(r => setTimeout(r, ms));
  const log = (...a) => { try { console.log('[PERGv5]', ...a); } catch (_) {} };

  function uniq(arr) { return Array.from(new Set(arr)); }

  function findBlocks(sec) {
    const sel = [
      '.j-bloco', '.js-bloco', '.bloco', '.block',
      '.perguntas-bloco', '.bloco-perguntas', '.q-block', '.quest-block',
      '.lista-perguntas', '.questions', '.questions-list',
      '[data-bloco]', '[data-block]', '[data-role="bloco"]', '[role="group"]'
    ];
    let out = [];
    for (const s of sel) { out = out.concat(qa(s, sec)); }
    out = uniq(out).filter(el => el.offsetParent !== null || getComputedStyle(el).display !== 'none');
    if (!out.length) out = [sec]; // Usa a seção como bloco se não houver blocos
    return out;
  }

  function looksLikeQuestion(el) {
    if (el.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, h4, legend')) return true;
    if (el.querySelector('textarea, input, select, [contenteditable]')) return true;
    if (el.matches('[data-pergunta], [data-question]') || el.querySelector('[data-typing]')) return true;
    const cls = (el.className || '').toString().toLowerCase();
    if (/\b(perg|pergunta|question|quest|q-item)\b/.test(cls)) return true;
    return false;
  }

  function findQuestions(root) {
    const sel = [
      '.j-pergunta', '.pergunta', '.question', '.q-item', '.questao',
      '[data-pergunta]', '[data-question]', '[data-role="pergunta"]'
    ];
    let items = [];
    for (const s of sel) { items = items.concat(qa(s, root)); }
    items = uniq(items).filter(looksLikeQuestion);
    if (!items.length) {
      items = qa(':scope > *', root).filter(looksLikeQuestion);
    }
    return items;
  }

  async function ensureQuestionsReady(maxTries = 40) {
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if (!sec) { log('seção não encontrada'); return false; }

    try { typeof window.updateBlocks === 'function' && window.updateBlocks(); } catch (_) {}
    try { typeof window.loadDynamicBlocks === 'function' && window.loadDynamicBlocks(); } catch (_) {}
    try { typeof window.initJornada === 'function' && window.initJornada(); } catch (_) {}

    let blocks = [], questions = [];
    for (let i = 0; i < maxTries; i++) {
      blocks = findBlocks(sec);
      questions = findQuestions(blocks[0] || sec);
      if (blocks.length && questions.length) break;
      await wait(200);
    }

    log('blocos:', blocks.length, 'perguntas no 1º bloco:', questions.length);

    if (!blocks.length || !questions.length) {
      const snap = qa('#section-perguntas *').slice(0, 40).map(el => ({
        tag: el.tagName.toLowerCase(),
        id: el.id || '',
        cls: el.className || '',
        data: Object.keys(el.dataset || {}).join(',')
      }));
      console.table(snap);
      return false;
    }

    // Garante visibilidade do primeiro bloco
    const vis = blocks[0];
    blocks.forEach((b, i) => { b.style.display = (b === vis ? 'block' : 'none'); });
    vis.style.display = 'block';

    // Garante ativação da primeira pergunta
    const currentActive = sec.querySelector('.j-pergunta.active, .pergunta.active, .question.active, .q-item.active');
    if (currentActive) currentActive.classList.remove('active');
    const first = questions[0];
    first.classList.add('active');

    // Atualiza ARIA
    const aria = q('#aria-pergunta');
    const lbl = (first.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, h4, p') || {}).textContent || '';
    if (aria) aria.textContent = lbl;

    // Roda datilografia no bloco visível
    if (typeof window.runTyping === 'function') {
      window.runTyping(vis || sec);
    } else {
      // Fallback: aplica datilografia diretamente na primeira pergunta
      const textEl = first.querySelector('[data-typing], .pergunta-enunciado, .question-title');
      if (textEl && typeof window.typeWriter === 'function') {
        window.typeWriter(textEl, textEl.textContent || textEl.getAttribute('data-text') || '', JORNADA.typing.charDelay, false);
      }
    }

    return true;
  }

  window.ensureQuestionsReady = ensureQuestionsReady;

  // Reforça openQuestions
  const prevOpen = window.openQuestions;
  window.openQuestions = function() {
    if (typeof window.showSection === 'function') window.showSection('section-perguntas');
    else {
      document.querySelectorAll('.j-section').forEach(s => s.classList.add('hidden'));
      (q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas'))?.classList.remove('hidden');
    }
    requestAnimationFrame(() => setTimeout(() => { ensureQuestionsReady(); }, 0));
    if (typeof prevOpen === 'function') { try { prevOpen(); } catch (_) {} }
  };

  // Observa quando a seção de perguntas fica visível
  const mo = new MutationObserver(() => {
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if (sec && !sec.classList.contains('hidden')) ensureQuestionsReady();
  });
  mo.observe(document.documentElement, { subtree: true, childList: true, attributes: true, attributeFilter: ['class', 'style'] });
})();
  
  <!-- === HOTFIX 2: wrapper com TTS natural (lê só no final) === -->
(function(){
  'use strict';
  window.JORNADA = window.JORNADA || {};
  JORNADA.typing = Object.assign({ charDelay: 18 }, (JORNADA.typing||{}));
  JORNADA.tts    = Object.assign({ enabled:true, lang:'pt-BR', rate:1.06, pitch:1.0, voiceName:'', readingMode:'after' }, (JORNADA.tts||{}));

  if (typeof window.speak !== 'function') {
    window.speak = function(){ return Promise.resolve(); }; // fallback
  }

  window.typeAndReadQuestion = async function(text, el){
    if (!el) return;
    try {
      await window.typeWriter(el, text||'', JORNADA.typing.charDelay, false);
    } catch(_){
      el.textContent = text||'';
    }
    if (JORNADA.tts.enabled && JORNADA.tts.readingMode==='after' && !window.isMuted){
      await window.speak(text||'');
    }
  };
})();

  window.typeAndReadQuestion = typeAndReadQuestion;

  /* ===== runTyping ===== */
  async function runTyping(root){
    if(!root || root.classList.contains('hidden')) return;
    if(G.__typingLock) return;
    G.__typingLock = true;

    try {
      if(window.speechSynthesis) window.speechSynthesis.cancel();

      const elements = Array
        .from(root.querySelectorAll('[data-typing]'))
        .filter(el => !el.dataset.typed && el.offsetParent !== null);

      for(const el of elements){
        if(el.dataset.typing==='1' || el.dataset.typed==='1') continue;

        const rawText = el.getAttribute('data-text') || el.textContent || '';
        const text = dedupe(rawText);

        el.textContent='';
        const highlight=el.querySelector('.highlight');
        if(highlight) highlight.style.width='0';

        const speed = parseInt(el.getAttribute('data-speed') || DEFAULT_SPEED, 10);
        const showCursor = String(el.getAttribute('data-cursor') || 'true')==='true';

        await typeWriter(el, text, speed, showCursor);
      }
    } catch(e) {
      console.error('[runTyping] erro:', e);
      toast('Erro durante a datilografia.');
    } finally {
      G.__typingLock = false;
    }
  }
  window.runTyping = runTyping;

  /* ===== showSection ===== */
  function showSection(sectionId){
    console.log('[showSection] Exibindo seção:', sectionId);
    if(window.speechSynthesis) window.speechSynthesis.cancel();

    // esconde e reseta tudo
    document.querySelectorAll('.j-section').forEach(s => {
      s.classList.add('hidden');

      s.querySelectorAll('[data-typing]').forEach(el => {
        el.classList.remove('lumen-typing', 'typing-done');
        el.dataset.typing = '0';
        delete el.dataset.typed;

        const keepText = el.getAttribute('data-text') || el.textContent || '';
        el.textContent = '';
        const h = el.querySelector('.highlight'); if (h) h.style.width = '0';
        if (!el.hasAttribute('data-text') && keepText) el.setAttribute('data-text', keepText);
      });
    });

    const active=document.getElementById(sectionId);
    if(!active){
      console.error('[showSection] Seção não encontrada:', sectionId);
      toast('Erro ao carregar a seção. Tente novamente.');
      return;
    }

    active.classList.remove('hidden');
    console.log('[showSection] Seção ativa:', active.id);

    // defer: roda só depois do paint
    requestAnimationFrame(()=>{ setTimeout(()=>{ runTyping(active); }, 0); });

    updateCanvasBackground(sectionId);
    ensureHeroFlame(sectionId);

    if(sectionId==='section-perguntas'){
      const perguntas=document.querySelectorAll('.j-pergunta');
      if(perguntas.length){
        const first=document.querySelector('.j-pergunta.active') || perguntas[0];
        first.classList.add('active');
        const lbl=first.querySelector('.pergunta-enunciado')?.textContent || '';
        const ta=first.querySelector('textarea');
        if(ta) ta.placeholder='Digite sua resposta...';
        const aria=document.getElementById('aria-pergunta');
        if(aria) aria.textContent=lbl;
      } else if(typeof window.loadDynamicBlocks==='function'){
        window.loadDynamicBlocks();
      }
    }

    if(sectionId==='section-final'){
      const url=localStorage.getItem('IRMANDADE_SELFIE_FINAL');
      if(url){
        const img=document.querySelector('#selfieInFlame'); if(img) img.src=url;
        const name=document.querySelector('#clientNameSlotFinal');
        if(name) name.textContent=(localStorage.getItem('JORNADA_NOME')||'').toUpperCase();
      }
    }

    if(sectionId==='section-guia'){
      const guiaNameInput=document.getElementById('guiaNameInput');
      const storedName=localStorage.getItem('JORNADA_NOME')||'';
      if(guiaNameInput && storedName) guiaNameInput.value=storedName.toUpperCase();
    }

    if(sectionId==='section-termos'){
      const pg1=document.getElementById('termos-pg1');
      if(pg1 && !pg1.classList.contains('hidden')) runTyping(pg1);
    }
  }
  window.showSection = showSection;

  /* ===== Avançar ===== */
  (function(){
    let __isTransitioning = false;

    function ensureFirstQuestion() {
      const sec = document.getElementById('section-perguntas');
      if (!sec) return false;

      // garante um bloco visível
      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = Array.from(sec.querySelectorAll('.j-bloco'));
      if (!vis && blocks.length) {
        blocks.forEach((b, i) => b.style.display = i === 0 ? 'block' : 'none');
        vis = blocks[0];
      }

      // ativa a primeira pergunta, se nenhuma ativa
      const activeQ = sec.querySelector('.j-pergunta.active');
      if (!activeQ && vis) {
        const first = vis.querySelector('.j-pergunta');
        if (first) {
          first.classList.add('active');
          const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
          const aria = document.getElementById('aria-pergunta'); if (aria) aria.textContent = lbl;
          runTyping(vis);
          return true;
        }
      }
      return !!activeQ;
    }

    function goNext() {
      if (__isTransitioning) return;
      __isTransitioning = true;

      try {
        const sec = document.getElementById('section-perguntas');

        // se não estamos em perguntas, abre perguntas e prepara primeira
        if (!sec || sec.classList.contains('hidden')) {
          if (sec) {
            showSection('section-perguntas');
            requestAnimationFrame(() => setTimeout(() => { ensureFirstQuestion(); }, 0));
          }
          return;
        }

        if (!ensureFirstQuestion()) return;

        // bloco e perguntas correntes
        const bloco = sec.querySelector('.j-bloco[style*="display: block"]') || sec.querySelector('.j-bloco');
        const perguntas = bloco ? Array.from(bloco.querySelectorAll('.j-pergunta')) : [];
        const current = bloco ? bloco.querySelector('.j-pergunta.active') : null;

        if (!bloco || perguntas.length === 0) return;

        if (!current) {
          perguntas[0].classList.add('active');
          runTyping(bloco);
          return;
        }

        const i = perguntas.indexOf(current);
        current.classList.remove('active');

        // próxima pergunta no mesmo bloco
        if (i >= 0 && i + 1 < perguntas.length) {
          const prox = perguntas[i + 1];
          prox.classList.add('active');
          const lbl = prox.querySelector('.pergunta-enunciado')?.textContent || '';
          const aria = document.getElementById('aria-pergunta'); if (aria) aria.textContent = lbl;
          runTyping(prox);
          return;
        }

        // próximo bloco
        const allBlocks = Array.from(sec.querySelectorAll('.j-bloco'));
        const idx = allBlocks.indexOf(bloco);
        if (idx >= 0 && idx + 1 < allBlocks.length) {
          allBlocks.forEach(b => b.style.display = 'none');
          const nextBlock = allBlocks[idx + 1];
          nextBlock.style.display = 'block';
          const first = nextBlock.querySelector('.j-pergunta');
          if (first) {
            first.classList.add('active');
            const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
            const aria = document.getElementById('aria-pergunta'); if (aria) aria.textContent = lbl;
            runTyping(nextBlock);
          }
          return;
        }

        // acabou tudo
        showSection('section-final');
      } finally {
        setTimeout(() => { __isTransitioning = false; }, 150);
      }
    }
    window.goNext = goNext;

    // Delegação de clique (corrigida)
    document.addEventListener('click', function (ev) {
      // avançar perguntas
      var btnNext = ev.target.closest ? ev.target.closest('[data-action="next"]') : null;
      if (btnNext) {
        ev.preventDefault();
        goNext();
        return;
      }

      // ir para Termos
      var btnToTermos = ev.target.closest ? ev.target.closest('[data-action="next-termos"]') : null;
      if (btnToTermos) {
        ev.preventDefault();
        showSection('section-termos');
        return;
      }

      // aceitar termos → ir para Senha
      var acceptSel = '[data-action="next-senha"],[data-action="accept"],[data-action="accept-terms"],[data-action="termos-aceito"],[data-action="aceito"]';
      var btnAccept = ev.target.closest ? ev.target.closest(acceptSel) : null;
      if (btnAccept) {
        ev.preventDefault();
        showSection('section-senha');
        requestAnimationFrame(function () {
          setTimeout(function () {
            var sec = document.getElementById('section-senha');
            if (sec) runTyping(sec);
          }, 0);
        });
        return;
      }

      // termos páginas internas (pg1→pg2→...→pg5)
      var termosSel = '[data-action="termos-next"],[data-action="termos-next2"],[data-action="termos-next3"],[data-action="termos-next4"]';
      var btnTermosNext = ev.target.closest ? ev.target.closest(termosSel) : null;
      if (btnTermosNext) {
        ev.preventDefault();
        var pages = ['termos-pg1','termos-pg2','termos-pg3','termos-pg4','termos-pg5'];
        var visId = null;
        for (var i = 0; i < pages.length; i++) {
          var el = document.getElementById(pages[i]);
          if (el && !el.classList.contains('hidden')) { visId = pages[i]; break; }
        }
        var idx = pages.indexOf(visId);
        if (idx >= 0 && idx + 1 < pages.length) {
          var cur = document.getElementById(pages[idx]);
          var nxt = document.getElementById(pages[idx + 1]);
          if (cur) cur.classList.add('hidden');
          if (nxt) { nxt.classList.remove('hidden'); runTyping(nxt); }
        }
        return;
      }
   
/* === SCRIPT 1: SENHA (toggle + validação + ir para perguntas) === */
(function(){
  'use strict';

  // util local
  function q(sel, root=document){ return root.querySelector(sel); }
  function qa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  function toast(msg){ try{
    const t=document.getElementById('toast'); if(!t) return;
    t.textContent=msg; t.classList.remove('hidden'); t.classList.add('show');
    setTimeout(()=>{ t.classList.remove('show'); },3000);
  }catch(_){} }

  // ===== Toggle de visibilidade da senha =====
  window.toggleSenha = function toggleSenha(){
    const input = q('#senhaInput, [data-role="senha"], input[type="password"]#senha');
    if(!input) { console.warn('[Senha] input não encontrado'); return; }
    input.type = (input.type === 'password' ? 'text' : 'password');
    const eye = q('[data-role="eye"], [data-action="toggle-password"] i, [data-action="toggle-password"] svg');
    if(eye){ eye.classList.toggle('on'); }
  };

  // ===== Validação e início da jornada =====
  window.startJourney = async function startJourney(){
    // 1) coleta senha e nome (se existir campo)
    const inputSenha = q('#senhaInput, [data-role="senha"], input[type="password"]#senha');
    const inputNome  = q('#nomeInput, [data-role="nome"], input[name="nome"]');
    const senha = (inputSenha && inputSenha.value || '').trim();
    const nome  = (inputNome && inputNome.value || '').trim();

    // 2) regra simples de validação (NÃO trava; aceita qualquer não-vazia)
    if(!senha){
      toast('Digite a senha para continuar.');
      if(inputSenha) inputSenha.focus();
      return;
    }

    // (Opcional) Se você tiver uma senha fixa via data-attr no body:
    // const target = document.body.getAttribute('data-pass') || '';
    // if(target && senha !== target){ toast('Senha inválida.'); return; }

    // 3) guarda nome (se houver)
    if(nome){ try { localStorage.setItem('JORNADA_NOME', nome); } catch(_){} }

    // 4) vai para PERGUNTAS
    try {
      if(window.speechSynthesis) speechSynthesis.cancel();
    } catch(_){}
    if (typeof window.showSection === 'function') {
      showSection('section-perguntas');
    } else {
      // fallback: mostra direto a seção se existir
      const secPerg = q('#section-perguntas');
      const secs = qa('.j-section');
      secs.forEach(s=>s.classList.add('hidden'));
      if(secPerg){ secPerg.classList.remove('hidden'); }
    }

    // 5) garante primeira pergunta visível e rola datilografia
    requestAnimationFrame(()=>setTimeout(()=>{
      const sec = q('#section-perguntas');
      if(!sec) return;

      // garante um bloco visível
      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = qa('.j-bloco', sec);
      if(!vis && blocks.length){
        blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none');
        vis = blocks[0];
      }

      // ativa primeira pergunta
      const active = sec.querySelector('.j-pergunta.active');
      if(!active && vis){
        const first = vis.querySelector('.j-pergunta');
        if(first){
          first.classList.add('active');
          const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
          const aria = q('#aria-pergunta'); if(aria) aria.textContent = lbl;
        }
      }

      // roda datilografia no bloco visível
      if (typeof window.runTyping === 'function') {
        runTyping(vis || sec);
      }
    }, 0));
  };

  // ===== Integra com a tela de senha ao abrir
  document.addEventListener('DOMContentLoaded', function(){
    const secSenha = q('#section-senha');
    if(secSenha && !secSenha.classList.contains('hidden')){
      if (typeof window.runTyping === 'function') runTyping(secSenha);
    }
  });
})();
    
/* === PATCH: captura robusta da senha e início da jornada === */
(function(){
  'use strict';

  function q(sel, root=document){ return root.querySelector(sel); }
  function qa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
  function toast(msg){ try{
    const t=document.getElementById('toast'); if(!t) return;
    t.textContent=msg; t.classList.remove('hidden'); t.classList.add('show');
    setTimeout(()=>{ t.classList.remove('show'); },3000);
  }catch(_){} }

  // acha o container da tela de senha
  function getSenhaSection(){
    return q('#section-senha') || q('[data-section="senha"]') || q('.section-senha') || document;
  }

  // acha o input de senha (varia conforme HTML)
  function getSenhaInput(){
    const root = getSenhaSection();

    // tente os seletores mais prováveis
    const tries = [
      '#senhaInput',
      'input[data-role="senha"]',
      'input[name="senha"]',
      'input[name*="senha" i]',
      'input[id*="senha" i]',
      'input[type="password"]',
      // as vezes é type="text" mas é o campo de senha visual
      'input[type="text"][name*="senha" i]',
      'input[type="text"][id*="senha" i]',
      '.senha input',
      '.senha-input',
    ];

    for (const sel of tries){
      const el = q(sel, root);
      if (el) return el;
    }
    // fallback: primeiro input visível dentro da seção
    const any = qa('input', root).find(el => el.offsetParent !== null);
    return any || null;
  }

  // alternar visibilidade (olhinho)
  window.toggleSenha = function toggleSenha(){
    const input = getSenhaInput();
    if(!input) { console.warn('[Senha] input não encontrado'); return; }
    input.type = (input.type === 'password' ? 'text' : 'password');
    const eye = q('[data-role="eye"], [data-action="toggle-password"] i, [data-action="toggle-password"] svg', getSenhaSection());
    if(eye){ eye.classList.toggle('on'); }
  };

  // valida e entra nas perguntas
  window.startJourney = async function startJourney(){
    const inputSenha = getSenhaInput();
    const inputNome  = q('#nomeInput, [data-role="nome"], input[name="nome"]', getSenhaSection());

    const senha = (inputSenha && inputSenha.value || '').trim();
    const nome  = (inputNome && inputNome.value || '').trim();

    if(!senha){
      toast('Digite a senha para continuar.');
      if(inputSenha) inputSenha.focus();
      return;
    }

    // se quiser restringir a valores específicos, descomente:
    // const validas = new Set(['jornada2025','iniciar']);
    // if (!validas.has(senha.toLowerCase())) { toast('Senha inválida.'); return; }

    if(nome){ try { localStorage.setItem('JORNADA_NOME', nome); } catch(_){} }

    try { if(window.speechSynthesis) speechSynthesis.cancel(); } catch(_){}

    if (typeof window.showSection === 'function') {
      showSection('section-perguntas');
    } else {
      const secs = qa('.j-section');
      const secPerg = q('#section-perguntas');
      secs.forEach(s=>s.classList.add('hidden'));
      if(secPerg){ secPerg.classList.remove('hidden'); }
    }

    // garante primeiro bloco/pergunta e datilografia
    requestAnimationFrame(()=>setTimeout(()=>{
      const sec = q('#section-perguntas');
      if(!sec) return;

      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = qa('.j-bloco', sec);
      if(!vis && blocks.length){
        blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none');
        vis = blocks[0];
      }

      const active = sec.querySelector('.j-pergunta.active');
      if(!active && vis){
        const first = vis.querySelector('.j-pergunta');
        if(first){
          first.classList.add('active');
          const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
          const aria = q('#aria-pergunta'); if(aria) aria.textContent = lbl;
        }
      }

      if (typeof window.runTyping === 'function') runTyping(vis || sec);
    }, 0));
  };

  // Enter no campo de senha dispara startJourney
  document.addEventListener('keydown', function(ev){
    const input = getSenhaInput();
    if (!input) return;
    if (ev.key === 'Enter' && document.activeElement === input){
      ev.preventDefault();
      if (typeof window.startJourney === 'function') startJourney();
    }
  }, true);

  // Garante o botão "Ativar e Iniciar" se não tiver data-action="start"
  document.addEventListener('click', function(ev){
    const root = getSenhaSection();
    // se o seu botão já tem [data-action="start"], o listener global existente cuida.
    // aqui criamos um fallback: qualquer botão dentro da seção com data-role="start" ou .btn-start
    const btnFallback = ev.target.closest('[data-role="start"], .btn-start');
    if (btnFallback && root.contains(btnFallback)){
      ev.preventDefault();
      if (typeof window.startJourney === 'function') startJourney();
    }
  }, true);

  // Ao abrir a seção senha, inicia datilografia se houver
  document.addEventListener('DOMContentLoaded', function(){
    const secSenha = getSenhaSection();
    if(secSenha && !secSenha.classList.contains('hidden')){
      if (typeof window.runTyping === 'function') runTyping(secSenha);
    }
  });
})();
    
/* === SCRIPT 2: Roteador de Fluxo + Abertura das Perguntas === */
(function(){
  'use strict';

  function q(sel, root=document){ return root.querySelector(sel); }
  function qa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }

  // Abre perguntas garantindo bloco/pergunta ativa + datilografia
  function openQuestions(){
    if (typeof window.showSection === 'function') {
      showSection('section-perguntas');
    } else {
      const secs = qa('.j-section');
      const secPerg = q('#section-perguntas');
      secs.forEach(s=>s.classList.add('hidden'));
      if(secPerg){ secPerg.classList.remove('hidden'); }
    }

    // garante bloco e pergunta
    requestAnimationFrame(()=>setTimeout(()=>{
      const sec = q('#section-perguntas');
      if(!sec) return;

      // torna um bloco visível
      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = qa('.j-bloco', sec);
      if(!vis && blocks.length){
        blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none');
        vis = blocks[0];
      }

      // ativa primeira pergunta
      const active = sec.querySelector('.j-pergunta.active');
      if(!active && vis){
        const first = vis.querySelector('.j-pergunta');
        if(first){
          first.classList.add('active');
          const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
          const aria = q('#aria-pergunta'); if(aria) aria.textContent = lbl;
        }
      }

      if (typeof window.runTyping === 'function') runTyping(vis || sec);
    }, 0));
  }
  window.openQuestions = openQuestions;

  // Decide próximo passo após “senha”
  function nextAfterSenha(){
    // ordem de preferência: GUIA → SELFIE → PERGUNTAS
    const hasGuia   = !!q('#section-guia, [data-section="guia"], .section-guia');
    const hasSelfie = !!q('#section-selfie, [data-section="selfie"], .section-selfie');

    if (hasGuia) {
      if (typeof window.showSection === 'function') showSection('section-guia');
      else {
        const secs = qa('.j-section');
        secs.forEach(s=>s.classList.add('hidden'));
        (q('#section-guia')||q('[data-section="guia"]')||q('.section-guia'))?.classList.remove('hidden');
      }
      // roda datilografia nessa tela
      requestAnimationFrame(()=>setTimeout(()=>{
        const sec = q('#section-guia') || q('[data-section="guia"]') || q('.section-guia');
        if (sec && typeof window.runTyping === 'function') runTyping(sec);
      },0));
      return;
    }

    if (hasSelfie) {
      if (typeof window.showSection === 'function') showSection('section-selfie');
      else {
        const secs = qa('.j-section');
        secs.forEach(s=>s.classList.add('hidden'));
        (q('#section-selfie')||q('[data-section="selfie"]')||q('.section-selfie'))?.classList.remove('hidden');
      }
      requestAnimationFrame(()=>setTimeout(()=>{
        const sec = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
        if (sec && typeof window.runTyping === 'function') runTyping(sec);
      },0));
      return;
    }

    // fallback: vai direto pras perguntas
    openQuestions();
  }

  // Intercepta o startJourney para usar o roteador acima
  const _startJourney = window.startJourney;
  window.startJourney = async function patchedStartJourney(){
    try {
      if (typeof _startJourney === 'function') {
        // roda a validação original (captura senha/nome etc.), mas NÃO navega para perguntas
        await _startJourney();
      }
    } catch(_) { /* não trava */ }

    // Após a validação, forçamos a navegação correta:
    nextAfterSenha();
  };

  /* ==== Ações na tela de GUIA e SELFIE ==== */

  // 1) Escolha do guia (qualquer elemento com data-action="choose-guide" e data-guide="lumen|zion|arian")
  document.addEventListener('click', function(ev){
    const el = ev.target.closest && ev.target.closest('[data-action="choose-guide"]');
    if (!el) return;

    ev.preventDefault();
    const guia = el.getAttribute('data-guide') || 'lumen';
    try { localStorage.setItem('JORNADA_GUIA', guia); } catch(_){}
    // depois de escolher o guia, se existir tela de selfie, vai pra ela; senão, perguntas
    const hasSelfie = !!q('#section-selfie, [data-section="selfie"], .section-selfie');
    if (hasSelfie){
      if (typeof window.showSection === 'function') showSection('section-selfie');
      else {
        const secs = qa('.j-section'); secs.forEach(s=>s.classList.add('hidden'));
        (q('#section-selfie')||q('[data-section="selfie"]')||q('.section-selfie'))?.classList.remove('hidden');
      }
      requestAnimationFrame(()=>setTimeout(()=>{
        const sec = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
        if (sec && typeof window.runTyping === 'function') runTyping(sec);
      },0));
    } else {
      openQuestions();
    }
  }, true);

  // 2) Botão “Continuar” na selfie (data-action="selfie-next")
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('[data-action="selfie-next"]');
    if (!btn) return;
    ev.preventDefault();
    openQuestions();
  }, true);

})();

/* === SCRIPT GUIA: fluxo + botões robustos === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  // Mostrar seção com fallback se showSection não existir
  function show(id){
    if (typeof window.showSection==='function') return showSection(id);
    const secs=qa('.j-section'); secs.forEach(s=>s.classList.add('hidden'));
    const tgt = q('#'+id) || q(`[data-section="${id.replace('section-','')}"]`) || q(`.${id}`);
    if (tgt) tgt.classList.remove('hidden');
  }
  function has(id){
    return !!( q('#'+id) || q(`[data-section="${id.replace('section-','')}"]`) || q(`.${id}`) );
  }

  // ---------- OVERRIDE: startJourney só valida e ROTEIA (não pula direto p/ perguntas)
  window.startJourney = async function startJourney(){
    const root = q('#section-senha') || document;
    const inputSenha = root.querySelector(
      '#senhaInput, input[data-role="senha"], input[name="senha"], input[name*="senha" i], input[id*="senha" i], input[type="password"], input[type="text"][name*="senha" i], input[type="text"][id*="senha" i]'
    ) || root.querySelector('input');

    const inputNome  = root.querySelector('#nomeInput, [data-role="nome"], input[name="nome"]');
    const senha = (inputSenha && inputSenha.value || '').trim();
    const nome  = (inputNome && inputNome.value || '').trim();

    if(!senha){
      try{
        const t=document.getElementById('toast');
        if(t){ t.textContent='Digite a senha para continuar.'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
      }catch(_){}
      if(inputSenha) inputSenha.focus();
      return;
    }

    if(nome){ try{ localStorage.setItem('JORNADA_NOME', nome); }catch(_){} }

    // Fluxo: GUIA -> SELFIE -> PERGUNTAS
    if (has('section-guia')) {
      show('section-guia');
      requestAnimationFrame(()=>setTimeout(()=>{ if (typeof window.runTyping==='function') runTyping(q('#section-guia')); },0));
      return;
    }
    if (has('section-selfie')) {
      show('section-selfie');
      requestAnimationFrame(()=>setTimeout(()=>{ if (typeof window.runTyping==='function') runTyping(q('#section-selfie')); },0));
      return;
    }
    // fallback
    openQuestions();
  };

  // ---------- Abrir perguntas garantindo bloco/pergunta ativa
  function openQuestions(){
    if (typeof window.showSection==='function') showSection('section-perguntas'); else show('section-perguntas');

    requestAnimationFrame(()=>setTimeout(()=>{
      const sec = q('#section-perguntas'); if(!sec) return;
      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = qa('.j-bloco', sec);
      if(!vis && blocks.length){
        blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none');
        vis = blocks[0];
      }
      const active = sec.querySelector('.j-pergunta.active');
      if(!active && vis){
        const first = vis.querySelector('.j-pergunta');
        if(first){
          first.classList.add('active');
          const aria = q('#aria-pergunta'); 
          const lbl  = first.querySelector('.pergunta-enunciado')?.textContent || '';
          if(aria) aria.textContent = lbl;
        }
      }
      if (typeof window.runTyping==='function') runTyping(vis || sec);
    },0));
  }
  window.openQuestions = openQuestions;

  // ---------- Normalização de nomes do guia
  function normGuide(s=''){
    s = String(s).toLowerCase();
    if (s.includes('lumen')) return 'lumen';
    if (s.includes('zion'))  return 'zion';
    if (s.includes('arion') || s.includes('arian')) return 'arion'; // cobre ARION/ARIAN
    return 'lumen';
  }

  function chooseGuideFromEl(el){
    const guess = el.getAttribute('data-guide')
                || el.getAttribute('data-guide-id')
                || el.dataset?.value
                || el.getAttribute('aria-label')
                || el.getAttribute('alt')
                || el.textContent;
    const guia = normGuide(guess);
    try{ localStorage.setItem('JORNADA_GUIA', guia); }catch(_){}

    // marca visualmente
    qa('[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id]')
      .forEach(n=>n.classList.remove('active'));
    el.classList.add('active');

    // próximo passo
    if (has('section-selfie')) {
      show('section-selfie');
      requestAnimationFrame(()=>setTimeout(()=>{ if (typeof window.runTyping==='function') runTyping(q('#section-selfie')); },0));
    } else {
      openQuestions();
    }
  }

  // ---------- Clique nos botões do guia (super abrangente)
  document.addEventListener('click', function(ev){
    const el = ev.target.closest && ev.target.closest(
      '[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id]'
    );
    if (!el) return;
    ev.preventDefault();
    chooseGuideFromEl(el);
  }, true);

  // ---------- Teclado acessível (Enter/Espaço)
  document.addEventListener('keydown', function(ev){
    if (ev.key!=='Enter' && ev.key!==' ') return;
    const el = document.activeElement;
    if (!el) return;
    if (el.matches('[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id]')){
      ev.preventDefault();
      chooseGuideFromEl(el);
    }
  }, true);

  // ---------- Segurança: garante clicabilidade
  const style = document.createElement('style');
  style.textContent = `
    [data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id] {
      pointer-events:auto; cursor:pointer; outline: none;
    }
    [data-action="choose-guide"].active, [data-guide].active, .choose-guide.active, .btn-guia.active, .card-guia.active {
      box-shadow: 0 0 0 2px rgba(255,215,0,.7);
    }
  `;
  document.head.appendChild(style);

})();

/* === SCRIPT GUIA+NOME: cliques robustos + placeholder do nome + fluxo === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* ---------- util ---------- */
  function has(id){
    return !!( q('#'+id) || q(`[data-section="${id.replace('section-','')}"]`) || q(`.${id}`) );
  }
  function show(id){
    if (typeof window.showSection==='function') return showSection(id);
    const secs=qa('.j-section'); secs.forEach(s=>s.classList.add('hidden'));
    const tgt = q('#'+id) || q(`[data-section="${id.replace('section-','')}"]`) || q(`.${id}`);
    if (tgt) tgt.classList.remove('hidden');
  }
  function openQuestions(){
    if (typeof window.openQuestions==='function') return window.openQuestions();
    if (typeof window.showSection==='function') showSection('section-perguntas'); else show('section-perguntas');
    requestAnimationFrame(()=>setTimeout(()=>{
      const sec = q('#section-perguntas'); if(!sec) return;
      let vis = sec.querySelector('.j-bloco[style*="display: block"]');
      const blocks = qa('.j-bloco', sec);
      if(!vis && blocks.length){ blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none'); vis = blocks[0]; }
      const active = sec.querySelector('.j-pergunta.active');
      if(!active && vis){
        const first = vis.querySelector('.j-pergunta');
        if(first){
          first.classList.add('active');
          const aria = q('#aria-pergunta');
          const lbl  = first.querySelector('.pergunta-enunciado')?.textContent || '';
          if(aria) aria.textContent = lbl;
        }
      }
      if (typeof window.runTyping==='function') runTyping(vis || sec);
    },0));
  }

  /* ---------- Normalização do guia ---------- */
  function normGuide(s=''){
    s = String(s).toLowerCase();
    if (s.includes('lumen')) return 'lumen';
    if (s.includes('zion'))  return 'zion';
    if (s.includes('arion') || s.includes('arian')) return 'arion';
    return 'lumen';
  }

  /* ---------- Ativa tela de guia (botões + nome) ---------- */
  function wireGuideSection(){
    const sec = q('#section-guia') || q('[data-section="guia"]') || q('.section-guia');
    if(!sec) return;

    // 1) Nome: placeholder / mensagem
    const nameInput = q('#guiaNameInput, [data-role="nome"], input[name="nome"], input[placeholder*="nome" i]', sec)
                   || q('input', sec);
    if (nameInput) {
      if (!nameInput.placeholder || !nameInput.placeholder.trim()){
        nameInput.placeholder = 'Digite seu nome';
      }
      nameInput.setAttribute('aria-label','Digite seu nome');
    }
    const nameMsg = q('#guiaNamePrompt, [data-role="guia-prompt"]', sec);
    if (nameMsg && !nameMsg.textContent.trim()){
      nameMsg.textContent = 'Digite seu nome';
    }

    // 2) Botões do guia — cobre várias formas de marcar
    const btns = qa('[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id], #btnLumen, #btnZion, #btnArion', sec);
    btns.forEach(btn=>{
      btn.setAttribute('tabindex','0');
      btn.style.pointerEvents = 'auto';
      btn.style.cursor = 'pointer';
      btn.addEventListener('click', onChoose);
      btn.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); onChoose(e); }});
    });

    // 3) Se havia overlay bloqueando clique, desarma
    const shields = qa('.click-shield, .overlay, [data-overlay]', sec);
    shields.forEach(s=>{ s.style.pointerEvents = 'none'; });

    function onChoose(ev){
      const el = ev.currentTarget;
      const guess = el.getAttribute('data-guide')
                   || el.getAttribute('data-guide-id')
                   || el.dataset?.value
                   || el.id
                   || el.getAttribute('aria-label')
                   || el.getAttribute('alt')
                   || el.textContent;
      const guia = normGuide(guess);
      try{ localStorage.setItem('JORNADA_GUIA', guia); }catch(_){}

      // marca visual
      btns.forEach(n=>n.classList.remove('active'));
      el.classList.add('active');

      // segue o fluxo: Selfie -> Perguntas
      if (has('section-selfie')) {
        if (typeof window.showSection==='function') showSection('section-selfie'); else show('section-selfie');
        requestAnimationFrame(()=>setTimeout(()=>{
          const s = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
          if (s && typeof window.runTyping==='function') runTyping(s);
        },0));
      } else {
        openQuestions();
      }
    }
  }

  // roda ao entrar na seção de guia
  const _showSection = window.showSection;
  window.showSection = function patchedShowSection(id){
    if (typeof _showSection === 'function') _showSection(id);
    else {
      // fallback de exibição
      const secs=qa('.j-section'); secs.forEach(s=>s.classList.add('hidden'));
      (q('#'+id) || q(`[data-section="${id.replace('section-','')}"]`) || q(`.${id}`))?.classList.remove('hidden');
    }
    if (id==='section-guia') {
      requestAnimationFrame(()=>setTimeout(wireGuideSection,0));
    }
  };

  // garante também via DOMContentLoaded e via mutação
  document.addEventListener('DOMContentLoaded', ()=>{ if (has('section-guia')) wireGuideSection(); });

  // se já estamos no guia agora, ativa imediatamente
  if ( (q('#section-guia') || q('[data-section="guia"]') || q('.section-guia')) && 
       !(q('#section-guia')||q('[data-section="guia"]')||q('.section-guia')).classList?.contains('hidden') ){
    wireGuideSection();
  }
})();

      // iniciar a jornada (valida senha)
      var btnStart = ev.target.closest ? ev.target.closest('[data-action="start"]') : null;
      if (btnStart) {
        ev.preventDefault();
        if (typeof window.startJourney === 'function') startJourney();
        return;
      }

      // alternar visibilidade da senha
      var btnToggle = ev.target.closest ? ev.target.closest('[data-action="toggle-password"], .password-toggle') : null;
      if (btnToggle) {
        ev.preventDefault();
        if (typeof window.toggleSenha === 'function') toggleSenha();
        return;
      }
    }, true);
  })();
 
/* === GUIA FIX v3 — clique robusto + logs + anti-overlay === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  function secGuia(){
    return q('#section-guia') || q('[data-section="guia"]') || q('.section-guia') || null;
  }

  function log(...a){ try{ console.log('[GUIA]', ...a);}catch(_){} }

  // normaliza nome do guia
  function normGuide(x=''){
    const s=String(x).toLowerCase();
    if (s.includes('lumen')) return 'lumen';
    if (s.includes('zion'))  return 'zion';
    if (s.includes('arion') || s.includes('arian')) return 'arion';
    return '';
  }

  // tenta inferir o guia a partir de um elemento
  function inferGuideFrom(el){
    if (!el) return '';
    const attrs = [
      el.getAttribute('data-guide'),
      el.getAttribute('data-guide-id'),
      el.dataset?.guide,
      el.dataset?.value,
      el.id,
      el.getAttribute('aria-label'),
      el.getAttribute('alt'),
      el.title,
      el.textContent
    ].filter(Boolean);

    for (const v of attrs){
      const g = normGuide(v);
      if (g) return g;
    }

    // tentativa com src de img
    if (el.tagName === 'IMG' && el.src){
      const src = el.src.toLowerCase();
      if (src.includes('lumen')) return 'lumen';
      if (src.includes('zion'))  return 'zion';
      if (src.includes('arion') || src.includes('arian')) return 'arion';
    }

    return '';
  }

  // aplica acessibilidade e estilos de clique aos possíveis botões
  function enhanceButtons(){
    const root = secGuia(); if (!root) return;
    const candidates = qa(`
      [data-action="choose-guide"],
      [data-guide],
      [data-guide-id],
      .choose-guide,
      .btn-guia,
      .card-guia,
      #btnLumen, #btnZion, #btnArion,
      img[alt*="Lumen" i],
      img[alt*="Zion" i],
      img[alt*="Arion" i]
    `, root);

    candidates.forEach(el=>{
      if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex','0');
      el.style.cursor = 'pointer';
      el.style.pointerEvents = 'auto';
      // se não tiver data-guide mas dá pra inferir, marque
      if (!el.getAttribute('data-guide')) {
        const g = inferGuideFrom(el);
        if (g) el.setAttribute('data-guide', g);
      }
    });

    // remove qualquer overlay que bloqueie clique
    qa('.click-shield, .overlay, [data-overlay]', root).forEach(ov=>{
      ov.style.pointerEvents = 'none';
      ov.style.opacity = ov.style.opacity || '1';
    });

    log('Botões candidatos:', candidates.length);
  }

  // abre selfie ou perguntas
  function goNextAfterGuide(){
    const hasSelfie = !!( q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie') );
    if (hasSelfie){
      if (typeof window.showSection==='function') showSection('section-selfie');
      else {
        document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
        (q('#section-selfie')||q('[data-section="selfie"]')||q('.section-selfie'))?.classList.remove('hidden');
      }
      requestAnimationFrame(()=>setTimeout(()=>{
        const s = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
        if (s && typeof window.runTyping==='function') runTyping(s);
      },0));
    } else if (typeof window.openQuestions==='function'){
      openQuestions();
    } else if (typeof window.showSection==='function'){
      showSection('section-perguntas');
    }
  }

  // handler central de escolha
  function choose(el){
    const guia = inferGuideFrom(el);
    log('Clique em guia — elemento:', el, '→ inferido:', guia || '(vazio)');
    if (!guia){
      console.warn('[GUIA] Não consegui inferir o guia a partir do elemento clicado.');
      return;
    }
    try{ localStorage.setItem('JORNADA_GUIA', guia); }catch(_){}
    // marca visual
    const root = secGuia() || document;
    qa('[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id]', root)
      .forEach(n=>n.classList.remove('active'));
    el.classList.add('active');

    goNextAfterGuide();
  }

  // delegação de clique (funciona mesmo se o DOM mudar depois)
  document.addEventListener('click', function(ev){
    const root = secGuia();
    if (!root) return;

    const target = ev.target;
    if (!root.contains(target)) return;

    // sobe na árvore até achar algo “clicável” como guia
    let el = target.closest?.('[data-action="choose-guide"], [data-guide], .choose-guide, .btn-guia, .card-guia, [data-guide-id], #btnLumen, #btnZion, #btnArion, img') || target;
    if (!el || !root.contains(el)) return;

    const g = inferGuideFrom(el);
    if (!g) return; // não é um botão válido

    ev.preventDefault();
    ev.stopPropagation();
    choose(el);
  }, true);

  // teclado acessível
  document.addEventListener('keydown', function(ev){
    if (ev.key!=='Enter' && ev.key!==' ') return;
    const root = secGuia(); if (!root) return;
    const el = document.activeElement;
    if (!el || !root.contains(el)) return;

    const g = inferGuideFrom(el);
    if (!g) return;

    ev.preventDefault();
    choose(el);
  }, true);

  // quando a seção de guia ficar visível, reforça botões
  const mo = new MutationObserver(()=>{ 
    const root = secGuia(); 
    if (root && !root.classList.contains('hidden')) enhanceButtons();
  });
  mo.observe(document.documentElement, {subtree:true, childList:true, attributes:true, attributeFilter:['class','style']});

  // também no carregamento
  document.addEventListener('DOMContentLoaded', enhanceButtons);
  // e já tenta agora
  enhanceButtons();
})();

<!-- ======== TAIL PACK: Selfie + Skip + Perguntas (fechado) ======== -->
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  /* 1) CSS da selfie (injetado, sem <style>) */
  (function injectSelfieCss(){
    const css = `
      #section-selfie .selfie-wrapper,
      #section-selfie .selfie-hero,
      #section-selfie .selfie-bg {
        position: relative;
        overflow: hidden;
        border-radius: 12px;
        min-height: 300px;
        background-color: rgba(0,0,0,0.15);
      }
      #section-selfie img[data-role="bg"],
      #section-selfie img#selfieBg,
      #section-selfie .selfie-bg > img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
        pointer-events: none;
        user-select: none;
        border-radius: 12px;
        display: block;
      }
    `;
    const st = document.createElement('style');
    st.id = 'selfie-bg-style';
    st.textContent = css;
    document.head.appendChild(st);
  })();
  
  // Dentro do seu <script>, crie o elemento em vez de colar <img> direto
(function ensureSelfieBgImg(){
  const sec = document.querySelector('#section-selfie, [data-section="selfie"], .section-selfie');
  if(!sec) return;
  const host = sec.querySelector('.selfie-bg, .selfie-hero, .selfie-wrapper') || sec;
  let img = host.querySelector('img[data-role="bg"]');
  if (!img) {
    img = document.createElement('img');
    img.setAttribute('data-role','bg');
    img.alt = 'Guia Background';
    host.appendChild(img);
  }
})();

  /* 2) Fundo por guia (com preload) */
  const GUIDE_BG = {
    lumen: [
      '/assets/img/irmandade-quarteto-bg-lumen.png',
      '/assets/img/irmandade-quarteto-bg-lumen.jpg',
      '/assets/img/irmandade-quarteto-bg-lumen.jpeg'
    ],
    zion: [
      '/assets/img/irmandade-quarteto-bg-zion.png',
      '/assets/img/irmandade-quarteto-bg-zion.jpg',
      '/assets/img/irmandade-quarteto-bg-zion.jpeg'
    ],
    arion: [
      '/assets/img/irmandade-quarteto-bg-arian.jpeg',
      '/assets/img/irmandade-quarteto-bg-arion.jpeg',
      '/assets/img/irmandade-quarteto-bg-arion.jpg',
      '/assets/img/irmandade-quarteto-bg-arion.png'
    ]
  };
  function normGuide(s=''){
    s=String(s).toLowerCase();
    if(s.includes('lumen')) return 'lumen';
    if(s.includes('zion'))  return 'zion';
    if(s.includes('arion')||s.includes('arian')) return 'arion';
    return 'lumen';
  }
  function preloadFirst(list){
    return new Promise(res=>{
      let i=0; (function step(){
        if(i>=list.length) return res(null);
        const src=list[i++], im=new Image();
        im.onload =()=>res(src);
        im.onerror=()=>step();
        im.src = src;
      })();
    });
  }
  async function applySelfieBg(){
    const sec = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
    if(!sec || sec.classList.contains('hidden')) return;

    const host = q('.selfie-bg',sec) || q('.selfie-hero',sec) || q('.selfie-wrapper',sec) || sec;

    let img = q('img[data-role="bg"]',host) || q('#selfieBg',host) || q('.selfie-bg > img',sec);
    if(!img){
      img = document.createElement('img');
      img.setAttribute('data-role','bg');
      img.alt = 'Guia Background';
      host.appendChild(img);
    }

    const guia = normGuide(localStorage.getItem('JORNADA_GUIA')||'');
    const src  = await preloadFirst(GUIDE_BG[guia] || GUIDE_BG.lumen);
    if(src){ img.src = src; }
  }

  const moSelfie=new MutationObserver(()=>{
    const sec=q('#section-selfie')||q('[data-section="selfie"]')||q('.section-selfie');
    if(sec && !sec.classList.contains('hidden')) applySelfieBg();
  });
  moSelfie.observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['class','style']});
  document.addEventListener('DOMContentLoaded', applySelfieBg);

  /* 3) Perguntas: garantir 1º bloco + 1ª pergunta + datilografia */
  function wait(ms){ return new Promise(r=>setTimeout(r,ms)); }
  async function ensureQuestionsReady(retries=10){
    const sec = q('#section-perguntas'); if(!sec) return false;

    let blocks = qa('.j-bloco', sec);
    if(blocks.length===0 && typeof window.loadDynamicBlocks==='function'){
      try{ window.loadDynamicBlocks(); }catch(_){}
      await wait(120);
      blocks = qa('.j-bloco', sec);
    }
    if(blocks.length===0 && retries>0){ await wait(150); return ensureQuestionsReady(retries-1); }

    let vis = sec.querySelector('.j-bloco[style*="display: block"]');
    if(!vis && blocks.length){ blocks.forEach((b,i)=> b.style.display = i===0 ? 'block' : 'none'); vis = blocks[0]; }

    let active = sec.querySelector('.j-pergunta.active');
    if(!active && vis){
      const first = vis.querySelector('.j-pergunta');
      if(first){
        first.classList.add('active');
        const aria = q('#aria-pergunta');
        const lbl  = first.querySelector('.pergunta-enunciado')?.textContent || '';
        if(aria) aria.textContent = lbl;
      }
    }

    if (typeof window.runTyping === 'function') window.runTyping(vis || sec);
    return true;
  }

  /* 4) Reforça openQuestions (sem quebrar o que já existe) */
  const __prevOpenQuestions = window.openQuestions;
  window.openQuestions = function openQuestionsPatched(){
    if (typeof window.showSection === 'function') window.showSection('section-perguntas');
    else {
      document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
      (q('#section-perguntas')||q('[data-section="perguntas"]')||q('.section-perguntas'))?.classList.remove('hidden');
    }
    requestAnimationFrame(()=>{ setTimeout(()=>{ ensureQuestionsReady(); }, 0); });
    // chama antigo se existir (não deve navegar denovo)
    if (typeof __prevOpenQuestions === 'function') {
      try { __prevOpenQuestions(); } catch(_){}
    }
  };

  /* 5) Botão “Pular foto / Iniciar” */
  document.addEventListener('click', function(ev){
    const sec = q('#section-selfie')||q('[data-section="selfie"]')||q('.section-selfie');
    if(!sec) return;
    const btn = ev.target.closest?.('[data-action="selfie-next"], [data-action="skip-selfie"], #btnSkipSelfie, .btn-skip-selfie, [data-role="start"]');
    if(btn && sec.contains(btn)){
      ev.preventDefault();
      window.openQuestions();
    }
  }, true);
})();
 
/* === PERGUNTAS FIX v3 — encontra blocos/perguntas, ativa 1ª e roda typing === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const log=(...a)=>{ try{ console.log('[PERG]',...a);}catch(_){} };
  const wait = (ms)=>new Promise(r=>setTimeout(r,ms));

  function uniq(arr){ return Array.from(new Set(arr)); }

  function findBlocks(sec){
    // cobre vários jeitos de marcar "bloco"
    const sels = [
      '.j-bloco', '.js-bloco', '.bloco', '.block',
      '.perguntas-bloco', '.bloco-perguntas', '.q-block', '.quest-block',
      '[data-bloco]', '[data-block]'
    ];
    let list=[];
    for(const s of sels){ list = list.concat(qa(s, sec)); }
    list = uniq(list).filter(el => el.offsetParent !== null || getComputedStyle(el).display !== 'none');
    return list;
  }

  function findQuestions(root){
    // cobre vários jeitos de marcar "pergunta"
    const sels = [
      '.j-pergunta', '.pergunta', '.question', '.q-item',
      '.item-pergunta', '[data-pergunta]', '[data-question]',
      '[class*="perg"]', '[class*="quest"]'
    ];
    let items=[];
    for(const s of sels){ items = items.concat(qa(s, root)); }
    items = uniq(items).filter(el=>{
      // precisa ter conteúdo relevante dentro
      return el.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, p, [data-typing], textarea, input');
    });
    return items;
  }

  async function ensureQuestionsReady(maxTries=12){
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if(!sec){ log('sec não encontrada'); return false; }

    // tenta (re)construir conteúdo, se existir
    try{ typeof window.updateBlocks==='function' && window.updateBlocks(); }catch(_){}
    try{ typeof window.loadDynamicBlocks==='function' && window.loadDynamicBlocks(); }catch(_){}

    let blocks=[], tries=0;
    while(tries++ < maxTries){
      blocks = findBlocks(sec);
      if (blocks.length) break;
      // caso não tenha "bloco", talvez só tenha perguntas diretas
      const qs = findQuestions(sec);
      if (qs.length){
        blocks = [sec]; // usa a própria seção como "bloco" hospedeiro
        break;
      }
      await wait(150);
    }
    log('blocos encontrados:', blocks.length);

    if (!blocks.length) return false;

    // garante 1º bloco visível
    let vis = sec.querySelector('.j-bloco[style*="display: block"], .bloco[style*="display: block"], .block[style*="display:block"]');
    if(!vis){ vis = blocks[0]; }
    blocks.forEach((b,i)=>{ if (b!==vis) b.style.display='none'; });
    vis.style.display = 'block';

    // ativa 1ª pergunta
    let qs = findQuestions(vis);
    log('perguntas no bloco visível:', qs.length);
    if (!qs.length){ 
      // tenta na seção inteira
      qs = findQuestions(sec);
      log('perguntas na seção:', qs.length);
    }
    if (!qs.length) return false;

    // marca ativa
    const currentActive = sec.querySelector('.j-pergunta.active, .pergunta.active, .question.active, .q-item.active');
    if (currentActive) currentActive.classList.remove('active');
    const first = qs[0];
    first.classList.add('active');

    // aria
    const aria = q('#aria-pergunta');
    const lbl  = first.querySelector('.pergunta-enunciado, .question-title, [data-enunciado], h3, p')?.textContent || '';
    if(aria) aria.textContent = lbl;

    // roda typing
    try {
      if (typeof window.runTyping === 'function'){
        window.runTyping(vis || sec);
      }
    } catch(e){ console.warn('[PERG] runTyping erro:', e); }

    return true;
  }

  // reforça openQuestions para usar nossa rotina
  window.openQuestions = function(){
    if (typeof window.showSection === 'function') window.showSection('section-perguntas');
    else {
      document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
      (q('#section-perguntas')||q('[data-section="perguntas"]')||q('.section-perguntas'))?.classList.remove('hidden');
    }
    requestAnimationFrame(()=>setTimeout(()=>{ ensureQuestionsReady(); }, 0));
  };

  // também tenta quando a seção perguntas ficar visível
  const mo = new MutationObserver(()=>{
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if (sec && !sec.classList.contains('hidden')) {
      ensureQuestionsReady();
    }
  });
  mo.observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['class','style']});
})();

/* === PERGUNTAS AUTOWIRE v5 — encontra/ativa perguntas em qualquer markup === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));
  const wait=(ms)=>new Promise(r=>setTimeout(r,ms));
  const log=(...a)=>{ try{ console.log('[PERGv5]',...a);}catch(_){} };

  function uniq(arr){ return Array.from(new Set(arr)); }

  function findBlocks(sec){
    // muitos nomes possíveis de "bloco"
    const sel = [
      '.j-bloco','.js-bloco','.bloco','.block',
      '.perguntas-bloco','.bloco-perguntas','.q-block','.quest-block',
      '.lista-perguntas','.questions','.questions-list',
      '[data-bloco]','[data-block]','[data-role="bloco"]','[role="group"]'
    ];
    let out=[];
    for(const s of sel){ out=out.concat(qa(s,sec)); }
    out=uniq(out);
    if(!out.length){
      // alguns projetos colocam tudo direto na seção
      out=[sec];
    }
    return out;
  }

  function looksLikeQuestion(el){
    // tem título/label?
    if (el.querySelector('.pergunta-enunciado,.question-title,[data-enunciado],h3,h4,legend')) return true;
    // tem algo para responder?
    if (el.querySelector('textarea,input,select,[contenteditable]')) return true;
    // tem typing?
    if (el.matches('[data-pergunta],[data-question]') || el.querySelector('[data-typing]')) return true;
    // heurística: classes com "perg"/"quest"
    const cls=(el.className||'').toString().toLowerCase();
    if (/\b(perg|pergunta|question|quest|q-item)\b/.test(cls)) return true;
    return false;
  }

  function findQuestions(root){
    const sel = [
      '.j-pergunta','.pergunta','.question','.q-item','.questao',
      '[data-pergunta]','[data-question]','[data-role="pergunta"]'
    ];
    let items=[];
    for(const s of sel){ items=items.concat(qa(s,root)); }
    items=uniq(items).filter(looksLikeQuestion);
    if(!items.length){
      // fallback: qualquer filho que "pareça" pergunta
      items=qa(':scope > *',root).filter(looksLikeQuestion);
    }
    return items;
  }

  async function ensureQuestionsReady(maxTries=40){
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if(!sec){ log('seção não encontrada'); return false; }

    // tenta carregar/construir, se seu app tiver essas funções
    try{ typeof window.updateBlocks==='function' && window.updateBlocks(); }catch(_){}
    try{ typeof window.loadDynamicBlocks==='function' && window.loadDynamicBlocks(); }catch(_){}
    try{ typeof window.initJornada==='function'    && window.initJornada(); }catch(_){}

    let blocks=[], questions=[];
    for (let i=0;i<maxTries;i++){
      blocks = findBlocks(sec);
      questions = findQuestions(blocks[0] || sec);
      if (blocks.length && questions.length) break;
      await wait(200);
    }

    log('blocos:', blocks.length, 'perguntas no 1º bloco:', questions.length);

    if(!blocks.length || !questions.length){
      // debug para você ver como está o DOM
      const snap = qa('#section-perguntas *').slice(0,40).map(el=>({
        tag: el.tagName.toLowerCase(),
        id:  el.id || '',
        cls: el.className || '',
        data: Object.keys(el.dataset||{}).join(',')
      }));
      console.table(snap);
      return false;
    }

    // mostra 1º bloco
    const vis = blocks[0];
    blocks.forEach((b,i)=>{ b.style.display = (b===vis ? 'block' : 'none'); });

    // ativa 1ª pergunta
    const first = questions[0];
    qa('.active', sec).forEach(n=>n.classList.remove('active'));
    first.classList.add('active');

    // aria
    const aria = q('#aria-pergunta');
    const lbl  = (first.querySelector('.pergunta-enunciado,.question-title,[data-enunciado],h3,h4,p')||{}).textContent || '';
    if(aria) aria.textContent = lbl;

    // roda datilografia
    if (typeof window.runTyping === 'function'){
      window.runTyping(vis || sec);
    }
    return true;
  }

  // expõe para outros scripts
  window.ensureQuestionsReady = ensureQuestionsReady;

  // reforça openQuestions (usa nosso ensure)
  const prevOpen = window.openQuestions;
  window.openQuestions = function(){
    if (typeof window.showSection === 'function') window.showSection('section-perguntas');
    else {
      document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
      (q('#section-perguntas')||q('[data-section="perguntas"]')||q('.section-perguntas'))?.classList.remove('hidden');
    }
    requestAnimationFrame(()=>setTimeout(()=>{ ensureQuestionsReady(); },0));
    if (typeof prevOpen === 'function') { try{ prevOpen(); }catch(_){} }
  };

  // quando perguntas ficar visível, tenta ligar
  const mo = new MutationObserver(()=>{
    const sec = q('#section-perguntas') || q('[data-section="perguntas"]') || q('.section-perguntas');
    if (sec && !sec.classList.contains('hidden')) ensureQuestionsReady();
  });
  mo.observe(document.documentElement,{subtree:true,childList:true,attributes:true,attributeFilter:['class','style']});
})();
  
/* === SECTION HIDER v2 — some a Selfie e mostra Perguntas de verdade === */
(function(){
  'use strict';
  const q=(s,r=document)=>r.querySelector(s);
  const qa=(s,r=document)=>Array.from(r.querySelectorAll(s));

  function hideAllSections(){
    qa('.j-section, [id^="section-"]').forEach(s=>{
      s.classList.add('hidden');
      s.style.display = 'none';
    });
  }

  // Throttle para evitar spam de ensure
  let _lastEnsure = 0;
  function ensureOnce(){
    const now = performance.now();
    if (now - _lastEnsure < 300) return;
    _lastEnsure = now;
    if (typeof window.ensureQuestionsReady === 'function') {
      window.ensureQuestionsReady();
    }
  }

  // Patch do showSection p/ esconder tudo (inclusive #section-selfie sem .j-section)
  const prevShow = window.showSection;
  window.showSection = function(sectionId){
    try{ window.speechSynthesis && speechSynthesis.cancel(); }catch(_){}
    hideAllSections();

    const active =
      document.getElementById(sectionId) ||
      q(`[data-section="${sectionId.replace('section-','')}"]`) ||
      q(`.${sectionId}`);

    if (active){
      active.classList.remove('hidden');
      active.style.display = 'block';
    }

    // se for perguntas, garante abertura
    if (sectionId === 'section-perguntas') {
      requestAnimationFrame(()=>setTimeout(ensureOnce,0));
    } else {
      // para a Selfie, garante que ela não bloqueie nada
      const selfie = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
      if (selfie && sectionId !== 'section-selfie') {
        selfie.style.pointerEvents = 'none';
        selfie.classList.add('hidden');
        selfie.style.display = 'none';
      }
    }

    // roda typing no que ficou ativo (se existir)
    if (typeof window.runTyping === 'function' && active) {
      requestAnimationFrame(()=>setTimeout(()=>window.runTyping(active),0));
    }
  };

  // Patch do openQuestions p/ usar o hider
  const prevOpen = window.openQuestions;
  window.openQuestions = function(){
    window.showSection('section-perguntas');   // já esconde tudo e chama ensureOnce()
    if (typeof prevOpen === 'function') { try{ prevOpen(); }catch(_){ } }
  };

  // Caso alguém tenha ficado preso na Selfie, força a transição quando clicar em “pular/confirmar”
  document.addEventListener('click', function(ev){
    const sec = q('#section-selfie') || q('[data-section="selfie"]') || q('.section-selfie');
    if(!sec) return;
    const btn = ev.target.closest &&
      ev.target.closest('[data-action="selfie-next"],[data-action="skip-selfie"],#btnSkipSelfie,.btn-skip-selfie,[data-role="start"],button,a');
    if (btn && sec.contains(btn)) {
      // se o texto sugere “pular / iniciar / confirmar”, navega
      const txt = (btn.textContent||'').toLowerCase();
      if (/\bpular|\biniciar|\bcomeçar|\bconfirmar/.test(txt) || btn.hasAttribute('data-action')) {
        ev.preventDefault();
        window.showSection('section-perguntas');
      }
    }
  }, true);
})();

  /* ===== Boot ===== */
(function(){
  'use strict';
  console.log('[Boot] Iniciando script seguro');
  try {
    ensureHeaderFlame();
    ensurePageFlames();
  } catch(e) {
    console.error('[Boot] Erro ao garantir chamas:', e);
  }
  
  if (typeof window.speechSynthesis !== 'undefined') {
    speechSynthesis.onvoiceschanged = () => {};
  }

  // Garante uma primeira seção
  if (document.getElementById('section-intro')) {
    showSection('section-intro');
  } else {
    // Fallback: tenta outras seções iniciais
    const possibleSections = ['section-termos', 'section-senha', 'section-guia', 'section-perguntas'];
    for (const secId of possibleSections) {
      if (document.getElementById(secId)) {
        showSection(secId);
        break;
      }
    }
  }
})();
</script>
</body>
</html>



