<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada Conhecimento com Luz ‚Äî Essencial</title>
  <meta name="description" content="Jornada Conhecimento com Luz ‚Äî Essencial. Responda com sinceridade e baixe seu PDF ao final.">
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {"50":"#f5f3ff","100":"#ede9fe","200":"#ddd6fe","300":"#c4b5fd","400":"#a78bfa","500":"#8b5cf6","600":"#7c3aed","700":"#6d28d9","800":"#5b21b6","900":"#4c1d95"},
            gold: {"500":"#fbbf24"}
          }
        }
      }
    }
  </script>
  <link rel="stylesheet" href="/assets/styles.css">
  <script defer src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gradient-to-br from-gray-950 via-gray-900 to-gray-800 text-gray-100 antialiased selection:bg-primary-500/30">

<header class="fixed top-0 inset-x-0 z-50 backdrop-blur bg-gray-900/70 border-b border-white/10">
  <nav class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
    <a href="/index.html" class="flex items-center gap-2">
      <img src="/assets/logo.svg" alt="Logo Irmandade" class="h-7 w-7">
      <span class="font-bold text-white">Irmandade Conhecimento com Luz</span>
    </a>
    <span class="text-xs text-gray-300">Jornada Essencial</span>
  </nav>
</header>

<main class="pt-24">
  <!-- Aviso legal curto -->
  <section class="max-w-3xl mx-auto px-4">
    <div class="rounded-2xl border border-yellow-400/30 bg-yellow-400/10 p-4 text-sm text-yellow-200">
      <p class="font-semibold mb-1">üõ°Ô∏è Aviso Importante</p>
      <ul class="list-disc pl-5 space-y-1">
        <li>Suas respostas ser√£o usadas apenas para gerar um PDF exclusivo.</li>
        <li>O PDF <u>n√£o</u> √© enviado por e-mail ‚Äî fa√ßa o download ao final.</li>
        <li>Ap√≥s o download, os dados s√£o limpos deste dispositivo.</li>
        <li>O acesso √© protegido por senha (validade: 15 dias para iniciar e 24h para concluir ap√≥s o in√≠cio).</li>
      </ul>
    </div>
  </section>

  <!-- Container das perguntas -->
  <section class="max-w-3xl mx-auto px-4 mt-8">
    <h1 class="text-2xl font-extrabold tracking-wide mb-4">
      Jornada Conhecimento com Luz ‚Äî <span class="text-primary-300">Essencial</span>
    </h1>

    <!-- Aqui as perguntas ser√£o renderizadas -->
    <div id="lista-perguntas"></div>
  </section>

  <!-- Espa√ßo final para respiro antes do rodap√© fixo -->
  <div class="h-24"></div>
</main>

<!-- Painel fixo (senha + a√ß√µes) -->
<div id="painel-controles"
     class="fixed bottom-0 left-0 right-0 z-40 bg-gray-900/95 border-t border-white/10 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
    <div class="flex items-center gap-3">
      <label for="senha" class="text-sm text-gray-300">Senha de acesso</label>
      <input id="senha" type="password" placeholder="Digite sua senha"
             class="rounded-lg bg-gray-800 border border-white/10 px-3 py-2 text-sm w-56" />
    </div>
    <div class="flex gap-3">
      <button id="btnLimpar" class="px-4 py-2 rounded-xl border border-yellow-400/50 text-yellow-300 hover:bg-yellow-400/10">
        Limpar respostas
      </button>
      <button id="btnEnviar" class="px-4 py-2 rounded-xl bg-yellow-400 text-gray-900 font-semibold hover:bg-yellow-300">
        Enviar respostas
      </button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  // Ajuste de espa√ßo para o painel fixo no mobile
  (function padBottomForFooter() {
    const painel = document.getElementById('painel-controles');
    function ajusta() {
      const h = painel?.getBoundingClientRect().height || 80;
      document.body.style.paddingBottom = (h + 16) + 'px';
    }
    window.addEventListener('load', ajusta);
    window.addEventListener('resize', ajusta);
    setTimeout(ajusta, 0);
  })();
</script>

<script>
  // === LISTA OFICIAL DE PERGUNTAS (32) ===
  const PERGUNTAS = [
    // BLOCO 1 ‚Äì Reflex√µes da Alma e da Exist√™ncia (10)
    "Como voc√™ tem percebido sua pr√≥pria vida at√© aqui?",
    "E a vida das pessoas ao seu redor, como voc√™ a enxerga?",
    "Como lida com seus traumas? Consegue falar sobre eles?",
    "Voc√™ acredita que a verdade existe ou tudo √© relativo? Explique.",
    "O que significa a doen√ßa para voc√™? Est√° enfrentando alguma? Fale livremente.",
    "H√° algu√©m que voc√™ gostaria de ter ao seu lado agora? Quem √© essa pessoa e por que ela n√£o est√°?",
    "Qual √© o seu maior v√≠cio? Por que voc√™ acha que ele surgiu? J√° tentou venc√™-lo?",
    "Sente que tem outros v√≠cios, mesmo que sutis ou emocionais? Quais?",
    "Como voc√™ percebe a morte? Ela te assusta, conforta ou provoca curiosidade?",
    "Voc√™ acredita em continuidade ap√≥s a morte? O que imagina que exista?",

    // BLOCO 2 ‚Äì Ra√≠zes e Experi√™ncias de Vida (8)
    "Com quem foi criado: ambos os pais biol√≥gicos, s√≥ um dos pais biol√≥gicos (div√≥rcio ou morte), pais afetivos (ado√ß√£o) ou parentes?",
    "√â filho √∫nico?",
    "Quantos irm√£os tem? √â primog√™nito, do meio ou ca√ßula?",
    "Passou fome quando crian√ßa?",
    "N√≠vel de escolaridade e forma√ß√£o acad√™mica.",
    "Estado civil: solteiro, namorando, casado, divorciado, vi√∫vo?",
    "Tem alguma defici√™ncia f√≠sica?",
    "Voc√™ j√° sofreu algum tipo de preconceito? Foi superado ou ainda interfere nas suas decis√µes?",

    // BLOCO 3 ‚Äì Futuro e Prop√≥sito (5)
    "Quais s√£o os seus maiores sonhos para o futuro?",
    "O que voc√™ considera essencial para ter uma vida plena?",
    "Se pudesse mudar algo na sociedade, o que mudaria?",
    "Qual legado gostaria de deixar?",
    "Se pudesse passar uma mensagem para o mundo inteiro agora, qual seria?",

    // BLOCO 4 ‚Äì Jornada Iluminada (9)
    "Voc√™ se recorda da idade em que, pela primeira vez, percebeu que era algu√©m neste mundo?",
    "Se encontrasse seu 'eu' de 10 anos atr√°s, o que diria?",
    "O que significa f√© para voc√™?",
    "J√° teve alguma experi√™ncia que mudou sua forma de ver a vida?",
    "Quais pessoas mais marcaram sua caminhada? Por qu√™?",
    "Voc√™ acredita que tudo tem um prop√≥sito?",
    "Se pudesse receber uma resposta direta de Deus agora, qual pergunta faria?",
    "Que h√°bito voc√™ pode iniciar hoje que te aproximaria do seu prop√≥sito?",
    "Qual √© a decis√£o corajosa que voc√™ vem adiando e precisa tomar?"
  ];

  // T√≠tulos por bloco (√≠ndices de in√≠cio)
  const BLOCO_TITULOS = {
    0: "Reflex√µes da Alma e da Exist√™ncia",
    10: "Ra√≠zes e Experi√™ncias de Vida",
    18: "Futuro e Prop√≥sito",
    23: "Jornada Iluminada"
  };

  // Renderiza√ß√£o
  const lista = document.getElementById("lista-perguntas");
  const parts = [];
  PERGUNTAS.forEach((texto, i) => {
    if (BLOCO_TITULOS[i]) {
      parts.push(`
        <h3 class="mt-10 mb-4 text-xl font-extrabold tracking-wide text-primary-300">
          ${BLOCO_TITULOS[i]}
        </h3>
      `);
    }
    parts.push(`
      <div class="mb-6 rounded-2xl bg-white/5 p-4 border border-white/10">
        <label class="block font-semibold mb-2 break-words">${i + 1}. ${texto}</label>
        <textarea name="q${i + 1}" rows="4"
          class="w-full min-h-[110px] rounded-xl bg-gray-900/60 border border-white/10 p-3"
          placeholder="Escreva com sinceridade..."></textarea>
      </div>
    `);
  });
  lista.innerHTML = parts.join("");
</script>

<script>
  // === COLETA + ENVIO PARA O BACKEND ===
 const API = 'https://lumen-backend-api.onrender.com';
 const ENDPOINT = '/formulario'; // ajuste se necess√°rio
  const MIN_CAMPOS = 10;                 // m√≠nimo de respostas para permitir envio

  // Aquece backend ao abrir a p√°gina (n√£o bloqueante)
  window.addEventListener('load', () => {
    fetch(API + '/ping').catch(()=>{});
  });

  // Utilidades
  const campos = () => Array.from(document.querySelectorAll('textarea[name^="q"]'));
  const KEY_PREFIX = 'jornada_essencial_';

  // Auto-save local
  function salvarAuto() {
    campos().forEach((t, i) => localStorage.setItem(KEY_PREFIX + (i+1), t.value));
  }
  function restaurarAuto() {
    campos().forEach((t, i) => {
      const v = localStorage.getItem(KEY_PREFIX + (i+1));
      if (v) t.value = v;
    });
  }
  // Restaura ap√≥s primeira renderiza√ß√£o
  setTimeout(restaurarAuto, 0);
  document.addEventListener('input', (e) => {
    if (e.target && e.target.matches('textarea[name^="q"]')) salvarAuto();
  });

  // Limpar
  document.getElementById('btnLimpar').addEventListener('click', () => {
    if (!confirm('Deseja limpar todas as respostas desta p√°gina?')) return;
    campos().forEach(t => t.value = '');
    salvarAuto();
  });

  <script>
// === CONFIG ===
const API = 'https://conhecimento-com-luz-api.onrender.com'; // troque se estiver usando outro backend

// === Helpers j√° existentes no seu arquivo ===
// campos(): Array de textareas
// KEY_PREFIX: prefixo do localStorage
// salvarAuto(), restaurarAuto() etc. j√° est√£o acima

// ================== ENVIAR ==================
document.getElementById('btnEnviar').addEventListener('click', async () => {
  const btn = document.getElementById('btnEnviar');
  const senhaEl = document.getElementById('senha');

  if (!senhaEl || !senhaEl.value.trim()) {
    alert('Digite a senha de acesso.');
    return;
  }

  // Monta respostas a partir dos <textarea name="q[1]">, q[2]...
  const respostas = campos().map((el, i) => {
    const idx = Number((el.name.match(/\[(\d+)\]/) || [])[1] || i + 1);
    const label = document.querySelector(`label[for="${el.id}"]`);
    const perguntaEl = label || el.closest('.pergunta') || el.previousElementSibling;
    const pergunta = perguntaEl ? perguntaEl.textContent.trim() : `Pergunta ${idx}`;
    return {
      indice: idx,
      pergunta,
      resposta: (el.value || '').trim()
    };
  });

  // Valida√ß√£o simples (opcional): exige ao menos 1 resposta
  if (!respostas.some(r => r.resposta.length)) {
    alert('Preencha ao menos uma resposta antes de enviar.');
    return;
  }

  // Payload padr√£o
  const payload = {
    senha: senhaEl.value.trim(),
    origem: 'site-irmandade',
    jornada: 'essencial',
    respostas
  };

  // Feedback de envio
  const oldTxt = btn.textContent;
  btn.disabled = true;
  btn.textContent = 'Enviando...';

  try {
    const res = await fetch(`${API}/jornada/essencial`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    // Mesmo se n√£o vier JSON v√°lido, seguimos sem quebrar
    const data = await res.json().catch(() => ({}));

    if (!res.ok) {
      const msg = data?.detail || data?.message || `Erro ${res.status}`;
      alert('Erro ao enviar: ' + msg);
      return;
    }

    // Mensagem clara (sem [object Object])
    alert(data?.message || data?.msg || 'Respostas enviadas com sucesso!');

    // PDF: url direta OU base64
    if (data?.pdf_url) {
      window.location.href = data.pdf_url; // abre/baixa o PDF
    } else if (data?.pdf_base64) {
      const a = document.createElement('a');
      a.href = 'data:application/pdf;base64,' + data.pdf_base64;
      a.download = data?.pdf_filename || 'jornada-essencial.pdf';
      a.click();
    }

    // Limpa auto-save local ap√≥s sucesso
    campos().forEach((_, i) => localStorage.removeItem(KEY_PREFIX + (i + 1)));
  } catch (err) {
    console.error(err);
    alert('Falha de rede. Tente novamente em instantes.');
  } finally {
    btn.disabled = false;
    btn.textContent = oldTxt || 'Enviar';
  }
});
</script>

    const respostas = campos().map((t, i) => ({
      id: i + 1,
      pergunta: (typeof PERGUNTAS !== 'undefined' ? PERGUNTAS[i] : `Q${i+1}`),
      resposta: t.value.trim()
    }));

    const preenchidas = respostas.filter(r => r.resposta.length > 0).length;
    if (preenchidas < MIN_CAMPOS) {
      const ok = confirm(`Somente ${preenchidas} respostas preenchidas. Deseja enviar assim mesmo?`);
      if (!ok) return;
    }

    // Metadados (timezone e hor√°rios)
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    const startedKey = KEY_PREFIX + 'started_at';
    if (!localStorage.getItem(startedKey)) localStorage.setItem(startedKey, new Date().toISOString());

    const payload = {
      senha,
      respostas,
      meta: {
        dispositivo: navigator.userAgent,
        timezone: tz,
        started_at: localStorage.getItem(startedKey),
        enviado_em: new Date().toISOString()
      }
    };

    // UI loading
    const btn = document.getElementById('btnEnviar');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Gerando PDF...';

    try {
      const r = await fetch(API + ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/pdf'
        },
        body: JSON.stringify(payload)
      });

      const ct = r.headers.get('Content-Type') || '';
      if (!r.ok) {
        if (ct.includes('application/json')) {
          const err = await r.json().catch(()=>({detail:'Erro desconhecido'}));
          throw new Error(err.detail || err.message || 'Falha ao gerar PDF.');
        }
        throw new Error('Falha ao gerar PDF. Tente novamente em instantes.');
      }

      if (ct.includes('application/pdf')) {
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Jornada-Conhecimento-com-Luz.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        // Limpa armazenamento local conforme a pol√≠tica
        campos().forEach((t, i) => localStorage.removeItem(KEY_PREFIX + (i+1)));
        localStorage.removeItem(startedKey);
        alert('PDF gerado com sucesso! Baixe e guarde com carinho. Os dados locais foram limpos.');
      } else if (ct.includes('application/json')) {
        const data = await r.json();
        if (data.url) {
          location.href = data.url;
        } else {
          alert(data.message || 'Resposta recebida, mas n√£o reconhecida.');
        }
      } else {
        alert('Formato de resposta inesperado do servidor.');
      }
    } catch (err) {
      console.error(err);
      alert(err.message || 'Erro ao enviar. Tente novamente.');
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  });

  window.lucide && lucide.createIcons();
</script>

</body>
</html>
