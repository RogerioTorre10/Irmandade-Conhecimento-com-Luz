<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />

  <!-- Fonts: Google para Berkshire/Cardo (evita OTS do .ttf local) -->
  <link href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Cardo:wght@400;700&display=swap" rel="stylesheet" />

  <!-- ManufacturingConsent local -->
  <link rel="preload" href="/assets/fonts/ManufacturingConsent-Regular.ttf" as="font" type="font/ttf" crossorigin />

  <!-- pdfMake para geração de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    /* ================== FONTS ================== */
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root {
      --bg: #f9f9f3;
      --ink: #222;
      --ink-soft: #444;
      --brand: #6b21a8;
      --brand-2: #7c3aed;
      --panel: #f6efe0;
    }

    /* ===== BASE ===== */
    html, body { height: 100% }
    body {
      margin: 0;
      color: var(--ink);
      background: var(--bg);
      font-family: "ManufacturingConsent", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .container { max-width: 960px; margin: 24px auto; padding: 0 16px }
    .card { background: var(--panel) !important; border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.12); padding: 28px; position: relative; z-index: 5 }

    /* ===== HEADER + CHAMA ===== */
    .chama-icone { position: relative; width: 36px; height: 72px; display: flex; align-items: flex-end }
    .chama-icone > * { position: static }
    .chama-vela {
      --altura: 90px; --largura: 60px; --pulso: 1.7s; --glow: 18px; --hue: 28; --satur: 96%; --light: 58%; --op: .98;
      position: relative; width: var(--largura); height: var(--altura); display: inline-block;
      filter: drop-shadow(0 0 var(--glow) hsla(var(--hue), var(--satur), 60%, .70));
    }
    .chama-vela.chama-md { --largura: 32px; --altura: 64px }
    .chama-vela.chama-lg { --largura: 60px; --altura: 120px }
    .chama-vela .brasa {
      position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura) * .86); height: 12px;
      border-radius: 50%; background: radial-gradient(circle at 50% 40%, hsla(var(--hue), var(--satur), 95%, .95) 0%, hsla(var(--hue), var(--satur), 70%, .85) 35%, transparent 72%);
      filter: blur(1px); animation: brasaPulse var(--pulso) ease-in-out infinite; opacity: var(--op)
    }
    .chama-vela .lingua {
      position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura) * .96); height: calc(var(--altura) * .98);
      border-radius: 62% 62% 20% 20% / 94% 94% 16% 16%;
      background: radial-gradient(48% 58% at 50% 18%, hsla(var(--hue), var(--satur), 98%, 1) 0%, hsla(var(--hue), var(--satur), 78%, .98) 32%, transparent 68%),
                  radial-gradient(110% 140% at 50% 72%, hsla(calc(var(--hue) - 8), calc(var(--satur) - 12%), 50%, .85) 0%, transparent 72%);
      mix-blend-mode: screen; filter: blur(.45px); transform-origin: 50% 100%; animation: velaWaver 1.6s ease-in-out infinite; opacity: var(--op);
      -webkit-mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%);
      mask: radial-gradient(58% 92% at 50% 6%, #000 70%, transparent 74%)
    }
    .chama-vela .lingua::after {
      content: ""; position: absolute; left: 50%; top: 5%; transform: translateX(-50%); width: 16%; height: 38%;
      background: radial-gradient(50% 60% at 50% 40%, rgba(255,255,255,.95), rgba(255,255,255,0)); filter: blur(1px); opacity: .95; pointer-events: none
    }
    .chama-vela .lingua:nth-child(2) { width: calc(var(--largura) * .76); height: calc(var(--altura) * .86); animation-duration: 1.9s; animation-delay: .05s; filter: blur(.35px) }
    .chama-vela .lingua:nth-child(3) { width: calc(var(--largura) * .60); height: calc(var(--altura) * .74); animation-duration: 2.2s; animation-delay: .10s; filter: blur(.3px) }
    .chama-vela .brilho {
      position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: calc(var(--largura) * 1.28); height: calc(var(--altura) * 1.06);
      background: radial-gradient(circle, hsla(var(--hue), var(--satur), 72%, .36) 0%, transparent 64%); filter: blur(12px); mix-blend-mode: screen;
      animation: aura var(--pulso) ease-in-out infinite; opacity: .62; pointer-events: none
    }
    .chama-vela.pico .lingua { animation-timing-function: ease-out; transform: translateX(-50%) scaleY(1.12) skewX(1.4deg) }
    .chama-vela.fraca { --altura: 72px; --largura: 50px; --pulso: 2.6s; --glow: 10px; --hue: 36; --satur: 86%; --light: 66%; --op: .70 }
    .chama-vela.media { --altura: 94px; --largura: 60px; --pulso: 1.7s; --glow: 18px; --hue: 28; --satur: 96%; --light: 58%; --op: .98 }
    .chama-vela.forte { --altura: 112px; --largura: 66px; --pulso: 1.1s; --glow: 28px; --hue: 20; --satur: 100%; --light: 52%; --op: 1 }
    .flame-corner { position: fixed; z-index: 1200; pointer-events: none }
    .flame-top-right { top: 14px; right: 14px }
    .flame-bottom-left { bottom: 14px; left: 14px }
    #chama-header .chama-vela { --largura: 34px; --altura: 68px }
    @keyframes velaWaver {
      0%, 100% { transform: translateX(-50%) scaleY(1.00) skewX(0deg) }
      25% { transform: translateX(calc(-50% + .6px)) scaleY(1.04) skewX(.6deg) }
      50% { transform: translateX(-50%) scaleY(1.08) skewX(1.2deg) }
      75% { transform: translateX(calc(-50% - .5px)) scaleY(1.03) skewX(.4deg) }
    }
    @keyframes brasaPulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: .70 } 50% { transform: translateX(-50%) scale(1.06); opacity: 1 } }
    @keyframes aura { 0%, 100% { opacity: .50 } 50% { opacity: .82 } }
    @media (prefers-reduced-motion: reduce) {
      .chama-vela .lingua, .chama-vela .brasa, .chama-vela .brilho { animation: none !important }
    }

    /* ===== PERGAMINHO ===== */
    .pergaminho-v { background-image: url('/assets/img/pergaminho-rasgado-vert.png') !important; background-size: cover !important; background-position: center !important; min-height: 82vh !important }
    .pergaminho-h { background-image: url('/assets/img/pergaminho-rasgado-horiz.png') !important; background-size: cover !important; background-position: center !important; min-height: 82vh !important }
    .pergaminho-h.fallback { background-image: url('/assets/img/pergaminho-rasgado-vert.png') !important }
    .conteudo-pergaminho { background: transparent !important; position: relative; z-index: 10; padding: 20px; min-height: 100%; overflow: visible }

    /* ===== UI ===== */
    .btn {
      display: inline-block; padding: 12px 22px; border-radius: 10px; border: 0;
      background: #1f2937; color: #fff; font-weight: 600; text-decoration: none;
      transition: background .2s ease, transform .15s ease;
      font-family: "Berkshire Swash", cursive; font-size: 16px; line-height: 1.15;
    }
    .btn:hover { background: #374151; transform: translateY(-1px) }
    .btn-primary { background: var(--brand) }
    .btn-primary:hover { background: var(--brand-2) }
    .btn-secondary { background: #4b5563 }
    .btn-secondary:hover { background: #6b7280 }
    .btn + .btn { margin-left: 10px }
    .btn:disabled { background: #6b7280; cursor: not-allowed; transform: none }

    /* Progresso */
    .progress-badge { position: fixed; top: 16px; right: 16px; padding: 8px 16px; background: var(--brand); color: #fff; border-radius: 8px; font-size: .9rem; z-index: 900 }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 12px }
    .progress-bar-fill { height: 100%; background: var(--brand); border-radius: 4px; transition: width .25s ease }
    .j-progress { margin: 8px 0 16px }
    .j-progress__bar { width: 100%; height: 6px; background: #e5e7eb; border-radius: 4px }
    .j-progress__fill { height: 100%; background: #1f2937; border-radius: 4px; transition: width .25s ease }
    .j-progress__meta { text-align: center; margin-top: 8px; font-size: .9rem; color: var(--ink-soft) }

    .footer-actions { display: flex; gap: 12px; justify-content: center; margin: 18px 0 }

    /* DATILOGRAFIA */
    .lumen-typing { white-space: pre-wrap; position: relative }
    .lumen-typing::after { content: "▌"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2, end) infinite }
    .lumen-typing.typing-done::after { content: ""; animation: none }
    @keyframes lumenBlink { 50% { opacity: 0 } }

    /* SEÇÕES */
    .j-section { height: 100% }
    .j-bloco { background: transparent !important; display: none; z-index: 5 }
    .j-pergunta { margin-bottom: 24px; display: none; z-index: 6; position: relative }
    .j-pergunta.active { display: block }
    .pergunta-enunciado {
      display: block; margin-bottom: 6px;
      font-family: "Berkshire Swash", cursive;
      font-size: 20px; color: var(--ink);
    }
    .j-pergunta textarea {
      width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db;
      background: rgba(255,255,255,.85); resize: vertical; min-height: 100px;
      font-family: "Cardo", serif; font-size: 16px; line-height: 1.45;
    }

    /* OVERLAY DE VÍDEO */
    #videoOverlay { position: fixed; inset: 0; background: rgba(0,0,0,.85); display: flex; justify-content: center; align-items: center; z-index: 2000 }
    #videoOverlay.hidden { display: none }
    .video-player { max-width: 90vw; max-height: 80vh; background: #000 }
    .video-fallback { max-width: 90vw; max-height: 80vh; background: url('/assets/img/perfil-da-irmandade.png') center/cover no-repeat; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.2rem; text-align: center; padding: 20px; font-family: "Berkshire Swash", cursive; }

    .site-footer { text-align: center; padding: 14px; color: #555; font-size: .85rem }
    .password-form { margin-top: 16px; text-align: center }
    .password-input { position: relative }
    .password-input input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif }
    .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer }

    .section-container { position: relative; min-height: 85vh }
    .hidden { display: none !important }

    /* Guia (opcional) */
    #guia-espiritual { position: fixed; bottom: 18px; right: 18px; z-index: 1200 }
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="halo"></div><div class="gota"></div><div class="brasa"></div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <!-- INTRO -->
        <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, ative sua senha." data-speed="50" data-cursor="true"></p>

          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'Berkshire Swash',cursive;font-size:24px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">👁️</span>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-primary" data-action="start">Ativar e Iniciar</button>
            </div>
          </div>
        </div>

        <!-- PERGUNTAS -->
        <div id="section-perguntas" class="j-section hidden">
          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="halo"></div><div class="gota"></div><div class="brasa"></div>
          </div>

          <!-- progresso inline -->
          <div class="j-progress">
            <div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div>
            <div class="j-progress__meta" id="j-meta"></div>
          </div>

          <div id="perguntas-container"></div>

          <div class="footer-actions">
            <button id="btnPrevPerguntas" class="btn btn-secondary" data-action="prev">Voltar</button>
            <button id="btnNextPerguntas" class="btn btn-primary" data-action="next">Próxima</button>
          </div>
        </div>

        <!-- FINAL -->
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn btn-primary" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button id="btnRestart" class="btn btn-secondary" data-action="restart">Reiniciar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:.8rem"></div>
  </footer>

  <!-- PROGRESS (badge/topo + barra global) -->
  <div class="progress-badge" id="jprog-pct">0% concluído</div>
  <div class="container">
    <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">Áudio da jornada em reprodução. Para ver o vídeo, converta para o formato H.264 MP4 (use FFmpeg: ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4).</div>
    <button id="skipVideo" class="btn btn-secondary" style="position:absolute; top:14px; right:14px">Pular vídeo</button>
  </div>

  <!-- Guia opcional -->
  <div id="guia-espiritual" class="hidden"></div>

  <script>
  (function() {
    /* ===== Tag ambiente ===== */
    const env = document.getElementById('envTag');
    if (env) env.textContent = `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/assets`;

    /* =========================
       DATILOGRAFIA
    ========================== */
    function typeWriter(el, text, speed, showCursor) {
      if (!el) return;
      el.textContent = '';
      if (showCursor) el.classList.add('lumen-typing');
      let i = 0;
      (function step() {
        if (i < text.length) {
          el.textContent += text.charAt(i++);
          setTimeout(step, speed);
        } else {
          el.classList.add('typing-done');
        }
      })();
    }
    function runTyping(root) {
      (root || document).querySelectorAll('[data-typing]').forEach(el => {
        if (el.dataset._typed) return;
        const t = el.getAttribute('data-text') || el.textContent || '';
        const spd = parseInt(el.getAttribute('data-speed') || '26', 10);
        const cur = String(el.getAttribute('data-cursor') || 'true') === 'true';
        el.dataset._typed = '1';
        typeWriter(el, t, spd, cur);
      });
    }

    /* =========================
       CHAMA API (intensidade por classe)
    ========================== */
    function makeFlame(cls) {
      const d = document.createElement('div');
      d.className = (cls || 'chama-vela chama-md');
      d.innerHTML = '<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
      return d;
    }
    function ensureHeaderFlame() {
      const H = document.getElementById('chama-header');
      if (!H) return;
      if (!H.querySelector('.brasa')) {
        H.innerHTML = '';
        H.appendChild(makeFlame('chama-vela chama-lg'));
      }
    }
    function ensureInlineFlame(id, cls) {
      const el = document.getElementById(id);
      if (!el) return null;
      if (!el.querySelector('.brasa')) {
        el.innerHTML = '';
        el.appendChild(makeFlame(cls || 'chama-vela chama-md'));
      }
      return el.firstElementChild;
    }
    function ensurePageFlames() {
      if (!document.getElementById('flame-top-right')) {
        const f = makeFlame('chama-vela chama-md');
        f.id = 'flame-top-right';
        f.style.cssText = 'position:fixed;top:12px;right:12px;z-index:1200;';
        document.body.appendChild(f);
      }
      if (!document.getElementById('flame-bottom-left')) {
        const f = makeFlame('chama-vela chama-md');
        f.id = 'flame-bottom-left';
        f.style.cssText = 'position:fixed;bottom:12px;left:12px;z-index:1200;';
        document.body.appendChild(f);
      }
    }
    function setMode(el, score) {
      if (!el) return;
      el.classList.remove('fraca', 'media', 'forte');
      el.classList.add(score <= -2 ? 'fraca' : score >= 2 ? 'forte' : 'media');
    }

    window.JORNADA_CHAMA = window.JORNADA_CHAMA || {};
    window.JORNADA_CHAMA.updateChama = function(score) {
      const main = ensureInlineFlame('chama-perguntas', 'chama-vela chama-md');
      setMode(main, score);
      setMode(document.getElementById('flame-top-right'), score);
      setMode(document.getElementById('flame-bottom-left'), score);
    };
    window.JORNADA_CHAMA.ensureHeroFlame = function(sectionId) {
      const canvas = document.getElementById('jornada-canvas');
      if (!canvas) return;
      let hero = document.getElementById('chama-hero');
      const show = (sectionId === 'section-intro' || sectionId === 'section-final');
      if (show) {
        if (!hero) {
          hero = makeFlame('chama-vela chama-lg');
          hero.id = 'chama-hero';
          hero.style.cssText = 'position:absolute;top:8px;left:8px;z-index:60;';
          canvas.appendChild(hero);
        }
      } else if (hero) {
        hero.remove();
      }
    };
    function updateChama(score) { window.JORNADA_CHAMA.updateChama(score); }
    function ensureHeroFlame(sectionId) { window.JORNADA_CHAMA.ensureHeroFlame(sectionId); }

    /* =========================
       PROGRESSO & STORAGE
    ========================== */
    function updateProgress() {
      const perguntas = document.querySelectorAll('.j-pergunta');
      const respondidas = Array.from(perguntas).filter(p => (p.querySelector('textarea')?.value.trim() || '') !== '').length;
      const total = perguntas.length || 1;
      const progresso = Math.round((respondidas / total) * 100);

      const fill = document.getElementById('jprog-fill');
      const badge = document.getElementById('jprog-pct');
      const jFill = document.getElementById('j-fill-inline');
      const jMeta = document.getElementById('j-meta');
      if (fill) fill.style.width = progresso + '%';
      if (badge) badge.textContent = progresso + '% concluído';
      if (jFill) jFill.style.width = progresso + '%';
      if (jMeta) jMeta.textContent = `Respondidas: ${respondidas} de ${total}`;
    }
    function saveAnswers() {
      const respostas = {};
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
        respostas[`q${idx}`] = input.value || '';
      });
      localStorage.setItem('jornada_respostas', JSON.stringify(respostas));
    }
    function loadAnswers() {
      const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
        input.value = respostas[`q${idx}`] || '';
      });
      updateProgress();
    }

    /* =========================
       PERGAMINHO & SEÇÕES
    ========================== */
    function checkImage(url, fallbackUrl) {
      return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => {
          console.warn('[checkImage] Imagem não encontrada:', url, 'Usando fallback:', fallbackUrl);
          resolve(fallbackUrl);
        };
        img.src = url;
      });
    }
    function updateCanvasBackground(sectionId) {
      const canvas = document.getElementById('jornada-canvas');
      if (!canvas) return;
      if (sectionId === 'section-perguntas') {
        checkImage('/assets/img/pergaminho-rasgado-horiz.png', '/assets/img/pergaminho-rasgado-vert.png').then(bg => {
          canvas.className = `card pergaminho pergaminho-h${bg.includes('vert') ? ' fallback' : ''}`;
          canvas.style.backgroundImage = `url('${bg}')`;
        });
      } else {
        canvas.className = 'card pergaminho pergaminho-v';
        canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-vert.png)';
      }
    }
    function showSection(sectionId) {
      document.querySelectorAll('.j-section').forEach(s => s.classList.add('hidden'));
      const active = document.getElementById(sectionId);
      if (active) active.classList.remove('hidden');
      updateCanvasBackground(sectionId);
      ensureHeroFlame(sectionId);
      if (sectionId === 'section-perguntas') {
        updateProgress();
        const perguntas = document.querySelectorAll('.j-pergunta');
        if (perguntas.length) runTyping(perguntas[0]);
      }
    }

    function loadDynamicBlocks() {
      const content = document.getElementById('perguntas-container');
      if (!content) {
        console.error('[loadDynamicBlocks] Container de perguntas não encontrado!');
        return;
      }

      const blocks = window.JORNADA_BLOCKS || [];
      console.log('[loadDynamicBlocks] Carregando blocos:', blocks);
      content.innerHTML = '';

      blocks.forEach((block, idx) => {
        const bloco = document.createElement('section');
        bloco.className = 'j-bloco';
        bloco.dataset.bloco = idx;
        bloco.dataset.video = block.video_after || '';

        (block.questions || []).forEach((q, qIdx) => {
          const label = (typeof q === 'string') ? q : (q.label || q.text || '');
          const div = document.createElement('div');
          div.className = 'j-pergunta';
          div.dataset.pergunta = qIdx;
          div.innerHTML = `
            <label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx + 1}:</b> ${label}" data-speed="36" data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>
          `;
          bloco.appendChild(div);
        });

        content.appendChild(bloco);
      });

      const firstBloco = content.querySelector('.j-bloco');
      if (firstBloco) {
        firstBloco.style.display = 'block';
        const firstPergunta = firstBloco.querySelector('.j-pergunta');
        if (firstPergunta) {
          firstPergunta.classList.add('active');
          runTyping(firstPergunta);
        }
      } else {
        console.error('[loadDynamicBlocks] Nenhum bloco carregado!');
      }

      loadAnswers();
      const firstTa = content.querySelector('.j-bloco .j-pergunta textarea');
      if (firstTa) handleInput(firstTa);

      console.log('Blocos carregados! Total de blocos:', blocks.length);
    }

    /* =========================
       CONTROLES
    ========================== */
    function analyzeSentiment(text) {
      const POS = {
        'feliz': 2, 'alegria': 2, 'amor': 3, 'sucesso': 2, 'esperança': 3, 'paz': 2, 'fé': 3, 'gratidão': 2, 'vitória': 3, 'superação': 3,
        'luz': 2, 'deus': 3, 'coragem': 2, 'força': 2, 'confiança': 2, 'propósito': 3
      };
      const NEG = {
        'triste': -2, 'dor': -3, 'raiva': -2, 'medo': -2, 'frustracao': -2, 'frustração': -2, 'decepcao': -2, 'decepção': -2,
        'perda': -3, 'culpa': -2, 'ansiedade': -2, 'solidao': -2, 'solidão': -2, 'desespero': -3, 'cansaco': -2, 'cansaço': -2,
        'fracasso': -2, 'trauma': -3, 'duvida': -2, 'dúvida': -2
      };
      let score = 0;
      (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').split(/\s+/).forEach(t => {
        if (POS[t] != null) score += POS[t];
        if (NEG[t] != null) score += NEG[t];
      });
      return score;
    }
    function handleInput(textarea) {
      const score = analyzeSentiment(textarea.value);
      updateChama(score);
      saveAnswers();
      updateProgress();
    }
    function toggleSenha() {
      const input = document.getElementById('senha');
      if (!input) return;
      input.type = (input.type === 'password' ? 'text' : 'password');
    }

    let isTransitioning = false;
    let lastClickTime = 0;
    function goNext() {
      const now = Date.now();
      if (isTransitioning || now - lastClickTime < 300) {
        console.warn('[goNext] Já em transição ou clique muito rápido, ignorando. isTransitioning:', isTransitioning, 'Tempo desde último clique:', now - lastClickTime);
        return;
      }
      isTransitioning = true;
      lastClickTime = now;
      console.log('[goNext] Iniciando goNext, isTransitioning:', isTransitioning);

      const current = document.querySelector('.j-pergunta.active');
      if (!current) {
        console.error('[goNext] Nenhuma pergunta ativa encontrada!');
        isTransitioning = false;
        return;
      }

      const bloco = current.closest('.j-bloco');
      if (!bloco) {
        console.error('[goNext] Bloco não encontrado para pergunta ativa!');
        isTransitioning = false;
        return;
      }

      const perguntasDoBloco = Array.from(bloco.querySelectorAll('.j-pergunta'));
      const i = perguntasDoBloco.indexOf(current);

      console.log('[goNext] Pergunta atual:', i + 1, 'de', perguntasDoBloco.length, 'no bloco', bloco.dataset.bloco);

      current.classList.remove('active');
      if (i + 1 < perguntasDoBloco.length) {
        const prox = perguntasDoBloco[i + 1];
        prox.classList.add('active');
        runTyping(prox);
        updateProgress();
        isTransitioning = false;
        console.log('[goNext] Avançando para próxima pergunta:', i + 2);
        return;
      }

      const blocos = Array.from(document.querySelectorAll('.j-bloco'));
      const idxBloco = parseInt(bloco.dataset.bloco, 10);
      const temProx = idxBloco + 1 < blocos.length;

      console.log('[goNext] Bloco atual:', idxBloco, 'Tem próximo?', temProx, 'Total de blocos:', blocos.length);

      const irAdiante = () => {
        if (temProx) {
          blocos.forEach(b => b.style.display = 'none');
          const proxBloco = blocos[idxBloco + 1];
          if (!proxBloco) {
            console.error('[goNext] Próximo bloco não encontrado para índice:', idxBloco + 1);
            isTransitioning = false;
            return;
          }
          proxBloco.style.display = 'block';
          const primeira = proxBloco.querySelector('.j-pergunta');
          if (primeira) {
            primeira.classList.add('active');
            runTyping(primeira);
          } else {
            console.error('[goNext] Nenhuma pergunta encontrada no bloco', idxBloco + 1);
          }
          updateProgress();
          isTransitioning = false;
          console.log('[goNext] Avançando para bloco:', idxBloco + 1);
        } else {
          if (window.JORNADA_FINAL_VIDEO) {
            console.log('[goNext] Tentando tocar Filme 5:', window.JORNADA_FINAL_VIDEO);
            playTransition(window.JORNADA_FINAL_VIDEO, () => {
              showSection('section-final');
              isTransitioning = false;
            });
          } else {
            console.warn('[goNext] Nenhum Filme 5 definido, indo para página final');
            showSection('section-final');
            isTransitioning = false;
          }
          updateProgress();
          console.log('[goNext] Indo para página final');
        }
      };

      const src = (window.JORNADA_BLOCKS[idxBloco] && window.JORNADA_BLOCKS[idxBloco].video_after) || '';
      if (src) {
        console.log('[goNext] Tentando tocar vídeo do bloco', idxBloco, ':', src);
        playTransition(src, () => {
          irAdiante();
        });
      } else {
        console.warn('[goNext] Nenhum vídeo associado ao bloco', idxBloco);
        irAdiante();
      }
    }

    function goPrev() {
      const now = Date.now();
      if (isTransitioning || now - lastClickTime < 300) {
        console.warn('[goPrev] Já em transição ou clique muito rápido, ignorando. isTransitioning:', isTransitioning, 'Tempo desde último clique:', now - lastClickTime);
        return;
      }
      isTransitioning = true;
      lastClickTime = now;
      console.log('[goPrev] Iniciando goPrev, isTransitioning:', isTransitioning);

      const current = document.querySelector('.j-pergunta.active');
      if (!current) {
        console.error('[goPrev] Nenhuma pergunta ativa encontrada!');
        isTransitioning = false;
        return;
      }

      const bloco = current.closest('.j-bloco');
      if (!bloco) {
        console.error('[goPrev] Bloco não encontrado para pergunta ativa!');
        isTransitioning = false;
        return;
      }

      const perguntasDoBloco = Array.from(bloco.querySelectorAll('.j-pergunta'));
      const i = perguntasDoBloco.indexOf(current);

      console.log('[goPrev] Pergunta atual:', i + 1, 'de', perguntasDoBloco.length, 'no bloco', bloco.dataset.bloco);

      current.classList.remove('active');

      if (i - 1 >= 0) {
        const prev = perguntasDoBloco[i - 1];
        prev.classList.add('active');
        runTyping(prev);
        updateProgress();
        isTransitioning = false;
        console.log('[goPrev] Voltando para pergunta:', i);
        return;
      }

      const blocos = Array.from(document.querySelectorAll('.j-bloco'));
      const idxBloco = parseInt(bloco.dataset.bloco, 10);
      const temAnterior = idxBloco - 1 >= 0;

      console.log('[goPrev] Bloco atual:', idxBloco, 'Tem anterior?', temAnterior);

      if (temAnterior) {
        blocos.forEach(b => b.style.display = 'none');
        const ant = blocos[idxBloco - 1];
        ant.style.display = 'block';
        const ultima = ant.querySelector('.j-pergunta:last-child');
        if (ultima) {
          ultima.classList.add('active');
          runTyping(ultima);
        }
        updateProgress();
        isTransitioning = false;
        console.log('[goPrev] Voltando para bloco:', idxBloco - 1);
      } else {
        showSection('section-intro');
        isTransitioning = false;
        console.log('[goPrev] Voltando para introdução');
      }
    }

    /* =========================
       VÍDEO (overlay)
    ========================== */
    function playTransition(src, onEnd) {
      if (isTransitioning) {
        console.warn('[playTransition] Já em transição, ignorando:', src);
        return;
      }
      isTransitioning = true;
      console.log('[playTransition] Iniciando transição para:', src);

      const overlay = document.getElementById('videoOverlay');
      const video = document.getElementById('videoTransicao');
      const fallback = document.getElementById('videoFallback');
      const skip = document.getElementById('skipVideo');

      if (!overlay || !video || !fallback || !src) {
        console.warn('[playTransition] Falta overlay, vídeo, fallback ou src:', { overlay, video, fallback, src });
        alert('Erro ao carregar o vídeo. Verifique o arquivo no servidor.');
        isTransitioning = false;
        onEnd && onEnd();
        return;
      }

      window.__playingTransition = true;
      overlay.classList.remove('hidden');
      video.classList.remove('hidden');
      fallback.classList.add('hidden');
      video.pause();
      video.removeAttribute('src');
      video.load();

      video.controls = true;
      video.muted = false;
      video.playsInline = true;
      video.setAttribute('playsinline', '');
      video.setAttribute('webkit-playsinline', '');
      video.style.background = '#000';

      let ended = false;
      const cleanup = () => {
        if (ended) return;
        ended = true;
        isTransitioning = false;
        window.__playingTransition = false;
        video.pause();
        overlay.classList.add('hidden');
        video.classList.add('hidden');
        fallback.classList.add('hidden');
        video.removeAttribute('src');
        video.load();
        console.log('[playTransition] Transição concluída para:', src);
        onEnd && onEnd();
      };

      video.onerror = () => {
        console.error('[Vídeo] Erro ao carregar:', src);
        video.classList.add('hidden');
        fallback.classList.remove('hidden');
        alert('Não foi possível carregar o vídeo: ' + src + '. Converta para H.264 MP4 (ex.: ffmpeg -i input.mp4 -c:v libx264 -c:a aac output.mp4).');
        setTimeout(cleanup, 5000);
      };
      video.onended = cleanup;
      if (skip) skip.onclick = cleanup;

      video.onloadedmetadata = () => {
        console.log('[Vídeo] Metadados carregados:', src, 'Dimensões:', video.videoWidth, 'x', video.videoHeight, 'Tempo inicial:', video.currentTime);
        if (!video.videoWidth || !video.videoHeight) {
          console.warn('[Vídeo] Apenas áudio detectado:', src);
          video.classList.add('hidden');
          fallback.classList.remove('hidden');
        }
        video.currentTime = 0; // Forçar início do vídeo
        setTimeout(() => {
          video.play().catch(err => {
            console.error('[Vídeo] Falha ao reproduzir:', err);
            video.classList.add('hidden');
            fallback.classList.remove('hidden');
            setTimeout(cleanup, 5000);
          });
        }, 200); // Delay de 200ms pra garantir carregamento
      };

      video.src = src + '?t=' + Date.now(); // Evitar cache
      setTimeout(cleanup, 120000); // Timeout de 120s para vídeos longos
    }

    window.playTransition = playTransition;

    function generatePDF() {
      const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
      const doc = { content: [] };

      doc.content.push({
        text: 'Jornada Essencial - Irmandade Conhecimento com Luz',
        style: { fontSize: 20, bold: true, alignment: 'center', margin: [0, 0, 0, 20] }
      });

      Object.keys(respostas).forEach((key, idx) => {
        const pergunta = document.querySelector(`.j-pergunta[data-pergunta="${idx}"] .pergunta-enunciado`)?.textContent || `Pergunta ${idx + 1}`;
        doc.content.push(
          { text: pergunta, style: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] } },
          { text: respostas[key] || 'Sem resposta', style: { fontSize: 12, margin: [0, 0, 0, 10] } }
        );
      });

      if (window.pdfMake) {
        pdfMake.createPdf(doc).download('jornada_essencial.pdf');
      } else {
        console.error('Biblioteca pdfMake não encontrada.');
        alert('Funcionalidade de PDF não disponível. Contate o suporte.');
      }
    }

    function finalize() {
      const respostas = {};
      document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
        respostas[`q${idx}`] = input.value || '';
      });
      console.log('[JORNADA] Finalizado. Respostas:', respostas);
      localStorage.removeItem('jornada_respostas');
      setTimeout(() => location.replace('/index.html'), 1200);
    }

    function startJourney() {
      const senha = (document.getElementById('senha')?.value || '').trim().toLowerCase();
      if (!['iniciar', 'olho magico', 'olho mágico'].includes(senha)) {
        alert('Senha incorreta. Tente novamente.');
        return;
      }

      const intro = window.JORNADA_VIDEOS?.intro || '';
      console.log('[startJourney] Iniciando jornada, Filme 0:', intro);

      if (!intro || window.__introPlayed) {
        proceedToQuestions();
        return;
      }

      window.__introPlayed = true;
      playTransition(intro, () => {
        console.log('[startJourney] Filme 0 concluído, prosseguindo para perguntas');
        proceedToQuestions();
      });
    }

    function proceedToQuestions() {
      isTransitioning = false; // Resetar antes de carregar perguntas
      console.log('[proceedToQuestions] Resetando isTransitioning:', isTransitioning);
      showSection('section-perguntas');
      loadDynamicBlocks();
      const perguntas = document.querySelectorAll('.j-pergunta');
      if (perguntas.length) {
        perguntas[0].classList.add('active');
        runTyping(perguntas[0]);
        const firstTa = document.querySelector('.j-pergunta.active textarea');
        if (firstTa) handleInput(firstTa);
      } else {
        console.error('Nenhuma pergunta encontrada após loadDynamicBlocks!');
      }
      updateProgress();
      console.log('Jornada iniciada com sucesso!');
    }

    function initJornada() {
      document.addEventListener('input', (ev) => {
        const ta = ev.target.closest('.j-pergunta textarea');
        if (ta) handleInput(ta);
      });

      document.addEventListener('click', (ev) => {
        const now = Date.now();
        if (isTransitioning || now - lastClickTime < 300) {
          console.warn('[initJornada] Clique ignorado, em transição ou muito rápido. isTransitioning:', isTransitioning, 'Tempo desde último clique:', now - lastClickTime);
          return;
        }
        lastClickTime = now;

        const aNext = ev.target.closest('[data-action="next"]');
        const aPrev = ev.target.closest('[data-action="prev"]');
        const aStart = ev.target.closest('[data-action="start"]');
        const aToggle = ev.target.closest('[data-action="toggle-password"], .password-toggle');
        const aRestart = ev.target.closest('[data-action="restart"]');
        const btnPDF = ev.target.closest('[data-action="generate-pdf"]');

        if (aNext) { ev.preventDefault(); goNext(); }
        if (aPrev) { ev.preventDefault(); goPrev(); }
        if (aStart) { ev.preventDefault(); startJourney(); }
        if (aToggle) { ev.preventDefault(); toggleSenha(); }
        if (aRestart) { ev.preventDefault(); localStorage.removeItem('jornada_respostas'); location.hash = '#intro'; location.reload(); }
        if (btnPDF) { ev.preventDefault(); generatePDF(); }
      }, { capture: true });

      console.log('Controlador da jornada inicializado!');
    }

    /* ===== Blocos e vídeos ===== */
    const VIDEO_BASE = '/assets/img/';
    window.JORNADA_VIDEOS = {
      intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
      afterBlocks: {
        0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4',
        1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4',
        2: VIDEO_BASE + 'filme-3-avancando-na-jornada.mp4',
        3: VIDEO_BASE + 'filme-4-quase-no-fim.mp4'
      },
      final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
    };

    (function ensureBlocks() {
      const fallback = [
        {
          title: 'Bloco 1 — Raízes',
          questions: [{ label: 'Quem é você hoje?' }, { label: 'O que a Luz te pede agora?' }],
          video_after: window.JORNADA_VIDEOS.afterBlocks[0]
        },
        {
          title: 'Bloco 2 — Caminho',
          questions: [{ label: 'Qual verdade você precisa admitir para seguir?' }, { label: 'O que precisa ser curado neste momento?' }],
          video_after: window.JORNADA_VIDEOS.afterBlocks[1]
        },
        {
          title: 'Bloco 3 — Transformação',
          questions: [{ label: 'O que você aprendeu até agora?' }, { label: 'Como você pode crescer com isso?' }],
          video_after: window.JORNADA_VIDEOS.afterBlocks[2]
        },
        {
          title: 'Bloco 4 — Conclusão',
          questions: [{ label: 'O que você leva desta jornada?' }, { label: 'Qual é o próximo passo?' }],
          video_after: window.JORNADA_VIDEOS.afterBlocks[3]
        }
      ];

      window.JORNADA_BLOCKS = (window.JORNADA_BLOCKS || fallback).map((b, idx) => ({
        title: b.title || `Bloco ${idx + 1}`,
        questions: (b.questions || []).map(q => ({ label: typeof q === 'string' ? q : q.label || q.text || '' })),
        video_after: b.video_after || window.JORNADA_VIDEOS.afterBlocks[idx] || ''
      }));

      window.JORNADA_FINAL_VIDEO = window.JORNADA_FINAL_VIDEO || window.JORNADA_VIDEOS.final;
      console.log('JORNADA_BLOCKS normalizados:', window.JORNADA_BLOCKS);
    })();

    /* ===== Silenciar diálogos enquanto há vídeo ===== */
    (function patchDialogs() {
      const A = window.alert, C = window.confirm, P = window.prompt;
      function emTransicao() { return !!(window.__playingTransition || !document.getElementById('videoOverlay')?.classList.contains('hidden')); }
      window.alert = (m) => emTransicao() ? (console.warn('[silenced alert]', m), void 0) : A(m);
      window.confirm = (m) => emTransicao() ? (console.warn('[silenced confirm]', m), true) : C(m);
      window.prompt = (m, d) => emTransicao() ? (console.warn('[silenced prompt]', m), d || '') : P(m, d);
    })();

    /* ===== Lock do vídeo final e rota ===== */
    (function patchFinalLock() {
      const ORIG_SHOW = showSection;
      let LOCK_UNTIL = 0;
      window.showSection = function(id) {
        if (Date.now() < LOCK_UNTIL && id !== 'section-final') {
          console.warn('[FinalLock] Ignorando troca durante lock:', id);
          return;
        }
        return ORIG_SHOW.apply(this, arguments);
      };

      const ORIG_PLAY = playTransition;
      window.playTransition = function(src, onEnd) {
        const isFinal = (window.JORNADA_FINAL_VIDEO && src === window.JORNADA_FINAL_VIDEO);
        return ORIG_PLAY(src, function() {
          if (isFinal) {
            try { location.hash = '#final'; } catch (_) {}
            LOCK_UNTIL = Date.now() + 1500;
            try { ORIG_SHOW('section-final'); } catch (_) {}
          }
          onEnd && onEnd();
        });
      };
    })();

    /* ===== Boot ===== */
    function boot() {
      ensureHeaderFlame();
      ensureInlineFlame('chama-perguntas', 'chama-vela chama-md');
      ensurePageFlames();
      const route = (location.hash || '#intro').slice(1);
      if (route === 'perguntas') { showSection('section-perguntas'); loadDynamicBlocks(); }
      else if (route === 'final') { showSection('section-final'); }
      else { showSection('section-intro'); }
      runTyping(document);
    }

    document.addEventListener('DOMContentLoaded', () => {
      runTyping(document);
      initJornada();
      boot();

      const target = document.getElementById('jornada-conteudo');
      if (target) {
        const obs = new MutationObserver(muts => {
          muts.forEach(m => {
            runTyping(m.target);
            if (m.target.id === 'perguntas-container') updateProgress();
          });
        });
        obs.observe(target, { childList: true, subtree: true });
      }
    });

    // ponte global
    window.toggleSenha = toggleSenha;
    window.startJourney = startJourney;
    window.showSection = showSection;
  })();
  </script>
</body>
</html>
