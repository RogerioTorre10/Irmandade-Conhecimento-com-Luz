// Estado global
let currentBlock = 0;
let currentQuestion = 0;
let isTransitioning = false;
let videoElement = null;
let blocks = [];
let totalBlocks = 0;

// Dados dos blocos (exemplo - substitua pelos seus dados reais)
const blockData = [
    {
        video: '/assets/img/filme-0-ao-encontro-da-jornada.mp4',
        questions: [
            { id: 1, text: 'Pergunta 1 do Bloco 0' },
            { id: 2, text: 'Pergunta 2 do Bloco 0' }
        ]
    },
    {
        video: '/assets/img/filme-1-entrando-na-jornada.mp4',
        questions: [
            { id: 1, text: 'Pergunta 1 do Bloco 1' },
            { id: 2, text: 'Pergunta 2 do Bloco 1' }
        ]
    },
    // Adicione mais blocos conforme necessário
];

// Inicializa a jornada
function initJornada() {
    console.log('[initJornada] Controlador da jornada inicializado!');
    videoElement = document.getElementById('journeyVideo');
    if (!videoElement) {
        console.error('[initJornada] Elemento de vídeo não encontrado!');
        return;
    }
    loadDynamicBlocks();
    setupEventListeners();
    console.log('[Jornada] Jornada iniciada com sucesso!');
}

// Carrega os blocos dinamicamente
function loadDynamicBlocks() {
    blocks = blockData; // Substitua por chamada à API ou fonte de dados real
    totalBlocks = blocks.length;
    console.log('[loadDynamicBlocks] Carregando blocos:', blocks);
    console.log('[loadDynamicBlocks] Blocos carregados! Total de blocos:', totalBlocks);
}

// Configura os event listeners com debouncing
function setupEventListeners() {
    const btnNext = document.getElementById('btnNextPerguntas');
    if (btnNext) {
        btnNext.addEventListener('click', debounce(handleClick, 300));
    } else {
        console.error('[setupEventListeners] Botão btnNextPerguntas não encontrado!');
    }
    console.log('[initJornada] Event listeners configurados.');
}

// Função de debounce para evitar cliques múltiplos
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Trata cliques
function handleClick(event) {
    const target = {
        aNext: event.target.closest('#btnNextPerguntas'),
        aPrev: event.target.closest('#btnPrevPerguntas'),
        aStart: event.target.closest('#btnStart'),
        aToggle: event.target.closest('#btnToggle'),
        aRestart: event.target.closest('#btnRestart')
    };
    console.log('[initJornada] Clique detectado:', target);

    if (isTransitioning && target.aNext) {
        console.log('[initJornada] Clique ignorado, em transição. isTransitioning:', isTransitioning);
        return;
    }

    if (target.aNext) {
        goNext();
    } else if (target.aStart) {
        startJourney();
    }
}

// Inicia a jornada
function startJourney() {
    console.log('[startJourney] Iniciando jornada, Filme 0:', blocks[0].video);
    playTransition(blocks[0].video, true).then(() => {
        console.log('[startJourney] Filme 0 concluído, prosseguindo para perguntas');
        proceedToQuestions();
    }).catch(error => {
        console.error('[startJourney] Erro ao iniciar jornada:', error);
        isTransitioning = false; // Garante que isTransitioning seja resetado em caso de erro
    });
}

// Toca a transição de vídeo
async function playTransition(videoSrc, isFirstVideo = false) {
    if (isTransitioning) {
        console.log('[playTransition] Já em transição, ignorando:', videoSrc);
        return;
    }

    isTransitioning = true;
    console.log('[playTransition] Iniciando transição para:', videoSrc);

    try {
        if (videoElement) {
            videoElement.src = videoSrc;
            videoElement.currentTime = 0; // Garante que o vídeo comece do início
            videoElement.load();

            // Aguarda carregamento dos metadados
            await new Promise((resolve, reject) => {
                videoElement.onloadedmetadata = () => {
                    console.log('[Vídeo] Metadados carregados:', videoSrc, 'Dimensões:', videoElement.videoWidth, 'x', videoElement.videoHeight, 'Tempo inicial:', videoElement.currentTime);
                    resolve();
                };
                videoElement.onerror = () => reject(new Error('Erro ao carregar metadados do vídeo'));
            });

            // Garante que o vídeo não pule os primeiros segundos
            if (isFirstVideo) {
                videoElement.currentTime = 0; // Redundância para o vídeo inicial
                console.log('[playTransition] Forçando início do vídeo 0 em t=0');
            }

            // Inicia a reprodução
            console.log('[Vídeo] Iniciando reprodução:', videoSrc, 'Tempo atual:', videoElement.currentTime);
            await videoElement.play();

            // Aguarda o término do vídeo
            await new Promise((resolve, reject) => {
                videoElement.onended = () => {
                    console.log('[playTransition] Transição concluída para:', videoSrc);
                    resolve();
                };
                videoElement.onerror = () => reject(new Error('Erro durante a reprodução do vídeo'));
            });
        } else {
            throw new Error('Elemento de vídeo não encontrado');
        }
    } catch (error) {
        console.error('[playTransition] Erro durante a transição:', error);
        throw error;
    } finally {
        isTransitioning = false;
        console.log('[playTransition] Resetando isTransitioning:', isTransitioning);
    }
}

// Prossegue para as perguntas
function proceedToQuestions() {
    isTransitioning = false;
    console.log('[proceedToQuestions] Resetando isTransitioning:', isTransitioning);
    displayQuestion(currentBlock, currentQuestion);
}

// Exibe a pergunta (placeholder para renderização na UI)
function displayQuestion(blockIndex, questionIndex) {
    const question = blocks[blockIndex].questions[questionIndex];
    console.log(`[displayQuestion] Exibindo pergunta ${questionIndex + 1} de ${blocks[blockIndex].questions.length} no bloco ${blockIndex}: ${question.text}`);
    // Adicione sua lógica de renderização na UI aqui
}

// Navega para o próximo passo
function goNext() {
    console.log('[goNext] Iniciando goNext, isTransitioning:', isTransitioning);
    if (isTransitioning) {
        console.log('[goNext] Ignorando, em transição.');
        return;
    }

    const currentBlockQuestions = blocks[currentBlock].questions;
    console.log(`[goNext] Pergunta atual: ${currentQuestion + 1} de ${currentBlockQuestions.length} no bloco ${currentBlock}`);

    if (currentQuestion < currentBlockQuestions.length - 1) {
        currentQuestion++;
        console.log('[goNext] Avançando para próxima pergunta:', currentQuestion + 1);
        displayQuestion(currentBlock, currentQuestion);
    } else {
        console.log('[goNext] Bloco atual:', currentBlock, 'Tem próximo?', currentBlock < totalBlocks - 1, 'Total de blocos:', totalBlocks);
        if (currentBlock < totalBlocks - 1) {
            currentBlock++;
            currentQuestion = 0;
            console.log('[goNext] Tentando tocar vídeo do bloco', currentBlock, ':', blocks[currentBlock].video);
            playTransition(blocks[currentBlock].video).then(() => {
                proceedToQuestions();
            }).catch(error => {
                console.error('[goNext] Erro ao tocar próximo vídeo:', error);
                isTransitioning = false; // Reseta em caso de erro
            });
        } else {
            console.log('[goNext] Jornada concluída!');
            // Lógica para fim da jornada
        }
    }
}

// Inicializa na carga da página
document.addEventListener('DOMContentLoaded', () => {
    initJornada();
});
