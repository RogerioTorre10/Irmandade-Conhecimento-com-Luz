<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jornada ‚Ä¢ Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />

  <!-- Fonts: Google para Berkshire/Cardo (evita OTS do .ttf local) -->
  <link href="https://fonts.googleapis.com/css2?family=Berkshire+Swash&family=Cardo:wght@400;700&display=swap" rel="stylesheet" />

  <!-- ManufacturingConsent local -->
  <link rel="preload" href="/assets/fonts/ManufacturingConsent-Regular.ttf" as="font" type="font/ttf" crossorigin />

  <style>
    /* ================== FONTS ================== */
    @font-face{
      font-family:"ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight:400; font-style:normal; font-display:swap;
    }

    :root{
      --bg:#f9f9f3;
      --ink:#222;
      --ink-soft:#444;
      --brand:#6b21a8;
      --brand-2:#7c3aed;
      --panel:#f6efe0;
    }

    /* ===== BASE ===== */
    html,body{height:100%}
    body{
      margin:0;
      color:var(--ink);
      background:var(--bg);
      font-family:"ManufacturingConsent", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-size:16px;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    .container{max-width:960px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel)!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:28px;position:relative;z-index:5}

    /* ===== HEADER + CHAMA ===== */
    .site-header{
      position:relative;z-index:20;
      display:flex;align-items:center;gap:14px;
      padding:18px 16px;background:#1f2937;color:#fff;
      box-shadow:0 2px 4px rgba(0,0,0,.15);
    }
    .site-header h1{
      margin:0;font-size:28px;letter-spacing:.4px;
      font-family:"Berkshire Swash", cursive;
    }

    /* chama √≠cone (a do print antigo) */
    .chama-icone{position:relative;width:36px;height:56px;filter:drop-shadow(0 0 12px rgba(255,200,120,.65))}
    .chama-icone .halo{
      position:absolute;left:50%;top:6%;
      transform:translateX(-50%);
      width:70%;height:85%;
      background:radial-gradient(50% 65% at 50% 35%, rgba(255,255,255,.9) 0%, rgba(255,212,110,.9) 40%, rgba(255,140,0,.4) 70%, rgba(255,140,0,0) 100%);
      border-radius:60% 60% 30% 30%/90% 90% 20% 20%;
      animation:chamaWaver 1.8s ease-in-out infinite;
      -webkit-mask: radial-gradient(55% 88% at 50% 0%, #000 70%, transparent 74%);
              mask: radial-gradient(55% 88% at 50% 0%, #000 70%, transparent 74%);
    }
    .chama-icone .gota{
      position:absolute;left:50%;bottom:4px;transform:translateX(-50%);
      width:74%;height:88%;
      border-radius:62% 62% 22% 22%/92% 92% 16% 16%;
      background:
        radial-gradient(50% 58% at 50% 20%, rgba(255,255,255,.96) 0%, rgba(255,226,140,.96) 32%, rgba(255,226,140,0) 68%),
        radial-gradient(120% 150% at 50% 74%, rgba(255,140,0,.85) 0%, rgba(255,140,0,0) 70%);
      mix-blend-mode:screen; filter:blur(.4px);
      animation:chamaWaver 1.6s ease-in-out infinite;
    }
    .chama-icone .brasa{
      position:absolute;left:50%;bottom:0;transform:translateX(-50%);
      width:80%;height:10px;border-radius:50%;
      background:radial-gradient(circle at 50% 40%, rgba(255,255,255,.95) 0%, rgba(255,212,120,.9) 35%, rgba(255,212,120,0) 72%);
      filter:blur(.8px);animation:brasaPulse 1.6s ease-in-out infinite;
    }

    .chama-fixed-top{position:absolute;top:10px;right:14px;z-index:60}
    .chama-fixed-hero{position:absolute;top:-8px;left:-8px;z-index:40}
    .chama-md{transform:scale(.9)}
    .chama-icone.fraca{filter:drop-shadow(0 0 6px rgba(255,200,120,.45))}
    .chama-icone.media{filter:drop-shadow(0 0 12px rgba(255,200,120,.65))}
    .chama-icone.forte{filter:drop-shadow(0 0 18px rgba(255,200,120,.85))}

    @keyframes chamaWaver{
      0%,100%{transform:translateX(-50%) scaleY(1) skewX(.2deg)}
      50%{transform:translateX(-50%) scaleY(1.06) skewX(1deg)}
    }
    @keyframes brasaPulse{0%,100%{opacity:.7}50%{opacity:1}}

    /* ===== PERGAMINHO ===== */
    .pergaminho-v{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h{background-image:url('/assets/img/pergaminho-rasgado-horiz.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h.fallback{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important}
    .conteudo-pergaminho{background:transparent!important;position:relative;z-index:10;padding:20px;min-height:100%;overflow:visible}

    /* ===== UI ===== */
    .btn{
      display:inline-block;padding:12px 22px;border-radius:10px;border:0;
      background:#1f2937;color:#fff;font-weight:600;text-decoration:none;
      transition:background .2s ease, transform .15s ease;
      font-family:"ManufacturingConsent", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      font-size:16px; line-height:1.15;
    }
    .btn:hover{background:#374151;transform:translateY(-1px)}
    .btn-primary{background:var(--brand)}
    .btn-primary:hover{background:var(--brand-2)}
    .btn-secondary{background:#4b5563}
    .btn-secondary:hover{background:#6b7280}
    .btn + .btn{margin-left:10px}

    /* Progresso */
    .progress-badge{position:fixed;top:16px;right:16px;padding:8px 16px;background:var(--brand);color:#fff;border-radius:8px;font-size:.9rem;z-index:900}
    .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px}
    .progress-bar-fill{height:100%;background:var(--brand);border-radius:4px;transition:width .25s ease}
    .j-progress{margin:8px 0 16px}
    .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
    .j-progress__fill{height:100%;background:#1f2937;border-radius:4px;transition:width .25s ease}
    .j-progress__meta{text-align:center;margin-top:8px;font-size:.9rem;color:var(--ink-soft)}

    .footer-actions{display:flex;gap:12px;justify-content:center;margin:18px 0}

    /* DATILOGRAFIA */
    .lumen-typing{white-space:pre-wrap;position:relative}
    .lumen-typing::after{content:"‚ñå";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .lumen-typing.typing-done::after{content:"";animation:none}
    @keyframes lumenBlink{50%{opacity:0}}

    /* SE√á√ïES */
    .j-section{height:100%}
    .j-bloco{background:transparent!important;display:none;z-index:5}
    .j-pergunta{margin-bottom:24px;display:none;z-index:6;position:relative}
    .j-pergunta.active{display:block}
    .pergunta-enunciado{
      display:block;margin-bottom:6px;
      font-family:"Berkshire Swash", cursive;
      font-size:20px; color:var(--ink);
    }
    .j-pergunta textarea{
      width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;
      background:rgba(255,255,255,.85);resize:vertical;min-height:100px;
      font-family:"Cardo", serif; font-size:16px; line-height:1.45;
    }

    /* OVERLAY DE V√çDEO */
    #videoOverlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;justify-content:center;align-items:center;z-index:2000}
    #videoOverlay.hidden{display:none}
    .video-player{max-width:90vw;max-height:80vh;background:#000}

    .site-footer{text-align:center;padding:14px;color:#555;font-size:.85rem}
    .password-form{margin-top:16px;text-align:center}
    .password-input{position:relative}
    .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;font-family:"Cardo", serif}
    .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer}

    .section-container{position:relative;min-height:85vh}
    .hidden{display:none!important}

    /* Guia (opcional) */
    #guia-espiritual{position:fixed;bottom:18px;right:18px;z-index:1200}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="halo"></div><div class="gota"></div><div class="brasa"></div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <!-- INTRO -->
        <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada √© sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <p data-typing data-text="Bem-vindo(a) √† nossa casa de reflex√£o e coragem. Antes de come√ßar, ative sua senha." data-speed="50" data-cursor="true"></p>

          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'Berkshire Swash',cursive;font-size:24px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">üëÅÔ∏è</span>
            </div>
            <div style="margin-top:12px">
              <button class="btn btn-primary" data-action="start">Ativar e Iniciar</button>
            </div>
          </div>
        </div>

        <!-- PERGUNTAS -->
        <div id="section-perguntas" class="j-section hidden">
          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="halo"></div><div class="gota"></div><div class="brasa"></div>
          </div>

          <!-- progresso inline -->
          <div class="j-progress">
            <div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div>
            <div class="j-progress__meta" id="j-meta"></div>
          </div>

          <div id="perguntas-container"></div>

          <div class="footer-actions">
            <button id="btnPrevPerguntas" class="btn btn-secondary" data-action="prev">Voltar</button>
            <button id="btnNextPerguntas" class="btn btn-primary" data-action="next">Pr√≥xima</button>
          </div>
        </div>

        <!-- FINAL -->
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="Parab√©ns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions">
            <button id="btnRestart" class="btn btn-secondary" data-action="restart">Reiniciar</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>¬© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:.8rem"></div>
  </footer>

  <!-- PROGRESS (badge/topo + barra global) -->
  <div class="progress-badge" id="jprog-pct">0% conclu√≠do</div>
  <div class="container">
    <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline preload="metadata" controls></video>
    <button id="skipVideo" class="btn btn-secondary" style="position:absolute; top:14px; right:14px">Pular v√≠deo</button>
  </div>

  <!-- Guia opcional -->
  <div id="guia-espiritual" class="hidden"></div>

  <script>
  (function(){
    /* ===== Tag ambiente ===== */
    const env = document.getElementById('envTag');
    if (env) env.textContent = `layout=${document.body.dataset.layout||'master'} ¬∑ journey=${document.body.dataset.journey||'essencial'} ¬∑ path=/assets`;

    /* =========================
       DATILOGRAFIA
    ==========================*/
    function typeWriter(el,text,speed,showCursor){
      if(!el) return;
      el.textContent=''; if(showCursor) el.classList.add('lumen-typing');
      let i=0;(function step(){ if(i<text.length){ el.textContent+=text.charAt(i++); setTimeout(step,speed);} else{ el.classList.add('typing-done'); } })();
    }
    function runTyping(root){
      (root||document).querySelectorAll('[data-typing]').forEach(el=>{
        if(el.dataset._typed) return;
        const t=el.getAttribute('data-text')||el.textContent||'';
        const spd=parseInt(el.getAttribute('data-speed')||'26',10);
        const cur=String(el.getAttribute('data-cursor')||'true')==='true';
        el.dataset._typed='1'; typeWriter(el,t,spd,cur);
      });
    }

    /* =========================
       CHAMA API (intensidade por classe)
    ==========================*/
    window.JORNADA_CHAMA = {
      updateChama(score){
        const el = document.getElementById('chama-perguntas'); if(!el) return;
        el.classList.remove('fraca','media','forte');
        const modo = (score <= -2) ? 'fraca' : (score >= 2) ? 'forte' : 'media';
        el.classList.add(modo);
      },
      ensureHeroFlame(sectionId){
        const canvas=document.getElementById('jornada-canvas'); if(!canvas) return;
        let hero=document.getElementById('chama-hero');
        const show=(sectionId==='section-intro'||sectionId==='section-final');
        if(show){
          if(!hero){
            hero=document.createElement('div'); hero.id='chama-hero';
            hero.className='chama-icone chama-fixed-top';
            hero.innerHTML='<div class="halo"></div><div class="gota"></div><div class="brasa"></div>';
            canvas.appendChild(hero);
          }
        } else if(hero){ hero.remove(); }
      }
    };
    function updateChama(score){ window.JORNADA_CHAMA.updateChama(score); }
    function ensureHeroFlame(sectionId){ window.JORNADA_CHAMA.ensureHeroFlame(sectionId); }

    /* =========================
       PROGRESSO & STORAGE
    ==========================*/
    function updateProgress(){
      const perguntas=document.querySelectorAll('.j-pergunta');
      const respondidas=Array.from(perguntas).filter(p=> (p.querySelector('textarea')?.value.trim()||'') !== '').length;
      const total=perguntas.length||1;
      const progresso=Math.round((respondidas/total)*100);

      const fill=document.getElementById('jprog-fill');
      const badge=document.getElementById('jprog-pct');
      const jFill=document.getElementById('j-fill-inline');
      const jMeta=document.getElementById('j-meta');
      if(fill) fill.style.width=progresso+'%';
      if(badge) badge.textContent=progresso+'% conclu√≠do';
      if(jFill) jFill.style.width=progresso+'%';
      if(jMeta) jMeta.textContent=`Respondidas: ${respondidas} de ${total}`;
    }
    function saveAnswers(){
      const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
      localStorage.setItem('jornada_respostas',JSON.stringify(respostas));
    }
    function loadAnswers(){
      const respostas=JSON.parse(localStorage.getItem('jornada_respostas')||'{}');
      document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ input.value=respostas[`q${idx}`]||''; });
      updateProgress();
    }

    /* =========================
       PERGAMINHO & SE√á√ïES
    ==========================*/
    function checkImage(url,fallbackUrl){
      return new Promise(resolve=>{
        const img=new Image(); img.onload=()=>resolve(url); img.onerror=()=>resolve(fallbackUrl); img.src=url;
      });
    }
    function updateCanvasBackground(sectionId){
      const canvas=document.getElementById('jornada-canvas');
      if(!canvas) return;
      if(sectionId==='section-perguntas'){
        checkImage('/assets/img/pergaminho-rasgado-horiz.png','/assets/img/pergaminho-rasgado-vert.png').then(bg=>{
          canvas.className=`card pergaminho pergaminho-h${bg.includes('vert')?' fallback':''}`;
          canvas.style.backgroundImage=`url('${bg}')`;
        });
      }else{
        canvas.className='card pergaminho pergaminho-v';
        canvas.style.backgroundImage='url(/assets/img/pergaminho-rasgado-vert.png)';
      }
    }
    function showSection(sectionId){
      document.querySelectorAll('.j-section').forEach(s=>s.classList.add('hidden'));
      const active=document.getElementById(sectionId); if(active) active.classList.remove('hidden');
      updateCanvasBackground(sectionId); ensureHeroFlame(sectionId);
      if(sectionId==='section-perguntas'){
        updateProgress();
        const perguntas=document.querySelectorAll('.j-pergunta'); if(perguntas.length) runTyping(perguntas[0]);
      }
    }

    function loadDynamicBlocks(){
      const content=document.getElementById('perguntas-container');
      if(!content) return;

      const blocks = window.JORNADA_BLOCKS || [];
      content.innerHTML='';

      blocks.forEach((block,idx)=>{
        const bloco=document.createElement('section');
        bloco.className='j-bloco'; bloco.dataset.bloco=idx; bloco.dataset.video=block.video_after||'';

        (block.questions||[]).forEach((q,qIdx)=>{
          const label = (typeof q === 'string') ? q : (q.label || q.text || '');
          const div = document.createElement('div');
          div.className='j-pergunta'; div.dataset.pergunta=qIdx;
          div.innerHTML = `
            <label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx+1}:</b> ${label}" data-speed="36" data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>
          `;
          bloco.appendChild(div);
        });

        content.appendChild(bloco);
      });

      const firstBloco = content.querySelector('.j-bloco');
      if(firstBloco){
        firstBloco.style.display='block';
        const firstPergunta=firstBloco.querySelector('.j-pergunta');
        if(firstPergunta){ firstPergunta.classList.add('active'); runTyping(firstPergunta); }
      }

      loadAnswers();
      const firstTa=content.querySelector('.j-bloco .j-pergunta textarea');
      if(firstTa) handleInput(firstTa);

      console.log('Blocos carregados!');
    }

    /* =========================
       CONTROLES
    ==========================*/
    function analyzeSentiment(text){
      const POS={'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperan√ßa':3,'paz':2,'f√©':3,'gratid√£o':2,'vit√≥ria':3,'supera√ß√£o':3,'luz':2,'deus':3,'coragem':2,'for√ßa':2,'confian√ßa':2,'prop√≥sito':3};
      const NEG={'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'frustra√ß√£o':-2,'decepcao':-2,'decep√ß√£o':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'solid√£o':-2,'desespero':-3,'cansaco':-2,'cansa√ßo':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'d√∫vida':-2};
      let score=0; (text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').split(/\s+/).forEach(t=>{ if(POS[t]!=null) score+=POS[t]; if(NEG[t]!=null) score+=NEG[t]; });
      return score;
    }
    function handleInput(textarea){
      const score=analyzeSentiment(textarea.value);
      updateChama(score); saveAnswers(); updateProgress();
    }
    function toggleSenha(){
      const input=document.getElementById('senha'); if(!input) return;
      input.type = (input.type==='password' ? 'text' : 'password');
    }

  function goNext(){
  const current = document.querySelector('.j-pergunta.active');
  if (!current) return;

  const bloco = current.closest('.j-bloco');
  const perguntasDoBloco = Array.from(bloco.querySelectorAll('.j-pergunta'));
  const i = perguntasDoBloco.indexOf(current);

  // avan√ßa dentro do mesmo bloco
  current.classList.remove('active');
  if (i + 1 < perguntasDoBloco.length) {
    const prox = perguntasDoBloco[i + 1];
    prox.classList.add('active');
    runTyping(prox);
    updateProgress();
    return;
  }

  // terminou o bloco ‚Üí toca video_after (se houver) e s√≥ ent√£o mostra o pr√≥ximo bloco
  const blocos = Array.from(document.querySelectorAll('.j-bloco'));
  const idxBloco = blocos.indexOf(bloco);
  const temProx = idxBloco + 1 < blocos.length;

  const irAdiante = () => {
    if (temProx) {
      blocos.forEach(b => b.style.display = 'none');
      const proxBloco = blocos[idxBloco + 1];
      proxBloco.style.display = 'block';
      const primeira = proxBloco.querySelector('.j-pergunta');
      if (primeira) { primeira.classList.add('active'); runTyping(primeira); }
      updateProgress();
    } else {
      // acabou tudo ‚Üí v√≠deo final (se existir) e p√°gina final
      if (window.JORNADA_FINAL_VIDEO) {
        playTransition(window.JORNADA_FINAL_VIDEO, () => showSection('section-final'));
      } else {
        showSection('section-final');
      }
      updateProgress();
    }
  };

  const idx = Number(bloco.dataset.bloco || idxBloco);
  const src = (window.JORNADA_BLOCKS[idx] && window.JORNADA_BLOCKS[idx].video_after) || '';
  if (src) playTransition(src, irAdiante); else irAdiante();
}

function goPrev(){
  const current = document.querySelector('.j-pergunta.active');
  if (!current) return;

  const bloco = current.closest('.j-bloco');
  const perguntasDoBloco = Array.from(bloco.querySelectorAll('.j-pergunta'));
  const i = perguntasDoBloco.indexOf(current);

  current.classList.remove('active');

  // volta dentro do bloco
  if (i - 1 >= 0) {
    const prev = perguntasDoBloco[i - 1];
    prev.classList.add('active');
    runTyping(prev);
    updateProgress();
    return;
  }

  // volta ao bloco anterior
  const blocos = Array.from(document.querySelectorAll('.j-bloco'));
  const idxBloco = blocos.indexOf(bloco);
  const temAnterior = idxBloco - 1 >= 0;

  if (temAnterior) {
    blocos.forEach(b => b.style.display = 'none');
    const ant = blocos[idxBloco - 1];
    ant.style.display = 'block';
    const ultima = ant.querySelector('.j-pergunta:last-child');
    if (ultima) { ultima.classList.add('active'); runTyping(ultima); }
    updateProgress();
  } else {
    showSection('section-intro');
  }
}
    /* =========================
       V√çDEO (overlay)
    ==========================*/
  function playTransition(src, onEnd){
  const overlay = document.getElementById('videoOverlay');
  const video   = document.getElementById('videoTransicao');
  const skip    = document.getElementById('skipVideo');

  if (!overlay || !video || !src) { onEnd && onEnd(); return; }

  overlay.classList.remove('hidden');

  // reset
  video.pause?.();
  video.removeAttribute('src');
  video.load();

  // garantir visibilidade e compat
  video.controls = true;
  video.muted    = false;
  video.playsInline = true;
  video.setAttribute('playsinline','');
  video.setAttribute('webkit-playsinline','');
  video.style.background = '#000';       // se vier s√≥ √°udio, ainda aparece um ret√¢ngulo preto

  let ended = false;
  const cleanup = () => {
    if (ended) return; ended = true;
    try { video.pause(); } catch(_) {}
    overlay.classList.add('hidden');
    video.removeAttribute('src');
    video.load();
    try { onEnd && onEnd(); } catch(_) {}
  };

  video.onerror   = cleanup;
  video.onended   = cleanup;
  if (skip) skip.onclick = cleanup;

  video.onloadedmetadata = () => {
    // Se o arquivo vier com trilha s√≥ de √°udio (videoWidth=0), ainda mostramos o quadro
    if (!video.videoWidth || !video.videoHeight) {
      console.warn('[V√≠deo] Parece conter apenas √°udio; mantendo fundo preto.');
    }
    video.play().catch(err => {
      console.warn('[V√≠deo] play() falhou:', err);
      cleanup();
    });
  };

  video.src = src;

  // fail-safe se o onended n√£o disparar
  setTimeout(cleanup, 20000);
}

    window.playTransition = playTransition;

    function finalize(){
      const respostas={}; document.querySelectorAll('.j-pergunta textarea').forEach((input,idx)=>{ respostas[`q${idx}`]=input.value||''; });
      console.log('[JORNADA] Finalizado. Respostas:', respostas);
      localStorage.removeItem('jornada_respostas');
      setTimeout(()=>location.replace('/index.html'), 1200);
    }

    let _journeyStarted = false;
    function startJourney(){
      if(_journeyStarted) return;
      const senha=(document.getElementById('senha')?.value||'').trim().toLowerCase();
      const senhasValidas=['iniciar','olho magico','olho m√°gico'];

      if(!senhasValidas.includes(senha)){
        alert('Senha incorreta. Tente novamente.');
        return;
      }

      _journeyStarted = true;

      showSection('section-perguntas');
      loadDynamicBlocks();

      const perguntas=document.querySelectorAll('.j-pergunta');
      if(perguntas.length){
        perguntas[0].classList.add('active'); runTyping(perguntas[0]);
        const firstTa=document.querySelector('.j-pergunta.active textarea'); if(firstTa) handleInput(firstTa);
      } else { console.error('Nenhuma pergunta encontrada ap√≥s loadDynamicBlocks!'); }

      updateProgress();
      console.log('Jornada iniciada com sucesso!');
    }

    function initJornada(){
      document.addEventListener('input', (ev)=>{
        const ta = ev.target.closest('.j-pergunta textarea');
        if(ta) handleInput(ta);
      });
      /* Reiniciar na p√°gina final */
document.addEventListener('click', (ev) => {
  const rst = ev.target.closest('#btnRestart,[data-action="restart"]');
  if (!rst) return;
  ev.preventDefault();
  try { localStorage.removeItem('jornada_respostas'); } catch(_){}
  location.hash = '#intro';
  location.reload();
});

     document.addEventListener('click',(ev)=>{
  const aNext    = ev.target.closest('[data-action="next"]');
  const aPrev    = ev.target.closest('[data-action="prev"]');
  const aStart   = ev.target.closest('[data-action="start"]');
  const aToggle  = ev.target.closest('[data-action="toggle-password"], .password-toggle');
  const aRestart = ev.target.closest('[data-action="restart"]');

  if(aNext){ ev.preventDefault(); goNext(); }
  if(aPrev){ ev.preventDefault(); goPrev(); }
  if(aStart){ /* filme 0 intercepta se senha v√°lida */ startJourney(); }
  if(aToggle){ ev.preventDefault(); toggleSenha(); }
  if(aRestart){ ev.preventDefault(); location.reload(); }
});

      console.log('Controlador da jornada inicializado!');
    }

    // ===== Blocos e v√≠deos =====
    const VIDEO_BASE = '/assets/img/';
    window.JORNADA_VIDEOS = {
      intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
      afterBlocks: {
        0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4',
        1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4'
      },
      final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
    };

    (function ensureBlocks(){
      const fallback = [
        {
          title:'Bloco 1 ‚Äî Ra√≠zes',
          questions:[ {label:'Quem √© voc√™ hoje?'}, {label:'O que a Luz te pede agora?'} ],
          video_after: window.JORNADA_VIDEOS.afterBlocks[0]
        },
        {
          title:'Bloco 2 ‚Äî Caminho',
          questions:[ {label:'Qual verdade voc√™ precisa admitir para seguir?'},{label:'O que precisa ser curado neste momento?'} ],
          video_after: window.JORNADA_VIDEOS.afterBlocks[1]
        }
      ];

      const src = window.JORNADA_BLOCKS || fallback;
      window.JORNADA_BLOCKS = src.map((b,idx)=>{
        const qs = (b.questions||[]).map(q=>{
          if(typeof q==='string') return {label:q};
          if(q && typeof q==='object'){
            if('label' in q) return {label:q.label||''};
            if('text'  in q) return {label:q.text ||''};
          }
          return {label:String(q||'')};
        });
        return {
          title: b.title || `Bloco ${idx+1}`,
          questions: qs,
          video_after: b.video_after || window.JORNADA_VIDEOS.afterBlocks[idx]
        };
      });

      if(!window.JORNADA_FINAL_VIDEO && window.JORNADA_VIDEOS.final){
        window.JORNADA_FINAL_VIDEO = window.JORNADA_VIDEOS.final;
      }
      console.log('JORNADA_BLOCKS normalizados:', window.JORNADA_BLOCKS);
    })();

    /* ===== Silenciar di√°logos enquanto h√° v√≠deo ===== */
    (function patchDialogs(){
      const A=window.alert, C=window.confirm, P=window.prompt;
      function emTransicao(){ return !!(window.__playingTransition || !document.getElementById('videoOverlay')?.classList.contains('hidden')); }
      window.alert=(m)=> emTransicao()? (console.warn('[silenced alert]',m),void 0) : A(m);
      window.confirm=(m)=> emTransicao()? (console.warn('[silenced confirm]',m),true) : C(m);
      window.prompt=(m,d)=> emTransicao()? (console.warn('[silenced prompt]',m), d||'') : P(m,d);
    })();

    /* ===== Lock do v√≠deo final e rota ===== */
    (function patchFinalLock(){
      const ORIG_SHOW = showSection;
      let LOCK_UNTIL = 0;
      window.showSection = function(id){
        if(Date.now() < LOCK_UNTIL && id !== 'section-final'){
          console.warn('[FinalLock] Ignorando troca durante lock:', id);
          return;
        }
        return ORIG_SHOW.apply(this, arguments);
      };

      const ORIG_PLAY = playTransition;
      window.playTransition = function(src, onEnd){
        const isFinal = (window.JORNADA_FINAL_VIDEO && src === window.JORNADA_FINAL_VIDEO);
        return ORIG_PLAY(src, function(){
          if(isFinal){
            try{ location.hash = '#final'; }catch(_){}
            LOCK_UNTIL = Date.now() + 1500;
            try{ ORIG_SHOW('section-final'); }catch(_){}
          }
          onEnd && onEnd();
        });
      };
    })();
    
  // === FILME 0 ‚Äî roda antes de iniciar, s√≥ com senha v√°lida, e apenas 1x
 (function hookFilme0(){
  if (typeof window.playTransition !== 'function' || typeof window.startJourney !== 'function') return;

  let jaRodou = false;
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('[data-action="start"]');
    if (!btn || jaRodou) return;

    const senha = (document.getElementById('senha')?.value || '').trim().toLowerCase();
    const ok = ['iniciar','olho magico','olho m√°gico'].includes(senha);
    if (!ok) return; // deixa o startJourney avisar a senha errada

    ev.preventDefault(); ev.stopPropagation();
    jaRodou = true;

    const intro = (window.JORNADA_VIDEOS && window.JORNADA_VIDEOS.intro) || '';
    if (!intro) { try { startJourney(); } catch(_) {} return; }

    try {
      playTransition(intro, () => { try { startJourney(); } catch(_) {} });
    } catch(_) {
      try { startJourney(); } catch(_) {}
    }
  }, true);
})();
    
  /* ===== Boot ===== */
    function boot(){
      const route=(location.hash||'#intro').slice(1);
      if(route==='perguntas'){ showSection('section-perguntas'); loadDynamicBlocks(); }
      else if(route==='final'){ showSection('section-final'); }
      else{ showSection('section-intro'); }
      runTyping(document);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      runTyping(document);
      initJornada();
      boot();

      const target=document.getElementById('jornada-conteudo');
      if(target){
        const obs=new MutationObserver(muts=>{
          muts.forEach(m=>{
            runTyping(m.target);
            if(m.target.id==='perguntas-container') updateProgress();
          });
        });
        obs.observe(target,{childList:true,subtree:true});
      }

     /* Chama do header (t√≠tulo) sempre montada */
(function ensureHeaderFlame(){
  const H = document.getElementById('chama-header');
  if (!H) return;
  H.classList.add('chama-icone');
  if (!H.querySelector('.halo')) {
    H.innerHTML = '<div class="halo"></div><div class="gota"></div><div class="brasa"></div>';
  }
})();

      // ponte global
      window.toggleSenha = toggleSenha;
      window.startJourney = startJourney;
      window.showSection = showSection;
    });
  })();
  </script>
</body>
</html>
