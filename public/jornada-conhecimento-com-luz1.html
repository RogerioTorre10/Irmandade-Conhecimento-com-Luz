<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Jornada â€¢ Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png" />
    <link href="https://fonts.googleapis.com/css2?family=Cardo:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="preload" href="/assets/fonts/ManufacturingConsent-Regular.ttf" as="font" type="font/ttf" crossorigin />
  <link rel="preload" href="/assets/fonts/BerkshireSwash-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

  <style>
    @font-face {
      font-family: "ManufacturingConsent";
      src: url("/assets/fonts/ManufacturingConsent-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "BerkshireSwash";
      src: url("/assets/fonts/BerkshireSwash-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Cardo";
      src: url("/assets/fonts/Cardo-Regular.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    :root { --bg: #1a1a1a; --ink: #000; --ink-soft: #555; --panel: #1a1a1a }

    html, body { height: 100%; box-sizing: border-box }
    body {
      margin: 0; color: #fff; background: var(--bg);
      font-family: "BerkshireSwash", cursive;
      font-size: 22px; line-height: 1.6; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    .container { max-width: 960px; margin: 24px auto; padding: 0 16px }
    .card { background: var(--panel) !important; border-radius: 14px; box-shadow: 0 8px 28px rgba(0,0,0,.12); padding: 28px; position: relative; z-index: 5 }

    /* Header + chama */
    .site-header { display: flex; align-items: center; justify-content: center; padding: 16px; background: transparent }
    .chama-icone { position: relative; width: 18px; height: 36px; display: flex; align-items: flex-end; margin-right: 12px }
    .chama-icone > * { position: static }
    .site-header h1 { font-family: "ManufacturingConsent"; font-size: 36px; color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); margin: 0 }

    /* Chama */
    .chama-vela { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98; position: relative; width: var(--largura); height: var(--altura); display: inline-block; filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.75)) }
    .chama-vela.chama-md { --largura: 40px; --altura: 90px }
    .chama-vela.chama-lg { --largura: 30px; --altura: 60px }
    .chama-vela .brasa { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.4); height: 10px; border-radius: 50% 50% 40% 40%; background: radial-gradient(circle at 50% 40%, hsla(var(--hue),var(--satur),95%,.95) 0%, hsla(var(--hue),var(--satur),70%,.85) 50%, transparent 80%); filter: blur(1px); animation: brasaPulse var(--pulso) ease-in-out infinite; opacity: var(--op) }
    .chama-vela .lingua { position: absolute; left: 50%; bottom: 2px; transform: translateX(-50%); width: calc(var(--largura)*1.0); height: calc(var(--altura)*1.0); border-radius: 50% 50% 4% 4%; background: radial-gradient(ellipse at center, rgba(255,190,0,.95) 0%, rgba(255,69,0,.75) 50%, rgba(230,10,10,.3) 70%, transparent 100%); mix-blend-mode: screen; filter: blur(.7px); transform-origin: 50% 100%; animation: velaWaver 1.2s ease-in-out infinite; opacity: var(--op); -webkit-mask: radial-gradient(60% 90% at 50% 4%, #000 65%, transparent 69%) }
    .chama-vela .lingua:nth-child(2) { width: calc(var(--largura)*.92); height: calc(var(--altura)*.95); animation-duration: 1.5s; animation-delay: .08s; filter: blur(.6px) }
    .chama-vela .lingua:nth-child(3) { width: calc(var(--largura)*.78); height: calc(var(--altura)*.85); animation-duration: 1.8s; animation-delay: .15s; filter: blur(.5px) }
    .chama-vela .brilho { position: absolute; left: 50%; bottom: 0; transform: translateX(-50%); width: calc(var(--largura)*1.7); height: calc(var(--altura)*1.5); background: radial-gradient(circle, hsla(var(--hue),var(--satur),72%,.55) 0%, transparent 70%); filter: blur(9px); mix-blend-mode: screen; animation: aura var(--pulso) ease-in-out infinite; opacity: .85; pointer-events: none }
    .chama-vela.fraca { --altura: 35px; --largura: 25px; --pulso: 1.6s; --glow: 5px; --hue: 36; --satur: 86%; --light: 66%; --op: .70 }
    .chama-vela.media { --altura: 45px; --largura: 30px; --pulso: 1.2s; --glow: 8px; --hue: 28; --satur: 96%; --light: 58%; --op: .98 }
    .chama-vela.forte { --altura: 55px; --largura: 35px; --pulso: .7s; --glow: 11px; --hue: 20; --satur: 100%; --light: 52%; --op: 1 }
    .flame-corner { position: fixed; z-index: 1200; pointer-events: none }
    .flame-bottom-right { bottom: 20px; right: 20px }
    #chama-header .chama-vela { --largura: 30px; --altura: 60px }
    @keyframes velaWaver { 0%, 100% { transform: translateX(-50%) scaleY(1.00) skewX(0deg) } 25% { transform: translateX(calc(-50% + .7px)) scaleY(1.12) skewX(1.4deg) } 50% { transform: translateX(-50%) scaleY(1.20) skewX(2.2deg) } 75% { transform: translateX(calc(-50% - .6px)) scaleY(1.10) skewX(1.2deg) } }
    @keyframes brasaPulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: .85 } 50% { transform: translateX(-50%) scale(1.14); opacity: 1 } }
    @keyframes aura { 0%, 100% { opacity: .75 } 50% { opacity: 1 } }
    @media (prefers-reduced-motion: reduce) { .chama-vela .lingua, .chama-vela .brasa, .chama-vela .brilho { animation: none !important } }

    /* Selfie */
    .selfie-row { display: grid; grid-template-columns: 1fr 1.3fr; gap: 16px; align-items: start }
    .selfie-left .selfie-controls { display: flex; flex-direction: column; gap: 10px; margin: 12px 0 }
    .selfie-left label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .selfie-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 6px }
    .muted { color: var(--ink-soft); font-size: 18px; font-family: "BerkshireSwash", cursive }
    .selfie-right { position: relative }
    .guide-card {
      position: relative; width: min(720px, 92vw); aspect-ratio: 2/3;
      margin: 24px auto; border-radius: 16px; overflow: hidden;
      background: #0f3b2f; box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .guide-bg {
      position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover;
    }
    .flame-layer {
      position: absolute; inset: 0;
      display: grid; place-items: center;
      opacity: 0; transition: opacity 900ms ease-in-out;
      pointer-events: none;
    }
    .flame-svg {
      width: 48%; height: 72%;
      transform: translateY(30%);
      filter: drop-shadow(0 8px 28px rgba(255,180,0,.45));
    }
    .client-name {
      position: absolute; bottom: 3.5%; left: 0; right: 0; text-align: center;
      font-family: "Cardo", serif; font-weight: 700; letter-spacing: .06em;
      font-size: clamp(48px, 8vw, 80px); color: #f7d37a; text-shadow: 0 2px 8px rgba(0,0,0,.4);
    }
    .controls {
      position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%);
      display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;
      padding: .5rem .75rem; border-radius: 12px; background: rgba(0,0,0,.25);
      backdrop-filter: blur(4px);
    }
    .controls input, .controls button {
      font: 500 16px/1.2 system-ui, sans-serif; padding: .55rem .7rem; border-radius: 10px; border: 0;
    }
    .controls button { cursor: pointer; }
    #selfieError { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); color: #fff; font-size: 20px; text-align: center; padding: 10px; background: #000; border-radius: 8px; display: none; font-family: "BerkshireSwash", cursive }
    @media (max-width: 860px) {
      .selfie-row { grid-template-columns: 1fr }
      .selfie-right { max-width: 100%; margin-top: 16px }
      .guide-card { max-width: 100% }
      .flame-svg { width: 60%; height: 60% }
      .client-name { font-size: clamp(36px, 6vw, 60px) }
    }
    /* === SELFIE DENTRO DA CHAMA (MÃSCARA) === */
    .flame-frame {
      position: relative;
      width: min(720px, 92vw);
      aspect-ratio: 3/4;
      margin: 24px auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .flame-mask {
      position: absolute;
      width: 48%;
      height: 72%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -20%);
      pointer-events: none;
      -webkit-mask-image: url('/assets/img/chama-mask.png');
      mask-image: url('/assets/img/chama-mask.png');
      -webkit-mask-size: contain;
      mask-size: contain;
      -webkit-mask-position: center;
      mask-position: center;
      -webkit-mask-repeat: no-repeat;
      mask-repeat: no-repeat;
      overflow: hidden;
    }
    .flame-mask img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
      transform: translateZ(0);
    }
    /* Esconder SVG para nÃ£o duplicar */
    .flame-svg { display: none; }

    /* Escolha do guia */
    .guia-container { margin-top: 20px; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; background: #000; color: #fff; text-align: center }
    .guia-container p { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .guia-options { display: flex; gap: 10px; justify-content: center; margin-top: 12px }
    .guia-options button { padding: 8px 16px; font-size: 20px }
    .guia-name-input { margin: 12px 0 }
    .guia-name-input label { display: flex; flex-direction: column; gap: 6px; font-weight: 600; font-size: 20px; color: #fff; background: #000; padding: 12px; border-radius: 8px; font-family: "BerkshireSwash", cursive }
    .guia-name-input input { padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; text-transform: uppercase }

    /* Chat */
    .grok-chat-container { display: none; background: #000; color: #fff; padding: 16px; border-radius: 8px }
    .grok-chat-message.grok { background: transparent; text-align: left; font-size: 20px; white-space: pre-wrap; position: relative; color: #fff; font-family: "Cardo", serif }
    .grok-chat-message.grok::after { content: "â–Œ"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .grok-chat-message.grok.typing-done::after { content: ""; animation: none }
    .grok-chat-input { display: none }
    .devolutiva-text { margin-top: 16px; font-family: "Cardo", serif; font-size: 20px; color: #fff }

    /* Pergaminho */
    .pergaminho-v { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h { background: var(--panel) url('/assets/img/pergaminho-rasgado-horiz.png') no-repeat center/cover !important; min-height: 82vh !important }
    .pergaminho-h.fallback { background: var(--panel) url('/assets/img/pergaminho-rasgado-vert.png') no-repeat center/cover !important }
    .conteudo-pergaminho { background: transparent !important; position: relative; z-index: 10; padding: 20px; min-height: 100%; overflow: visible; color: #fff; box-sizing: border-box; max-width: 100% }
    .conteudo-pergaminho h2, .conteudo-pergaminho h3, .conteudo-pergaminho .pergunta-enunciado { color: #fff; text-shadow: 0 0 10px hsla(28,96%,60%,.7); font-size: 28px; font-family: "ManufacturingConsent" }
    .conteudo-pergaminho p, .conteudo-pergaminho small, .conteudo-pergaminho li { font-size: 20px; color: #fff; font-family: "BerkshireSwash", cursive }
    .conteudo-pergaminho p[data-typing], .conteudo-pergaminho small[data-typing], .conteudo-pergaminho li[data-typing] { white-space: pre-wrap; position: relative }
    .conteudo-pergaminho p[data-typing]::after, .conteudo-pergaminho small[data-typing]::after, .conteudo-pergaminho li[data-typing]::after { content: "â–Œ"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .conteudo-pergaminho p[data-typing].typing-done::after, .conteudo-pergaminho small[data-typing].typing-done::after, .conteudo-pergaminho li[data-typing].typing-done::after { content: ""; animation: none }
    @media (max-width: 600px) {
      .conteudo-pergaminho { padding: 16px }
      .conteudo-pergaminho h2, .conteudo-pergaminho h3 { font-size: 24px }
      .conteudo-pergaminho p, .conteudo-pergaminho li, .conteudo-pergaminho small { font-size: 18px; line-height: 1.5; color: #fff }
      .conteudo-pergaminho ul { padding-left: 20px }
    }

    /* UI */
    .btn {
      display: inline-block;
      padding: 14px 24px;
      border-radius: 10px;
      border: 0;
      color: #fff;
      font-weight: 600;
      text-decoration: none;
      transition: background 0.2s ease, transform 0.15s ease;
      font-family: "BerkshireSwash", cursive;
      font-size: 20px;
      line-height: 1.15;
      background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      border: 3px solid #4a4a4a;
      border-radius: 12px 8px 15px 10px;
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6);
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .btn:hover {
      background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover;
      background-blend-mode: overlay;
      transform: translateY(-2px);
      box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 8px 16px rgba(0,0,0,0.7);
    }
    .btn+.btn { margin-left: 10px }
    .btn:disabled { background: #6b7280; cursor: not-allowed; transform: none }

    /* Progresso */
    .progress-container { margin: 16px 0; text-align: center }
    .progress-badge { padding: 8px 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; color: #fff; border-radius: 8px; font-size: 20px; border: 3px solid #4a4a4a; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .progress-bar { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; margin-top: 12px }
    .progress-bar-fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress { margin: 8px 0 16px }
    .j-progress__bar { width: 100%; height: 6px; background: #e5e7eb; border-radius: 4px }
    .j-progress__fill { height: 100%; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border-radius: 4px; transition: width .25s ease }
    .j-progress__meta { text-align: center; margin-top: 8px; font-size: 20px; color: var(--ink-soft); font-family: "BerkshireSwash", cursive }

    .footer-actions { display: flex; gap: 12px; justify-content: center; margin: 32px 0 }

    /* Datilografia */
    .lumen-typing { white-space: pre-wrap; position: relative }
    .lumen-typing::after { content: "â–Œ"; margin-left: 2px; opacity: .75; animation: lumenBlink 1s steps(2,end) infinite }
    .lumen-typing.typing-done::after { content: ""; animation: none }
    @keyframes lumenBlink { 50% { opacity: 0 } }

    /* SeÃ§Ãµes */
    .j-section { height: 100% }
    .j-bloco { background: transparent !important; display: none; z-index: 5 }
    .j-pergunta { margin-bottom: 24px; display: none; z-index: 6; position: relative }
    .j-pergunta.active { display: block }
    .pergunta-enunciado { display: block; margin-bottom: 6px; font-family: "ManufacturingConsent"; font-size: 28px; color: #fff }
    .j-pergunta textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #000; color: #fff; resize: vertical; min-height: 100px; font-family: "Cardo", serif; font-size: 20px; line-height: 1.45 }

    /* Acessibilidade: Microfone e Ãudio */
    .accessibility-controls { display: flex; gap: 10px; margin-top: 8px }
    .btn-mic, .btn-audio, .btn-clear { padding: 8px 16px; font-size: 16px; background: linear-gradient(to bottom, #a0a0a0, #808080), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay; border: 3px solid #4a4a4a; border-radius: 8px; cursor: pointer; color: #fff; box-shadow: inset 0 3px 6px rgba(0,0,0,0.4), 0 6px 12px rgba(0,0,0,0.6); text-shadow: 1px 1px 3px rgba(0,0,0,0.7); font-family: "BerkshireSwash", cursive }
    .btn-mic:hover, .btn-audio:hover, .btn-clear:hover { background: linear-gradient(to bottom, #b0b0b0, #909090), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-mic.recording { background: linear-gradient(to bottom, #ff6666, #cc3333), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }
    .btn-audio.muted { background: linear-gradient(to bottom, #6b7280, #5a6268), url('/assets/img/textura-de-pedra.jpg') center/cover; background-blend-mode: overlay }

    /* Seletor de Idioma */
    .language-selector { position: absolute; top: 10px; right: 10px; z-index: 100 }
    .language-selector select { padding: 8px; font-size: 18px; border-radius: 8px; background: #000; color: #fff; font-family: "BerkshireSwash", cursive }

    /* VÃ­deo overlay */
    #videoOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #000; display: flex; justify-content: center; align-items: center; z-index: 2000 }
    #videoOverlay.hidden { display: none }
    .video-player { width: 100vw; height: 100vh; object-fit: contain; background: #000; transform: rotate(0deg) }
    @media (orientation: portrait) {
      .video-player { width: 100vw; height: 100%; max-height: 100vh; object-fit: contain }
    }
    .video-fallback { width: 100vw; height: 100vh; background: url('/assets/img/perfil-da-irmandade.png') no-repeat center/cover; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; text-align: center; padding: 20px; font-family: "BerkshireSwash", cursive }

    .site-footer { text-align: center; padding: 14px; color: var(--ink-soft); font-size: 20px; font-family: "BerkshireSwash", cursive }
    .password-form { margin-top: 16px; text-align: center }
    .password-input { position: relative }
    .password-input input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-family: "Cardo", serif; font-size: 20px; background: #000; color: #fff }
    .password-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; color: #fff }

    .section-container { position: relative; min-height: 85vh }
    .hidden { display: none !important }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0 }

    /* Toast */
    #toast { position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%); background: #111; color: #fff; padding: 10px 14px; border-radius: 10px; box-shadow: 0 6px 18px rgba(0,0,0,.35); font-size: 18px; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity .25s ease; font-family: "BerkshireSwash", cursive }
    #toast.show { opacity: 1 }

    /* Highlight para efeito de leitura */
    [data-typing] { position: relative; }
    .highlight { position: absolute; background-color: rgba(255, 255, 0, 0.3); height: 1.2em; top: 0; left: 0; transition: width 0.1s; pointer-events: none; width: 0; }
  </style>
</head>
<body data-layout="master" data-journey="essencial">
    <div class="language-selector">
    <select id="language-select">
      <option value="pt-BR">PortuguÃªs (BR)</option>
      <option value="en-US">English (US)</option>
      <option value="es-ES">EspaÃ±ol (ES)</option>
    </select>
  </div>

  <header class="site-header">
    <div id="chama-header" class="chama-icone" aria-hidden="true">
      <div class="chama-vela chama-lg">
        <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
      </div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <div class="section-container container">
    <section id="jornada-canvas" class="card pergaminho pergaminho-v">
      <div id="jornada-conteudo" class="conteudo-pergaminho">
        <div id="aria-pergunta" class="sr-only" aria-live="polite"></div>

                <div id="section-intro" class="j-section">
          <p data-typing data-text="Respire. Esta jornada Ã© sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
          <div class="footer-actions"><button class="btn" data-action="next-termos">AvanÃ§ar</button></div>
        </div>
        <div id="section-termos" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Jornada Conhecimento com Luz - Essencial</h2>
            <div id="termos-pg1">
              <p data-typing data-text="Bem-vindo(a) Ã  nossa casa de reflexÃ£o e coragem. Antes de comeÃ§ar, leia os termos abaixo." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="AVISO IMPORTANTE â€“ LEIA ANTES DE INICIAR" data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Esta Ã© uma jornada pessoal, simbÃ³lica e inspiradora. Para proteger sua privacidade e garantir uma experiÃªncia Ã©tica, leia com atenÃ§Ã£o:" data-speed="50" data-cursor="true"></p>
              <ul>
                <li data-typing data-text="Suas respostas nÃ£o serÃ£o armazenadas apÃ³s o tÃ©rmino." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Ao final, serÃ¡ gerado um PDF exclusivo com suas respostas e a devolutiva simbÃ³lica do Lumen." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="O PDF nÃ£o Ã© enviado por e-mail. FaÃ§a o download imediatamente apÃ³s a geraÃ§Ã£o." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="ApÃ³s a entrega do PDF, todos os dados sÃ£o apagados automaticamente e sem possibilidade de recuperaÃ§Ã£o." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next">PrÃ³xima pÃ¡gina</button>
              </div>
            </div>
            <div id="termos-pg2" class="hidden">
              <ul>
                <li data-typing data-text="Acesso por senha individual, com prazos:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="15 dias para iniciar a jornada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="24 horas para concluir, a partir do primeiro acesso." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next2">PrÃ³xima pÃ¡gina</button>
              </div>
            </div>
            <div id="termos-pg3" class="hidden">
              <h3 style="margin-top:0;">Termo de Responsabilidade e Consentimento Consciente</h3>
              <ul>
                <li data-typing data-text="Responsabilidade Pessoal: As respostas fornecidas refletem sua visÃ£o de mundo, sentimentos e experiÃªncias pessoais." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="CarÃ¡ter NÃ£o TerapÃªutico: Esta jornada nÃ£o substitui acompanhamento psicolÃ³gico, psiquiÃ¡trico, mÃ©dico ou terapÃªutico. NÃ£o hÃ¡ diagnÃ³stico, prescriÃ§Ã£o ou orientaÃ§Ã£o clÃ­nica." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="Neutralidade Religiosa: Respeitamos todas as crenÃ§as e tradiÃ§Ãµes. O convite Ã© para um diÃ¡logo interior conforme sua prÃ³pria fÃ© e consciÃªncia." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next3">PrÃ³xima pÃ¡gina</button>
              </div>
            </div>
            <div id="termos-pg4" class="hidden">
              <ul>
                <li data-typing data-text="Autonomia do Participante:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="VocÃª decide quando iniciar (dentro do prazo de 15 dias)." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="ApÃ³s usar a senha, hÃ¡ atÃ© 24 horas corridas para concluir." data-speed="50" data-cursor="true"></li>
                </ul>
                <li data-typing data-text="Conduta Respeitosa com a IA Guia:" data-speed="50" data-cursor="true"></li>
                <ul>
                  <li data-typing data-text="Os Guias sÃ£o IA com percepÃ§Ã£o humanizada." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="Mantenha linguagem cordial; evite ofensas e xingamentos." data-speed="50" data-cursor="true"></li>
                  <li data-typing data-text="A forma de se comunicar com os Guias reflete o respeito por si mesmo(a)." data-speed="50" data-cursor="true"></li>
                </ul>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="termos-next4">PrÃ³xima pÃ¡gina</button>
              </div>
            </div>
            <div id="termos-pg5" class="hidden">
              <ul>
                <li data-typing data-text="Privacidade e SeguranÃ§a: Os dados transitam apenas para gerar o PDF final. NÃ£o hÃ¡ criaÃ§Ã£o de conta nem envio de e-mails. ApÃ³s o encerramento, os dados locais do navegador podem ser removidos por vocÃª a qualquer momento." data-speed="50" data-cursor="true"></li>
                <li data-typing data-text="ConcordÃ¢ncia: Ao prosseguir, vocÃª declara estar ciente e de acordo com todas as condiÃ§Ãµes descritas." data-speed="50" data-cursor="true"></li>
              </ul>
              <div class="footer-actions">
                <button class="btn" data-action="next-senha">Aceito e quero continuar</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-senha" class="j-section hidden">
          <div class="password-form">
            <h3 style="margin:.2rem 0 1rem;font-family:'ManufacturingConsent';font-size:28px;">Ative sua Senha</h3>
            <div class="password-input">
              <input type="password" id="senha" placeholder="Digite sua senha..." />
              <span class="password-toggle" data-action="toggle-password">ğŸ‘ï¸</span>
            </div>
            <div style="margin-top:12px"><button class="btn" data-action="start">Ativar e Iniciar</button></div>
          </div>
        </div>

                <div id="section-guia" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Escolha seu Guia</h2>
            <div class="guia-container">
              <p data-typing data-text="Zion (Grok): Curioso e direto, busca respostas profundas com visÃ£o cÃ³smica." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Lumen (ChatGPT): Acolhedor e reflexivo, guia com empatia e clareza." data-speed="50" data-cursor="true"></p>
              <p data-typing data-text="Arian (Gemini): Criativo e versÃ¡til, inspira com perspectivas inovadoras." data-speed="50" data-cursor="true"></p>
              <div class="guia-name-input">
                <label for="guiaNameInput">Seu Nome</label>
                <input id="guiaNameInput" type="text" placeholder="Digite seu nome para a jornada...">
              </div>
              <div class="guia-options">
                <button class="btn" data-action="select-guia" data-guia="zion">Escolher Zion</button>
                <button class="btn" data-action="select-guia" data-guia="lumen">Escolher Lumen</button>
                <button class="btn" data-action="select-guia" data-guia="arian">Escolher Arian</button>
              </div>
            </div>
          </div>
        </div>

                <div id="section-selfie" class="j-section hidden">
          <div class="conteudo-pergaminho">
            <h2 style="margin-top:0;">Entre na Irmandade</h2>
            <p data-typing data-text="FaÃ§a uma foto ou envie da galeria. Ajuste e gere sua imagem com seu guia." data-speed="50" data-cursor="true"></p>
            <div class="selfie-row">
              <div class="selfie-left">
                <label class="btn" for="selfieInput">ğŸ“¸ Tirar Foto</label>
                <input id="selfieInput" type="file" accept="image/*" capture="user" style="display:none" />
                <div class="selfie-controls">
                  <label>Zoom <input id="selfieScale" type="range" min="0.8" max="2.5" step="0.01" value="1"></label>
                  <label>Horizontal <input id="selfieOffsetX" type="range" min="-50" max="50" step="1" value="0"></label>
                  <label>Vertical <input id="selfieOffsetY" type="range" min="-50" max="50" step="1" value="0"></label>
                  <small class="muted" data-typing data-text="Dica: alinhe seu rosto na chama ao lado do guia." data-speed="50" data-cursor="true"></small>
                </div>
                <div class="selfie-actions">
                  <button id="previewBtn" class="btn">âœ¨ Ver PrÃ©via</button>
                  <button id="captureBtn" class="btn">â¬‡ï¸ Confirmar e Baixar</button>
                  <button id="btnSkipSelfie" class="btn" data-action="skip-selfie">Pular Foto/Iniciar</button>
                </div>
              </div>
              <div class="selfie-right">
                <section id="card-guide" class="guide-card" data-guide="ZION" aria-label="Guia">
                  <img class="guide-bg" id="guideBg" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
                  <div class="flame-layer" aria-hidden="true">
                    <svg class="flame-svg" viewBox="0 0 100 150" preserveAspectRatio="xMidYMid meet">
                      <defs>
                        <clipPath id="flameClip">
                          <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" />
                        </clipPath>
                        <radialGradient id="flameGlow" cx="50%" cy="70%" r="55%">
                          <stop offset="0%" stop-color="rgba(255, 224, 130, 1)"/>
                          <stop offset="55%" stop-color="rgba(255, 180, 0, 0.9)"/>
                          <stop offset="100%" stop-color="rgba(255, 180, 0, 0)"/>
                        </radialGradient>
                      </defs>
                      <image id="selfieImage" href="" x="15" y="35" width="70" height="90" clip-path="url(#flameClip)" preserveAspectRatio="xMidYMid slice" />
                      <ellipse cx="50" cy="95" rx="28" ry="40" fill="url(#flameGlow)"></ellipse>
                      <path d="M50,20 C42,35 34,45 33,58 C32,73 41,82 50,92 C59,82 68,73 67,58 C66,45 58,35 50,20 Z" fill="none" stroke="rgba(255,200,0,.85)" stroke-width="1.6"/>
                    </svg>
                  </div>
                  <div class="client-name" id="clientNameSlot"></div>
                </section>
                <div id="selfieError" class="selfie-error">Erro ao carregar a prÃ©-visualizaÃ§Ã£o. Tente novamente ou pule.</div>
                <small class="muted" data-typing data-text="PrÃ©-visualizaÃ§Ã£o" data-speed="50" data-cursor="true"></small>
            </div>
          </div>
        </div>

                <div id="section-perguntas" class="j-section hidden">
          <div class="progress-container">
            <div class="progress-badge" id="jprog-pct">0% concluÃ­do</div>
            <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
            <div class="j-progress"><div class="j-progress__bar"><div class="j-progress__fill" id="j-fill-inline"></div></div><div class="j-progress__meta" id="j-meta"></div></div>
          </div>

          <div id="chama-perguntas" class="chama-icone chama-fixed-hero media" aria-hidden="true">
            <div class="chama-vela chama-md"><div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div></div>
          </div>

          <div id="perguntas-container"></div>

                    <div id="grok-chat" class="grok-chat-container">
            <div id="grok-chat-messages"></div>
            <div class="grok-chat-input">
              <input id="grok-chat-input" type="text" placeholder="Fale com seu guia..." />
              <button class="btn" data-action="send-chat">Enviar</button>
            </div>
          </div>

          <div class="footer-actions">
            <button id="btnSpeakAnswer" class="btn btn-mic" data-action="start-mic">ğŸ¤ Falar Resposta</button>
            <button id="btnClearAnswer" class="btn btn-clear" data-action="clear-answer">ğŸ—‘ï¸ Apagar Resposta</button>
            <button id="btnNextPerguntas" class="btn" data-action="next">â¡ï¸ AvanÃ§ar</button>
            <button id="btnMute" class="btn btn-audio" data-action="mute">ğŸ”‡ Silenciar</button>
          </div>
        </div>
        <div id="section-final" class="j-section hidden">
          <p data-typing data-text="ParabÃ©ns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
         <div class="selfie-final" style="text-align:center; margin-top:20px;">
  <div class="flame-frame" id="selfieResult">
    <img id="resultBackground" src="/assets/img/irmandade-quarteto-bg-zion.jpeg" alt="Guia Background">
    <div class="flame-mask">
      <img id="selfieInFlame" alt="Selfie na chama">
    </div>
    <div class="client-name" id="clientNameSlotFinal"></div>
  </div>
</div>

          <p style="margin-top:12px;"><small data-typing data-text="Sua imagem foi unida Ã  Irmandade." data-speed="50" data-cursor="true"></small></p>
          <div class="footer-actions">
            <button id="btnGeneratePDF" class="btn" data-action="generate-pdf">Gerar PDF/HQ</button>
            <button class="btn" data-action="download-selfie">Baixar Imagem</button>
            <button id="btnRestart" class="btn" data-action="restart">Voltar ao Portal</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <footer class="site-footer">
    <small>Â© 2025 Irmandade Conhecimento com Luz</small>
    <div id="envTag" style="margin-top:6px;opacity:.6;font-size:20px;"></div>
  </footer>

    <div id="videoOverlay" class="hidden">
    <video id="videoTransicao" class="video-player" playsinline controls></video>
    <div id="videoFallback" class="video-fallback hidden">Ãudio da jornada em reproduÃ§Ã£o. Converta para H.264 MP4.</div>
    <button id="skipVideo" class="btn" style="position:absolute; top:14px; right:14px">Pular vÃ­deo</button>
  </div>

    <div id="flame-bottom-right" class="flame-corner flame-bottom-right">
    <div class="chama-vela chama-md">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
  </div>

    <div id="toast" role="status" aria-live="polite" class="hidden"></div>
  
 <script>
(function(){
Â  /* ===== util: toast + erro global ===== */
Â  function toast(msg) {
Â  Â  try {
Â  Â  Â  const t = document.getElementById('toast');
Â  Â  Â  if(!t) return;
Â  Â  Â  t.textContent = msg;
Â  Â  Â  t.classList.remove('hidden');
Â  Â  Â  t.classList.add('show');
Â  Â  Â  setTimeout(() => { t.classList.remove('show'); }, 3000);
Â  Â  } catch(_) {}
Â  }
Â  window.addEventListener('error', (e) => {
Â  Â  console.error('[Erro global]', e?.error || e);
Â  Â  toast('Opsâ€¦ algo falhou, mas jÃ¡ seguimos em frente.');
Â  });

Â  /* ===== env tag ===== */
Â  const env = document.getElementById('envTag');
Â  if(env) env.textContent = `layout=${document.body.dataset.layout || 'master'} Â· journey=${document.body.dataset.journey || 'essencial'} Â· path=/assets`;

Â  /* ===== datilografia ===== */
Â  function typeWriter(el, text, speed, showCursor) {
Â  Â  if(!el) return Promise.resolve();
Â  Â  el.textContent = '';
Â  Â  if(showCursor) el.classList.add('lumen-typing');
Â  Â  let i = 0;
Â  Â  return new Promise(resolve => {
Â  Â  Â  function step() {
Â  Â  Â  Â  if(i < text.length) {
Â  Â  Â  Â  Â  el.textContent += text.charAt(i++);
Â  Â  Â  Â  Â  setTimeout(step, speed);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  el.classList.add('typing-done');
Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  step();
Â  Â  });
Â  }
Â  async function runTyping(root) {
Â  Â  if(!root || root.classList.contains('hidden')) return;
Â  Â  const elements = Array.from(root.querySelectorAll('[data-typing]'));
Â  Â  for (const el of elements) {
Â  Â  Â  if (el.dataset.typed) continue;
Â  Â  Â  const t = dedupe(el.getAttribute('data-text') || el.textContent || '');
Â  Â  Â  const spd = parseInt(el.getAttribute('data-speed') || '26', 10);
Â  Â  Â  const cur = String(el.getAttribute('data-cursor') || 'true') === 'true';
Â  Â  Â  await typeWriter(el, t, spd, cur);
Â  Â  Â  el.dataset.typed = '1';
Â  Â  Â  if(!window.isMuted && !el.closest('textarea')) {
Â  Â  Â  Â  await new Promise(r => setTimeout(r, 500));
Â  Â  Â  Â  readAloud(t, (localStorage.getItem('JORNADA_GUIA') === 'zion' ? 'male' : 'female'));
Â  Â  Â  }
Â  Â  }
Â  }

Â  /* ===== datilografia no placeholder e respostas ===== */
Â  let __abortTypingPlaceholder = null;
Â  async function typePlaceholder(inp, text, speed = 22) {
Â  Â  if(!inp) return;
Â  Â  if(__abortTypingPlaceholder) __abortTypingPlaceholder();
Â  Â  let abort = false;
Â  Â  __abortTypingPlaceholder = () => abort = true;
Â  Â  inp.placeholder = '';
Â  Â  const aria = document.getElementById('aria-pergunta');
Â  Â  if(aria) aria.textContent = text;
Â  Â  for(let i = 0; i <= text.length; i++) {
Â  Â  Â  if(abort) break;
Â  Â  Â  inp.placeholder = text.slice(0, i) + (i < text.length ? 'â–Œ' : '');
Â  Â  Â  await new Promise(r => setTimeout(r, speed));
Â  Â  }
Â  Â  if(!abort) inp.placeholder = text;
Â  }
Â  async function typeAnswer(textarea, text, speed = 36) {
Â  Â  if(!textarea) return;
Â  Â  textarea.value = '';
Â  Â  textarea.classList.add('lumen-typing');
Â  Â  for(let i = 0; i <= text.length; i++) {
Â  Â  Â  textarea.value = text.slice(0, i);
Â  Â  Â  await new Promise(r => setTimeout(r, speed));
Â  Â  }
Â  Â  textarea.classList.remove('lumen-typing');
Â  Â  textarea.classList.add('typing-done');
Â  }
Â  async function typeDevolutiva(div, text, speed = 36) {
Â  Â  if(!div) return;
Â  Â  div.textContent = '';
Â  Â  div.classList.add('lumen-typing');
Â  Â  for(let i = 0; i <= text.length; i++) {
Â  Â  Â  div.textContent = text.slice(0, i);
Â  Â  Â  await new Promise(r => setTimeout(r, speed));
Â  Â  }
Â  Â  div.classList.add('typing-done');
Â  Â  if(!window.isMuted) readAloud(text, (localStorage.getItem('JORNADA_GUIA') === 'zion' ? 'male' : 'female'));
Â  }

Â  /* ===== chamas ===== */
Â  function makeFlame(cls) {
Â  Â  const d = document.createElement('div');
Â  Â  d.className = (cls || 'chama-vela chama-md');
Â  Â  d.innerHTML = '<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
Â  Â  return d;
Â  }
Â  function ensureHeaderFlame() {
Â  Â  const H = document.getElementById('chama-header');
Â  Â  if(!H) return;
Â  Â  if(!H.querySelector('.brasa')) {
Â  Â  Â  H.innerHTML = '';
Â  Â  Â  H.appendChild(makeFlame('chama-vela chama-lg'));
Â  Â  }
Â  }
Â  function ensureInlineFlame(id, cls) {
Â  Â  const el = document.getElementById(id);
Â  Â  if(!el) return null;
Â  Â  if(!el.querySelector('.brasa')) {
Â  Â  Â  el.innerHTML = '';
Â  Â  Â  el.appendChild(makeFlame(cls || 'chama-vela chama-md'));
Â  Â  }
Â  Â  return el.firstElementChild;
Â  }
Â  function ensurePageFlames() {
Â  Â  if(!document.getElementById('flame-bottom-right')) {
Â  Â  Â  const f = makeFlame('chama-vela chama-md');
Â  Â  Â  f.id = 'flame-bottom-right';
Â  Â  Â  f.style.cssText = 'position:fixed;bottom:12px;right:12px;z-index:1200;';
Â  Â  Â  document.body.appendChild(f);
Â  Â  }
Â  }
Â  function setMode(el, score) {
Â  Â  if(!el) return;
Â  Â  el.classList.remove('fraca', 'media', 'forte');
Â  Â  el.classList.add(score <= -2 ? 'fraca' : score >= 2 ? 'forte' : 'media');
Â  }
Â  window.JORNADA_CHAMA = window.JORNADA_CHAMA || {};
Â  window.JORNADA_CHAMA.updateChama = function(score) {
Â  Â  const main = ensureInlineFlame('chama-perguntas', 'chama-vela chama-md');
Â  Â  setMode(main, score);
Â  Â  setMode(document.getElementById('flame-bottom-right'), score);
Â  };
Â  window.JORNADA_CHAMA.ensureHeroFlame = function(sectionId) {
Â  Â  const canvas = document.getElementById('jornada-canvas');
Â  Â  if(!canvas) return;
Â  Â  let hero = document.getElementById('chama-hero');
Â  Â  const show = (sectionId === 'section-intro' || sectionId === 'section-termos' || sectionId === 'section-senha' || sectionId === 'section-final' || sectionId === 'section-selfie' || sectionId === 'section-guia');
Â  Â  if(show) {
Â  Â  Â  if(!hero) {
Â  Â  Â  Â  hero = makeFlame('chama-vela chama-lg');
Â  Â  Â  Â  hero.id = 'chama-hero';
Â  Â  Â  Â  hero.style.cssText = 'position:absolute;top:8px;left:8px;z-index:60;';
Â  Â  Â  Â  canvas.appendChild(hero);
Â  Â  Â  }
Â  Â  } else if(hero) {
Â  Â  Â  hero.remove();
Â  Â  }
Â  };
Â  function updateChama(score) {
Â  Â  window.JORNADA_CHAMA.updateChama(score);
Â  }
Â  function ensureHeroFlame(sectionId) {
Â  Â  window.JORNADA_CHAMA.ensureHeroFlame(sectionId);
Â  }

Â  /* ===== selfie ===== */
Â  (function() {
Â  Â  const $ = s => document.querySelector(s);
Â  Â  const card = $("#card-guide");
Â  Â  const clientNameEl = $("#clientNameSlot");
Â  Â  const clientNameFinal = $("#clientNameSlotFinal");
Â  Â  const flameLayer = $("#card-guide .flame-layer");
Â  Â  const selfieImg = $("#selfieImage");
Â  Â  const bgImg = $("#guideBg");
Â  Â  const resultBg = $("#resultBackground");
Â  Â  const selfieInFlame = $("#selfieInFlame");
Â  Â  const fileInput = $("#selfieInput");
Â  Â  const previewBtn = $("#previewBtn");
Â  Â  const captureBtn = $("#captureBtn");
Â  Â  const errorDiv = $("#selfieError");
Â  Â  const scaleInput = $("#selfieScale");
Â  Â  const offsetXInput = $("#selfieOffsetX");
Â  Â  const offsetYInput = $("#selfieOffsetY");

Â  Â  let selfieURL = '';

Â  Â  function getBgUrl() {
Â  Â  Â  const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
Â  Â  Â  card.dataset.guide = guia.toUpperCase();
Â  Â  Â  return `/assets/img/irmandade-quarteto-bg-${guia}.jpeg`;
Â  Â  }

Â  Â  function loadBg() {
Â  Â  Â  const bgUrl = getBgUrl();
Â  Â  Â  bgImg.src = bgUrl;
Â  Â  Â  resultBg.src = bgUrl;
Â  Â  Â  bgImg.onload = () => {
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'none';
Â  Â  Â  };
Â  Â  Â  bgImg.onerror = () => {
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'block';
Â  Â  Â  Â  toast('Erro ao carregar a imagem de fundo do guia.');
Â  Â  Â  };
Â  Â  }

Â  Â  function updatePreview() {
Â  Â  Â  const scale = parseFloat(scaleInput.value);
Â  Â  Â  const ox = parseFloat(offsetXInput.value);
Â  Â  Â  const oy = parseFloat(offsetYInput.value);
Â  Â  Â  const baseX = 15 + ox;
Â  Â  Â  const baseY = 35 + oy;
Â  Â  Â  const baseW = 70 * scale;
Â  Â  Â  const baseH = 90 * scale;
Â  Â  Â  selfieImg.setAttribute('x', baseX);
Â  Â  Â  selfieImg.setAttribute('y', baseY);
Â  Â  Â  selfieImg.setAttribute('width', baseW);
Â  Â  Â  selfieImg.setAttribute('height', baseH);
Â  Â  Â  selfieInFlame.style.transform = `scale(${scale}) translate(${ox}px, ${oy}px)`;
Â  Â  Â  clientNameEl.textContent = localStorage.getItem('JORNADA_NOME')?.toUpperCase() || '';
Â  Â  Â  clientNameFinal.textContent = localStorage.getItem('JORNADA_NOME')?.toUpperCase() || '';
Â  Â  }

Â  Â  scaleInput.addEventListener('input', updatePreview);
Â  Â  offsetXInput.addEventListener('input', updatePreview);
Â  Â  offsetYInput.addEventListener('input', updatePreview);

Â  Â  fileInput.addEventListener('change', () => {
Â  Â  Â  const f = fileInput.files?.[0];
Â  Â  Â  if(!f) return;
Â  Â  Â  if(selfieURL) URL.revokeObjectURL(selfieURL);
Â  Â  Â  selfieURL = URL.createObjectURL(f);
Â  Â  Â  selfieImg.setAttribute('href', selfieURL);
Â  Â  Â  selfieInFlame.src = selfieURL;
Â  Â  Â  if(errorDiv) errorDiv.style.display = 'none';
Â  Â  Â  updatePreview();
Â  Â  });

Â  Â  previewBtn.addEventListener('click', async () => {
Â  Â  Â  if(!selfieImg.getAttribute('href')) {
Â  Â  Â  Â  toast('Selecione uma selfie antes.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  updatePreview();
Â  Â  Â  flameLayer.style.opacity = 1;
Â  Â  });

Â  Â  captureBtn.addEventListener('click', async () => {
Â  Â  Â  if(!selfieImg.getAttribute('href')) {
Â  Â  Â  Â  toast('Selecione uma selfie antes.');
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  updatePreview();
Â  Â  Â  flameLayer.style.opacity = 1;
Â  Â  Â  await new Promise(r => requestAnimationFrame(r));

Â  Â  Â  const canvas = document.createElement('canvas');
Â  Â  Â  const rect = card.getBoundingClientRect();
Â  Â  Â  const scale = window.devicePixelRatio || 1;
Â  Â  Â  canvas.width = Math.round(rect.width * scale);
Â  Â  Â  canvas.height = Math.round(rect.height * scale);
Â  Â  Â  const ctx = canvas.getContext('2d');

Â  Â  Â  const load = (src) => new Promise((res, rej) => {
Â  Â  Â  Â  const im = new Image();
Â  Â  Â  Â  im.crossOrigin = 'anonymous';
Â  Â  Â  Â  im.onload = () => res(im);
Â  Â  Â  Â  im.onerror = rej;
Â  Â  Â  Â  im.src = src;
Â  Â  Â  });

Â  Â  Â  const bg = await load(bgImg.currentSrc || bgImg.src).catch(() => {
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'block';
Â  Â  Â  Â  toast('Erro ao carregar a imagem de fundo.');
Â  Â  Â  Â  return;
Â  Â  Â  });
Â  Â  Â  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

Â  Â  Â  const W = canvas.width, H = canvas.height;
Â  Â  Â  const fw = 0.48 * W, fh = 0.72 * H, fx = (W - fw) / 2, fy = (H - fh) / 2 + 0.20 * H;

Â  Â  Â  const grad = ctx.createRadialGradient(fx + fw / 2, fy + fh * 0.65, fh * 0.02, fx + fw / 2, fy + fh * 0.65, fh * 0.55);
Â  Â  Â  grad.addColorStop(0, 'rgba(255,224,130,1)');
Â  Â  Â  grad.addColorStop(0.55, 'rgba(255,180,0,0.9)');
Â  Â  Â  grad.addColorStop(1, 'rgba(255,180,0,0)');
Â  Â  Â  ctx.fillStyle = grad;
Â  Â  Â  ctx.beginPath();
Â  Â  Â  ctx.ellipse(fx + fw / 2, fy + fh * 0.65, fw * 0.35, fh * 0.45, 0, 0, Math.PI * 2);
Â  Â  Â  ctx.fill();

Â  Â  Â  function flamePath(ctx, x, y, w, h) {
Â  Â  Â  Â  ctx.beginPath();
Â  Â  Â  Â  ctx.moveTo(x + 0.50 * w, y + 0.133 * h);
Â  Â  Â  Â  ctx.bezierCurveTo(x + 0.42 * w, y + 0.233 * h, x + 0.34 * w, y + 0.300 * h, x + 0.33 * w, y + 0.387 * h);
Â  Â  Â  Â  ctx.bezierCurveTo(x + 0.32 * w, y + 0.487 * h, x + 0.41 * w, y + 0.547 * h, x + 0.50 * w, y + 0.613 * h);
Â  Â  Â  Â  ctx.bezierCurveTo(x + 0.59 * w, y + 0.547 * h, x + 0.68 * w, y + 0.487 * h, x + 0.67 * w, y + 0.387 * h);
Â  Â  Â  Â  ctx.bezierCurveTo(x + 0.66 * w, y + 0.233 * h, x + 0.58 * w, y + 0.233 * h, x + 0.50 * w, y + 0.133 * h);
Â  Â  Â  }

Â  Â  Â  ctx.save();
Â  Â  Â  flamePath(ctx, fx, fy, fw, fh);
Â  Â  Â  ctx.clip();

Â  Â  Â  const selfie = await load(selfieImg.getAttribute('href')).catch(() => {
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'block';
Â  Â  Â  Â  toast('Erro ao carregar a selfie.');
Â  Â  Â  Â  return;
Â  Â  Â  });

Â  Â  Â  const selfieScaleVal = parseFloat(scaleInput.value);
Â  Â  Â  const ox = parseFloat(offsetXInput.value);
Â  Â  Â  const oy = parseFloat(offsetYInput.value);
Â  Â  Â  const svgScaleX = fw / 100;
Â  Â  Â  const svgScaleY = fh / 150;

Â  Â  Â  let coverRatio = Math.max(fw / selfie.width, fh / selfie.height) * selfieScaleVal;
Â  Â  Â  let sw = selfie.width * coverRatio;
Â  Â  Â  let sh = selfie.height * coverRatio;
Â  Â  Â  let sx = fx + (fw - sw) / 2 + ox * svgScaleX;
Â  Â  Â  let sy = fy + (fh - sh) / 2 + oy * svgScaleY;

Â  Â  Â  ctx.drawImage(selfie, sx, sy, sw, sh);
Â  Â  Â  ctx.restore();

Â  Â  Â  ctx.strokeStyle = 'rgba(255,200,0,.85)';
Â  Â  Â  ctx.lineWidth = Math.max(1.2, W * 0.0022);
Â  Â  Â  flamePath(ctx, fx, fy, fw, fh);
Â  Â  Â  ctx.stroke();

Â  Â  Â  ctx.fillStyle = '#f7d37a';
Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  ctx.font = `bold ${Math.round(W * 0.11)}px Cardo, serif`;
Â  Â  Â  ctx.textBaseline = 'bottom';
Â  Â  Â  ctx.fillText(localStorage.getItem('JORNADA_NOME')?.toUpperCase() || '', W / 2, H * 0.965);

Â  Â  Â  const dataURL = canvas.toDataURL('image/png');
Â  Â  Â  try {
Â  Â  Â  Â  localStorage.setItem('IRMANDADE_SELFIE_FINAL', dataURL);
Â  Â  Â  Â  selfieInFlame.src = dataURL;
Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  a.href = dataURL;
Â  Â  Â  Â  a.download = `jornada-${card.dataset.guide.toLowerCase()}-${Date.now()}.png`;
Â  Â  Â  Â  a.click();
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'none';
Â  Â  Â  } catch(_) {
Â  Â  Â  Â  if(errorDiv) errorDiv.style.display = 'block';
Â  Â  Â  Â  toast('Erro ao salvar ou baixar a imagem.');
Â  Â  Â  }
Â  Â  });

Â  Â  loadBg();
Â  })();

Â  /* ===== chat com guia ===== */
Â  async function sendChatMessage() {
Â  Â  const input = document.getElementById('grok-chat-input');
Â  Â  const messagesDiv = document.getElementById('grok-chat-messages');
Â  Â  if(!input || !messagesDiv) return;
Â  Â  const userMessage = input.value.trim();
Â  Â  if(!userMessage) return;

Â  Â  const tokens = userMessage.split(/\s+/).length;
Â  Â  if(tokens > 100) {
Â  Â  Â  const guiaMsg = document.createElement('div');
Â  Â  Â  guiaMsg.className = 'grok-chat-message grok';
Â  Â  Â  guiaMsg.textContent = 'Por favor, limite sua mensagem a 100 palavras.';
Â  Â  Â  messagesDiv.appendChild(guiaMsg);
Â  Â  Â  messagesDiv.scrollTop = messagesDiv.scrollHeight;
Â  Â  Â  return;
Â  Â  }

Â  Â  const userMsg = document.createElement('div');
Â  Â  userMsg.className = 'grok-chat-message user';
Â  Â  userMsg.textContent = userMessage;
Â  Â  messagesDiv.appendChild(userMsg);

Â  Â  const currentQuestion = document.querySelector('.j-pergunta.active .pergunta-enunciado')?.textContent || '';
Â  Â  const currentAnswer = document.querySelector('.j-pergunta.active textarea')?.value || '';
Â  Â  const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
Â  Â  const blocoIdx = document.querySelector('.j-bloco[style*="display: block"]')?.dataset.bloco || 0;
Â  Â  const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
Â  Â  const context = { currentQuestion, currentAnswer, respostas, blocoIdx, progresso: document.getElementById('jprog-pct')?.textContent || '0% concluÃ­do', guia };

Â  Â  const guiaConfigs = window.guiaConfigs || {
Â  Â  Â  zion: { apiUrl: 'https://zion-backend-api.onrender.com/v1/chat', model: 'grok', voice: 'male' },
Â  Â  Â  lumen: { apiUrl: 'https://lumen-backend-api.onrender.com/v1/chat', model: 'gpt-5', voice: 'female' },
Â  Â  Â  arian: { apiUrl: 'https://arion-backend-api.onrender.com/v1/chat', model: 'gemini', voice: 'female' }
Â  Â  };
Â  Â  const cfg = guiaConfigs[guia] || guiaConfigs.lumen;

Â  Â  try {
Â  Â  Â  const system = `VocÃª Ã© ${guia === 'zion' ? 'Zion (Grok)' : guia === 'arian' ? 'Arian (Gemini)' : 'Lumen (ChatGPT)'} guiando a Jornada. Contexto: ` + JSON.stringify(context);
Â  Â  Â  const resp = await fetch(cfg.apiUrl, {
Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  model: cfg.model,
Â  Â  Â  Â  Â  messages: [{ role: 'system', content: system }, { role: 'user', content: userMessage }],
Â  Â  Â  Â  Â  temperature: 0.7
Â  Â  Â  Â  })
Â  Â  Â  });
Â  Â  Â  if(!resp.ok) throw new Error('API falhou: ' + resp.status);
Â  Â  Â  const data = await resp.json();
Â  Â  Â  const guiaMessage = data?.choices?.[0]?.message?.content || data?.message?.content || 'TÃ´ pronto pra te guiar! Como posso ajudar?';
Â  Â  Â  const guiaMsg = document.createElement('div');
Â  Â  Â  guiaMsg.className = 'grok-chat-message grok';
Â  Â  Â  messagesDiv.appendChild(guiaMsg);
Â  Â  Â  await typeWriter(guiaMsg, guiaMessage, 36, true);
Â  Â  Â  if(!window.isMuted) readAloud(guiaMessage, cfg.voice);
Â  Â  Â  messagesDiv.scrollTop = messagesDiv.scrollHeight;
Â  Â  } catch(e) {
Â  Â  Â  console.error('[Chat] erro', e);
Â  Â  Â  const guiaMsg = document.createElement('div');
Â  Â  Â  guiaMsg.className = 'grok-chat-message grok';
Â  Â  Â  await typeWriter(guiaMsg, 'Ops, nÃ£o consegui me conectar ao guia. Tenta novamente ou pula pra prÃ³xima pergunta.', 36, true);
Â  Â  Â  if(!window.isMuted) readAloud('Ops, nÃ£o consegui me conectar ao guia. Tenta novamente ou pula pra prÃ³xima pergunta.', cfg.voice);
Â  Â  Â  messagesDiv.appendChild(guiaMsg);
Â  Â  Â  messagesDiv.scrollTop = messagesDiv.scrollHeight;
Â  Â  }
Â  Â  input.value = '';
Â  }

Â  /* ===== util: remove duplicaÃ§Ãµes de letras e espaÃ§os, mantendo a integridade de ss, rr, etc. ===== */
Â  function dedupe(s='') {
Â  Â  return s
Â  Â  Â  .normalize('NFC')
Â  Â  Â  .replace(/\s{2,}/g, ' ')
Â  Â  Â  .replace(/([^\p{L}\p{N}])\1+/gu, '$1')
Â  Â  Â  .trim();
Â  }

Â  /* ===== rotas candidatas p/ fallback ===== */
Â  const CHAT_PATHS = [
Â  Â  '/v1/chat',
Â  Â  '/v1/chat/completions',
Â  Â  '/v1/completions',
Â  Â  '/chat',
Â  Â  '/chat/completions'
Â  ];

Â  /* ===== bases e modelos padrÃ£o ===== */
Â  const GUIDE_BASES = {
Â  Â  lumen: 'https://lumen-backend-api.onrender.com',
Â  Â  zion:Â  'https://zion-backend-api.onrender.com',
Â  Â  arian: 'https://arion-backend-api.onrender.com'
Â  };
Â  const GUIDE_MODELS = {
Â  Â  lumen: 'gpt-5',
Â  Â  zion:Â  'grok',
Â  Â  arian: 'gemini'
Â  };

Â  /* ===== devolutiva da API ===== */
Â  async function fetchDevolutiva(pergunta, resposta, guia, maxRetries = 3, retryDelay = 1000) {
Â  Â  const g = (guia || 'lumen').toLowerCase();
Â  Â  const cfgWin = (window.guiaConfigs && window.guiaConfigs[g]) || {};
Â  Â  const rawBase = cfgWin.apiUrlBase || cfgWin.apiUrl || GUIDE_BASES[g] || GUIDE_BASES.lumen;
Â  Â  const base = (rawBase || '').replace(/\/(v1\/chat|v1\/chat\/completions|v1\/completions|chat|chat\/completions)\/?$/,'');
Â  Â  const model = cfgWin.model || GUIDE_MODELS[g] || GUIDE_MODELS.lumen;

Â  Â  const quem = g === 'zion' ? 'Zion (Grok)' : (g === 'arian' ? 'Arian (Gemini)' : 'Lumen (ChatGPT)');
Â  Â  const payload = {
Â  Â  Â  model,
Â  Â  Â  messages: [
Â  Â  Â  Â  { role: 'system', content: `VocÃª Ã© ${quem} guiando a Jornada. ForneÃ§a uma devolutiva acolhedora, reflexiva e simbÃ³lica.` },
Â  Â  Â  Â  { role: 'user', content: `Pergunta: ${dedupe(pergunta)}\nResposta: ${resposta ?? '(vazia)'}` }
Â  Â  Â  ],
Â  Â  Â  temperature: 0.7,
Â  Â  Â  meta: { guia: g.toUpperCase() }
Â  Â  };

Â  Â  for (let attempt = 1; attempt <= maxRetries; attempt++) {
Â  Â  Â  console.log(`[Devolutiva] Tentativa ${attempt} para pergunta: "${dedupe(pergunta)}"`);
Â  Â  Â  for (const path of CHAT_PATHS) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const r = await fetch(`${base}${path}`, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload),
Â  Â  Â  Â  Â  Â  mode: 'cors',
Â  Â  Â  Â  Â  Â  credentials: 'omit'
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  if (r.ok) {
Â  Â  Â  Â  Â  Â  const data = await r.json();
Â  Â  Â  Â  Â  Â  const devolutiva = data?.content || data?.choices?.[0]?.message?.content || 'Obrigado por compartilhar. Sua reflexÃ£o ilumina o caminho.';
Â  Â  Â  Â  Â  Â  console.log('[Devolutiva] Sucesso:', devolutiva);
Â  Â  Â  Â  Â  Â  return devolutiva;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (r.status !== 404) throw new Error(`HTTP ${r.status} @ ${path}`);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  console.error('[Devolutiva] Erro na tentativa:', e);
Â  Â  Â  Â  Â  if (attempt === maxRetries && path === CHAT_PATHS[CHAT_PATHS.length-1]) {
Â  Â  Â  Â  Â  Â  console.error('[Devolutiva] falhou:', e);
Â  Â  Â  Â  Â  Â  const msg = `NÃ£o consegui conectar ao guia ${g}. Verifique sua conexÃ£o ou tente novamente mais tarde.`;
Â  Â  Â  Â  Â  Â  toast(msg);
Â  Â  Â  Â  Â  Â  if (!window.isMuted) readAloud(msg, (cfgWin.voice || 'female'));
Â  Â  Â  Â  Â  Â  return msg;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  await new Promise(res => setTimeout(res, retryDelay));
Â  Â  }
Â  }

Â  /* ===== progresso & storage ===== */
Â  function updateProgress() {
Â  Â  const perguntas = document.querySelectorAll('.j-pergunta');
Â  Â  const respondidas = Array.from(perguntas).filter(p => (p.querySelector('textarea')?.value.trim() || '') !== '').length;
Â  Â  const total = perguntas.length || 1;
Â  Â  const pct = Math.round((respondidas / total) * 100);
Â  Â  const fill = document.getElementById('jprog-fill');
Â  Â  const badge = document.getElementById('jprog-pct');
Â  Â  const jFill = document.getElementById('j-fill-inline');
Â  Â  const jMeta = document.getElementById('j-meta');
Â  Â  if(fill) fill.style.width = `${pct}%`;
Â  Â  if(badge) badge.textContent = `${pct}% concluÃ­do`;
Â  Â  if(jFill) jFill.style.width = `${pct}%`;
Â  Â  if(jMeta) jMeta.textContent = `Respondidas: ${respondidas} de ${total}`;
Â  }

Â  function saveAnswers() {
Â  Â  const respostas = {};
Â  Â  document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
Â  Â  Â  const text = input.value.trim();
Â  Â  Â  const tokens = text.split(/\s+/).length;
Â  Â  Â  if(tokens > 100) {
Â  Â  Â  Â  input.value = text.split(/\s+/).slice(0, 100).join(' ');
Â  Â  Â  Â  toast('Resposta limitada a 100 palavras.');
Â  Â  Â  }
Â  Â  Â  respostas[`q${idx}`] = input.value || '';
Â  Â  });
Â  Â  try {
Â  Â  Â  localStorage.setItem('jornada_respostas', JSON.stringify(respostas));
Â  Â  } catch(_) {}
Â  }

Â  function loadAnswers() {
Â  Â  const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
Â  Â  document.querySelectorAll('.j-pergunta textarea').forEach((input, idx) => {
Â  Â  Â  const savedText = respostas[`q${idx}`] || '';
Â  Â  Â  if(savedText) {
Â  Â  Â  Â  input.value = savedText;
Â  Â  Â  }
Â  Â  });
Â  Â  updateProgress();
Â  }

Â  /* ===== pergaminho & seÃ§Ãµes ===== */
Â  function checkImage(url, fallbackUrl) {
Â  Â  return new Promise(resolve => {
Â  Â  Â  const img = new Image();
Â  Â  Â  img.onload = () => resolve(url);
Â  Â  Â  img.onerror = () => resolve(fallbackUrl);
Â  Â  Â  img.src = url;
Â  Â  });
Â  }

Â  function updateCanvasBackground(sectionId) {
Â  Â  const canvas = document.getElementById('jornada-canvas');
Â  Â  if(!canvas) return;
Â  Â  if(sectionId === 'section-perguntas') {
Â  Â  Â  checkImage('/assets/img/pergaminho-rasgado-horiz.png', '/assets/img/pergaminho-rasgado-vert.png').then(bg => {
Â  Â  Â  Â  canvas.className = `card pergaminho pergaminho-h${bg.includes('vert') ? ' fallback' : ''}`;
Â  Â  Â  Â  canvas.style.background = `var(--panel) url('${bg}') no-repeat center/cover`;
Â  Â  Â  });
Â  Â  } else {
Â  Â  Â  canvas.className = 'card pergaminho pergaminho-v';
Â  Â  Â  canvas.style.background = 'var(--panel) url(/assets/img/pergaminho-rasgado-vert.png) no-repeat center/cover';
Â  Â  }
Â  }

Â  function showSection(sectionId) {
Â  Â  console.log('[showSection] Exibindo seÃ§Ã£o:', sectionId);
Â  Â  document.querySelectorAll('.j-section').forEach(s => {
Â  Â  Â  s.classList.add('hidden');
Â  Â  Â  s.querySelectorAll('[data-typing]').forEach(el => {
Â  Â  Â  Â  el.textContent = el.getAttribute('data-text') || el.textContent || '';
Â  Â  Â  Â  el.classList.remove('lumen-typing', 'typing-done');
Â  Â  Â  Â  delete el.dataset.typed;
Â  Â  Â  });
Â  Â  });
Â  Â  const active = document.getElementById(sectionId);
Â  Â  if(active) {
Â  Â  Â  active.classList.remove('hidden');
Â  Â  Â  console.log('[showSection] SeÃ§Ã£o ativa:', active.id);
Â  Â  } else {
Â  Â  Â  console.error('[showSection] SeÃ§Ã£o nÃ£o encontrada:', sectionId);
Â  Â  Â  toast('Erro ao carregar a seÃ§Ã£o. Tente novamente.');
Â  Â  }
Â  Â  updateCanvasBackground(sectionId);
Â  Â  ensureHeroFlame(sectionId);

Â  Â  if(sectionId === 'section-perguntas') {
Â  Â  Â  updateProgress();
Â  Â  Â  const perguntas = document.querySelectorAll('.j-pergunta');
Â  Â  Â  if(perguntas.length) {
Â  Â  Â  Â  const first = document.querySelector('.j-pergunta.active') || perguntas[0];
Â  Â  Â  Â  first.classList.add('active');
Â  Â  Â  Â  const lbl = first.querySelector('.pergunta-enunciado')?.textContent || '';
Â  Â  Â  Â  const ta = first.querySelector('textarea');
Â  Â  Â  Â  ta.placeholder = "Digite sua resposta...";
Â  Â  Â  Â  const aria = document.getElementById('aria-pergunta');
Â  Â  Â  Â  if(aria) aria.textContent = lbl;
Â  Â  Â  Â  runTyping(first);
Â  Â  Â  }
Â  Â  }
Â  Â  if(sectionId === 'section-final') {
Â  Â  Â  const url = localStorage.getItem('IRMANDADE_SELFIE_FINAL');
Â  Â  Â  if(url) {
Â  Â  Â  Â  const img = document.querySelector('#selfieInFlame');
Â  Â  Â  Â  if(img) img.src = url;
Â  Â  Â  Â  const clientNameFinal = document.querySelector('#clientNameSlotFinal');
Â  Â  Â  Â  if(clientNameFinal) clientNameFinal.textContent = localStorage.getItem('JORNADA_NOME')?.toUpperCase() || '';
Â  Â  Â  }
Â  Â  Â  runTyping(active);
Â  Â  }
Â  Â  if(sectionId === 'section-guia') {
Â  Â  Â  const guiaNameInput = document.getElementById('guiaNameInput');
Â  Â  Â  const storedName = localStorage.getItem('JORNADA_NOME') || '';
Â  Â  Â  if(guiaNameInput && storedName) guiaNameInput.value = storedName.toUpperCase();
Â  Â  Â  runTyping(active);
Â  Â  }
Â  Â  if(sectionId === 'section-termos') {
Â  Â  Â  const pg1 = document.getElementById('termos-pg1');
Â  Â  Â  if(pg1 && !pg1.classList.contains('hidden')) runTyping(pg1);
Â  Â  }
Â  }

Â  /* ===== blocos dinÃ¢micos ===== */
Â  window.loadDynamicBlocks = function() {
Â  Â  const content = document.getElementById('perguntas-container');
Â  Â  if(!content) return;

Â  Â  const blocks = window.JORNADA_BLOCKS || [];
Â  Â  content.innerHTML = '';

Â  Â  blocks.forEach((block, bIdx) => {
Â  Â  Â  const bloco = document.createElement('section');
Â  Â  Â  bloco.className = 'j-bloco';
Â  Â  Â  bloco.dataset.bloco = bIdx;
Â  Â  Â  bloco.dataset.video = block.video_after || '';

Â  Â  Â  (block.questions || []).forEach((q, qIdx) => {
Â  Â  Â  Â  const label = typeof q === 'string' ? q : (q.label || q.text || '');
Â  Â  Â  Â  const cleanLabel = dedupe(label);
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'j-pergunta';
Â  Â  Â  Â  div.dataset.pergunta = qIdx;

Â  Â  Â  Â  const enunciado = `
Â  Â  Â  Â  Â  <label class="pergunta-enunciado"Â 
Â  Â  Â  Â  Â  Â  data-typing data-text="Pergunta ${qIdx + 1}: ${cleanLabel}"Â 
Â  Â  Â  Â  Â  Â  data-speed="36" data-cursor="true"></label>`;

Â  Â  Â  Â  div.innerHTML = enunciado +
Â  Â  Â  Â  Â  `\n<textarea rows="4" class="input" placeholder="Digite sua resposta..."></textarea>` +
Â  Â  Â  Â  Â  `\n<p class="devolutiva-text" style="display:none;" data-typing data-speed="36" data-cursor="true"></p>` +
Â  Â  Â  Â  Â  `\n<div class="accessibility-controls"></div>`;

Â  Â  Â  Â  bloco.appendChild(div);
Â  Â  Â  });

Â  Â  Â  content.appendChild(bloco);
Â  Â  });

Â  Â  const firstBloco = content.querySelector('.j-bloco');
Â  Â  if(firstBloco) {
Â  Â  Â  firstBloco.style.display = 'block';
Â  Â  Â  const first = firstBloco.querySelector('.j-pergunta');
Â  Â  Â  if(first) {
Â  Â  Â  Â  first.classList.add('active');
Â  Â  Â  Â  runTyping(first);
Â  Â  Â  }
Â  Â  }

Â  Â  if(typeof loadAnswers === 'function') loadAnswers();
Â  Â  const firstTa = document.querySelector('.j-bloco .j-pergunta textarea');
Â  Â  if(firstTa && typeof handleInput === 'function') handleInput(firstTa);
Â  Â  initAccessibility();
Â  };

Â  /* ===== controles ===== */
Â  let lastDevolutivaText = '';
Â  function analyzeSentiment(text) {
Â  Â  const POS = {'feliz': 2, 'alegria': 2, 'amor': 3, 'sucesso': 2, 'esperanÃ§a': 3, 'paz': 2, 'fÃ©': 3, 'gratidÃ£o': 2, 'vitÃ³ria': 3, 'superaÃ§Ã£o': 3, 'luz': 2, 'deus': 3, 'coragem': 2, 'forÃ§a': 2, 'confianÃ§a': 2, 'propÃ³sito': 3};
Â  Â  const NEG = {'triste': -2, 'dor': -3, 'raiva': -2, 'medo': -2, 'frustracao': -2, 'frustraÃ§Ã£o': -2, 'decepcao': -2, 'decepÃ§Ã£o': -2, 'perda': -3, 'culpa': -2, 'ansiedade': -2, 'solidao': -2, 'solidÃ£o': -2, 'desespero': -3, 'cansaco': -2, 'cansaÃ§o': -2, 'fracasso': -2, 'trauma': -3, 'duvida': -2, 'dÃºvida': -2};
Â  Â  let score = 0;
Â  Â  (text || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').split(/\s+/).forEach(t => {
Â  Â  Â  if(POS[t] != null) score += POS[t];
Â  Â  Â  if(NEG[t] != null) score += NEG[t];
Â  Â  });
Â  Â  return score;
Â  }

Â  function handleInput(textarea) {
Â  Â  const score = analyzeSentiment(textarea.value);
Â  Â  updateChama(score);
Â  Â  saveAnswers();
Â  Â  updateProgress();
Â  }

Â  async function handleDevolutiva(textarea) {
Â  Â  const perguntaDiv = textarea.closest('.j-pergunta');
Â  Â  const devolutivaP = perguntaDiv.querySelector('.devolutiva-text');
Â  Â  if(textarea.value.trim() && devolutivaP && textarea.value !== lastDevolutivaText) {
Â  Â  Â  devolutivaP.style.display = 'block';
Â  Â  Â  const pergunta = perguntaDiv.querySelector('.pergunta-enunciado')?.textContent || '';
Â  Â  Â  const resposta = textarea.value;
Â  Â  Â  lastDevolutivaText = resposta;
Â  Â  Â  const guia = localStorage.getItem('JORNADA_GUIA') || 'zion';
Â  Â  Â  const devolutiva = await fetchDevolutiva(pergunta, resposta, guia);
Â  Â  Â  await typeDevolutiva(devolutivaP, devolutiva, 36);
Â  Â  } else if(!textarea.value.trim() && devolutivaP) {
Â  Â  Â  devolutivaP.style.display = 'none';
Â  Â  }
Â  }

Â  function toggleSenha() {
Â  Â  const input = document.getElementById('senha');
Â  Â  if(!input) return;
Â  Â  input.type = (input.type === 'password' ? 'text' : 'password');
Â  }

Â  function proceedAfterGuia(guia) {
Â  Â  const guiaNameInput = document.getElementById('guiaNameInput');
Â  Â  if(guiaNameInput && guiaNameInput.value.trim()) {
Â  Â  Â  localStorage.setItem('JORNADA_NOME', guiaNameInput.value.trim().toUpperCase());
Â  Â  } else {
Â  Â  Â  toast('Por favor, insira seu nome antes de prosseguir.');
Â  Â  Â  return;
Â  Â  }
Â  Â  localStorage.setItem('JORNADA_GUIA', guia);
Â  Â  ensureHeroFlame('section-selfie');
Â  Â  showSection('section-selfie');
Â  Â  const card = document.getElementById('card-guide');
Â  Â  const bgImg = document.getElementById('guideBg');
Â  Â  const resultBg = document.getElementById('resultBackground');
Â  Â  const clientNameEl = document.getElementById('clientNameSlot');
Â  Â  const clientNameFinal = document.getElementById('clientNameSlotFinal');
Â  Â  card.dataset.guide = guia.toUpperCase();
Â  Â  clientNameEl.textContent = guiaNameInput.value.toUpperCase();
Â  Â  clientNameFinal.textContent = guiaNameInput.value.toUpperCase();
Â  Â  const bgUrl = `/assets/img/irmandade-quarteto-bg-${guia}.jpeg`;
Â  Â  bgImg.src = bgUrl;
Â  Â  resultBg.src = bgUrl;
Â  }

Â  function proceedAfterSelfie() {
Â  Â  isTransitioning = false;
Â  Â  const intro = window.JORNADA_VIDEOS?.intro || '';
Â  Â  if(!intro || window.__introPlayed) {
Â  Â  Â  proceedToQuestions();
Â  Â  Â  return;
Â  Â  }
Â  Â  window.__introPlayed = true;
Â  Â  playTransition(intro, () => { proceedToQuestions(); });
Â  }

Â  let isTransitioning = false;
Â  async function goNext() {
Â  Â  if(isTransitioning) {
Â  Â  Â  console.warn('[goNext] TransiÃ§Ã£o bloqueada por isTransitioning');
Â  Â  Â  return;
Â  Â  }
Â  Â  isTransitioning = true;
Â  Â  const current = document.querySelector('.j-pergunta.active');
Â  Â  if(!current) {
Â  Â  Â  console.error('[goNext] Nenhuma pergunta ativa encontrada');
Â  Â  Â  isTransitioning = false;
Â  Â  Â  return;
Â  Â  }
Â  Â  const ta = current.querySelector('textarea');
Â  Â  if(ta) {
Â  Â  Â  await handleDevolutiva(ta);
Â  Â  }
Â  Â  
Â  Â  current.classList.remove('active');

Â  Â  const perguntas = Array.from(current.closest('.j-bloco').querySelectorAll('.j-pergunta'));
Â  Â  const i = perguntas.indexOf(current);

Â  Â  if(i + 1 < perguntas.length) {
Â  Â  Â  const prox = perguntas[i + 1];
Â  Â  Â  prox.classList.add('active');
Â  Â  Â  const lbl = prox.querySelector('.pergunta-enunciado')?.textContent || '';
Â  Â  Â  const ta = prox.querySelector('textarea');
Â  Â  Â  typeAnswer(ta, ta.value || '', 36);
Â  Â  Â  const aria = document.getElementById('aria-pergunta');
Â  Â  Â  if(aria) aria.textContent = lbl;
Â  Â  Â  runTyping(prox);
Â  Â  Â  updateProgress();
Â  Â  Â  isTransitioning = false;
Â  Â  Â  return;
Â  Â  }

Â  Â  const blocos = Array.from(document.querySelectorAll('.j-bloco'));
Â  Â  const idxBloco = parseInt(current.closest('.j-bloco').dataset.bloco, 10);
Â  Â  const temProx = idxBloco + 1 < blocos.length;

Â  Â  const irAdiante = () => {
Â  Â  Â  if(temProx) {
Â  Â  Â  Â  blocos.forEach(b => b.style.display = 'none');
Â  Â  Â  Â  const proxBloco = blocos[idxBloco + 1];
Â  Â  Â  Â  if(!proxBloco) {
Â  Â  Â  Â  Â  console.error('[goNext] PrÃ³ximo bloco nÃ£o encontrado');
Â  Â  Â  Â  Â  isTransitioning = false;
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  proxBloco.style.display = 'block';
Â  Â  Â  Â  const primeira = proxBloco.querySelector('.j-pergunta');
Â  Â  Â  Â  if(primeira) {
Â  Â  Â  Â  Â  primeira.classList.add('active');
Â  Â  Â  Â  Â  const lbl = primeira.querySelector('.pergunta-enunciado')?.textContent || '';
Â  Â  Â  Â  Â  const ta = primeira.querySelector('textarea');
Â  Â  Â  Â  Â  ta.placeholder = "Digite sua resposta...";
Â  Â  Â  Â  Â  const aria = document.getElementById('aria-pergunta');
Â  Â  Â  Â  Â  if(aria) aria.textContent = lbl;
Â  Â  Â  Â  Â  runTyping(primeira);
Â  Â  Â  Â  }
Â  Â  Â  Â  updateProgress();
Â  Â  Â  Â  isTransitioning = false;
Â  Â  Â  } else {
Â  Â  Â  Â  if(window.JORNADA_FINAL_VIDEO) {
Â  Â  Â  Â  Â  playTransition(window.JORNADA_FINAL_VIDEO, () => { showSection('section-final'); isTransitioning = false; });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showSection('section-final');
Â  Â  Â  Â  Â  isTransitioning = false;
Â  Â  Â  Â  }
Â  Â  Â  Â  updateProgress();
Â  Â  Â  }
Â  Â  };

Â  Â  const src = (window.JORNADA_BLOCKS[idxBloco] && window.JORNADA_BLOCKS[idxBloco].video_after) || '';
Â  Â  if(src) {
Â  Â  Â  playTransition(src, () => { irAdiante(); });
Â  Â  } else {
Â  Â  Â  irAdiante();
Â  Â  }
Â  }
Â  window.goNext = goNext;

Â  function playTransition(src, onEnd) {
Â  Â  const overlay = document.getElementById('videoOverlay');
Â  Â  const video = document.getElementById('videoTransicao');
Â  Â  const fallback = document.getElementById('videoFallback');
Â  Â  const skip = document.getElementById('skipVideo');
Â  Â  if(!overlay || !video || !fallback || !src) {
Â  Â  Â  console.error('[playTransition] Elementos ou src ausentes');
Â  Â  Â  onEnd && onEnd();
Â  Â  Â  return;
Â  Â  }

Â  Â  window.__playingTransition = true;
Â  Â  overlay.classList.remove('hidden');
Â  Â  video.classList.remove('hidden');
Â  Â  fallback.classList.add('hidden');
Â  Â  video.pause();
Â  Â  video.removeAttribute('src');
Â  Â  video.load();
Â  Â  video.currentTime = 0;
Â  Â  video.controls = true;
Â  Â  video.muted = false;
Â  Â  video.playsInline = true;
Â  Â  video.setAttribute('playsinline', '');
Â  Â  video.setAttribute('webkit-playsinline', '');
Â  Â  video.style.background = '#000';

Â  Â  let ended = false;
Â  Â  const cleanup = () => {
Â  Â  Â  if(ended) return;
Â  Â  Â  ended = true;
Â  Â  Â  isTransitioning = false;
Â  Â  Â  window.__playingTransition = false;
Â  Â  Â  video.pause();
Â  Â  Â  overlay.classList.add('hidden');
Â  Â  Â  video.classList.add('hidden');
Â  Â  Â  fallback.classList.add('hidden');
Â  Â  Â  video.removeAttribute('src');
Â  Â  Â  video.load();
Â  Â  Â  onEnd && onEnd();
Â  Â  };

Â  Â  video.onerror = (e) => {
Â  Â  Â  console.error('Video error:', e, 'Source:', src);
Â  Â  Â  fallback.classList.remove('hidden');
Â  Â  Â  video.classList.add('hidden');
Â  Â  Â  toast('NÃ£o foi possÃ­vel carregar o vÃ­deo.');
Â  Â  Â  setTimeout(cleanup, 1500);
Â  Â  };
Â  Â  video.onended = cleanup;
Â  Â  if(skip) skip.onclick = cleanup;

Â  Â  video.onloadedmetadata = () => {
Â  Â  Â  if(!video.videoWidth || !video.videoHeight) {
Â  Â  Â  Â  video.classList.add('hidden');
Â  Â  Â  Â  fallback.classList.remove('hidden');
Â  Â  Â  }
Â  Â  Â  video.currentTime = 0;
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  video.play().catch((e) => {
Â  Â  Â  Â  Â  console.error('Video playback error:', e, 'Source:', src);
Â  Â  Â  Â  Â  fallback.classList.remove('hidden');
Â  Â  Â  Â  Â  video.classList.add('hidden');
Â  Â  Â  Â  Â  setTimeout(cleanup, 1500);
Â  Â  Â  Â  });
Â  Â  Â  }, 400);
Â  Â  };

Â  Â  video.src = src + '?t=' + Date.now();
Â  Â  setTimeout(cleanup, 90000);
Â  }
Â  window.playTransition = playTransition;

Â  function lockVideoOrientation() {
Â  Â  const video = document.getElementById('videoTransicao');
Â  Â  if(!video) return;
Â  Â  video.addEventListener('webkitbeginfullscreen', (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  video.exitFullscreen?.();
Â  Â  });
Â  Â  video.addEventListener('fullscreenchange', () => {
Â  Â  Â  if(document.fullscreenElement === video) {
Â  Â  Â  Â  document.exitFullscreen?.();
Â  Â  Â  }
Â  Â  });
Â  Â  window.addEventListener('orientationchange', () => {
Â  Â  Â  video.style.transform = 'rotate(0deg)';
Â  Â  });
Â  Â  if(window.matchMedia('(orientation: portrait)').matches) {
Â  Â  Â  video.style.width = '100vw';
Â  Â  Â  video.style.height = 'auto';
Â  Â  Â  video.style.maxHeight = '100vh';
Â  Â  }
Â  }

Â  function generatePDF() {
Â  Â  const respostas = JSON.parse(localStorage.getItem('jornada_respostas') || '{}');
Â  Â  const doc = { content: [] };
Â  Â  doc.content.push({ text: 'Jornada Essencial - Irmandade Conhecimento com Luz', style: { fontSize: 20, bold: true, alignment: 'center', margin: [0, 0, 0, 20] } });
Â  Â  Object.keys(respostas).forEach((key, idx) => {
Â  Â  Â  const pergunta = document.querySelector(`.j-pergunta[data-pergunta="${idx}"] .pergunta-enunciado`)?.textContent || `Pergunta ${idx + 1}`;
Â  Â  Â  doc.content.push(
Â  Â  Â  Â  { text: pergunta, style: { fontSize: 14, bold: true, margin: [0, 10, 0, 5] } },
Â  Â  Â  Â  { text: respostas[key] || 'Sem resposta', style: { fontSize: 12, margin: [0, 0, 0, 10] } }
Â  Â  Â  );
Â  Â  });
Â  Â  if(window.pdfMake) {
Â  Â  Â  pdfMake.createPdf(doc).download('jornada_essencial.pdf');
Â  Â  } else {
Â  Â  Â  toast('PDF nÃ£o disponÃ­vel.');
Â  Â  }
Â  }

Â  function startJourney() {
Â  Â  const senha = (document.getElementById('senha')?.value || '').trim().toLowerCase();
Â  Â  const senhaCorreta = 'jornada2025';
Â  Â  if (senha === senhaCorreta) {
Â  Â  Â  console.log('[startJourney] Senha vÃ¡lida, iniciando jornada');
Â  Â  Â  ensureHeroFlame('section-guia');
Â  Â  Â  showSection('section-guia');
Â  Â  } else {
Â  Â  Â  console.warn('[startJourney] Senha invÃ¡lida:', senha);
Â  Â  Â  toast('Senha incorreta. Tente novamente.');
Â  Â  }
Â  }

Â  function proceedToQuestions() {
Â  Â  isTransitioning = false;
Â  Â  showSection('section-perguntas');
Â  Â  loadDynamicBlocks();
Â  Â  const perguntas = document.querySelectorAll('.j-pergunta');
Â  Â  if(perguntas.length) {
Â  Â  Â  perguntas[0].classList.add('active');
Â  Â  Â  const lbl = perguntas[0].querySelector('.pergunta-enunciado')?.textContent || '';
Â  Â  Â  const ta = perguntas[0].querySelector('textarea');
Â  Â  Â  ta.placeholder = "Digite sua resposta...";
Â  Â  Â  const aria = document.getElementById('aria-pergunta');
Â  Â  Â  if(aria) aria.textContent = lbl;
Â  Â  Â  if(ta) typeAnswer(ta, ta.value || '', 36);
Â  Â  Â  runTyping(perguntas[0]);
Â  Â  }
Â  Â  updateProgress();
Â  }

Â  /* ===== Acessibilidade: Microfone e Ãudio ===== */
Â  let recognition = null;
Â  let currentLang = 'pt-BR';
Â  let isRecognizing = false;
Â  window.isMuted = false;

Â  function initAccessibility() {
Â  Â  if('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
Â  Â  Â  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
Â  Â  Â  recognition.continuous = false;
Â  Â  Â  recognition.interimResults = false;
Â  Â  Â  recognition.lang = currentLang;
Â  Â  } else {
Â  Â  Â  toast('Seu navegador nÃ£o suporta reconhecimento de voz.');
Â  Â  }

Â  Â  document.addEventListener('click', (ev) => {
Â  Â  Â  if(!ev.target) return false;
Â  Â  Â  const btnMic = ev.target.closest('[data-action="start-mic"]');
Â  Â  Â  const btnClear = ev.target.closest('[data-action="clear-answer"]');
Â  Â  Â  const btnMute = ev.target.closest('[data-action="mute"]');
Â  Â  Â  const btnNextTermos = ev.target.closest('[data-action="next-termos"]');
Â  Â  Â  if(btnMic) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  const ta = btnMic.closest('.j-pergunta')?.querySelector('textarea');
Â  Â  Â  Â  if(ta) startRecognition(ta, btnMic);
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnClear) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  const ta = btnClear.closest('.j-pergunta')?.querySelector('textarea');
Â  Â  Â  Â  if(ta) {
Â  Â  Â  Â  Â  ta.value = '';
Â  Â  Â  Â  Â  ta.classList.remove('lumen-typing', 'typing-done');
Â  Â  Â  Â  Â  const devolutivaP = ta.closest('.j-pergunta').querySelector('.devolutiva-text');
Â  Â  Â  Â  Â  if (devolutivaP) devolutivaP.style.display = 'none';
Â  Â  Â  Â  Â  handleInput(ta);
Â  Â  Â  Â  Â  toast('Resposta apagada.');
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnMute) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  window.isMuted = !window.isMuted;
Â  Â  Â  Â  btnMute.textContent = window.isMuted ? 'ğŸ”Š Ativar Som' : 'ğŸ”‡ Silenciar';
Â  Â  Â  Â  btnMute.classList.toggle('muted', window.isMuted);
Â  Â  Â  Â  toast(window.isMuted ? 'Som silenciado.' : 'Som ativado.');
Â  Â  Â  Â  if(window.isMuted) speechSynthesis.cancel();
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnNextTermos) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[initAccessibility] BotÃ£o AvanÃ§ar clicado');
Â  Â  Â  Â  isTransitioning = false; // Reset para garantir transiÃ§Ã£o
Â  Â  Â  Â  showSection('section-termos');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg1'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  }, { capture: true });

Â  Â  document.addEventListener('blur', (ev) => {
Â  Â  Â  if(ev.target && ev.target.matches('.j-pergunta textarea')) {
Â  Â  Â  Â  handleDevolutiva(ev.target);
Â  Â  Â  }
Â  Â  }, true);

Â  Â  const langSelect = document.getElementById('language-select');
Â  Â  if(langSelect) {
Â  Â  Â  langSelect.addEventListener('change', (ev) => {
Â  Â  Â  Â  currentLang = ev.target.value;
Â  Â  Â  Â  if(recognition) recognition.lang = currentLang;
Â  Â  Â  Â  toast(`Idioma alterado para ${currentLang}`);
Â  Â  Â  Â  updateBlocks();
Â  Â  Â  Â  if(!document.getElementById('section-perguntas').classList.contains('hidden')) {
Â  Â  Â  Â  Â  loadDynamicBlocks();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }
Â  }

Â  function startRecognition(textarea, btn) {
Â  Â  if(!recognition || isRecognizing) return;
Â  Â  isRecognizing = true;
Â  Â  btn.classList.add('recording');
Â  Â  btn.textContent = 'Gravando...';
Â  Â  recognition.onresult = (event) => {
Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  textarea.value = (textarea.value ? textarea.value + ' ' : '') + transcript;
Â  Â  Â  typeAnswer(textarea, textarea.value, 36);
Â  Â  Â  saveAnswers();
Â  Â  Â  updateProgress();
Â  Â  Â  handleDevolutiva(textarea);
Â  Â  };
Â  Â  recognition.onend = () => {
Â  Â  Â  isRecognizing = false;
Â  Â  Â  btn.classList.remove('recording');
Â  Â  Â  btn.textContent = 'ğŸ¤ Falar Resposta';
Â  Â  };
Â  Â  recognition.onerror = (event) => {
Â  Â  Â  toast('Erro no reconhecimento: ' + event.error);
Â  Â  Â  recognition.onend();
Â  Â  };
Â  Â  recognition.start();
Â  }

Â  function readAloud(text, voiceGender) {
Â  Â  if(window.isMuted || !('speechSynthesis' in window)) return;
Â  Â  speechSynthesis.cancel();
Â  Â  const utterance = new SpeechSynthesisUtterance(text);
Â  Â  utterance.lang = currentLang;
Â  Â  const voices = speechSynthesis.getVoices();
Â  Â  let selectedVoice = voices.find(v => v.lang === currentLang && v.name.includes(voiceGender === 'male' ? 'Male' : 'Female')) ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â voices.find(v => v.lang === currentLang) || voices[0];
Â  Â  utterance.voice = selectedVoice;
Â  Â  speechSynthesis.speak(utterance);
Â  }

Â  /* vÃ­deos & blocos */
Â  const VIDEO_BASE = '/assets/img/';
Â  window.JORNADA_VIDEOS = {
Â  Â  intro: VIDEO_BASE + 'filme-0-ao-encontro-da-jornada.mp4',
Â  Â  afterBlocks: {
Â  Â  Â  0: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4',
Â  Â  Â  1: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4',
Â  Â  Â  2: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4',
Â  Â  Â  3: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4'
Â  Â  },
Â  Â  final: VIDEO_BASE + 'filme-5-fim-da-jornada.mp4'
Â  };
Â  window.JORNADA_FINAL_VIDEO = window.JORNADA_VIDEOS.final;

Â  const blockTranslations = {
Â  Â  'pt-BR': [
Â  Â  Â  { title: 'Bloco 1 â€” RaÃ­zes', questions: [{ label: 'Quem Ã© vocÃª hoje?' }, { label: 'O que te trouxe atÃ© esta jornada?' }, { label: 'Qual Ã© o seu maior sonho espiritual?' }], video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4' },
Â  Â  Â  { title: 'Bloco 2 â€” ReflexÃµes', questions: [{ label: 'Quais sÃ£o seus maiores desafios atuais?' }, { label: 'Como vocÃª lida com o medo ou a dÃºvida?' }, { label: 'O que a "luz" significa para vocÃª?' }], video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4' },
Â  Â  Â  { title: 'Bloco 3 â€” Crescimento', questions: [{ label: 'O que vocÃª quer mudar na sua vida?' }, { label: 'Quem inspira vocÃª e por quÃª?' }, { label: 'Como vocÃª pratica gratidÃ£o no dia a dia?' }], video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4' },
Â  Â  Â  { title: 'Bloco 4 â€” IntegraÃ§Ã£o', questions: [{ label: 'Qual liÃ§Ã£o vocÃª leva dessa jornada?' }, { label: 'Como vai aplicar isso no futuro?' }, { label: 'Uma mensagem para seu eu futuro.' }], video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4' }
Â  Â  ],
Â  Â  'en-US': [
Â  Â  Â  { title: 'Block 1 â€” Roots', questions: [{ label: 'Who are you today?' }, { label: 'What brought you to this journey?' }, { label: 'What is your greatest spiritual dream?' }], video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4' },
Â  Â  Â  { title: 'Block 2 â€” Reflections', questions: [{ label: 'What are your biggest current challenges?' }, { label: 'How do you deal with fear or doubt?' }, { label: 'What does "light" mean to you?' }], video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4' },
Â  Â  Â  { title: 'Block 3 â€” Growth', questions: [{ label: 'What do you want to change in your life?' }, { label: 'Who inspires you and why?' }, { label: 'How do you practice gratitude in your daily life?' }], video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4' },
Â  Â  Â  { title: 'Block 4 â€” Integration', questions: [{ label: 'What lesson do you take from this journey?' }, { label: 'How will you apply this in the future?' }, { label: 'A message to your future self.' }], video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4' }
Â  Â  ],
Â  Â  'es-ES': [
Â  Â  Â  { title: 'Bloque 1 â€” RaÃ­ces', questions: [{ label: 'Â¿QuiÃ©n eres hoy?' }, { label: 'Â¿QuÃ© te trajo a este viaje?' }, { label: 'Â¿CuÃ¡l es tu mayor sueÃ±o espiritual?' }], video_after: VIDEO_BASE + 'filme-1-entrando-na-jornada.mp4' },
Â  Â  Â  { title: 'Bloque 2 â€” Reflexiones', questions: [{ label: 'Â¿CuÃ¡les son tus mayores desafÃ­os actuales?' }, { label: 'Â¿CÃ³mo lidias con el miedo o la duda?' }, { label: 'Â¿QuÃ© significa la "luz" para ti?' }], video_after: VIDEO_BASE + 'filme-2-dentro-da-jornada.mp4' },
Â  Â  Â  { title: 'Bloque 3 â€” Crecimiento', questions: [{ label: 'Â¿QuÃ© quieres cambiar en tu vida?' }, { label: 'Â¿QuiÃ©n te inspira y por quÃ©?' }, { label: 'Â¿CÃ³mo practicas la gratitud en el dÃ­a a dÃ­a?' }], video_after: VIDEO_BASE + 'filme-3-traumas-na-jornada.mp4' },
Â  Â  Â  { title: 'Bloque 4 â€” IntegraciÃ³n', questions: [{ label: 'Â¿QuÃ© lecciÃ³n te llevas de este viaje?' }, { label: 'Â¿CÃ³mo lo aplicarÃ¡s en el futuro?' }, { label: 'Un mensaje para tu yo futuro.' }], video_after: VIDEO_BASE + 'filme-4-aproximando-do-final.mp4' }
Â  Â  ]
Â  };

Â  function updateBlocks() {
Â  Â  window.JORNADA_BLOCKS = blockTranslations[currentLang] || blockTranslations['pt-BR'];
Â  }

Â  /* ===== inicializaÃ§Ã£o da jornada ===== */
Â  function initJornada() {
Â  Â  console.log('[initJornada] Inicializando jornada');
Â  Â  document.addEventListener('input', (ev) => {
Â  Â  Â  const ta = ev.target.closest?.('.j-pergunta textarea');
Â  Â  Â  if(ta) handleInput(ta);
Â  Â  Â  return true;
Â  Â  }, { capture: true });
Â  Â  document.addEventListener('focusin', (ev) => {
Â  Â  Â  if(ev.target && ev.target.matches('.j-pergunta textarea')) {
Â  Â  Â  Â  if(__abortTypingPlaceholder) __abortTypingPlaceholder();
Â  Â  Â  }
Â  Â  Â  return true;
Â  Â  }, { capture: true });
Â  Â  document.addEventListener('click', (ev) => {
Â  Â  Â  if(isTransitioning || !ev.target) {
Â  Â  Â  Â  console.warn('[click] Bloqueado por isTransitioning ou target nulo');
Â  Â  Â  Â  return false;
Â  Â  Â  }
Â  Â  Â  console.log('[click] Evento de clique disparado', ev.target);
Â  Â  Â  const aNext = ev.target.closest?.('[data-action="next"]');
Â  Â  Â  const aStart = ev.target.closest?.('[data-action="start"]');
Â  Â  Â  const aToggle = ev.target.closest?.('[data-action="toggle-password"], .password-toggle');
Â  Â  Â  const aRestart = ev.target.closest?.('[data-action="restart"]');
Â  Â  Â  const btnPDF = ev.target.closest?.('[data-action="generate-pdf"]');
Â  Â  Â  const btnDownloadSelfie = ev.target.closest?.('[data-action="download-selfie"]');
Â  Â  Â  const btnSkipSelfie = ev.target.closest?.('[data-action="skip-selfie"]');
Â  Â  Â  const btnSendChat = ev.target.closest?.('[data-action="send-chat"]');
Â  Â  Â  const btnSelectGuia = ev.target.closest?.('[data-action="select-guia"]');
Â  Â  Â  const btnNextTermos = ev.target.closest?.('[data-action="next-termos"]');
Â  Â  Â  const btnNextSenha = ev.target.closest?.('[data-action="next-senha"]');
Â  Â  Â  const btnTermosNext = ev.target.closest?.('[data-action="termos-next"]');
Â  Â  Â  const btnTermosNext2 = ev.target.closest?.('[data-action="termos-next2"]');
Â  Â  Â  const btnTermosNext3 = ev.target.closest?.('[data-action="termos-next3"]');
Â  Â  Â  const btnTermosNext4 = ev.target.closest?.('[data-action="termos-next4"]');

Â  Â  Â  if(aNext) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Next clicado');
Â  Â  Â  Â  goNext();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(aStart) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Start clicado');
Â  Â  Â  Â  startJourney();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(aToggle) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Toggle Senha clicado');
Â  Â  Â  Â  toggleSenha();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(aRestart) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Restart clicado');
Â  Â  Â  Â  localStorage.removeItem('jornada_respostas');Â 
Â  Â  Â  Â  localStorage.removeItem('JORNADA_GUIA');Â 
Â  Â  Â  Â  localStorage.removeItem('JORNADA_NOME');Â 
Â  Â  Â  Â  location.hash = '#intro';Â 
Â  Â  Â  Â  location.replace('/index.html');Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnPDF) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Gerar PDF clicado');
Â  Â  Â  Â  generatePDF();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnDownloadSelfie) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o Download Selfie clicado');
Â  Â  Â  Â  const dataURL = localStorage.getItem('IRMANDADE_SELFIE_FINAL');
Â  Â  Â  Â  if(dataURL) {
Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  a.href = dataURL;
Â  Â  Â  Â  Â  a.download = 'jornada-selfie.png';
Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  toast('Nenhuma imagem disponÃ­vel para download.');
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnSkipSelfie) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Pular Selfie clicado');
Â  Â  Â  Â  proceedAfterSelfie();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnSendChat) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Enviar Chat clicado');
Â  Â  Â  Â  sendChatMessage();Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnSelectGuia) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o Selecionar Guia clicado:', btnSelectGuia.dataset.guia);
Â  Â  Â  Â  proceedAfterGuia(btnSelectGuia.dataset.guia);Â 
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnNextTermos) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o AvanÃ§ar Termos clicado');
Â  Â  Â  Â  isTransitioning = false; // Reset para garantir transiÃ§Ã£o
Â  Â  Â  Â  showSection('section-termos');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg1'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnNextSenha) {Â 
Â  Â  Â  Â  ev.preventDefault();Â 
Â  Â  Â  Â  console.log('[click] BotÃ£o PrÃ³xima Senha clicado');
Â  Â  Â  Â  showSection('section-senha');Â 
Â  Â  Â  Â  runTyping(document.getElementById('section-senha'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnTermosNext) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o PrÃ³xima PÃ¡gina Termos 1 clicado');
Â  Â  Â  Â  document.getElementById('termos-pg1')?.classList.add('hidden');
Â  Â  Â  Â  document.getElementById('termos-pg2')?.classList.remove('hidden');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg2'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnTermosNext2) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o PrÃ³xima PÃ¡gina Termos 2 clicado');
Â  Â  Â  Â  document.getElementById('termos-pg2')?.classList.add('hidden');
Â  Â  Â  Â  document.getElementById('termos-pg3')?.classList.remove('hidden');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg3'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnTermosNext3) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o PrÃ³xima PÃ¡gina Termos 3 clicado');
Â  Â  Â  Â  document.getElementById('termos-pg3')?.classList.add('hidden');
Â  Â  Â  Â  document.getElementById('termos-pg4')?.classList.remove('hidden');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg4'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  if(btnTermosNext4) {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[click] BotÃ£o PrÃ³xima PÃ¡gina Termos 4 clicado');
Â  Â  Â  Â  document.getElementById('termos-pg4')?.classList.add('hidden');
Â  Â  Â  Â  document.getElementById('termos-pg5')?.classList.remove('hidden');
Â  Â  Â  Â  runTyping(document.getElementById('termos-pg5'));
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  }, { capture: true });

Â  Â  document.getElementById('grok-chat-input')?.addEventListener('keypress', (ev) => {
Â  Â  Â  if(ev.key === 'Enter') {
Â  Â  Â  Â  ev.preventDefault();
Â  Â  Â  Â  console.log('[keypress] Enter no chat input');
Â  Â  Â  Â  sendChatMessage();
Â  Â  Â  Â  return true;
Â  Â  Â  }
Â  Â  Â  return false;
Â  Â  }, { capture: true });

Â  Â  document.getElementById('guiaNameInput')?.addEventListener('input', (ev) => {
Â  Â  Â  ev.target.value = ev.target.value.toUpperCase();
Â  Â  Â  return true;
Â  Â  }, { capture: true });
Â  }

Â  /* boot */
Â  console.log('[Boot] Iniciando script');
Â  ensureHeaderFlame();
Â  ensurePageFlames();
Â  initJornada();
Â  showSection('section-intro');
Â  updateBlocks();
Â  lockVideoOrientation();
Â  speechSynthesis.onvoiceschanged = () => {};
})();
</script>
</body>
</html>


