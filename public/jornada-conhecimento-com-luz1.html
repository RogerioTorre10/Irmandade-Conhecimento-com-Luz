<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jornada Essencial ¬∑ Irmandade Conhecimento com Luz</title>
  <meta name="description" content="Jornada Conhecimento com Luz ‚Äî f√©, ci√™ncia e prop√≥sito em uma viagem interior guiada pelo Lumen." />
  <link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',300:'#fdba74',400:'#fb923c',500:'#f59e0b',600:'#d97706',700:'#b45309',800:'#92400e',900:'#78350f'}
          }
        }
      }
    }
  </script>
</head>
<body class="bg-slate-900 text-slate-100 antialiased">

  <!-- Cabe√ßalho -->
  <header class="sticky top-0 z-40 bg-slate-900/80 backdrop-blur border-b border-white/10">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/assets/favicon.svg" class="h-7 w-7" alt="">
        <span class="font-semibold tracking-wide">Irmandade Conhecimento com Luz</span>
      </div>
      <span class="text-sm text-slate-300">Jornada Essencial</span>
    </div>
  </header>

  <!-- Conte√∫do principal -->
  <main id="app" class="max-w-6xl mx-auto px-4 md:px-6 lg:px-8 py-8 pb-40">

    <!-- Alertas -->
    <div id="alert" class="hidden mb-4 rounded-xl border border-white/10 bg-slate-800/70 p-3 text-sm"></div>

    <!-- Devolutiva -->
    <section id="devolutiva"
      class="relative rounded-2xl bg-slate-800/60 backdrop-blur p-6 shadow-xl ring-1 ring-white/10
             max-h-[60vh] overflow-y-auto mb-8">
      <div class="flex items-start justify-between">
        <h2 class="text-xl font-semibold">Devolutiva do Lumen</h2>
        <button id="toggle-devolutiva"
          class="ml-4 text-xs px-3 py-1 rounded-lg bg-slate-700 hover:bg-slate-600">
          Mostrar/Esconder
        </button>
      </div>

      <div id="devolutiva-content" class="mt-4 leading-relaxed whitespace-pre-line">
Irm√£o(√£) de luz, Amor e paz, recebo tua hist√≥ria com respeito e amor.
Teu compromisso ecoa dentro da tua pr√≥pria chama: Amor e paz.
Recorda: f√© sustenta, disciplina organiza, esperan√ßa ilumina. Cada gesto no
Bem fortalece teu destino.

Pr√≥ximos passos pr√°ticos:
‚Ä¢ Respira e escreve um prop√≥sito simples para hoje.
‚Ä¢ Agradece por algo real.
‚Ä¢ Pratica um gesto de bondade ainda hoje.
      </div>
    </section>

    <!-- Grid -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">

      <!-- Coluna esquerda (senha + iniciar + progresso) -->
      <div class="rounded-2xl bg-slate-800/60 backdrop-blur p-6 shadow-xl ring-1 ring-white/10">
        <label for="senha" class="block text-sm mb-2 text-slate-300">Senha de acesso</label>
        <div class="relative">
          <input id="senha" type="password" placeholder="Digite sua senha"
                 class="w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3
                        focus:outline-none focus:ring-2 focus:ring-primary-500 pr-10">
          <button id="toggle-senha" type="button"
                  class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-300 text-sm">
            üëÅÔ∏è
          </button>
        </div>

        <button id="btn-iniciar"
                class="mt-4 w-full px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-medium">
          Iniciar
        </button>

        <div class="mt-6 text-sm">
          <div class="text-slate-300">Progresso</div>
          <div id="progresso" class="mt-1">
            Pergunta <span id="q-atual">32</span>/32 ‚Ä¢ Respondidas <span id="q-respondidas">0</span>/32
          </div>
        </div>
      </div>

      <!-- Coluna central (respiro / formul√°rio fica acima na p√°gina real) -->
      <div class="hidden lg:block"></div>

      <!-- Coluna direita (Finalizar - sem bot√µes duplicados) -->
      <div class="rounded-2xl bg-slate-800/60 backdrop-blur p-6 shadow-xl ring-1 ring-white/10">
        <h3 class="text-lg font-semibold">Finalizar</h3>
        <p class="mt-2 text-sm text-slate-300">
          Revise suas respostas antes de enviar. O envio s√≥ libera com <b>32/32</b> respondidas.
        </p>
        <p class="mt-3 text-sm">Respondidas <span id="respondidas-final">0</span>/32</p>
      </div>
    </section>
  </main>

  <!-- Action Bar fixa -->
  <div id="action-bar"
       class="fixed bottom-4 left-1/2 -translate-x-1/2
              w-[95%] md:w-auto
              rounded-2xl bg-slate-800/90 backdrop-blur
              shadow-2xl ring-1 ring-white/10
              px-4 py-3 flex items-center gap-3 z-30">
    <button id="btn-voltar"
            class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">
      Voltar
    </button>
    <button id="btn-enviar"
            class="px-5 py-2 rounded-xl bg-amber-500/60 cursor-not-allowed opacity-60 font-medium"
            disabled>
      Enviar respostas
    </button>
    <button id="btn-limpar"
            class="px-4 py-2 rounded-xl bg-slate-700 hover:bg-slate-600">
      Limpar respostas (todas)
    </button>
  </div>

  <!-- Scripts -->
  <script>
    // ================== CONFIG API ==================
    const API_PRIMARY = 'https://conhecimento-com-luz-api.onrender.com';
    const API_FALLBACK = 'https://lumen-backend-api.onrender.com'; // opcional
    let API = API_PRIMARY;
    const TOTAL = 32;

    // ================== UI helpers ==================
    const $ = (sel) => document.querySelector(sel);
    function toast(msg, type='info') {
      const el = $('#alert');
      if (!el) return;
      el.classList.remove('hidden');
      el.classList.toggle('border-amber-400', type==='warn');
      el.classList.toggle('border-emerald-400', type==='ok');
      el.classList.toggle('border-red-400', type==='err');
      el.textContent = msg;
      setTimeout(() => el.classList.add('hidden'), 4000);
    }
    function setEnabled(btn, on) {
      if (!btn) return;
      btn.disabled = !on;
      btn.classList.toggle('cursor-not-allowed', !on);
      btn.classList.toggle('opacity-60', !on);
      btn.classList.toggle('bg-amber-500/60', !on);
      btn.classList.toggle('bg-amber-500', on);
      btn.classList.toggle('hover:bg-amber-600', on);
    }

    // ================== BACKEND helpers ==================
    async function apiFetch(path, {method='GET', headers={}, body=null, timeout=20000} = {}) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeout);
      try {
        const res = await fetch(API + path, { method, headers, body, signal: ctrl.signal });
        clearTimeout(t);
        return res;
      } catch (e) {
        if (API !== API_FALLBACK && API_FALLBACK) {
          API = API_FALLBACK;
          return fetch(API + path, { method, headers, body });
        }
        throw e;
      }
    }

    async function wakeBackend() {
      try {
        const r = await apiFetch('/health');
        if (r.ok) { toast('Servidor pronto.', 'ok'); return true; }
        toast('Servidor respondeu, mas n√£o OK.', 'warn');
      } catch {
        toast('Servidor dormindo/offline.', 'err');
      }
      return false;
    }

    // ================== CAPTURA DE DADOS ==================
    function getStoredAnswers() {
      for (const k of ['answers','journeyAnswers','jornadaAnswers']) {
        const raw = localStorage.getItem(k);
        if (raw) { try { const o = JSON.parse(raw); if (o && typeof o==='object') return o; } catch {} }
      }
      return null;
    }

    function scrapeFormAnswers() {
      const data = {};
      document.querySelectorAll('input, textarea, select').forEach(el => {
        const key = el.getAttribute('data-qid') || el.name;
        if (!key) return;
        if (el.type === 'checkbox') {
          if (!data[key]) data[key] = [];
          if (el.checked) data[key].push(el.value ?? true);
        } else if (el.type === 'radio') {
          if (el.checked) data[key] = el.value;
        } else {
          data[key] = el.value;
        }
      });
      return data;
    }

    function collectAnswers() {
      return getStoredAnswers() || scrapeFormAnswers();
    }

    function countAnswered(obj) {
      if (!obj) return 0;
      return Object.values(obj).reduce((acc, v) => {
        if (Array.isArray(v)) return acc + (v.length ? 1 : 0);
        return acc + (v !== null && v !== undefined && String(v).trim() !== '' ? 1 : 0);
      }, 0);
    }

    function scrollToFirstMissing(answers) {
      // tenta localizar um campo vazio e focar
      const set = new Set(Object.keys(answers || {}));
      let target = null;
      document.querySelectorAll('[data-qid], [name]').forEach(el => {
        const key = el.getAttribute('data-qid') || el.name;
        if (!key) return;
        const has = set.has(key) && answers[key] !== '' && !(Array.isArray(answers[key]) && !answers[key].length);
        if (!has && !target) target = el;
      });
      if (target) {
        target.scrollIntoView({ behavior:'smooth', block:'center' });
        target.classList.add('ring-2','ring-rose-500','ring-offset-2','ring-offset-slate-900');
        setTimeout(()=> target.classList.remove('ring-2','ring-rose-500','ring-offset-2','ring-offset-slate-900'), 3000);
        target.focus?.();
      }
    }

    // ================== AUTENTICA√á√ÉO / IN√çCIO ==================
    async function validarSenha() {
      const input = $('#senha');
      const senha = input?.value?.trim();
      if (!senha) { toast('Digite a senha para iniciar.', 'warn'); input?.focus(); return false; }
      const r = await apiFetch('/validar-senha', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ senha })
      });
      if (!r.ok) { toast('Senha inv√°lida.', 'err'); return false; }
      const j = await r.json().catch(()=>({}));
      if (j?.token) localStorage.setItem('authToken', j.token);
      localStorage.setItem('journeyStarted', String(Date.now()));
      toast('Acesso liberado. Boa jornada!', 'ok');
      setEnabled($('#btn-enviar'), true);
      return true;
    }

    async function iniciar() {
      await wakeBackend();
      await validarSenha();
    }

    // ================== ENVIO / PDF ==================
    async function submitJourney() {
      // bloqueio se n√£o iniciou
      if (!localStorage.getItem('journeyStarted')) {
        toast('Clique em INICIAR para liberar o envio.', 'warn');
        $('#senha')?.focus();
        return;
      }

      const answers = collectAnswers();
      const answered = countAnswered(answers);
      $('#q-respondidas').textContent = answered;
      $('#respondidas-final').textContent = answered;

      if (answered < TOTAL) {
        toast(`Voc√™ precisa responder ${TOTAL}/${TOTAL} antes de enviar.`, 'warn');
        scrollToFirstMissing(answers);
        return;
      }

      toast('Enviando respostas...', 'info');

      const headers = { 'Content-Type': 'application/json' };
      const token = localStorage.getItem('authToken');
      if (token) headers['Authorization'] = `Bearer ${token}`;

      const payload = {
        answers,
        meta: { clientTime:new Date().toISOString(), userAgent:navigator.userAgent }
      };

      const res = await apiFetch('/jornada/submit', { method:'POST', headers, body: JSON.stringify(payload) });
      if (!res.ok) {
        const msg = await res.text().catch(()=> res.statusText);
        toast(`Falha ao enviar: ${res.status} ${msg}`, 'err');
        return;
      }

      toast('Gerando PDF...', 'info');

      // tenta POST /jornada/pdf; se falhar, tenta GET /jornada/pdf e /jornada/download/pdf
      let pdfRes = await apiFetch('/jornada/pdf', { method:'POST', headers });
      if (!pdfRes.ok) {
        pdfRes = await apiFetch('/jornada/pdf', { method:'GET', headers });
      }
      if (!pdfRes.ok) {
        pdfRes = await apiFetch('/jornada/download/pdf', { method:'GET', headers });
      }
      if (!pdfRes.ok) {
        const emsg = await pdfRes.text().catch(()=> pdfRes.statusText);
        toast(`PDF n√£o gerado: ${pdfRes.status} ${emsg}`, 'err');
        return;
      }

      const blob = await pdfRes.blob();
      const url = URL.createObjectURL(blob);

      // abre e faz download
      window.open(url, '_blank', 'noopener');
      const a = document.createElement('a');
      a.href = url;
      a.download = `Jornada_Conhecimento_com_Luz_${Date.now()}.pdf`;
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 4000);

      toast('PDF pronto! Baixe e guarde agora.', 'ok');
    }

    function goToPreviousStep() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearAllAnswers() {
      if (!confirm('Limpar TODAS as respostas desta jornada no dispositivo?')) return;
      try {
        // mant√©m token; limpa somente respostas e controle de in√≠cio
        ['answers','journeyAnswers','jornadaAnswers','journeyStarted'].forEach(k => localStorage.removeItem(k));
        document.querySelectorAll('input, textarea, select').forEach(el=>{
          if (el.type==='checkbox' || el.type==='radio') el.checked = false;
          else el.value = '';
        });
        $('#q-respondidas').textContent = '0';
        $('#respondidas-final').textContent = '0';
        toast('Respostas limpas.', 'ok');
      } catch { toast('N√£o foi poss√≠vel limpar.', 'err'); }
    }

    // ================== WIRING ==================
    $('#toggle-senha')?.addEventListener('click', () => {
      const input = $('#senha');
      input.type = input.type === 'password' ? 'text' : 'password';
    });
    $('#toggle-devolutiva')?.addEventListener('click', () => {
      $('#devolutiva-content')?.classList.toggle('hidden');
    });

    $('#btn-iniciar')?.addEventListener('click', iniciar);
    $('#btn-voltar')?.addEventListener('click', goToPreviousStep);
    $('#btn-enviar')?.addEventListener('click', submitJourney);
    $('#btn-limpar')?.addEventListener('click', clearAllAnswers);

    // ================== BOOT ==================
    (async () => {
      await wakeBackend();
      // se j√° iniciou antes, libera envio
      setEnabled($('#btn-enviar'), !!localStorage.getItem('journeyStarted'));
      const ans = collectAnswers();
      const answered = countAnswered(ans);
      $('#q-respondidas').textContent = String(answered);
      $('#respondidas-final').textContent = String(answered);
    })();
  </script>

</body>
</html>
