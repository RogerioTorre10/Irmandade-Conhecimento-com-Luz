<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jornada ‚Ä¢ Conhecimento com Luz</title>
  <style>
    :root { --bg:#0f1226; --panel:#1b1f3a; --txt:#f5f7ff; --gold:#ffd54a; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,Segoe UI,Roboto,Inter,Arial;
      color:var(--txt); background:linear-gradient(135deg,#0b0e22,#1b1f3a);
      min-height:100svh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .wrap{ width:100%; max-width:900px; background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:24px 20px 16px; backdrop-filter: blur(6px); }
    h1{ margin:0 0 4px; text-align:center; font-size:clamp(22px,3.6vw,32px); color:var(--gold) }
    p.sub{ text-align:center; margin:0 0 18px; opacity:.85 }
    form{ display:grid; gap:18px }
    .q{ background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:14px }
    .q label{ display:block; font-weight:600; margin-bottom:8px }
    .q textarea,.q input[type="text"]{
      width:100%; background:#101429; color:var(--txt); border:1px solid rgba(255,255,255,.12);
      border-radius:10px; padding:10px 12px; min-height:84px; resize:vertical; outline:none;
    }
    .q textarea:focus,.q input[type="text"]:focus{ border-color:var(--gold); box-shadow:0 0 0 2px rgba(255,213,74,.25)}
    .row{ display:grid; gap:12px; grid-template-columns:1fr }
    @media (min-width:720px){ .row{ grid-template-columns:1fr 1fr } }
    .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:6px }
    button{ background:var(--gold); color:#000; border:0; border-radius:10px; padding:12px 18px; font-weight:700; cursor:pointer }
    button.secondary{ background:transparent; color:var(--gold); border:1px solid var(--gold) }
    .msg{ text-align:center; font-weight:700; min-height:24px }
    .hidden{ display:none !important }
    .downloads{ display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap }
    .downloads a{ background:#12d6ff; color:#001018; padding:10px 14px; border-radius:10px; text-decoration:none; font-weight:800 }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Jornada ‚Äî Conhecimento com Luz ‚ú®</h1>
    <p class="sub">Responda com sinceridade. Seus dados s√£o usados apenas para a Jornada.</p>

    <form id="jornada">
      <div class="row">
        <div class="q">
          <label for="nome">Seu nome</label>
          <input type="text" id="nome" name="nome" placeholder="Como quer ser chamado(a)?" required>
        </div>
        <div class="q">
          <label for="email">E-mail</label>
          <input type="text" id="email" name="email" placeholder="(opcional)">
        </div>
      </div>

      <div id="lista-perguntas"></div>
      <div id="perguntas"></div>

      <div class="actions">
        <button type="button" class="secondary" id="btnLimpar">Limpar respostas</button>
        <button type="submit" id="btnEnviar">Enviar respostas</button>
      </div>
      <div id="mensagem" class="msg"></div>

      <!-- √Årea de download p√≥s-envio -->
      <div id="downloads" class="downloads hidden">
        <a id="linkPdf" href="#" target="_blank" rel="noopener">Baixar PDF üìÑ</a>
        <a id="linkHq"  href="#" target="_blank" rel="noopener">Baixar HQ üìò</a>
      </div>
    </form>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "https://lumen-backend-api.onrender.com";
    const URL_PERGUNTAS  = API_BASE + "/perguntas";
    const URL_FORMULARIO = API_BASE + "/formulario";

    // ===== helpers =====
    const $ = (sel)=>document.querySelector(sel);
    const perguntasDiv = $("#perguntas");
    const form = $("#jornada");
    const msg  = $("#mensagem");
    const downloadsBox = $("#downloads");
    const linkPdf = $("#linkPdf");
    const linkHq  = $("#linkHq");
    const btnEnviar = $("#btnEnviar");

    // Renderiza perguntas vindas da API
    async function carregarPerguntas(){
      msg.textContent = "Carregando‚Ä¶";
      try{
        const r = await fetch(URL_PERGUNTAS);
        if(!r.ok) throw new Error("Falha ao carregar perguntas");
        const data = await r.json();
        perguntasDiv.innerHTML = "";
        const perguntas = data.perguntas || {};
        const keys = Object.keys(perguntas).sort((a,b)=>Number(a)-Number(b));
        keys.forEach(k=>{
          const texto = perguntas[k];
          const id = "q"+k;
          const bloco = document.createElement("div");
          bloco.className = "q";
          bloco.innerHTML = `
            <label for="\${id}">\${k}. \${texto}</label>
            <textarea id="\${id}" name="\${id}" rows="4" required></textarea>
          `;
          perguntasDiv.appendChild(bloco);
        });
        msg.textContent = "";
      }catch(e){
        console.error(e);
        msg.textContent = "N√£o foi poss√≠vel carregar as perguntas. Tente novamente.";
      }
    }

    // Envio do formul√°rio
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      msg.textContent = "Gerando sua devolutiva‚Ä¶ isso pode levar alguns segundos.";
      btnEnviar.disabled = true;

      // monta payload
      const payload = {
        meta: {
          enviado_em: new Date().toISOString(),
          user_agent: navigator.userAgent
        },
        contato: {
          nome: $("#nome").value.trim(),
          email: $("#email").value.trim()
        },
        respostas: {}
      };

      // coleta respostas
      document.querySelectorAll("#perguntas textarea").forEach(area=>{
        const k = area.id.replace("q","");
        payload.respostas[k] = area.value.trim();
      });

      try{
        const r = await fetch(URL_FORMULARIO, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>({}));
        if(!r.ok || data.status!=="ok"){
          throw new Error(data.mensagem || "Falha no processamento");
        }

        msg.textContent = "‚úÖ Pronto! Baixe seus arquivos abaixo.";

        // S√≥ mostra os bot√µes que vierem na resposta
        if (data?.links?.pdf) {
          linkPdf.href = API_BASE + data.links.pdf;
        } else {
          linkPdf.remove();
        }
        if (data?.links?.hq) {
          linkHq.href  = API_BASE + data.links.hq;
        } else {
          linkHq.remove();
        }

        downloadsBox.classList.remove("hidden");
        downloadsBox.scrollIntoView({behavior:"smooth", block:"center"});

      }catch(err){
        console.error(err);
        msg.textContent = "‚ùå N√£o foi poss√≠vel gerar agora. Tente novamente em instantes.";
      }finally{
        btnEnviar.disabled = false;
      }
    });

    $("#btnLimpar").onclick = ()=> form.reset();

    // ‚ÄúAcorda‚Äù a inst√¢ncia free e carrega perguntas
    (async ()=>{
      try{
        const ctrl = new AbortController();
        setTimeout(()=>ctrl.abort(), 8000);
        await fetch(API_BASE + "/ping", { signal: ctrl.signal });
      }catch(_){}
      await carregarPerguntas();
    })();
  </script>
  <script>
  // === JORNADA CONHECIMENTO COM LUZ ‚Äî ESSENCIAL ===
  // Lista oficial de perguntas (32+), organizada por blocos

  const PERGUNTAS = [
    // BLOCO 1 ‚Äì Reflex√µes da Alma e da Exist√™ncia (10)
    "Como voc√™ tem percebido sua pr√≥pria vida at√© aqui?",
    "E a vida das pessoas ao seu redor, como voc√™ a enxerga?",
    "Como lida com seus traumas? Consegue falar sobre eles?",
    "Voc√™ acredita que a verdade existe ou tudo √© relativo? Explique.",
    "O que significa a doen√ßa para voc√™? Est√° enfrentando alguma? Fale livremente.",
    "H√° algu√©m que voc√™ gostaria de ter ao seu lado agora? Quem √© essa pessoa e por que ela n√£o est√°?",
    "Qual √© o seu maior v√≠cio? Por que voc√™ acha que ele surgiu? J√° tentou venc√™-lo?",
    "Sente que tem outros v√≠cios, mesmo que sutis ou emocionais? Quais?",
    "Como voc√™ percebe a morte? Ela te assusta, conforta ou provoca curiosidade?",
    "Voc√™ acredita em continuidade ap√≥s a morte? O que imagina que exista?",

    // BLOCO 2 ‚Äì Ra√≠zes e Experi√™ncias de Vida (8)
    "Com quem foi criado: ambos os pais biol√≥gicos, s√≥ um dos pais biol√≥gicos (div√≥rcio ou morte), pais afetivos (ado√ß√£o) ou parentes?",
    "√â filho √∫nico?",
    "Quantos irm√£os tem? √â primog√™nito, do meio ou ca√ßula?",
    "Passou fome quando crian√ßa?",
    "N√≠vel de escolaridade e forma√ß√£o acad√™mica.",
    "Estado civil: solteiro, namorando, casado, divorciado, vi√∫vo?",
    "Tem alguma defici√™ncia f√≠sica?",
    "Voc√™ j√° sofreu algum tipo de preconceito? Foi superado ou ainda interfere nas suas decis√µes?",

    // BLOCO 3 ‚Äì Futuro e Prop√≥sito (5)
    "Quais s√£o os seus maiores sonhos para o futuro?",
    "O que voc√™ considera essencial para ter uma vida plena?",
    "Se pudesse mudar algo na sociedade, o que mudaria?",
    "Qual legado gostaria de deixar?",
    "Se pudesse passar uma mensagem para o mundo inteiro agora, qual seria?",

    // BLOCO 4 ‚Äì Jornada Iluminada (9)
    "Voc√™ se recorda da idade em que, pela primeira vez, percebeu que era algu√©m neste mundo?",
    "Se encontrasse seu 'eu' de 10 anos atr√°s, o que diria?",
    "O que significa f√© para voc√™?",
    "J√° teve alguma experi√™ncia que mudou sua forma de ver a vida?",
    "Quais pessoas mais marcaram sua caminhada? Por qu√™?",
    "Voc√™ acredita que tudo tem um prop√≥sito?",
    "Se pudesse receber uma resposta direta de Deus agora, qual pergunta faria?",
    "Que h√°bito voc√™ pode iniciar hoje que te aproximaria do seu prop√≥sito?",
    "Qual √© a decis√£o corajosa que voc√™ vem adiando e precisa tomar?"
  ];

  // Cabe√ßalho visual por blocos (opcional)
  const BLOCO_TITULOS = {
    0: "Reflex√µes da Alma e da Exist√™ncia",
    10: "Ra√≠zes e Experi√™ncias de Vida",
    18: "Futuro e Prop√≥sito",
    23: "Jornada Iluminada"
  };

  const lista = document.getElementById("lista-perguntas");
  const parts = [];

  PERGUNTAS.forEach((texto, i) => {
    // Se existir um t√≠tulo para este √≠ndice, insere um separador
    if (BLOCO_TITULOS[i]) {
      parts.push(`
        <h3 class="mt-10 mb-4 text-xl font-extrabold tracking-wide text-primary-300">
          ${BLOCO_TITULOS[i]}
        </h3>
      `);
    }
    parts.push(`
      <div class="mb-6 rounded-2xl bg-white/5 p-4 border border-white/10">
        <label class="block font-semibold mb-2">${i + 1}. ${texto}</label>
        <textarea name="q${i + 1}" rows="4"
          class="w-full rounded-xl bg-gray-900/60 border border-white/10 p-3"
          placeholder="Escreva com sinceridade..."></textarea>
      </div>
    `);
  });

  lista.innerHTML = parts.join("");
</script>
  <script>
  // === COLETA + ENVIO PARA O BACKEND ===
  const API = 'https://lumen-backend-api.onrender.com';
  const ENDPOINT = '/jornada/essencial'; // ajuste se necess√°rio
  const MIN_CAMPOS = 10;                 // m√≠nimo de respostas preenchidas para enviar

  // 1) Injeta barra de controle (senha + bot√µes) se n√£o existir no HTML
  (function injectControls() {
    if (document.getElementById('painel-controles')) return;
    const painel = document.createElement('div');
    painel.id = 'painel-controles';
    painel.className = 'sticky bottom-0 left-0 right-0 z-40 bg-gray-900/90 border-t border-white/10 backdrop-blur';
    painel.innerHTML = `
      <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <label class="text-sm text-gray-300">Senha de acesso</label>
          <input id="senha" type="password" placeholder="Digite sua senha"
                 class="rounded-lg bg-gray-800 border border-white/10 px-3 py-2 text-sm w-56" />
        </div>
        <div class="flex gap-3">
          <button id="btnLimpar" class="px-4 py-2 rounded-xl border border-yellow-400/50 text-yellow-300 hover:bg-yellow-400/10">
            Limpar respostas
          </button>
          <button id="btnEnviar" class="px-4 py-2 rounded-xl bg-yellow-400 text-gray-900 font-semibold hover:bg-yellow-300">
            Enviar respostas
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(painel);
  })();

  // 2) Persist√™ncia simples (auto-save local) enquanto o usu√°rio digita
  const campos = () => Array.from(document.querySelectorAll('textarea[name^="q"]'));
  const KEY_PREFIX = 'jornada_essencial_';
  function salvarAuto() {
    campos().forEach((t, i) => localStorage.setItem(KEY_PREFIX + (i+1), t.value));
  }
  function restaurarAuto() {
    campos().forEach((t, i) => {
      const v = localStorage.getItem(KEY_PREFIX + (i+1));
      if (v) t.value = v;
    });
  }
  restaurarAuto();
  document.addEventListener('input', (e) => {
    if (e.target && e.target.matches('textarea[name^="q"]')) salvarAuto();
  });

  // 3) Bot√£o Limpar
  document.getElementById('btnLimpar').addEventListener('click', () => {
    if (!confirm('Deseja limpar todas as respostas desta p√°gina?')) return;
    campos().forEach(t => t.value = '');
    salvarAuto();
  });

  // 4) Envio
  document.getElementById('btnEnviar').addEventListener('click', async () => {
    const senha = document.getElementById('senha').value.trim();
    if (!senha) { alert('Digite a senha de acesso.'); return; }

    const respostas = campos().map((t, i) => ({
      id: i + 1,
      pergunta: (typeof PERGUNTAS !== 'undefined' ? PERGUNTAS[i] : `Q${i+1}`),
      resposta: t.value.trim()
    }));

    const preenchidas = respostas.filter(r => r.resposta.length > 0).length;
    if (preenchidas < MIN_CAMPOS) {
      const ok = confirm(`Somente ${preenchidas} respostas preenchidas. Deseja enviar assim mesmo?`);
      if (!ok) return;
    }

    // Metadados √∫teis (timezone e hor√°rio de in√≠cio p/ regra 15d/24h se quiser usar)
    const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
    const startedKey = KEY_PREFIX + 'started_at';
    if (!localStorage.getItem(startedKey)) localStorage.setItem(startedKey, new Date().toISOString());

    const payload = {
      senha,
      respostas,
      meta: {
        dispositivo: navigator.userAgent,
        timezone: tz,
        started_at: localStorage.getItem(startedKey),
        enviado_em: new Date().toISOString()
      }
    };

    // UI: loading state
    const btn = document.getElementById('btnEnviar');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Gerando PDF...';

    try {
      // Aquece o backend (opcional)
      await fetch(API + '/ping', { method: 'GET' }).catch(()=>{});

      const r = await fetch(API + ENDPOINT, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/pdf'   // backend deve retornar PDF direto
        },
        body: JSON.stringify(payload)
      });

      const ct = r.headers.get('Content-Type') || '';
      if (!r.ok) {
        // Se vier JSON de erro, mostra mensagem amig√°vel
        if (ct.includes('application/json')) {
          const err = await r.json().catch(()=>({detail:'Erro desconhecido'}));
          throw new Error(err.detail || err.message || 'Falha ao gerar PDF.');
        }
        throw new Error('Falha ao gerar PDF. Tente novamente em instantes.');
      }

      if (ct.includes('application/pdf')) {
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Jornada-Conhecimento-com-Luz.pdf';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        // Pol√≠tica: apagar respostas locais ap√≥s download
        campos().forEach((t, i) => localStorage.removeItem(KEY_PREFIX + (i+1)));
        localStorage.removeItem(startedKey);
        alert('PDF gerado com sucesso! Lembre-se: baixe e guarde. Os dados foram limpos do dispositivo.');
      } else if (ct.includes('application/json')) {
        // Alternativa: backend pode retornar { url: '...' }
        const data = await r.json();
        if (data.url) {
          location.href = data.url;
        } else if (data.message) {
          alert(data.message);
        } else {
          alert('Resposta recebida, mas n√£o reconhecida.');
        }
      } else {
        alert('Formato de resposta inesperado do servidor.');
      }
    } catch (err) {
      console.error(err);
      alert(err.message || 'Erro ao enviar. Tente novamente.');
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  });
</script>
</body>
</html>
