<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada • Irmandade Conhecimento com Luz</title>
  <link rel="alternate icon" href="/assets/img/perfil-da-irmandade.png" type="image/png">

  <style>
    /* ===== BASE ===== */
    body { margin:0; font-family: Arial, sans-serif; background:#f9f9f9; color:#333; }
    @font-face { font-family: 'BerkshireSwash'; src: url('/assets/fonts/BerkshireSwash-Regular.ttf') format('truetype'); }
    .site-header{display:flex;align-items:center;gap:12px;padding:16px;background:#1f2937;color:#fff;box-shadow:0 2px 4px rgba(0,0,0,.1);position:relative;z-index:1000}
    .container{max-width:900px;margin:24px auto;padding:0 16px}
    .card{background:#f6efe0!important;border-radius:14px;box-shadow:0 8px 28px rgba(0,0,0,.12);padding:32px;position:relative;z-index:10}

    /* ===== PERGAMINHO ===== */
    .pergaminho-v{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h{background-image:url('/assets/img/pergaminho-rasgado-horiz.png')!important;background-size:cover!important;background-position:center!important;min-height:82vh!important}
    .pergaminho-h.fallback{background-image:url('/assets/img/pergaminho-rasgado-vert.png')!important}
    .conteudo-pergaminho{background:transparent!important;position:relative;z-index:20;padding:20px;min-height:100%;overflow:visible}

    /* ===== CHAMA VIVA ATUALIZADA (forma de vela: apontada no topo, gordinha no meio, estreita na base, sem recipiente) ===== */
    .chama-viva{
      --altura: 90px; --largura: 60px; --pulso: 1.8s; --glow: 16px;
      --hue: 32; --satur: 95%; --light: 58%; --op: .95;
      position: relative;
      width: var(--largura);
      height: var(--altura);
      clip-path: polygon(20% 100%, 80% 100%, 50% 0%);
      background: linear-gradient(to top, #ffff00 0%, #ff8c00 40%, #ff4500 100%);
      filter: drop-shadow(0 0 var(--glow) hsla(var(--hue),var(--satur),60%,.65));
    }
    .chama-viva .brasa{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * .8);
      height: 16px;
      border-radius: 50%;
      background: radial-gradient(circle at 50% 50%, hsla(var(--hue),var(--satur),95%,.9) 0%, hsla(var(--hue),var(--satur),70%,.8) 35%, hsla(var(--hue),var(--satur),40%,.0) 70%);
      filter: blur(1.5px);
      animation: brasaPulse var(--pulso) infinite ease-in-out;
      opacity: var(--op);
    }
    .chama-viva .lingua{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: var(--largura);
      height: var(--altura);
      clip-path: polygon(20% 100%, 80% 100%, 50% 0%);
      background: radial-gradient(60% 60% at 50% 28%, hsla(var(--hue),var(--satur),98%,1) 0%, hsla(var(--hue),var(--satur),70%,.95) 35%, hsla(calc(var(--hue) - 8),calc(var(--satur) - 15%),50%,.85) 65%, transparent 82%);
      mix-blend-mode: screen;
      filter: blur(0.6px);
      animation: lingua var(--pulso) infinite ease-in-out;
      transform-origin: 50% 100%;
      opacity: var(--op);
    }
    .chama-viva .lingua:nth-child(2){
      width: calc(var(--largura) * .78);
      height: calc(var(--altura) * .88);
      animation-duration: calc(var(--pulso) + 0.3s);
      animation-delay:.05s;
    }
    .chama-viva .lingua:nth-child(3){
      width: calc(var(--largura) * .62);
      height: calc(var(--altura) * .76);
      animation-duration: calc(var(--pulso) + 0.6s);
      animation-delay:.12s;
    }
    .chama-viva .brilho{
      position:absolute; left:50%; bottom:0; transform:translateX(-50%);
      width: calc(var(--largura) * 1.3);
      height: calc(var(--altura) * 1.1);
      background: radial-gradient(circle, hsla(var(--hue),var(--satur),70%,.35) 0%, transparent 65%);
      filter: blur(12px);
      pointer-events:none;
      mix-blend-mode: screen;
      animation: aura var(--pulso) infinite ease-in-out;
      opacity: .6;
    }
    .chama-viva.vibrante { animation: moveFlame 6s linear infinite, enlargeFlame 5s linear infinite; }
    .chama-viva.chama-pico .lingua{
      animation-timing-function: ease-out;
      transform: translateX(-50%) scaleY(1.1) skewX(1.6deg);
    }
    .chama-viva.chama-md { --altura: 64px; --largura: 32px; }
    .chama-viva.chama-lg { --altura: 120px; --largura: 60px; }
    .chama-viva[data-intensidade="fraca"]{ --altura: 70px; --largura: 52px; --pulso: 2.8s; --glow: 8px; --hue: 40; --satur: 80%; --light: 65%; --op: .65; animation: none; }
    .chama-viva[data-intensidade="media"]{ --altura: 90px; --largura: 60px; --pulso: 1.8s; --glow: 16px; --hue: 32; --satur: 95%; --light: 58%; --op: .95; animation: none; }
    .chama-viva[data-intensidade="forte"]{ --altura: 110px; --largura: 66px; --pulso: 1.1s; --glow: 26px; --hue: 20; --satur: 100%; --light: 52%; --op: 1; animation: none; }
    @keyframes lingua{0%,100%{transform:translateX(-50%) scaleY(1) skewX(0deg);}50%{transform:translateX(-50%) scaleY(1.06) skewX(1.2deg);}}
    @keyframes brasaPulse{0%,100%{transform:translateX(-50%) scale(1);opacity:.7;}50%{transform:translateX(-50%) scale(1.05);opacity:1;}}
    @keyframes aura{0%,100%{opacity:.5;}50%{opacity:.8;}}
    @keyframes moveFlame{0%,100%{transform:rotate(-2deg);}50%{transform:rotate(2deg);}}
    @keyframes enlargeFlame{0%,100%{height:var(--altura);}50%{height:calc(var(--altura) * 1.2);}}
    @media (prefers-reduced-motion:reduce){.chama-viva .lingua,.chama-viva .brasa,.chama-viva .brilho,.chama-viva.vibrante{animation:none!important;}}
    .chama-viva::after { display: none !important; } /* Remover recipiente */

    /* ===== BOLA DE CHAMA ATUALIZADA (menor, com chamas flamejantes altas) ===== */
    #chama-bola{
      --size: 40px; --glow: 22px; --color1:#fff7cc; --color2:#ffd166; --color3:#ff8c00; --color4:transparent;
      position:relative; width:var(--size); height:var(--size); border-radius:50%;
      background:radial-gradient(circle at 50% 50%,var(--color1) 0%,var(--color2) 35%,var(--color3) 65%,var(--color4) 100%);
      filter:drop-shadow(0 0 var(--glow) rgba(255,140,0,.65));
      animation:bolaPulse 1.6s infinite ease-in-out;
    }
    #chama-bola .lingua{
      position:absolute; left:50%; bottom:50%; transform:translateX(-50%);
      width: calc(var(--size) * 0.4);
      height: calc(var(--size) * 1.8); /* Altas flamejantes */
      background: linear-gradient(to top, #ff8c00, #ffd700);
      clip-path: polygon(30% 100%, 50% 0%, 70% 100%);
      animation: linguaJitter 3s infinite ease-in-out;
    }
    #chama-bola .lingua:nth-child(2){
      width: calc(var(--size) * 0.3);
      height: calc(var(--size) * 1.6);
      animation-delay: 0.2s;
    }
    #chama-bola .lingua:nth-child(3){
      width: calc(var(--size) * 0.2);
      height: calc(var(--size) * 1.4);
      animation-delay: 0.4s;
    }
    #chama-bola::after {
      content: "";
      position: absolute;
      inset: -20%;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,180,50,0.4) 0%, transparent 70%);
      filter: blur(12px);
      animation: auraPulse 2.2s infinite ease-in-out;
    }
    #chama-bola.fraca{--size:30px;--glow:10px;opacity:0.6;animation-duration:2.5s;}
    #chama-bola.media{--size:40px;--glow:22px;opacity:0.9;animation-duration:1.6s;}
    #chama-bola.forte{--size:50px;--glow:36px;opacity:1;animation-duration:1s;}
    @keyframes bolaPulse{0%,100%{transform:scale(1);opacity:.9;}50%{transform:scale(1.15);opacity:1;}}
    @keyframes auraPulse{0%,100%{opacity:.4;}50%{opacity:.8;}}
    @keyframes linguaJitter { 0%, 100% { transform: translateX(-50%) scaleY(1) skewX(0deg); } 20% { transform: translateX(-50%) scaleY(1.05) skewX(.5deg); } 50% { transform: translateX(-50%) scaleY(1.1) skewX(1.2deg); } 80% { transform: translateX(-50%) scaleY(1.03) skewX(.3deg); } }
    #guia-espiritual{position:fixed;left:20px;bottom:20px;z-index:9999;pointer-events:none;}
    #guia-espiritual::after,#chama-bola::after{display:none!important;}

    /* ===== UI ===== */
    .btn{display:inline-block;padding:12px 24px;border-radius:10px;border:0;background:#1f2937;color:#fff;font-family:'BerkshireSwash',cursive;font-weight:600;font-size:18px;text-decoration:none;transition:background .3s ease,transform .2s ease;z-index:30}
    .btn:hover{background:#374151;transform:scale(1.05)}
    .btn-primary{background:#6b21a8}
    .btn-primary:hover{background:#7c3aed}
    .btn-secondary{background:#4b5563}
    .btn-secondary:hover{background:#6b7280}
    .btn + .btn{margin-left:12px}

    .progress-badge{position:fixed;top:16px;right:16px;padding:8px 16px;background:#6b21a8;color:#fff;border-radius:8px;font-size:.9rem;font-family:'BerkshireSwash',cursive;z-index:900;visibility:visible}
    .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;margin-top:12px;z-index:900;visibility:visible}
    .progress-bar-fill{height:100%;background:#6b21a8;border-radius:4px;transition:width .3s ease}
    .j-progress{margin-top:12px;z-index:900;visibility:visible}
    .j-progress__bar{width:100%;height:6px;background:#e5e7eb;border-radius:4px}
    .j-progress__fill{height:100%;background:#1f2937;border-radius:4px;transition:width .3s ease}
    .j-progress__meta{text-align:center;margin-top:8px;font-size:.9rem;font-family:'BerkshireSwash',cursive}

    .footer-actions{display:flex;gap:12px;justify-content:center;margin:16px 0;z-index:900}

    .lumen-typing{white-space:pre-wrap;position:relative}
    .lumen-typing::after{content:"▌";margin-left:2px;opacity:.75;animation:lumenBlink 1s steps(2,end) infinite}
    .lumen-typing.typing-done::after{content:"";animation:none}
    @keyframes lumenBlink{50%{opacity:0}}

    .j-section{height:100%}
    .j-bloco{background:transparent!important;display:none;z-index:50}
    .j-pergunta{margin-bottom:24px;display:none;z-index:60;position:relative}
    .j-pergunta.active{display:block}
    .pergunta-enunciado{font-weight:600;margin-bottom:8px;display:block}
    .j-pergunta textarea{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db;background:rgba(255,255,255,.8);resize:vertical;min-height:100px}

    #videoOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:2000}
    #videoOverlay.hidden{display:none}
    .video-player{max-width:90vw;max-height:80vh;background:#000}

    .site-footer{text-align:center;padding:16px;opacity:.6;font-size:.85rem;z-index:10}
    .password-form{margin-top:20px;text-align:center}
    .password-input{position:relative}
    .password-input input{width:100%;padding:12px;border-radius:8px;border:1px solid #d1d5db}
    .password-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);cursor:pointer}

    .section-container{position:relative;min-height:85vh}
    .hidden{display:none!important}

    .chama-fixed-hero{position:absolute;top:-8px;left:-8px;z-index:60}
    .chama-fixed-top{position:absolute;top:10px;right:14px;z-index:60}
  </style>
</head>

<body data-layout="master" data-journey="essencial">
  <header class="site-header">
    <div class="chama-viva chama-md chama-fixed-top" id="chama-top">
      <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
    </div>
    <h1>Jornada Essencial</h1>
  </header>

  <main id="page-shell" class="container">
    <div class="container">
      <a class="btn btn-primary" href="#intro">Ir para Introdução</a>
      <a class="btn btn-secondary" href="/jornadas.html">Retornar à Homepage</a>
    </div>

    <div class="section-container">
      <section id="jornada-canvas" class="card pergaminho pergaminho-v">
        <div id="jornada-conteudo" class="conteudo-pergaminho">
          <!-- INTRO -->
          <div id="section-intro" class="j-section">
            <div class="chama-viva chama-lg vibrante chama-fixed-hero" id="chama-hero">
              <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
            </div>
            <p data-typing data-text="Respire. Esta jornada é sua. Um passo de cada vez." data-speed="40" data-cursor="true"></p>
            <p data-typing data-text="Bem-vindo(a) à nossa casa de reflexão e coragem. Antes de começar, ative sua senha." data-speed="50" data-cursor="true"></p>
            <div class="password-form">
              <h3>Ative sua Senha</h3>
              <div class="password-input">
                <input type="password" id="senha" placeholder="Digite sua senha...">
                <span class="password-toggle" data-action="toggle-password">👁️</span>
              </div>
              <button class="btn btn-primary" data-action="start">Iniciar</button>
            </div>
          </div>

          <!-- ORIENTAÇÕES E CONTRATO -->
          <div id="section-orientations" class="j-section hidden">
            <div class="chama-viva chama-lg vibrante chama-fixed-hero" id="chama-hero-orientations">
              <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
            </div>
            <h2>Orientações e Contrato</h2>
            <p>Leia atentamente as orientações antes de prosseguir com a jornada.</p>
            <p>Ao continuar, você concorda com os termos da Irmandade Conhecimento com Luz.</p>
            <div class="footer-actions">
              <button class="btn btn-primary" data-action="start-journey">Avançar</button>
              <button class="btn btn-secondary" data-action="home">Retornar à Homepage</button>
            </div>
          </div>

          <!-- PERGUNTAS -->
          <div id="section-perguntas" class="j-section hidden">
            <div class="chama-viva chama-md" id="chama-perguntas">
              <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
            </div>
            <div id="perguntas-container"></div>
            <div class="footer-actions">
              <button class="btn btn-secondary" data-action="prev">Voltar</button>
              <button class="btn btn-primary" data-action="next">Avançar</button>
            </div>
          </div>

          <!-- FINAL -->
          <div id="section-final" class="j-section hidden">
            <div class="chama-viva chama-lg vibrante chama-fixed-hero" id="chama-hero-final">
              <div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>
            </div>
            <p data-typing data-text="Parabéns por completar esta jornada! Que sua chama interior continue a brilhar." data-speed="40" data-cursor="true"></p>
            <div class="footer-actions">
              <button class="btn btn-primary" data-action="print">Imprimir PDF/HQ</button>
              <button class="btn btn-secondary" data-action="home">Retornar à Homepage</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <footer class="site-footer">
      <small>© 2025 Irmandade Conhecimento com Luz</small>
      <div id="envTag"></div>
    </footer>
  </main>

  <!-- PROGRESS -->
  <div class="progress-badge" id="jprog-pct">0% concluído</div>
  <div class="progress-bar"><div class="progress-bar-fill" id="jprog-fill"></div></div>
  <div class="j-progress">
    <div class="j-progress__bar"><div class="j-progress__fill"></div></div>
    <div class="j-progress__meta" id="j-meta">0/10</div>
  </div>

  <!-- OVERLAY VIDEO -->
  <div id="videoOverlay" class="video-overlay hidden">
    <video id="videoTransicao" class="video-player" playsinline preload="metadata" controls></video>
  </div>

  <!-- GUIA ESPIRITUAL -->
  <div id="guia-espiritual">
    <div id="chama-bola" class="media">
      <div class="lingua"></div><div class="lingua"></div><div class="lingua"></div>
    </div>
  </div>

  <script>
    // Tag ambiente
    document.getElementById('envTag').textContent = `layout=${document.body.dataset.layout || 'master'} · journey=${document.body.dataset.journey || 'essencial'} · path=/public`;

    // ESTADO
    const JC = { _state: { blocoIndex: 0, perguntaIndex: 0, respostas: Object.create(null) } };
    const S = {
      root: () => document.getElementById('jornada-canvas'),
      blocos: () => Array.from(document.querySelectorAll('.j-bloco,[data-bloco]')),
      blocoAtivo: () => S.blocos()[JC._state.blocoIndex],
      perguntasDo: (blocoEl) => Array.from(blocoEl.querySelectorAll('.j-pergunta,[data-pergunta]')),
      btnPrev: () => document.querySelector('[data-action="prev"]'),
      btnNext: () => document.querySelector('[data-action="next"]'),
      btnStart: () => document.querySelector('[data-action="start"]'),
      meta: () => document.getElementById('j-meta'),
      progressFill: () => document.querySelector('.j-progress__fill'),
      overlay: () => document.getElementById('videoOverlay'),
      video: () => document.getElementById('videoTransicao')
    };
    const U = {
      show: (el, disp = 'block') => { if (el) el.style.display = disp; },
      hide: (el) => { if (el) el.style.display = 'none'; },
      clamp: (n, a, b) => Math.max(a, Math.min(b, n)),
      key: (b, q) => `b${b}-q${q}`,
      getAnswerEl: (qEl) => qEl?.querySelector('textarea, input[type="text"], input[type="email"], input[type="number"], input[type="search"]') || null,
      getVal: (el) => (el && (el.value ?? '')).trim(),
      setProgress: (cur, total) => {
        const pct = total ? Math.round((cur / total) * 100) : 0;
        const bar = S.progressFill();
        const meta = S.meta();
        const badge = document.getElementById('jprog-pct');
        const jFill = document.querySelector('.j-progress__fill');
        if (bar) bar.style.width = `${pct}%`;
        if (jFill) jFill.style.width = `${pct}%`;
        if (meta) meta.textContent = `${cur}/10`;
        if (badge) badge.textContent = `${pct}% concluído`;
      }
    };

    // EMOÇÃO & DATILOGRAFIA
    const EMO = {
      POS: {'feliz':2,'alegria':2,'amor':3,'sucesso':2,'esperanca':3,'paz':2,'fe':3,'gratidao':2,'vitoria':3,'superacao':3,'luz':2,'deus':3,'coragem':2,'forca':2,'confianca':2,'proposito':3},
      NEG: {'triste':-2,'dor':-3,'raiva':-2,'medo':-2,'frustracao':-2,'decepcao':-2,'perda':-3,'culpa':-2,'ansiedade':-2,'solidao':-2,'desespero':-3,'cansaco':-2,'fracasso':-2,'trauma':-3,'duvida':-2,'vazio':-2}
    };
    function norm(s) { return (s || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); }
    function analyzeSentiment(text) {
      let score = 0;
      const tokens = norm(text).split(/\s+/);
      for (const t of tokens) {
        if (EMO.POS[t] != null) score += EMO.POS[t];
        if (EMO.NEG[t] != null) score += EMO.NEG[t];
      }
      return score;
    }
    function typeWriter(el, text, speed, showCursor) {
      if (!el) return;
      el.textContent = ''; if (showCursor) el.classList.add('lumen-typing');
      let i = 0; (function step() { if (i < text.length) { el.textContent += text.charAt(i++); setTimeout(step, speed); } else { el.classList.add('typing-done'); } })();
    }
    function runTyping(root) {
      (root || document).querySelectorAll('[data-typing]').forEach(el => {
        if (el.dataset._typed) return;
        const t = el.getAttribute('data-text') || el.textContent || '';
        const spd = parseInt(el.getAttribute('data-speed') || '26', 10);
        const cur = String(el.getAttribute('data-cursor') || 'true') === 'true';
        el.dataset._typed = '1'; typeWriter(el, t, spd, cur);
      });
    }

    // CHAMA API
    function scoreToIntensity(scoreNum) {
      if (scoreNum <= -2) return 'fraca';
      if (scoreNum >= 2) return 'forte';
      return 'media';
    }
    function mountFlame(el) {
      if (!el || el._chamaMounted) return;
      el.classList.add('chama-viva');
      el.setAttribute('data-intensidade', 'media');
      el.innerHTML = `<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>`;
      el._chamaMounted = true;
    }
    function setChamaIntensidade(target, modo) {
      const el = typeof target === 'string' ? document.getElementById(target) : target;
      if (!el) return;
      mountFlame(el);
      el.setAttribute('data-intensidade', modo);
    }
    function updateChama(scoreNum, targetId = 'chama-perguntas') {
      const el = document.getElementById(targetId);
      if (!el) return;
      mountFlame(el);
      const modo = scoreToIntensity(Number(scoreNum) || 0);
      el.setAttribute('data-intensidade', modo);
      clearTimeout(el._pulse_t);
      if (modo === 'forte') {
        el.classList.add('chama-pico');
        el._pulse_t = setTimeout(() => el.classList.remove('chama-pico'), 700);
      }
      setChamaBola(modo);
      const topFlame = document.getElementById('chama-top');
      if (topFlame) topFlame.setAttribute('data-intensidade', modo);
    }
    function updateChamaFromText(text, targetId = 'chama-perguntas') {
      const score = analyzeSentiment(text);
      updateChama(score, targetId);
      return { score, intensidade: scoreToIntensity(score) };
    }
    function setChamaBola(intensidade, targetId = 'chama-bola') {
      const el = document.getElementById(targetId);
      if (!el) return;
      el.classList.remove('fraca', 'media', 'forte');
      el.classList.add(intensidade);
    }
    function ensureHeroFlame(sectionId) {
      const canvas = document.getElementById('jornada-canvas'); if (!canvas) return;
      let hero = document.getElementById(`chama-hero${sectionId === 'section-intro' ? '' : sectionId === 'section-orientations' ? '-orientations' : sectionId === 'section-final' ? '-final' : ''}`);
      const show = (sectionId === 'section-intro' || sectionId === 'section-orientations' || sectionId === 'section-final');
      if (show) {
        if (!hero) {
          hero = document.createElement('div'); hero.id = `chama-hero${sectionId === 'section-intro' ? '' : sectionId === 'section-orientations' ? '-orientations' : sectionId === 'section-final' ? '-final' : ''}`;
          hero.className = 'chama-viva chama-lg vibrante chama-fixed-hero';
          hero.innerHTML = '<div class="brasa"></div><div class="lingua"></div><div class="lingua"></div><div class="lingua"></div><div class="brilho"></div>';
          canvas.appendChild(hero);
        }
      } else if (hero) { hero.remove(); }
    }
    window.JORNADA_CHAMA = { analyzeSentiment, updateChama, updateChamaFromText, setChamaIntensidade, ensureHeroFlame, setChamaBola };

    // RENDER
    function renderIntro() {
      console.log('[JORNADA_RENDER] Renderizando intro');
      const section = document.getElementById('section-intro');
      if (section) {
        section.classList.remove('hidden');
        const canvas = document.getElementById('jornada-canvas');
        if (canvas) {
          canvas.className = 'card pergaminho pergaminho-v';
          canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-vert.png)';
        }
      }
    }
    function renderPerguntas(blocoIndex = 0) {
      console.log('[JORNADA_RENDER] Renderizando perguntas, bloco:', blocoIndex);
      const section = document.getElementById('section-perguntas');
      if (section) {
        section.classList.remove('hidden');
        const canvas = document.getElementById('jornada-canvas');
        if (canvas) {
          canvas.className = 'card pergaminho pergaminho-h';
          canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-horiz.png)';
        }
        const perguntasContainer = document.getElementById('perguntas-container');
        if (perguntasContainer) {
          const blocos = Array.from(perguntasContainer.querySelectorAll('.j-bloco'));
          if (blocos[blocoIndex]) {
            blocos.forEach(b => b.style.display = 'none');
            blocos[blocoIndex].style.display = 'block';
            const perguntas = Array.from(blocos[blocoIndex].querySelectorAll('.j-pergunta'));
            if (perguntas.length) {
              perguntas.forEach(p => p.classList.remove('active'));
              perguntas[0].classList.add('active');
              console.log('Exibindo pergunta inicial do bloco:', blocoIndex);
            } else {
              console.warn('Nenhuma pergunta encontrada no bloco:', blocoIndex);
            }
          } else {
            console.error('Bloco não encontrado no índice:', blocoIndex);
          }
        }
      }
    }
    function renderFinal() {
      console.log('[JORNADA_RENDER] Renderizando final');
      const section = document.getElementById('section-final');
      if (section) {
        section.classList.remove('hidden');
        const canvas = document.getElementById('jornada-canvas');
        if (canvas) {
          canvas.className = 'card pergaminho pergaminho-v';
          canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-vert.png)';
        }
      }
    }

    // CONTROLES
    function saveCurrentAnswer() {
      const bloco = S.blocoAtivo();
      if (!bloco) return;
      const perguntas = S.perguntasDo(bloco);
      const qEl = perguntas[JC._state.perguntaIndex];
      if (!qEl) return;
      const input = U.getAnswerEl(qEl);
      if (input) {
        const k = U.key(JC._state.blocoIndex, JC._state.perguntaIndex);
        JC._state.respostas[k] = U.getVal(input);
        try { localStorage.setItem('JORNADA_RESPOSTAS', JSON.stringify(JC._state.respostas)); } catch {}
      }
    }
    function updateCanvasBackground(sectionId) {
      const canvas = document.getElementById('jornada-canvas');
      if (canvas) {
        if (sectionId === 'section-perguntas') {
          checkImage('/assets/img/pergaminho-rasgado-horiz.png', '/assets/img/pergaminho-rasgado-vert.png').then(bg => {
            canvas.className = `card pergaminho pergaminho-h${bg.includes('vert') ? ' fallback' : ''}`;
            canvas.style.backgroundImage = `url('${bg}')`;
          });
        } else {
          canvas.className = 'card pergaminho pergaminho-v';
          canvas.style.backgroundImage = 'url(/assets/img/pergaminho-rasgado-vert.png)';
        }
      }
    }
    function render() {
      const root = S.root();
      if (!root) { console.warn('Root #jornada-canvas não encontrado'); return; }
      U.show(root, 'block');
      const blocos = S.blocos();
      if (!blocos.length) { console.error('Nenhum bloco encontrado após loadDynamicBlocks!'); return; }
      blocos.forEach(U.hide);
      const bloco = S.blocoAtivo();
      if (bloco) U.show(bloco);
      else { console.error('Bloco ativo não encontrado no índice:', JC._state.blocoIndex); return; }
      const perguntas = S.perguntasDo(bloco);
      if (!perguntas.length) { console.error('Nenhuma pergunta encontrada no bloco ativo:', bloco); return; }
      perguntas.forEach(q => q.classList.remove('active'));
      JC._state.perguntaIndex = U.clamp(JC._state.perguntaIndex, 0, Math.max(0, perguntas.length - 1));
      const atual = perguntas[JC._state.perguntaIndex];
      if (atual) {
        atual.classList.add('active');
        console.log('Exibindo pergunta:', JC._state.perguntaIndex + 1, 'de', perguntas.length);
        const input = U.getAnswerEl(atual);
        if (input) {
          input.style.display = 'block';
          input.style.visibility = 'visible';
          try { input.focus({ preventScroll: true }); } catch (e) { console.warn('Erro ao focar input:', e); }
        }
      } else {
        console.error('Pergunta atual não encontrada no índice:', JC._state.perguntaIndex);
      }
      runTyping(atual);
      U.setProgress(JC._state.perguntaIndex + 1, perguntas.length);
      const prev = S.btnPrev();
      const next = S.btnNext();
      if (prev) prev.disabled = (JC._state.blocoIndex === 0 && JC._state.perguntaIndex === 0);
      if (next) {
        const ultimaPergunta = JC._state.perguntaIndex === perguntas.length - 1;
        const ultimoBloco = JC._state.blocoIndex === blocos.length - 1;
        next.textContent = ultimaPergunta ? (ultimoBloco ? 'Finalizar' : 'Concluir bloco ➜') : 'Avançar';
        next.disabled = false;
      }
    }
    function goNext() {
      const bloco = S.blocoAtivo();
      const perguntas = S.perguntasDo(bloco);
      saveCurrentAnswer();
      if (JC._state.perguntaIndex < perguntas.length - 1) {
        JC._state.perguntaIndex++;
        render();
        return;
      }
      const videoSrc = window.JORNADA_BLOCKS[JC._state.blocoIndex]?.video_before || '';
      console.log('Transição para próximo bloco, videoSrc:', videoSrc);
      const haProximoBloco = JC._state.blocoIndex < S.blocos().length - 1;
      if (haProximoBloco) {
        playTransition(videoSrc, () => {
          JC._state.blocoIndex++;
          JC._state.perguntaIndex = 0;
          render();
        });
      } else {
        finalize();
      }
    }
    function goPrev() {
      if (JC._state.perguntaIndex > 0) {
        JC._state.perguntaIndex--;
        render();
        return;
      }
      if (JC._state.blocoIndex > 0) {
        JC._state.blocoIndex--;
        const perguntas = S.perguntasDo(S.blocoAtivo());
        JC._state.perguntaIndex = Math.max(0, perguntas.length - 1);
        render();
      } else {
        showSection('section-orientations');
      }
    }
    function checkImage(url, fallbackUrl) {
      return new Promise(resolve => {
        const img = new Image(); img.onload = () => resolve(url); img.onerror = () => resolve(fallbackUrl); img.src = url;
      });
    }
    function showSection(sectionId) {
      document.querySelectorAll('.j-section').forEach(s => s.classList.add('hidden'));
      const active = document.getElementById(sectionId);
      if (active) active.classList.remove('hidden');
      updateCanvasBackground(sectionId);
      window.JORNADA_CHAMA.ensureHeroFlame(sectionId);
      if (sectionId === 'section-perguntas') {
        if (document.getElementById('perguntas-container').innerHTML === '') {
          loadDynamicBlocks();
        }
        const blocos = S.blocos();
        if (blocos.length) {
          JC._state.blocoIndex = 0;
          JC._state.perguntaIndex = 0;
          render();
        }
      }
    }
    function loadDynamicBlocks() {
      const content = document.getElementById('perguntas-container');
      if (!content) { console.error('Erro: #perguntas-container não encontrado no DOM!'); return; }
      if (content.innerHTML !== '') { console.log('Blocos já carregados, skipping.'); return; }
      window.JORNADA_BLOCKS = [
        { title: 'Bloco 1 — Raízes', questions: [{ label: 'Quem é você hoje?' }, { label: 'O que a Luz te pede agora?' }], video_before: '/assets/img/filme-1-entrando-na-jornada.mp4' },
        { title: 'Bloco 2 — Caminho', questions: [{ label: 'Qual verdade você precisa admitir para seguir?' }, { label: 'O que precisa ser curado neste momento?' }], video_before: '/assets/img/filme-2-dentro-da-jornada.mp4' },
        { title: 'Bloco 3 — Propósito', questions: [{ label: 'Qual é o seu maior propósito?' }, { label: 'Como você pode servir à Luz?' }], video_before: '/assets/img/filme-3-proposito.mp4' },
        { title: 'Bloco 4 — Transformação', questions: [{ label: 'O que você precisa deixar para trás?' }, { label: 'O que está nascendo em você?' }], video_before: '/assets/img/filme-4-transformacao.mp4' },
        { title: 'Bloco 5 — Conclusão', questions: [{ label: 'O que você aprendeu nesta jornada?' }, { label: 'Como você levará a Luz adiante?' }], video_before: '/assets/img/filme-5-fim-da-jornada.mp4' }
      ];
      content.innerHTML = '';
      window.JORNADA_BLOCKS.forEach((block, idx) => {
        if (!block.questions || !Array.isArray(block.questions)) { console.warn(`Bloco ${idx} inválido: sem perguntas ou perguntas não é um array`); return; }
        const bloco = document.createElement('section');
        bloco.className = 'j-bloco';
        bloco.dataset.bloco = idx;
        bloco.dataset.video = block.video_before || '';
        bloco.style.display = 'none';
        block.questions.forEach((q, qIdx) => {
          if (!q.label) { console.warn(`Pergunta ${qIdx} no bloco ${idx} inválida: sem label`); return; }
          const pergunta = document.createElement('div');
          pergunta.className = 'j-pergunta';
          pergunta.dataset.pergunta = qIdx;
          pergunta.innerHTML = `
            <label class="pergunta-enunciado" data-typing data-text="<b>Pergunta ${qIdx + 1}:</b> ${q.label}" data-speed="40" data-cursor="true"></label>
            <textarea rows="4" class="input" placeholder="Digite sua resposta..." oninput="handleInput(this)"></textarea>
          `;
          bloco.appendChild(pergunta);
        });
        content.appendChild(bloco);
        console.log(`Bloco ${idx} criado com ${block.questions.length} perguntas`);
      });
      const firstBloco = content.querySelector('.j-bloco');
      if (firstBloco) {
        firstBloco.style.display = 'block';
        const firstPergunta = firstBloco.querySelector('.j-pergunta');
        if (firstPergunta) {
          firstPergunta.classList.add('active');
          runTyping(firstPergunta);
          const firstTa = firstPergunta.querySelector('textarea');
          if (firstTa) handleInput(firstTa);
        }
        loadAnswers();
      }
    }
    function playTransition(src, onEnd) {
      const overlay = S.overlay();
      const video = S.video();
      if (!overlay || !video || !src) { console.warn('Overlay, vídeo ou src não disponível:', { overlay, video, src }); onEnd && onEnd(); return; }
      try { video.pause(); video.removeAttribute('src'); video.load(); } catch {}
      video.src = src;
      overlay.classList.remove('hidden');
      const cleanup = () => {
        try { video.pause(); } catch {}
        overlay.classList.add('hidden');
        try { video.removeAttribute('src'); video.load(); } catch {}
        onEnd && onEnd();
      };
      video.onended = cleanup;
      video.onerror = cleanup;
      video.muted = false;
      try {
        video.play().catch(() => cleanup());
      } catch {}
      setTimeout(cleanup, 12000);
    }
    function finalize() {
      saveCurrentAnswer();
      const respostas = JC._state.respostas;
      console.log('[JORNADA] Finalizado. Respostas:', respostas);
      const pdfContent = Object.entries(respostas).map(([key, value]) => `${key}: ${value}`).join('\n\n');
      const pdfBlob = new Blob([pdfContent], { type: 'text/plain' });
      const pdfUrl = URL.createObjectURL(pdfBlob);
      const link = document.createElement('a');
      link.href = pdfUrl;
      link.download = 'jornada-conhecimento-com-luz.pdf';
      link.click();
      URL.revokeObjectURL(pdfUrl);
      localStorage.removeItem('JORNADA_RESPOSTAS');
      showSection('section-final');
    }
    function startJourney() {
      const senha = document.getElementById('senha')?.value || '';
      const senhasValidas = ['iniciar', 'olho magico', 'olho mágico'];
      if (senhasValidas.includes(senha.toLowerCase())) {
        showSection('section-orientations');
      } else { alert('Senha incorreta. Tente novamente.'); }
    }
    function startJourneyAfterOrientations() {
      showSection('section-perguntas');
      const videoSrc = window.JORNADA_BLOCKS[0].video_before;
      playTransition(videoSrc, () => {
        loadDynamicBlocks();
        JC._state.blocoIndex = 0;
        JC._state.perguntaIndex = 0;
        render();
      });
      document.querySelector('.progress-badge')?.classList.remove('hidden');
      document.querySelector('.progress-bar')?.classList.remove('hidden');
      document.querySelector('.j-progress')?.classList.remove('hidden');
      document.querySelector('.footer-actions')?.classList.remove('hidden');
      console.log('Jornada iniciada com sucesso!');
    }
    function handleInput(textarea) {
      const score = analyzeSentiment(textarea.value);
      updateChamaFromText(textarea.value);
      saveCurrentAnswer();
      U.setProgress(JC._state.perguntaIndex + 1, S.perguntasDo(S.blocoAtivo()).length);
    }
    function loadAnswers() {
      try {
        const stash = localStorage.getItem('JORNADA_RESPOSTAS');
        if (stash) JC._state.respostas = JSON.parse(stash) || JC._state.respostas;
        const perguntas = document.querySelectorAll('.j-pergunta');
        perguntas.forEach((q, idx) => {
          const input = U.getAnswerEl(q);
          if (input) {
            const k = U.key(JC._state.blocoIndex, idx);
            input.value = JC._state.respostas[k] || '';
          }
        });
        U.setProgress(JC._state.perguntaIndex + 1, S.perguntasDo(S.blocoAtivo()).length);
      } catch {}
    }

    // BOOTSTRAP
    function routeFromHash() { return (location.hash || '#intro').slice(1); }
    function boot() {
      document.body.classList.add('jornada-active');
      const route = routeFromHash();
      console.log('[BOOT] tentando iniciar • rota:', route);
      if (route === 'intro') {
        renderIntro();
      } else if (route === 'perguntas') {
        renderPerguntas(0);
      } else if (route === 'final') {
        renderFinal();
      } else if (route === 'orientations') {
        showSection('section-orientations');
      } else {
        renderIntro();
      }
      setTimeout(() => {
        if (S.root()) {
          console.log('[BOOT] acionando JC.init() (reforço)');
          initJornada();
        }
      }, 200);
      console.log('[BOOT] inicialização concluída.');
      return true;
    }
    function initJornada() {
      const startBtn = S.btnStart();
      if (startBtn) startBtn.addEventListener('click', startJourney);
      const prevBtn = S.btnPrev();
      const nextBtn = S.btnNext();
      if (nextBtn) nextBtn.addEventListener('click', goNext);
      if (prevBtn) prevBtn.addEventListener('click', goPrev);
      document.addEventListener('click', (ev) => {
        const n = ev.target.closest('[data-action="next"]');
        const p = ev.target.closest('[data-action="prev"]');
        const s = ev.target.closest('[data-action="start"]');
        const t = ev.target.closest('[data-action="start-journey"]');
        const h = ev.target.closest('[data-action="home"]');
        const pr = ev.target.closest('[data-action="print"]');
        const tp = ev.target.closest('[data-action="toggle-password"], .password-toggle');
        if (n) { ev.preventDefault(); goNext(); }
        if (p) { ev.preventDefault(); goPrev(); }
        if (s) { ev.preventDefault(); startJourney(); }
        if (t) { ev.preventDefault(); startJourneyAfterOrientations(); }
        if (h) { ev.preventDefault(); location.href = '/jornadas.html'; }
        if (pr) { ev.preventDefault(); finalize(); }
        if (tp) { ev.preventDefault(); toggleSenha(); }
      });
      try {
        const stash = localStorage.getItem('JORNADA_RESPOSTAS');
        if (stash) JC._state.respostas = JSON.parse(stash) || JC._state.respostas;
      } catch {}
      render();
      console.log('Controlador da jornada inicializado!');
    }
    function toggleSenha() {
      const input = document.getElementById('senha');
      if (input) { input.type = (input.type === 'password' ? 'text' : 'password'); }
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
      runTyping(document);
      boot();
      const target = document.getElementById('jornada-conteudo');
      if (target) {
        const obs = new MutationObserver(muts => {
          muts.forEach(m => { runTyping(m.target); if (m.target.id === 'perguntas-container') U.setProgress(JC._state.perguntaIndex + 1, S.perguntasDo(S.blocoAtivo()).length); });
        });
        obs.observe(target, { childList: true, subtree: true });
      }
    });
    window.JC = JC;
    window.JC.toggleSenha = toggleSenha;
    window.JC.startJourney = startJourney;
    window.JC.showSection = showSection;
    window.JC.Chama = window.JORNADA_CHAMA;
  </script>
</body>
</html>
