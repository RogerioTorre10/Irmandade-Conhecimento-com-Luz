<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jornada Â· FinalizaÃ§Ã£o</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- util (se nÃ£o carregar, o fallback cobre) -->
  <link rel="preload" as="script" href="/jornada.js?v=8">
  <script defer src="/jornada.js?v=8"></script>

  <style>
    button:focus, button:focus-visible { outline: none !important; box-shadow: none !important; }
  </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100">
  <header class="p-6 border-b border-slate-800">
    <div class="max-w-5xl mx-auto flex items-center justify-between">
      <span class="text-xl font-semibold opacity-90 select-none cursor-default">
        Irmandade Conhecimento com Luz
      </span>
      <nav class="text-sm opacity-80">Jornada Â· Final</nav>
    </div>
  </header>

  <main class="max-w-3xl mx-auto p-6">
    <section class="rounded-2xl border border-slate-800 p-8 bg-slate-800/40 text-center">
      <h2 class="text-2xl font-bold mb-2">ParabÃ©ns! ðŸŽ‰</h2>
      <p class="opacity-90">VocÃª finalizou a jornada.</p>

      <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
        <a href="/jornada-conhecimento-com-luz1.html" class="px-5 py-3 rounded-xl border border-slate-700">Revisar respostas</a>
        <!-- ÃšNICO BOTÃƒO -->
        <button id="btnEntregar" class="px-5 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700" type="button">
          Baixar Entrega (PDF + HQ)
        </button>
        <a id="btnHome" href="/" class="px-5 py-3 rounded-xl border border-slate-700">Voltar ao inÃ­cio</a>
      </div>

      <p class="text-xs opacity-70 mt-4">
        Dica: se estiver sem espaÃ§o no dispositivo, o PDF baixa mesmo assim; a HQ pode falhar. Nesse caso, apenas o PDF serÃ¡ entregue.
      </p>
    </section>
  </main>

  <script>
    /* =================== UTIL/FALLBACKS =================== */
    const API_BASE = 'https://conhecimento-com-luz-api.onrender.com';
    const PDF_ENDPOINTS = ['/generate-pdf','/pdf','/api/pdf'];
    const ts = () => new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    const nomePDF = () => `Jornada_${ts()}.pdf`;
    const nomeHQ  = () => `Jornada_HQ_${ts()}.png`;

    const msg = (e) => (e && e.message) ? e.message : (typeof e === 'string' ? e : 'Erro inesperado');

    function _safeJSON(text, fb){ try{ return JSON.parse(text); } catch{ return fb; } }
    function _baixarBlob(blob){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=nomePDF(); document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(a.href),3000); }
    function _baixarBase64(b64){ const a=document.createElement('a'); a.href='data:application/pdf;base64,'+b64; a.download=nomePDF(); document.body.appendChild(a); a.click(); a.remove(); }

    function payload(){
      const fn = (window.JornadaUtil?.coletarPayload) || (() => {
        let respostas = _safeJSON(localStorage.getItem('respostas_jornada')||'{}', {});
        if(!respostas || (typeof respostas==='object' && Object.keys(respostas).length===0)){
          respostas={};
          document.querySelectorAll('textarea[name],input[name],select[name]').forEach(el=>{
            const k=el.name||el.id||''; if(!k) return;
            if(el.type==='checkbox') respostas[k]=!!el.checked;
            else if(el.type==='radio'){ if(el.checked) respostas[k]=el.value; }
            else respostas[k]=el.value;
          });
        }
        return { respostas, meta:{ agente:'Lumen', gerado_em:new Date().toISOString(), tz:(Intl.DateTimeFormat().resolvedOptions().timeZone||'UTC') } };
      });
      return fn();
    }

    /* ---------- PDF local (jsPDF) ----------- */
    function loadJsPDF(){
      if (window.jspdf?.jsPDF) return Promise.resolve();
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
        s.onload=()=>window.jspdf?.jsPDF?resolve():reject(new Error('jsPDF nÃ£o disponÃ­vel'));
        s.onerror=()=>reject(new Error('Falha ao carregar jsPDF'));
        document.head.appendChild(s);
      });
    }
    function wrapText(doc, text, maxW){ return doc.splitTextToSize(String(text ?? ''), maxW); }
    async function gerarPDFLocal(p){
      await loadJsPDF();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const margin = 56, maxW = pageW - margin*2;
      let y = margin;

      doc.setFont('Helvetica','bold'); doc.setFontSize(18);
      doc.text('Jornada Conhecimento com Luz', margin, y); y += 18;
      doc.setFont('Helvetica','normal'); doc.setFontSize(11);
      doc.text(`Gerado em: ${new Date().toLocaleString()}`, margin, y); y += 20;

      const entries = Object.entries(p?.respostas || {});
      entries.forEach(([k,v],idx)=>{
        if (y > pageH - margin - 60) { doc.addPage(); y = margin; }
        doc.setFont('Helvetica','bold'); doc.setFontSize(12);
        doc.text(`${idx+1}. ${k}`, margin, y); y += 14;
        doc.setFont('Helvetica','normal'); doc.setFontSize(11);
        wrapText(doc, Array.isArray(v)? v.join('\n'): v, maxW).forEach(line=>{
          if (y > pageH - margin - 20) { doc.addPage(); y = margin; }
          doc.text(line, margin, y); y += 14;
        });
        y += 8;
      });

      doc.save(nomePDF());
    }

    /* ---------- PDF robusto (tenta remoto; se falhar, local) ----------- */
    async function gerarPDFRobusto(p){
      try{
        if (window.JornadaUtil?.gerarPDF) { await window.JornadaUtil.gerarPDF(p); return; }
        let last;
        for (const ep of PDF_ENDPOINTS){
          try{
            const res = await fetch(API_BASE+ep,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json,application/pdf'},body:JSON.stringify(p||{})});
            const ct = (res.headers.get('content-type')||'').toLowerCase();
            if(res.ok && ct.includes('application/pdf')){ const blob=await res.blob(); _baixarBlob(blob); return; }
            const json = await res.json().catch(()=>({})); const b64 = json.pdf_base64 || json.file || json.pdf;
            if(b64){ _baixarBase64(b64); return; }
            last = new Error('Resposta inesperada: '+(JSON.stringify(json)||'sem detalhes'));
          }catch(e){ last=e; }
        }
        if (last) throw last;
      }catch(e){ await gerarPDFLocal(p); }
    }

    /* ---------- HQ robusto (leve + fallback) ----------- */
    function loadHtml2Canvas(){
      if (window.html2canvas) return Promise.resolve();
      return new Promise((resolve, reject)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        s.onload=resolve; s.onerror=()=>reject(new Error('Falha ao carregar html2canvas'));
        document.head.appendChild(s);
      });
    }
    function montarHQDOM(p){
      const respostas = p?.respostas || {};
      const wrap = document.createElement('div');
      Object.assign(wrap.style,{position:'fixed',left:'-99999px',top:'0',width:'900px',padding:'32px',color:'#e2e8f0',background:'#0f172a',fontFamily:'ui-sans-serif,system-ui'});
      wrap.innerHTML = `<div style="font-size:28px;font-weight:800;margin-bottom:8px">Jornada Conhecimento com Luz</div>
                        <div style="opacity:.8;margin-bottom:24px">Resumo simbÃ³lico â€” ${new Date().toLocaleString()}</div>`;
      Object.entries(respostas).forEach(([k,v],i)=>{
        const card=document.createElement('div');
        card.style.cssText='border:1px solid #1f2937;border-radius:16px;background:#111827;padding:16px;margin:12px 0;';
        card.innerHTML = `<div style="font-weight:700;margin-bottom:8px;color:#93c5fd">${i+1}. ${k}</div>
                          <div style="white-space:pre-wrap;line-height:1.5">${Array.isArray(v)?v.join('\n'):(v??'')}</div>`;
        wrap.appendChild(card);
      });
      return wrap;
    }
    async function gerarHQRobusto(p){
      // tenta versÃ£o leve (JPEG + scale 1.5); se falhar, cai pra PNG + scale 1
      try{
        await loadHtml2Canvas();
        const el = montarHQDOM(p || payload());
        document.body.appendChild(el);
        let canvas = await window.html2canvas(el,{backgroundColor:'#0f172a',scale:1.5,useCORS:true});
        let url = canvas.toDataURL('image/jpeg', 0.92);
        baixarArquivo(url, nomeHQ().replace('.png','.jpg'));
        el.remove();
      } catch (e1) {
        try {
          await loadHtml2Canvas();
          const el2 = montarHQDOM(p || payload());
          document.body.appendChild(el2);
          let canvas2 = await window.html2canvas(el2,{backgroundColor:'#0f172a',scale:1,useCORS:true});
          let url2 = canvas2.toDataURL('image/png');
          baixarArquivo(url2, nomeHQ());
          el2.remove();
        } catch(e2){
          throw e2;
        }
      }
    }
    function baixarArquivo(url, fname){
      const a=document.createElement('a'); a.href=url; a.download=fname; document.body.appendChild(a); a.click(); a.remove();
    }

    /* ---------- limpeza + redirecionamento ----------- */
    function finalizarEVoltar(){
      try{ localStorage.removeItem('respostas_jornada'); }catch{}
      try{ sessionStorage.removeItem('veio_da_intro'); }catch{}
      setTimeout(()=>{ location.href='/'; }, 1200); // dÃ¡ ~1s para os downloads comeÃ§arem
    }

    /* ---------- Ãºnico botÃ£o (PDF + HQ) ----------- */
    const btn = document.getElementById('btnEntregar');
    btn?.addEventListener('click', async (ev) => {
      btn.disabled = true;
      btn.classList.add('opacity-70','cursor-wait');
      const texto = btn.textContent;
      btn.textContent = 'Gerando entrega...';

      const p = payload();
      let pdfOK = false, hqOK = false;

      try { await gerarPDFRobusto(p); pdfOK = true; } 
      catch(e){ alert('PDF falhou, vamos tentar a imagem (HQ).\n\n'+msg(e)); }

      try { await gerarHQRobusto(p); hqOK = true; } 
      catch(e){ alert('HQ falhou.\n\n'+msg(e)); }

      // Mesmo que a HQ falhe por memÃ³ria/armazenamento, o PDF estando ok jÃ¡ encerra.
      finalizarEVoltar();

      // se quiser reabilitar o botÃ£o (em caso de debug local), descomente:
      // btn.disabled = false; btn.classList.remove('opacity-70','cursor-wait'); btn.textContent = texto;
    });
  </script>
</body>
</html>
