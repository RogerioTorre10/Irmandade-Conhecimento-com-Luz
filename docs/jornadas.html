/* ============================================
   Jornada Conhecimento com Luz — v9.1 estável
   - Intro com senha ("iniciar")
   - Formulário em blocos
   - Revisão
   - Download sequencial: PDF depois HQ
   - Limpeza de dados + retorno à home
   ============================================ */

const CONFIG = {
  API_BASE: 'https://conhecimento-com-luz-api.onrender.com', // backend no Render
  PASSWORD: 'iniciar',
  STORAGE_KEY: 'jornada_v9_respostas',
  VERSION: '9.1-pages'
};

// Estado simples
const state = {
  step: 'intro',  // intro | form | review | done
  answers: {}
};

const $ = (s) => document.querySelector(s);
const app = $('#app');

// ——— Persistência local ———
function saveLocal() {
  try {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.answers));
  } catch {}
}
function loadLocal() {
  try {
    const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
    if (raw) state.answers = JSON.parse(raw) || {};
  } catch {}
}
function clearLocal() {
  localStorage.removeItem(CONFIG.STORAGE_KEY);
  state.answers = {};
}

// ——— Modelo de perguntas (substitua/expanda quando quiser) ———
const QUESTIONS = [
  { id: 'q1', label: 'Quem é você hoje? (uma frase que te represente)', type: 'text' },
  { id: 'q2', label: 'Qual foi a maior superação da sua vida?', type: 'textarea' },
  { id: 'q3', label: 'O que você quer transformar nos próximos 90 dias?', type: 'text' }
];

function inputField(q) {
  const v = state.answers[q.id] || '';
  if (q.type === 'textarea') {
    return `<textarea class="input" rows="4" data-id="${q.id}">${v}</textarea>`;
  }
  return `<input class="input" type="text" data-id="${q.id}" value="${v}">`;
}

// ——— Renderização ———
function render() {
  if (state.step === 'intro')   return renderIntro();
  if (state.step === 'form')    return renderForm();
  if (state.step === 'review')  return renderReview();
  if (state.step === 'done')    return renderDone();
}

// Intro (senha)
function renderIntro() {
  app.innerHTML = `
    <section class="card space-y-4">
      <header class="text-center">
        <h2 class="text-xl font-semibold titulo-pergaminho">Acesso à Jornada</h2>
        <p class="texto-pergaminho">Digite a senha de acesso para iniciar.</p>
      </header>

      <div class="space-y-2">
        <label class="small texto-pergaminho">Senha</label>
        <input id="pwd" class="input" type="password" placeholder="iniciar">
        <p id="msg" class="small" style="color:#8b0000;"></p>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="btnStart" class="btn">Iniciar</button>
        <a href="./" class="btn" style="background:#334155">Voltar</a>
      </div>
    </section>
  `;

  $('#btnStart').addEventListener('click', () => {
    const val = ($('#pwd').value || '').trim().toLowerCase();
    if (val === CONFIG.PASSWORD) {
      state.step = 'form';
      render();
    } else {
      $('#msg').textContent = 'Senha inválida. Tente novamente.';
    }
  });
}

// Formulário
function renderForm() {
  loadLocal();

  const items = QUESTIONS.map(q => `
    <div class="space-y-2">
      <label class="block font-medium texto-pergaminho">${q.label}</label>
      ${inputField(q)}
    </div>
  `).join('\n');

  app.innerHTML = `
    <section class="card space-y-6">
      <header class="flex items-center justify-between">
        <h2 class="text-xl font-semibold titulo-pergaminho">Responda com calma</h2>
        <span class="small">Versão ${CONFIG.VERSION}</span>
      </header>

      ${items}

      <div class="flex flex-wrap gap-3 pt-2">
        <button id="btnReview" class="btn">Revisar</button>
        <button id="btnClear" class="btn" style="background:#334155">Limpar respostas</button>
        <a href="./" class="btn" style="background:#334155">Voltar</a>
      </div>
    </section>
  `;

  app.querySelectorAll('[data-id]').forEach(el => {
    el.addEventListener('input', (e) => {
      const id = e.target.getAttribute('data-id');
      state.answers[id] = e.target.value;
      saveLocal();
    });
  });

  $('#btnClear').addEventListener('click', () => {
    if (confirm('Tem certeza que deseja apagar TODAS as respostas?')) {
      clearLocal();
      renderForm();
    }
  });

  $('#btnReview').addEventListener('click', () => {
    state.step = 'review';
    render();
  });
}

// Revisão + Download
function renderReview() {
  const list = QUESTIONS.map(q => `
    <div class="space-y-1">
      <div class="small texto-pergaminho"><strong>${q.label}</strong></div>
      <div class="p-3 rounded" style="background:rgba(255,255,255,.85); border:1px solid #d8c2a1; color:#2b2620;">
        ${(state.answers[q.id] || '').replace(/\n/g,'<br>')}
      </div>
    </div>
  `).join('\n');

  app.innerHTML = `
    <section class="card space-y-6">
      <h2 class="text-xl font-semibold titulo-pergaminho">Revise suas respostas</h2>

      ${list}

      <div id="status" class="small" style="color:#3b2f2f;"></div>

      <div class="flex flex-wrap gap-3 pt-2">
        <button id="btnBack" class="btn" style="background:#334155">Voltar</button>
        <button id="btnSend" class="btn">Baixar PDF + HQ</button>
      </div>
    </section>
  `;

  $('#btnBack').addEventListener('click', () => {
    state.step = 'form';
    render();
  });
  $('#btnSend').addEventListener('click', sendAndDownload);
}

// Final
function renderDone() {
  app.innerHTML = `
    <section class="card space-y-3 text-center">
      <h2 class="text-2xl font-bold titulo-pergaminho">Parabéns! Você finalizou a jornada.</h2>
      <p class="texto-pergaminho">Você será redirecionado para a página inicial.</p>
    </section>
  `;
  setTimeout(() => window.location.href = './', 2200);
}

// ——— Geração sequencial: PDF depois HQ ———
async function sendAndDownload() {
  const el = $('#status');
  el.textContent = 'Gerando sua devolutiva (PDF e HQ)...';

  const payload = {
    answers: state.answers,
    meta: { version: CONFIG.VERSION, ts: new Date().toISOString() }
  };

  // 1) PDF
  try {
    const pdfResp = await fetch(`${CONFIG.API_BASE}/gerar-pdf`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/pdf'
      },
      body: JSON.stringify(payload)
    });
    if (!pdfResp.ok) throw new Error(`Falha PDF: ${pdfResp.status}`);
    const pdfBlob = await pdfResp.blob();
    triggerDownload(pdfBlob, `Jornada-Conhecimento-com-Luz.pdf`);
    el.textContent = 'PDF concluído. Gerando HQ...';
  } catch (e) {
    el.textContent = 'Não foi possível gerar o PDF. Tente novamente em instantes.';
    console.error(e);
    return;
  }

  // 2) HQ
  try {
    const hqResp = await fetch(`${CONFIG.API_BASE}/gerar-hq`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/pdf'
      },
      body: JSON.stringify({ answers: state.answers })
    });
    if (!hqResp.ok) throw new Error(`Falha HQ: ${hqResp.status}`);
    const hqBlob = await hqResp.blob();
    triggerDownload(hqBlob, `Jornada-Conhecimento-com-Luz-HQ.pdf`);
    el.textContent = 'HQ concluída. Limpando dados...';
  } catch (e) {
    el.textContent = 'PDF ok, mas houve falha ao gerar a HQ. Você pode tentar novamente mais tarde.';
    console.error(e);
  }

  clearLocal();
  state.step = 'done';
  render();
}

// ——— Util ———
function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// ——— Boot ———
(function init(){
  loadLocal();
  render();
})();
